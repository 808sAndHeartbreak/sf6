<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SF6 FRAME LAB - Ë°óÈú∏6 Â∏ßÊï∞ËÆ°ÁÆóÂô®</title>
    <meta name="description" content="Street Fighter 6 Â∏ßÊï∞ÂéãÂà∂ËÆ°ÁÆóÂ∑•ÂÖ∑ÔºåËá™Âä®ËÆ°ÁÆóÊúÄ‰ºòÂç°Â∏ßÊñπÊ°àÂíåÊäïÊäÄÊó∂Êú∫">
    <meta name="keywords" content="SF6, Street Fighter 6, Ë°óÈú∏6, Â∏ßÊï∞, Frame Data, ÂéãËµ∑Ë∫´, Meaty, Okizeme">
    <!-- Open Graph Á§æ‰∫§ÂàÜ‰∫´ -->
    <meta property="og:title" content="SF6 FRAME LAB - Â∏ßÊï∞ËÆ°ÁÆóÂô®">
    <meta property="og:description" content="Street Fighter 6 ÂéãËµ∑Ë∫´Â∏ßÊï∞ËÆ°ÁÆóÂ∑•ÂÖ∑">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ‰ΩøÁî®Á≥ªÁªüÂ≠ó‰ΩìÔºåÊó†ÈúÄÂ§ñÈÉ®Âä†ËΩΩ */
        :root {
            --theme-primary: #ff007a;
            --theme-secondary: #00f2ff;
            --theme-accent: #ffd700;
            --theme-bg: #0a0a0c;
            --theme-card-bg: #111114;
            --theme-card-border: #222;
        }

        html {
            scrollbar-gutter: stable;
        }

        body { 
            background-color: var(--theme-bg); 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", "PingFang SC", sans-serif;
        }
        
        .impact-text { 
            font-family: "Arial Black", "Helvetica Neue", Impact, sans-serif; 
            text-transform: uppercase; 
            font-style: italic; 
        }
        
        /* ========== Èò∂ÊÆµAÔºöGlitch Âä®ÊÄÅÊïàÊûú ========== */
        /* ‰∏ªÊ†áÈ¢ò - Â∏∏È©ªÂèëÂÖâ + ÂëºÂê∏ÊïàÊûú */
        .glitch-hover {
            position: relative;
            cursor: default;
            user-select: none;
            display: inline-block;
            /* Â∏∏È©ªÊüîÂíåÂèëÂÖâ */
            text-shadow: 
                0 0 10px var(--theme-primary),
                0 0 20px color-mix(in srgb, var(--theme-primary) 60%, transparent),
                0 0 30px color-mix(in srgb, var(--theme-primary) 30%, transparent);
            animation: glow-breathe 3s ease-in-out infinite;
        }
        
        /* ÂëºÂê∏ÂèëÂÖâÂä®Áîª */
        @keyframes glow-breathe {
            0%, 100% {
                text-shadow: 
                    0 0 8px var(--theme-primary),
                    0 0 16px color-mix(in srgb, var(--theme-primary) 50%, transparent),
                    0 0 24px color-mix(in srgb, var(--theme-primary) 25%, transparent);
            }
            50% {
                text-shadow: 
                    0 0 12px var(--theme-primary),
                    0 0 25px color-mix(in srgb, var(--theme-primary) 70%, transparent),
                    0 0 40px color-mix(in srgb, var(--theme-primary) 40%, transparent);
            }
        }
        
        /* ÊÇ¨ÂÅú/ÂàáÊç¢Êó∂ÔºöÊäñÂä® + Âº∫ÂåñÂèëÂÖâ */
        html.loaded .glitch-hover:hover,
        html.loaded .glitch-hover.glitch-active {
            animation: glitch-chaotic 1s steps(1) infinite !important;
            text-shadow: 
                4px 0 var(--theme-primary), 
                -4px 0 var(--theme-secondary),
                0 0 30px var(--theme-primary),
                0 0 60px var(--theme-primary),
                0 0 100px color-mix(in srgb, var(--theme-primary) 70%, transparent),
                0 0 150px color-mix(in srgb, var(--theme-primary) 40%, transparent) !important;
        }
        
        /* ÊÇ¨ÂÅúÁ¶ªÂºÄÂêéÁ´ãÂç≥ÈùôÊ≠¢ÔºåÊÅ¢Â§çÂ∏∏È©ªÂèëÂÖâ */
        html.loaded .glitch-hover:not(:hover):not(.glitch-active) {
            animation: none !important;
            transform: none;
            /* ‰øùÁïôÂ∏∏È©ªÂèëÂÖâÔºåÈÄöËøáÁªßÊâø .glitch-hover ÁöÑ text-shadow */
        }
        
        @keyframes glitch-chaotic {
            /* 0-80%: Âø´ÈÄüÊäñÂä®Èó™ÁÉÅÔºàÁ∫¶0.8ÁßíÔºâ */
            0% { transform: translate(0) skewX(0); }
            5% { transform: translate(-4px, 3px) skewX(-3deg); }
            7% { transform: translate(0) skewX(0); }
            13% { transform: translate(3px, -2px) skewX(2deg); }
            15% { transform: translate(0) skewX(0); }
            21% { transform: translate(-2px, -3px) skewX(-1deg); }
            23% { transform: translate(0) skewX(0); }
            29% { transform: translate(5px, 1px) skewX(4deg); }
            31% { transform: translate(0) skewX(0); }
            37% { transform: translate(-3px, 2px) skewX(-2deg); }
            39% { transform: translate(0) skewX(0); }
            45% { transform: translate(2px, -4px) skewX(3deg); }
            47% { transform: translate(0) skewX(0); }
            53% { transform: translate(-1px, 1px) skewX(-1deg); }
            55% { transform: translate(0) skewX(0); }
            61% { transform: translate(4px, -1px) skewX(2deg); }
            63% { transform: translate(0) skewX(0); }
            69% { transform: translate(-3px, -2px) skewX(-2deg); }
            71% { transform: translate(0) skewX(0); }
            77% { transform: translate(2px, 3px) skewX(1deg); }
            80% { transform: translate(0) skewX(0); }
            /* 80-100%: ÊÖ¢ÈÄüÂº±ÊäñÂä®Êî∂Â∞æÔºàÁ∫¶0.2ÁßíÔºâ */
            87% { transform: translate(0.8px, -0.4px) skewX(0.4deg); }
            94% { transform: translate(-0.4px, 0.3px) skewX(-0.2deg); }
            100% { transform: translate(0) skewX(0); }
        }
        
        /* ÊãõÂºèÂêçÊÇ¨ÂÅú - ‰ºòÈõÖÂæÆÂä®Êïà + ÂèëÂÖâ */
        .glitch-text {
            cursor: default;
            display: inline-block;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-size: 0.93em; /* Êï¥‰ΩìÁ®çÂ∞èÔºåËßÜËßâÂπ≥Ë°°‰∏≠Êñá */
        }
        
        .glitch-text:hover {
            transform: translateY(-2px);
            text-shadow: 0 0 15px var(--theme-primary), 0 4px 12px rgba(0, 0, 0, 0.5);
            filter: brightness(1.15);
        }
        
        /* Â∏ßÊï∞Êï∞Â≠óÊÇ¨ÂÅúÊïàÊûú */
        .frame-number {
            cursor: default;
            display: inline-block;
        }
        
        .frame-number:hover {
            animation: glitch-number 0.2s ease;
            color: var(--theme-primary);
            text-shadow: 0 0 20px var(--theme-primary), 0 0 40px var(--theme-primary);
        }
        
        @keyframes glitch-number {
            0%, 100% { transform: translate(0); opacity: 1; }
            33% { transform: translate(2px, -1px); opacity: 0.8; }
            66% { transform: translate(-2px, 1px); opacity: 0.9; }
        }
        
        /* ========== Á¨¨‰∏ÄÈò∂ÊÆµÔºöNew-Brutalism ÁªìÊûÑÂº∫Âåñ ========== */
        .trend-card { 
            background: color-mix(in srgb, var(--theme-primary) 10%, #0a0a0c);
            border: 3px solid color-mix(in srgb, var(--theme-primary) 40%, #333);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .trend-card:hover { 
            border-color: var(--theme-primary); 
            background: color-mix(in srgb, var(--theme-primary) 15%, #0a0a0c);
            /* New-Brutalism ÂçäÁ°¨Èò¥ÂΩ±ÔºöÊúâ‰ΩçÁßª + ËΩªÂæÆÊ®°Á≥ä */
            box-shadow: 6px 6px 0 color-mix(in srgb, var(--theme-primary) 60%, transparent);
            transform: translate(-2px, -2px);
        }
        
        .trend-card:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0 color-mix(in srgb, var(--theme-primary) 40%, transparent);
        }

        .btn-hype {
            background: var(--theme-secondary);
            color: #000;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 900;
        }

        .btn-hype:hover {
            background: var(--theme-primary);
            color: #fff;
            box-shadow: 0 0 25px var(--theme-primary), 0 0 50px color-mix(in srgb, var(--theme-primary) 50%, transparent);
        }
        
        /* Ê¨°Ë¶ÅÊåâÈíÆ - ÊöóËâ≤‰∏ªÈ¢òËâ≤ */
        .btn-secondary {
            background: color-mix(in srgb, var(--theme-primary) 70%, #000);
            color: #fff;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 900;
        }
        
        .btn-secondary:hover {
            background: var(--theme-primary);
            box-shadow: 0 0 15px color-mix(in srgb, var(--theme-primary) 50%, transparent);
        }
        
        .btn-secondary:active {
            transform: translateY(2px);
            filter: brightness(0.9);
        }
        
        /* ========== Á¨¨‰∏âÈò∂ÊÆµÔºöÁâ©ÁêÜÁÇπÂáªÂèçÈ¶à ========== */
        .btn-hype:active {
            transform: translateY(3px);
            box-shadow: none;
            filter: brightness(0.85);
        }

        /* ========== Êé®ËçêÁêÜÁî±ÊèêÁ§∫Ê°Ü ========== */
        .recommend-card {
            position: relative;
        }
        
        .recommend-tooltip {
            position: absolute;
            top: 50%;
            left: -10px;
            transform: translate(-100%, -50%);
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.95) 0%, rgba(59, 130, 246, 0.95) 100%);
            color: #000;
            font-size: 11px;
            font-weight: 700;
            line-height: 1.6;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s, transform 0.25s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        .recommend-tooltip::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -6px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 0 6px 6px;
            border-color: transparent transparent transparent rgba(59, 130, 246, 0.95);
        }
        
        .recommend-card:hover .recommend-tooltip {
            opacity: 1;
            transform: translate(-100%, -50%) translateX(-8px);
        }
        
        /* ÁßªÂä®Á´Ø‰ºòÂåñÔºöÊèêÁ§∫Ê°ÜÊòæÁ§∫Âú®‰∏äÊñπ */
        @media (max-width: 1024px) {
            .recommend-tooltip {
                top: -10px;
                left: 50%;
                transform: translate(-50%, -100%);
            }
            
            .recommend-tooltip::after {
                top: 100%;
                right: auto;
                left: 50%;
                transform: translateX(-50%);
                border-width: 6px 6px 0 6px;
                border-color: rgba(59, 130, 246, 0.95) transparent transparent transparent;
            }
            
            .recommend-card:hover .recommend-tooltip {
                transform: translate(-50%, -100%) translateY(-8px);
            }
        }
        
        /* ========== Á¨¨‰∫îÈò∂ÊÆµÔºöÊî∂ËóèÂç∞Á´†Ê†áÁ≠æ ========== */
        .favorite-stamp {
            position: absolute;
            top: -4px;
            left: -4px;
            background: #f59e0b;
            color: #000;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 10px;
            transform: rotate(-8deg);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            z-index: 5;
            pointer-events: none;
        }

        /* Tab Áü©ÂΩ¢ÂºÄÂÖ≥ÊåâÈíÆÁªÑ */
        .tab-btn {
            font-family: "Arial Black", "Helvetica Neue", Impact, sans-serif;
            font-style: italic;
            font-size: 0.9rem;
            color: #555;
            background: transparent;
            border: none;
            padding: 0.55rem 1rem;
            transition: color 0.25s, transform 0.15s;
            position: relative;
        }
        
        /* ‰∏ãÂàíÁ∫øÂ±ïÂºÄÊïàÊûú */
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 6px;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--theme-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-50%);
        }
        
        .tab-btn:hover:not(.active)::after {
            width: 70%;
        }
        
        /* ËßÑÂàôÁ±ªÂûã Tab ÊåâÈíÆ */
        .rule-tab-btn {
            color: #71717a;
            border-bottom: 2px solid transparent;
            transition: all 0.25s;
        }
        
        .rule-tab-btn:hover {
            color: #a1a1aa;
        }
        
        .rule-tab-btn.active {
            color: var(--theme-secondary);
            border-bottom-color: var(--theme-secondary);
        }
        
        /* ÊâìÊäïÊã© Tab ÊåâÈíÆ */
        .mixup-tab-btn {
            color: #71717a;
            border-bottom: 2px solid transparent;
            transition: all 0.25s;
            background: transparent;
        }
        
        .mixup-tab-btn:hover {
            color: #a1a1aa;
        }
        
        .mixup-tab-btn.active {
            color: var(--theme-primary);
            border-bottom-color: var(--theme-primary);
        }
        
        /* ÊâìÊäïÊã©ÊñπÊ°àÁÆ≠Â§¥ÊóãËΩ¨ */
        #mixupDetails[open] .mixup-arrow {
            transform: rotate(90deg);
        }
        
        /* ÊúüÊúõÂêéÁª≠ÁÆ≠Â§¥ÊóãËΩ¨ */
        #expectDetails[open] .expect-arrow {
            transform: rotate(90deg);
        }
        
        /* ÈÄöÁî®ÊäòÂè†ÁÆ≠Â§¥ÊóãËΩ¨ */
        details[open] .collapse-arrow {
            transform: rotate(90deg);
        }
        
        .tab-btn:hover:not(.active) {
            color: #aaa;
        }
        
        .tab-btn:active {
            transform: scale(0.96);
        }

        .tab-btn.active { 
            color: #000;
            font-weight: 900;
        }
        
        .tab-btn.active::after {
            width: 0;
        }

        /* JSON ÊèêÁ§∫Âå∫ */
        .json-hint {
            background: color-mix(in srgb, var(--theme-secondary) 5%, transparent);
            border: 1px dashed var(--theme-secondary);
            padding: 8px;
            font-size: 11px;
            color: var(--theme-secondary);
        }

        /* ËßíËâ≤ÈÄâÊã©ÊåâÈíÆ - Opium/Trap Ëè±ÂΩ¢È£éÊ†º */
        .champion-btn {
            font-family: "Arial Black", "Helvetica Neue", Impact, sans-serif;
            font-weight: 900;
            font-size: 1.5rem;
            letter-spacing: 0.1em;
            color: #fff;
            transition: all 0.3s;
            background: color-mix(in srgb, var(--theme-primary) 20%, #000);
            border: 2px solid var(--theme-primary);
            padding: 0.5rem 1.4rem;
            position: relative;
            cursor: pointer;
            /* Ëè±ÂΩ¢ÊñúÂàá */
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
            margin-right: auto;
        }
        
        /* ÂÜÖÂèëÂÖâËæπÊ°ÜÊïàÊûú */
        .champion-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(0,0,0,0.2) 100%);
            pointer-events: none;
        }
        
        .champion-btn:hover {
            background: color-mix(in srgb, var(--theme-primary) 40%, #000);
            border-color: var(--theme-primary);
            box-shadow: 
                0 0 20px color-mix(in srgb, var(--theme-primary) 50%, transparent),
                inset 0 0 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);
            color: #fff;
            text-shadow: 0 0 10px var(--theme-primary);
        }
        
        .champion-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        
        .champion-btn .char-icon {
            font-size: 1.6rem;
            transition: transform 0.3s;
        }
        
        .champion-btn .char-text {
            font-family: "Arial Black", Impact, "Noto Sans SC", "Microsoft YaHei", sans-serif;
            font-weight: 900;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
        }
        
        .champion-btn:hover .char-icon {
            transform: scale(1.15);
        }
        
        /* ËßíËâ≤ÊåâÈíÆÂàáÊç¢Âä®Áîª */
        @keyframes char-btn-pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(var(--theme-primary-rgb, 255, 0, 122), 0);
            }
            15% {
                transform: scale(1.05) translateX(-2px);
                box-shadow: 
                    0 0 20px var(--theme-primary),
                    inset 0 0 10px color-mix(in srgb, var(--theme-primary) 30%, transparent);
            }
            30% {
                transform: scale(1.02) translateX(2px);
            }
            45% {
                transform: scale(1.04) translateX(-1px);
                box-shadow: 
                    0 0 30px var(--theme-primary),
                    0 0 60px color-mix(in srgb, var(--theme-primary) 50%, transparent),
                    inset 0 0 15px color-mix(in srgb, var(--theme-primary) 40%, transparent);
            }
            60% {
                transform: scale(1.01) translateX(1px);
            }
            75% {
                transform: scale(1.03);
                box-shadow: 
                    0 0 15px var(--theme-primary),
                    inset 0 0 8px color-mix(in srgb, var(--theme-primary) 20%, transparent);
            }
            100% {
                transform: scale(1);
                box-shadow: none;
            }
        }
        
        .champion-btn.char-switch-active {
            animation: char-btn-pulse 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            border-color: var(--theme-secondary) !important;
        }
        
        .champion-btn.char-switch-active .char-icon {
            animation: char-icon-bounce 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        @keyframes char-icon-bounce {
            0%, 100% { transform: scale(1) rotate(0deg); }
            20% { transform: scale(1.3) rotate(-10deg); }
            40% { transform: scale(1.1) rotate(5deg); }
            60% { transform: scale(1.2) rotate(-5deg); }
            80% { transform: scale(1.05) rotate(2deg); }
        }

        /* ËßíËâ≤ÈÄâÊã©ÁΩëÊ†º - ÂìçÂ∫îÂºè */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            padding-bottom: 8px; /* ‰∏∫hoverÊîæÂ§ßÊïàÊûúÈ¢ÑÁïôÁ©∫Èó¥ÔºåÈÅøÂÖçÂá∫Áé∞ÊªöÂä®Êù° */
        }
        
        /* Ë∂ÖÂ∞èÂ±èÂπï‰ºòÂåñÔºö3ÂàóÊõ¥ÊòìÁÇπÂáª */
        @media (max-width: 359px) {
            .char-grid { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 6px;
            }
        }
        
        @media (min-width: 640px) {
            .char-grid { 
                grid-template-columns: repeat(5, 1fr); 
                gap: 8px;
            }
        }
        
        @media (min-width: 768px) {
            .char-grid { 
                grid-template-columns: repeat(6, 1fr); 
                gap: 10px;
            }
        }

        .char-item {
            aspect-ratio: 1.1;
            background: #1a1a2e;
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
        }
        
        .char-item:hover {
            border-color: var(--theme-secondary);
            transform: scale(1.05);
        }
        
        .char-item.selected {
            border-color: var(--theme-primary);
            background: var(--theme-card-bg);
            box-shadow: 0 0 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);
        }
        
        .char-item.no-data { 
            opacity: 0.3; 
            cursor: not-allowed;
            filter: grayscale(0.8);
        }
        .char-item.no-data:hover { 
            opacity: 0.35; 
            transform: none;
            border-color: #333;
        }
        
        .char-name {
            font-family: "Arial Black", "Helvetica Neue", Impact, sans-serif;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            margin-top: 2px;
            line-height: 1.1;
            text-align: center;
        }
        
        .char-icon { font-size: 20px; }
        
        /* ËæÉÂ§ßÂ±èÂπïÊÅ¢Â§çÂ∞∫ÂØ∏ */
        @media (min-width: 480px) {
            .char-item {
                aspect-ratio: 1.2;
                padding: 6px;
            }
            .char-name {
                font-size: 11px;
                margin-top: 4px;
            }
            .char-icon { font-size: 24px; }
        }
        
        /* ========== ÁßªÂä®Á´Ø‰ºòÂåñ ========== */
        /* Ëß¶Êë∏ËÆæÂ§á‰∏äÁßªÈô§ hover ÂèòÊç¢ÊïàÊûúÔºåÈÅøÂÖç sticky hover */
        @media (hover: none) {
            .char-item:hover { transform: none; }
            .trend-card:hover { 
                border-color: color-mix(in srgb, var(--theme-primary) 40%, #333); 
                background: color-mix(in srgb, var(--theme-primary) 10%, #0a0a0c);
                box-shadow: none;
                transform: none;
            }
        }
        
        /* ÁßªÂä®Á´ØÂßãÁªàÊòæÁ§∫Êìç‰ΩúÊåâÈíÆÔºà‰∏ç‰æùËµñ hoverÔºâ */
        @media (hover: none), (max-width: 640px) {
            .group .group-hover\:opacity-100 {
                opacity: 1 !important;
            }
            .sm\:opacity-0 {
                opacity: 0.7 !important;
            }
            .sm\:group-hover\/ctx\:opacity-100 {
                opacity: 1 !important;
            }
            /* ÊâìÊäïÊã©Âç°ÁâáÊìç‰ΩúÊåâÈíÆ - Â¢ûÂ§ßÁÇπÂáªÂå∫Âüü */
            .group button[onclick*="copyPlanInfo"],
            .group button[onclick*="openMixupEditModal"],
            .group button[onclick*="toggleMixupFavorite"] {
                min-width: 36px;
                min-height: 36px;
                padding: 8px;
                font-size: 14px;
            }
        }
        
        /* Èò≤Ê≠¢ iOS ËæìÂÖ•Ê°ÜÁº©Êîæ */
        input, textarea, select {
            font-size: 16px;
        }
        @media (min-width: 640px) {
            input, textarea, select {
                font-size: inherit;
            }
        }
        
        /* ‰ºòÂåñÊªöÂä®ÊÄßËÉΩ */
        .overflow-x-auto, .overflow-y-auto {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Èò≤Ê≠¢ÈïøÊåâÂºπÂá∫ËèúÂçï */
        button, a {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* ========== ÂèØËÆøÈóÆÊÄß‰ºòÂåñ ========== */
        /* Áªü‰∏ÄÁÑ¶ÁÇπÊ†∑Âºè */
        button:focus-visible, 
        input:focus-visible, 
        textarea:focus-visible,
        select:focus-visible,
        a:focus-visible,
        details summary:focus-visible {
            outline: 2px solid var(--theme-secondary);
            outline-offset: 2px;
        }
        
        /* ÂáèÂ∞ëÂä®ÁîªÔºàÁî®Êà∑ÂÅèÂ•ΩÔºâ */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* È´òÂØπÊØîÂ∫¶Ê®°ÂºèÊîØÊåÅ */
        @media (prefers-contrast: high) {
            .trend-card {
                border-width: 3px;
            }
            button {
                border: 2px solid currentColor;
            }
        }
        
        /* ÊåâÈíÆÁÇπÂáªÂèçÈ¶à */
        button:active:not(:disabled) {
            transform: scale(0.97);
        }
        
        /* ‰∏ªÈ¢òËâ≤ Modal ÊåâÈíÆ */
        .modal-btn-primary {
            background-color: var(--theme-btn-primary);
        }
        .modal-btn-primary:hover {
            background-color: var(--theme-btn-primary-hover);
        }
        .modal-btn-active {
            background-color: var(--theme-btn-primary);
        }
        
        /* ÊéíÂ∫èÊåâÈíÆÊ†∑Âºè */
        .sort-btn {
            background: #18181b;
            border-color: color-mix(in srgb, var(--theme-secondary) 60%, #333);
            color: var(--theme-secondary);
        }
        .sort-btn:hover {
            background: color-mix(in srgb, var(--theme-primary) 20%, #18181b);
            border-color: var(--theme-primary);
            color: var(--theme-primary);
        }
        
        /* Context Ê†áÁ≠æÊ†∑Âºè */
        .context-tag {
            color: var(--theme-primary);
            background: color-mix(in srgb, var(--theme-secondary) 15%, transparent);
            border-color: var(--theme-secondary);
        }
        
        /* È¢ÑËÆæÂú∫ÊôØÊ†áÁ≠æÊ†∑Âºè - ÊèêÈ´òÂèØËßÅÂ∫¶ */
        .context-tag-preset {
            color: #d0d0d0;
            background: color-mix(in srgb, var(--theme-secondary) 12%, transparent);
            border-color: #606070;
        }
        
        /* Â±ïÂºÄÁä∂ÊÄÅÁöÑÂú∫ÊôØÊ†áÁ≠æ */
        .expanded-context-tag {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        @media (max-width: 640px) {
            .expanded-context-tag {
                max-width: 150px;
            }
        }
        
        /* ÊäòÂè†Áä∂ÊÄÅÁöÑÂú∫ÊôØÊ†áÁ≠æ - È´òÂèØËßÅÂ∫¶ */
        .compact-context-tag {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            background: color-mix(in srgb, var(--theme-primary) 25%, transparent);
            border: 1px solid color-mix(in srgb, var(--theme-primary) 50%, transparent);
            color: var(--theme-secondary);
            text-transform: uppercase;
            letter-spacing: 0.02em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* ÁßªÂä®Á´ØÂú∫ÊôØÊ†áÁ≠æ‰ºòÂåñ */
        @media (max-width: 480px) {
            .compact-context-tag {
                font-size: 10px;
                padding: 2px 6px;
                max-width: 80px;
            }
        }
        
        /* ÊäòÂè†Áä∂ÊÄÅÊñπÊ°àÊèèËø∞ - ÁßªÂä®Á´ØÊà™Êñ≠ */
        .compact-plan-desc {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        @media (max-width: 640px) {
            .compact-plan-desc {
                max-width: 150px;
            }
        }
        
        @media (max-width: 400px) {
            .compact-plan-desc {
                max-width: 100px;
            }
        }
        
        /* ÂÆâÂÖ®Ë∑≥Ê†áÁ≠æ - ÊñúÂàáËè±ÂΩ¢È£éÊ†º */
        .safe-jump-badge {
            display: inline-block;
        }
        .safe-jump-badge-inner {
            display: inline-block;
            font-size: 11px;
            font-weight: 900;
            padding: 4px 12px 4px 10px;
            letter-spacing: 0.5px;
            position: relative;
            clip-path: polygon(8px 0, 100% 0, calc(100% - 8px) 100%, 0 100%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .safe-jump-true {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #16a34a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        }
        .safe-jump-pseudo {
            background: linear-gradient(135deg, #ca8a04 0%, #eab308 50%, #ca8a04 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(234, 179, 8, 0.4);
        }
        .safe-jump-badge-inner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 50%);
            clip-path: inherit;
            pointer-events: none;
        }
        
        /* Â∏ßÊï∞ËæìÂÖ•ÁªÑ‰ª∂ */
        .adv-input-group {
            display: flex;
            border: 1px solid var(--theme-card-border);
        }
        .adv-input-group .adv-btn {
            width: 56px;
            background: #27272a;
            color: #a1a1aa;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.15s;
            user-select: none;
            border: none;
        }
        .adv-input-group .adv-btn:hover {
            background: #3f3f46;
            color: white;
        }
        .adv-input-group .adv-btn:first-child {
            border-right: 1px solid var(--theme-card-border);
        }
        .adv-input-group .adv-btn:last-child {
            border-left: 1px solid var(--theme-card-border);
        }
        .adv-input-group .adv-input {
            flex: 1;
            min-width: 0;
            background: black;
            padding: 1rem;
            font-size: 2.25rem;
            font-weight: 900;
            text-align: center;
            color: var(--theme-input-accent);
            border: none;
            outline: none;
        }
        .adv-input-group .adv-input::placeholder {
            color: #52525b;
        }
        
        /* Ê®°Á≥äÂ∏ßÊï∞ÊªëÂä®ÂºÄÂÖ≥ */
        .fuzzy-switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        .fuzzy-switch-label {
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            transition: all 0.2s;
        }
        .fuzzy-switch-label-inactive {
            color: #52525b;
        }
        .fuzzy-switch {
            width: 36px;
            height: 20px;
            background: #27272a;
            border: 1px solid var(--theme-card-border);
            border-radius: 10px;
            position: relative;
            transition: all 0.3s ease;
        }
        .fuzzy-switch-thumb {
            width: 14px;
            height: 14px;
            background: var(--theme-secondary, #ff1493);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .fuzzy-switch.active {
            background: var(--theme-fuzzy, #f59e0b);
            border-color: var(--theme-fuzzy, #f59e0b);
        }
        .fuzzy-switch.active .fuzzy-switch-thumb {
            left: 18px;
            background: white;
        }
        
        /* Ê®°Á≥äÂ∏ßÊï∞ËåÉÂõ¥ËæìÂÖ• */
        .fuzzy-input-group {
            display: flex;
            align-items: center;
            border: 1px solid var(--theme-card-border);
            background: black;
        }
        .fuzzy-input-group .fuzzy-input {
            flex: 1;
            min-width: 0;
            background: transparent;
            padding: 1rem;
            font-size: 2rem;
            font-weight: 900;
            text-align: center;
            color: var(--theme-input-accent);
            border: none;
            outline: none;
        }
        .fuzzy-input-group .fuzzy-input::placeholder {
            color: #52525b;
        }
        .fuzzy-input-group .fuzzy-separator {
            color: #71717a;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0 0.5rem;
        }
        
        /* Ê®°Á≥äÂ∏ßÊï∞È¢ÑËßàÁªìÊûú */
        .fuzzy-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--theme-card-border);
        }
        .fuzzy-preview-title {
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            color: #71717a;
            margin-bottom: 0.75rem;
        }
        .fuzzy-preview-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #18181b;
            border-left: 3px solid var(--theme-btn-primary);
        }
        .fuzzy-preview-item:last-child {
            margin-bottom: 0;
        }
        .fuzzy-preview-label {
            font-size: 0.625rem;
            font-weight: bold;
            text-transform: uppercase;
            color: #71717a;
            margin-bottom: 0.25rem;
        }
        .fuzzy-preview-plan {
            font-weight: bold;
            color: white;
        }
        .fuzzy-preview-avg {
            font-size: 0.75rem;
            color: #a1a1aa;
            margin-top: 0.25rem;
        }
        .fuzzy-preview-detail {
            font-size: 0.625rem;
            color: #71717a;
            margin-top: 0.25rem;
        }
        
        /* Ê®°Á≥äÂú∫ÊôØÂç°Áâá */
        .fuzzy-scenario-card {
            border-left: 3px solid var(--theme-fuzzy, #f59e0b);
        }
        .fuzzy-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            font-size: 0.625rem;
            font-weight: bold;
        }
        .fuzzy-plan-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--theme-card-border);
            padding: 0.75rem 1rem;
        }
        .fuzzy-plan-label {
            font-size: 0.625rem;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--theme-fuzzy, #f59e0b);
            margin-bottom: 0.25rem;
        }
        .fuzzy-plan-desc {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        .fuzzy-plan-stats {
            font-size: 0.75rem;
            color: #a1a1aa;
            display: flex;
            gap: 1rem;
        }
        .fuzzy-plan-detail {
            font-size: 0.625rem;
            color: #71717a;
            margin-top: 0.25rem;
        }
        
        /* iPhone ÂÆâÂÖ®Âå∫ÂüüÈÄÇÈÖç */
        body {
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Modal Â∫ïÈÉ®ÂÆâÂÖ®Âå∫Âüü */
        .fixed.inset-0 > div {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* È°µÈù¢Âä†ËΩΩËøáÊ∏°ÔºåÈò≤Ê≠¢ FOUC */
        html:not(.loaded) body {
            opacity: 0;
        }
        html.loaded body {
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }
        
        /* ========== Ê†áÈ¢òËøõÂÖ•Âä®Áîª ========== */
        @keyframes title-glitch-in {
            0% {
                opacity: 0;
                transform: translateX(-20px) skewX(-10deg);
                filter: blur(10px);
                clip-path: inset(0 100% 0 0);
            }
            30% {
                opacity: 1;
                transform: translateX(5px) skewX(5deg);
                filter: blur(0);
                clip-path: inset(0 0 0 0);
            }
            50% {
                transform: translateX(-3px) skewX(-2deg);
                text-shadow: 3px 0 var(--theme-primary), -3px 0 var(--theme-secondary);
            }
            70% {
                transform: translateX(2px) skewX(1deg);
                text-shadow: -2px 0 var(--theme-primary), 2px 0 var(--theme-secondary);
            }
            100% {
                transform: translateX(0) skewX(0);
                text-shadow: none;
            }
        }
        
        html.loaded .title-animate {
            animation: title-glitch-in 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        html:not(.loaded) .title-animate {
            opacity: 0;
        }
        
        /* ========== Tab Áü©ÂΩ¢ÂºÄÂÖ≥ÂÆπÂô® ========== */
        .tab-container {
            position: relative;
            display: flex;
            gap: 0;
            background: #111;
            padding: 4px;
            border: 2px solid #333;
        }
        
        /* ÊªëÂä®È´ò‰∫ÆÊåáÁ§∫Âô® - Áü©ÂΩ¢ */
        .tab-indicator {
            position: absolute;
            top: 4px;
            bottom: 4px;
            background: var(--theme-primary);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
            box-shadow: 
                0 0 20px color-mix(in srgb, var(--theme-primary) 60%, transparent),
                0 0 40px color-mix(in srgb, var(--theme-primary) 30%, transparent);
        }
        
        .tab-btn {
            position: relative;
            z-index: 1;
        }
        
        .tab-btn.active {
            z-index: 2;
        }
        
        /* ========== Â∞ÅÊù°ËÉ∂Â∏¶ÊªöÂä®ÊïàÊûú (Marquee Tape) ========== */
        /* ÂçïÊù°Â∞ÅÊù° - È°µÈù¢È°∂ÈÉ®ÔºåÈöèÈ°µÈù¢ÊªöÂä® */
        .marquee-tape {
            position: relative;
            width: 100vw;
            left: 50%;
            transform: translateX(-50%);
            margin-top: -1rem;
            margin-bottom: 1.5rem;
            height: 52px;
            background: 
                linear-gradient(90deg, 
                    transparent 0%, 
                    rgba(255,255,255,0.05) 25%, 
                    transparent 50%,
                    rgba(0,0,0,0.05) 75%,
                    transparent 100%
                ),
                var(--theme-primary);
            overflow: hidden;
            z-index: 10;
            box-shadow: 
                0 4px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: pointer;
            border-bottom: 2px solid rgba(0,0,0,0.3);
        }
        
        .marquee-tape:hover {
            filter: brightness(1.1);
        }
        
        @media (min-width: 768px) {
            .marquee-tape {
                margin-top: -2.5rem;
            }
        }
        
        .marquee-track {
            display: flex;
            animation: marquee-scroll 80s linear infinite;
            white-space: nowrap;
            width: fit-content;
        }
        
        .marquee-content {
            display: flex;
            align-items: center;
            height: 52px;
            flex-shrink: 0;
        }
        
        .marquee-content span {
            font-family: "Arial Black", Impact, sans-serif;
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #000;
            padding: 0 20px;
        }
        
        .marquee-content span::after {
            content: "‚ú¶";
            margin-left: 20px;
            opacity: 0.5;
            font-size: 20px;
        }
        
        @keyframes marquee-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        /* Á¨¨‰∫åÊù°ËÉ∂Â∏¶ - ÈöêËóè */
        .marquee-tape-2 {
            display: none;
        }
        
        /* È°µÈù¢ÂÜÖÂÆπÊ≠£Â∏∏Â∏ÉÂ±Ä */
        .main-content {
            padding-top: 20px;
        }
        
        .marquee-track-reverse {
            display: flex;
            animation: marquee-scroll-reverse 35s linear infinite;
            white-space: nowrap;
        }
        
        .marquee-content-2 {
            display: flex;
            align-items: center;
            height: 44px;
        }
        
        .marquee-content-2 span {
            font-family: "Arial Black", Impact, sans-serif;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #000;
            padding: 0 50px;
        }
        
        .marquee-content-2 span::after {
            content: "‚ú¶";
            margin-left: 50px;
            opacity: 0.3;
        }
        
        @keyframes marquee-scroll-reverse {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(0); }
        }
        
        /* ========== Èò∂ÊÆµFÔºöËÉåÊôØÊ∞õÂõ¥Â±Ç ========== */
        .ambient-layer {
            position: fixed;
            inset: 0;
            z-index: -8;
            pointer-events: none;
            opacity: 0.4;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 80%, var(--theme-primary), transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 20%, var(--theme-secondary), transparent 50%);
            animation: ambient-drift 20s ease-in-out infinite alternate;
            filter: blur(80px);
        }
        
        @keyframes ambient-drift {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translate(-5%, 3%) scale(1.1);
                opacity: 0.5;
            }
            100% {
                transform: translate(5%, -3%) scale(1);
                opacity: 0.35;
            }
        }
        
        /* ========== Èò∂ÊÆµGÔºöÈ°µÈù¢ËøáÊ∏°Âä®Áîª ========== */
        /* Âç°ÁâáÂÖ•Âú∫Âä®Áîª */
        .card-enter {
            opacity: 0;
            transform: translateY(20px);
            animation: card-fade-in 0.4s ease forwards;
        }
        
        @keyframes card-fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Tab ÂÜÖÂÆπÂàáÊç¢Âä®Áîª */
        .view-transition {
            animation: view-fade-in 0.3s ease;
        }
        
        @keyframes view-fade-in {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* ========== È°∂ÈÉ®Âõ∫ÂÆöÂØºËà™Ê†è ========== */
        .sf6-top-nav {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 200;
            padding: 5px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sf6-nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--theme-primary);
            color: var(--theme-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            backdrop-filter: blur(8px);
            clip-path: polygon(6px 0, 100% 0, calc(100% - 6px) 100%, 0 100%);
        }
        
        .sf6-nav-btn:hover {
            background: var(--theme-primary);
            color: #000;
            box-shadow: 0 0 20px var(--theme-primary), 0 0 40px color-mix(in srgb, var(--theme-primary) 50%, transparent);
        }
        
        .sf6-nav-btn svg {
            width: 22px;
            height: 22px;
        }
        
        /* ========== ÂÖ®Â±èËèúÂçï ========== */
        .sf6-fullscreen-menu {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.97);
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.2rem;
        }
        
        .sf6-fullscreen-menu.active {
            display: flex;
        }
        
        .sf6-menu-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: transparent;
            border: 2px solid var(--theme-primary);
            color: var(--theme-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            clip-path: polygon(6px 0, 100% 0, calc(100% - 6px) 100%, 0 100%);
        }
        
        .sf6-menu-close-btn:hover {
            background: var(--theme-primary);
            color: #000;
            box-shadow: 0 0 20px var(--theme-primary);
        }
        
        .sf6-menu-close-btn svg {
            width: 26px;
            height: 26px;
        }
        
        .sf6-menu-link {
            font-family: 'Syne', sans-serif;
            font-size: clamp(1.6rem, 5vw, 3rem);
            font-weight: 900;
            font-style: italic;
            letter-spacing: -0.02em;
            color: #fff;
            text-decoration: none;
            text-transform: uppercase;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .sf6-menu-link:hover {
            color: var(--theme-primary);
            text-shadow: 
                0 0 20px var(--theme-primary),
                0 0 40px color-mix(in srgb, var(--theme-primary) 50%, transparent);
        }
        
        .sf6-menu-link.current {
            color: var(--theme-secondary);
            text-shadow: 0 0 15px var(--theme-secondary);
        }
        
        /* ËèúÂçïÈ°πË£ÖÈ•∞Á∫ø */
        .sf6-menu-link::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            width: 0;
            height: 3px;
            background: var(--theme-primary);
            transform: translateY(-50%);
            transition: width 0.3s ease;
        }
        
        .sf6-menu-link:hover::before {
            width: 15px;
        }
        
        /* ÁßªÂä®Á´Ø‰ºòÂåñ */
        @media (max-width: 768px) {
            .sf6-top-nav {
                padding: 7px 12px;
            }
            .sf6-nav-btn {
                width: 38px;
                height: 38px;
            }
            .sf6-nav-btn svg {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-10">
    <!-- È°∂ÈÉ®Âõ∫ÂÆöÂØºËà™Ê†è -->
    <nav class="sf6-top-nav">
        <a href="../" class="sf6-nav-btn" title="ËøîÂõû‰∏ªÈ°µ">
            <i data-lucide="home"></i>
        </a>
        <button class="sf6-nav-btn" id="sf6MenuBtn" title="ËèúÂçï">
            <i data-lucide="menu"></i>
        </button>
    </nav>
    
    <!-- ÂÖ®Â±èËèúÂçï -->
    <div class="sf6-fullscreen-menu" id="sf6FullscreenMenu">
        <button class="sf6-menu-close-btn" id="sf6CloseMenu">
            <i data-lucide="x"></i>
        </button>
        <a href="../" class="sf6-menu-link">HOME</a>
        <a href="./" class="sf6-menu-link current">SF6 FRAME LAB</a>
        <a href="../gojuon/" class="sf6-menu-link">GOJUON</a>
        <a href="../gallery/" class="sf6-menu-link">MY GALLERY</a>
        <a href="javascript:void(0)" onclick="closeSf6Menu(); alert('ÂºÄÂèë‰∏≠')" class="sf6-menu-link">I AM MUSIC</a>
    </div>
    
    <!-- ËÉåÊôØÊ∞õÂõ¥Â±Ç -->
    <div class="ambient-layer"></div>
    
    <!-- ËßíËâ≤ËÉåÊôØÂõæÂ±Ç -->
    <div id="bgOverlay" class="fixed inset-0 -z-10 bg-cover bg-center bg-no-repeat opacity-0 transition-opacity duration-500" style="background-position: center 20%;"></div>
    <div class="fixed inset-0 -z-10 bg-gradient-to-b from-black/90 via-black/80 to-black/70"></div>
    
    <!-- Â∞ÅÊù°ËÉ∂Â∏¶ÊªöÂä®ÊïàÊûú (Fixed ÂÆö‰ΩçÔºåÊ®™ÂêëÊó†Èôê) -->
    <div class="marquee-tape" id="marqueeTape1" onclick="openCharacterModal()" style="cursor: pointer;" title="ÁÇπÂáªÂàáÊç¢ËßíËâ≤">
        <div class="marquee-track">
            <div class="marquee-content" id="marqueeContent1"></div>
            <div class="marquee-content" id="marqueeContent1Clone"></div>
        </div>
    </div>
    <div class="marquee-tape-2">
        <div class="marquee-track-reverse">
            <div class="marquee-content-2" id="marqueeContent2"></div>
            <div class="marquee-content-2" id="marqueeContent2Clone"></div>
        </div>
    </div>
    
    <div class="max-w-6xl mx-auto main-content">
        <!-- HEADER -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-16 border-b-2 border-zinc-800 pb-6">
                <div class="flex flex-col">
                <div class="flex items-center gap-3">
                    <h1 class="impact-text text-5xl sm:text-6xl tracking-tighter title-animate glitch-hover">SF6 FRAME LAB</h1>
                    <button onclick="openHelpModal()" class="group px-3 py-1 ml-1 bg-gradient-to-r from-cyan-600/20 to-pink-600/20 border border-cyan-500/50 hover:border-cyan-400 text-cyan-400 hover:text-cyan-300 text-xs font-bold tracking-wider uppercase transition-all hover:shadow-[0_0_15px_rgba(0,255,255,0.3)] flex items-center gap-1 whitespace-nowrap" title="‰ΩøÁî®ËØ¥Êòé">
                        <span class="text-sm">?</span>
                        <span>ËØ¥Êòé</span>
                    </button>
                </div>
                <span class="text-zinc-500 font-bold text-xs tracking-widest mt-1">made by Yuetian</span>
            </div>
            <nav class="flex items-end gap-6 sm:gap-8 w-full sm:w-auto">
                <button onclick="openCharacterModal()" class="champion-btn uppercase flex items-center gap-2">
                    <span class="char-icon" id="currentCharIcon">ü•ã</span>
                    <span class="char-text">ËßíËâ≤</span>
                </button>
                <div class="flex gap-1 sm:gap-2 tab-container relative ml-auto sm:ml-0" id="tabContainer">
                    <button onclick="switchTab('notes')" id="tab-notes" class="tab-btn active uppercase tracking-widest text-base sm:text-xl pb-2">ÊñπÊ°à</button>
                    <button onclick="switchTab('library')" id="tab-library" class="tab-btn uppercase tracking-widest text-base sm:text-xl pb-2">Êï∞ÊçÆ</button>
                    <div class="tab-indicator" id="tabIndicator"></div>
                </div>
            </nav>
        </header>

        <!-- VIEW: ÊñπÊ°à -->
        <div id="view-notes" class="space-y-6 pt-4">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                <h2 class="impact-text text-4xl sm:text-5xl font-black" style="color: var(--theme-secondary);">Âç°Â∏ßÁ≠ñÁï•</h2>
                <div class="flex gap-2">
                    <button onclick="resetToDefault()" class="px-4 py-3 text-xs bg-zinc-800 text-zinc-500 hover:bg-zinc-700 hover:text-white transition-all font-bold">ÈáçÁΩÆ</button>
                    <button onclick="openNoteModal()" class="btn-hype px-6 sm:px-8 py-3 text-sm font-bold">+ Êñ∞Â¢ûÂú∫ÊôØ</button>
                </div>
            </div>
            
            <!-- Ê®°ÂùóÔºöÊâìÊäïÊã©ÊñπÊ°à -->
            <div class="mb-10">
                <h3 class="text-xl sm:text-2xl font-black text-zinc-300 mb-2 border-l-4 pl-4" style="border-color: var(--theme-primary);">ÊâìÊäïÊã©ÊñπÊ°à</h3>
                <p class="text-xs text-zinc-500 mb-4 pl-4">ÂØªÊâæËÉΩÂç°Âá∫ÁâπÂÆöÊúâÂà©Â∏ßÔºàÊâìÊäïÊã©Êó∂Êú∫ÔºâÁöÑÂú∫ÊôØ ¬∑ ËåÉÂõ¥ 6~50F</p>
                
                <!-- ÊäòÂè†Âå∫Âüü -->
                <details class="trend-card" id="mixupDetails">
                    <summary class="px-5 py-3 cursor-pointer text-zinc-300 hover:text-white text-sm font-bold transition-colors select-none flex items-center gap-2">
                        <span class="text-zinc-500 text-xs mixup-arrow transition-transform duration-200">‚ñ∂</span>
                        Â±ïÂºÄÊü•ÁúãÊâìÊäïÊã©ÊñπÊ°à
                    </summary>
                    <div class="px-5 pb-5 pt-3 border-t" style="border-color: var(--theme-card-border);">
                        <!-- Tab ÂàáÊç¢ -->
                        <div class="flex gap-3 mb-4 border-b-2 pb-1" style="border-color: var(--theme-card-border);">
                            <button onclick="switchMixupTab(5)" id="mixupTab5" class="mixup-tab-btn active px-6 py-3 text-lg font-black transition-colors">5F</button>
                            <button onclick="switchMixupTab(4)" id="mixupTab4" class="mixup-tab-btn px-6 py-3 text-lg font-black transition-colors">4F</button>
                            <button onclick="switchMixupTab(3)" id="mixupTab3" class="mixup-tab-btn px-6 py-3 text-lg font-black transition-colors">3F</button>
                        </div>
                        
                        <!-- ÂÜÖÂÆπÂå∫ -->
                        <div id="throwMixupContent" class="min-h-[80px]"></div>
                    </div>
                </details>
            </div>
            
            <!-- Ê®°ÂùóÔºöÂéãÂà∂ÊñπÊ°à -->
            <div>
                <h3 class="text-xl sm:text-2xl font-black text-zinc-300 mb-4 border-l-4 pl-4" style="border-color: var(--theme-primary);">ÂéãÂà∂ÊñπÊ°à</h3>
            </div>
            
            <!-- ÊêúÁ¥¢Ê°ÜÂíåÂ∑•ÂÖ∑Ê†è - ÂßãÁªàÂêåË°å -->
            <div class="mb-6 flex flex-row gap-2 items-center">
                <div class="flex-1 relative min-w-0">
                    <input type="text" id="solutionSearch" 
                        class="w-full bg-black border border-zinc-700 px-3 py-2 pr-8 text-sm text-white placeholder-zinc-600 focus:border-cyan-500 focus:outline-none transition-colors"
                        placeholder="ÊêúÁ¥¢Â∏ßÊï∞ÊàñÊÉÖÂ¢É..."
                        aria-label="ÊêúÁ¥¢Âú∫ÊôØ"
                        oninput="debounce(filterSolutions)(); updateClearBtn()">
                    <button id="clearSearchBtn" onclick="clearSearch()" 
                        class="absolute right-1.5 top-1/2 -translate-y-1/2 text-zinc-600 hover:text-white text-lg p-0.5 hidden transition-colors"
                        title="Ê∏ÖÈô§ÊêúÁ¥¢">√ó</button>
                </div>
                <!-- Â∑•ÂÖ∑Ê†èÊåâÈíÆÁªÑ -->
                <div class="flex gap-1.5 flex-shrink-0">
                    <button onclick="toggleSortOrder()" id="sortOrderBtn" 
                        class="sort-btn px-2.5 py-2 border transition-all flex items-center gap-1 text-xs font-bold"
                        title="ÂàáÊç¢ÊéíÂ∫èÊñπÂêë">
                        <span id="sortOrderIcon">‚Üë</span>
                        <span id="sortOrderText" class="hidden sm:inline">Â∏ßÊï∞</span>
                    </button>
                    <button onclick="toggleAllDetails()" id="toggleAllDetailsBtn" 
                        class="sort-btn px-2.5 py-2 border transition-all flex items-center gap-1 text-xs font-bold"
                        title="Â±ïÂºÄ/Êî∂Ëµ∑ÊâÄÊúâËØ¶ÊÉÖ">
                        <span id="toggleAllIcon" class="text-[10px] opacity-80">‚ñº</span>
                        <span id="toggleAllText" class="hidden sm:inline">Â±ïÂºÄ</span>
                    </button>
                    <button onclick="toggleShowOnlyFavorites()" id="showFavoritesBtn" 
                        class="sort-btn px-2.5 py-2 border transition-all flex items-center gap-1 text-xs font-bold"
                        title="Âè™ÊòæÁ§∫Êî∂ËóèÊñπÊ°à">
                        <span id="showFavoritesIcon">‚òÜ</span>
                        <span id="showFavoritesText" class="hidden sm:inline">Êî∂Ëóè</span>
                    </button>
                </div>
            </div>
            <div id="noteListContainer" class="grid grid-cols-1 gap-6"></div>
        </div>

        <!-- VIEW: Êï∞ÊçÆ -->
        <div id="view-library" class="hidden space-y-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 pt-4">
                <h2 class="impact-text text-4xl sm:text-5xl font-black" style="color: var(--theme-secondary);">ËßíËâ≤Êï∞ÊçÆ</h2>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 bg-zinc-900 p-6 border border-zinc-800">
                    <!-- Êñ∞Â¢ûÊãõÂºèÊåâÈíÆ -->
                    <button onclick="openAddMoveModal()" class="btn-secondary w-full py-2 mb-4 text-sm font-bold">
                        + Êñ∞Â¢ûÊãõÂºè
                    </button>
                    
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="impact-text text-2xl font-black" style="color: var(--theme-primary);">ÊâπÈáèÂØºÂÖ•</h3>
                        <button onclick="loadTemplate()" class="text-xs text-zinc-500 hover:text-cyan-400 underline transition-colors">
                            JSON Ê†ºÂºè
                        </button>
                    </div>

                    <textarea id="rawPaste" class="w-full h-40 bg-black border border-zinc-700 p-4 text-xs font-mono text-cyan-500 resize-none" placeholder='Á≤òË¥¥ JSON Êï∞ÊçÆ...'></textarea>
                    <button onclick="importJson()" class="btn-secondary w-full mt-4 py-2 text-sm font-bold">ÊâπÈáèÂØºÂÖ•</button>
                    <button onclick="resetMovesToDefault()" class="w-full mt-2 py-2 bg-zinc-800 text-zinc-500 text-xs font-bold hover:bg-blue-900 hover:text-white transition-all">ÈáçÁΩÆÈ¢ÑËÆæ</button>
                </div>
                <div class="lg:col-span-8 overflow-x-auto relative bg-black/60 p-4 border border-zinc-800/50">
                    <!-- ÁßªÂä®Á´ØÊªöÂä®ÊèêÁ§∫ -->
                    <div class="lg:hidden text-[10px] text-zinc-600 text-right mb-1 italic">‚Üê Â∑¶Âè≥ÊªëÂä®Êü•Áúã ‚Üí</div>
                    <table class="w-full text-left min-w-[500px]">
                        <thead class="text-zinc-600 text-[10px] font-black uppercase tracking-widest border-b border-zinc-800">
                            <tr>
                                <th class="p-4">Name</th>
                                <th class="p-4 text-center">Start</th>
                                <th class="p-4 text-center">Active</th>
                                <th class="p-4 text-center">Recov</th>
                                <th class="p-4 text-center">Hit</th>
                                <th class="p-4 text-center">Blk</th>
                                <th class="p-4 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="moveTableBody" class="text-sm font-bold"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ËßÑÂàôÂå∫Âüü -->
            <div class="mt-8 p-4 bg-zinc-900/50 border border-zinc-800/50">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-sm font-bold text-zinc-400 uppercase tracking-widest">ËøáÊª§ËßÑÂàô</h4>
                    <div class="flex gap-2">
                        <button onclick="clearAllRules()" class="text-[10px] px-3 py-1.5 bg-zinc-800 text-zinc-500 hover:text-red-400 hover:bg-zinc-700 transition-all font-bold">Ê∏ÖÈô§ÂÖ®ÈÉ®</button>
                        <button onclick="openRuleModal()" class="text-[10px] px-3 py-1.5 bg-zinc-800 text-zinc-400 hover:text-white hover:bg-zinc-700 transition-all font-bold">+ Ê∑ªÂä†ËßÑÂàô</button>
                    </div>
                </div>
                <p class="text-[10px] text-zinc-600 mb-2">*ÂÖ®Â±ÄËßÑÂàô‰∏çÂèØÂà†Èô§ ¬∑ È¢ÑËÆæÂèäËá™ÂÆö‰πâËßÑÂàôÂèØÂà†Èô§</p>
                <div id="rulesContainer" class="space-y-1 text-xs"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: Add Scenario -->
    <div id="noteModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="noteModalTitle">
        <div class="bg-zinc-900 border w-full max-w-lg p-8 sm:p-10 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-8">
                <h2 id="noteModalTitle" class="impact-text text-4xl sm:text-5xl font-black" style="color: var(--theme-modal-title);">Êñ∞Â¢ûÂú∫ÊôØ</h2>
                <button onclick="closeModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="ÂÖ≥Èó≠">&times;</button>
            </div>
            <div class="space-y-8">
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-black uppercase text-zinc-400">ÂàùÂßãÊúâÂà©Â∏ß</label>
                        <div class="fuzzy-switch-container" onclick="toggleFuzzyMode()" title="ÂàáÊç¢Á≤æÁ°Æ/Ê®°Á≥äÊ®°Âºè">
                            <span class="fuzzy-switch-label" id="fuzzyLabelExact">üéØ Á≤æÁ°Æ</span>
                            <div class="fuzzy-switch" id="fuzzySwitch">
                                <div class="fuzzy-switch-thumb"></div>
                            </div>
                            <span class="fuzzy-switch-label fuzzy-switch-label-inactive" id="fuzzyLabelFuzzy">Ê®°Á≥ä üé≤</span>
                        </div>
                    </div>
                    <!-- Á≤æÁ°ÆÊ®°ÂºèËæìÂÖ• -->
                    <div id="exactInputGroup" class="adv-input-group">
                        <button type="button" onclick="adjustAdv(-1)" class="adv-btn">‚àí</button>
                        <input type="text" id="inputAdv" inputmode="numeric" pattern="[0-9]*" maxlength="2"
                            class="adv-input" placeholder="40" oninput="sanitizeAdvInput(); updateExpectOptions()">
                        <button type="button" onclick="adjustAdv(1)" class="adv-btn">+</button>
                    </div>
                    <!-- Ê®°Á≥äÊ®°ÂºèËæìÂÖ• -->
                    <div id="fuzzyInputGroup" class="fuzzy-input-group hidden">
                        <input type="text" id="inputAdvMin" inputmode="numeric" pattern="[0-9]*" maxlength="2"
                            class="fuzzy-input" placeholder="35" oninput="sanitizeFuzzyInput('inputAdvMin'); calculateFuzzyPreview()">
                        <span class="fuzzy-separator">~</span>
                        <input type="text" id="inputAdvMax" inputmode="numeric" pattern="[0-9]*" maxlength="2"
                            class="fuzzy-input" placeholder="40" oninput="sanitizeFuzzyInput('inputAdvMax'); calculateFuzzyPreview()">
                    </div>
                    <p id="advHint" class="text-xs text-zinc-500 mt-2">ËåÉÂõ¥ 1~99</p>
                </div>
                <div>
                    <label class="block text-sm font-black uppercase mb-3 text-zinc-400">ÊÉÖÂ¢ÉËØ¥Êòé</label>
                    <input type="text" id="inputContext" class="w-full bg-black border p-4 text-base font-bold text-white" style="border-color: var(--theme-card-border);" placeholder="‰æãÂ¶ÇÔºö2HKÊîæÂÄí">
                </div>
                
                <!-- ÊúüÊúõÂêéÁª≠ - ËøõÈò∂ÈÄâÈ°π -->
                <details id="expectDetails" class="border bg-zinc-900/50" style="border-color: var(--theme-card-border);">
                    <summary class="px-5 py-4 cursor-pointer text-zinc-400 hover:text-zinc-200 text-base font-bold transition-colors select-none flex items-center gap-2">
                        <span class="text-zinc-500 text-xs expect-arrow transition-transform duration-200">‚ñ∂</span>
                        ÊúüÊúõÂêéÁª≠ (ÂèØÈÄâ)
                    </summary>
                    <div class="p-5 border-t space-y-5" style="border-color: var(--theme-card-border);">
                        <!-- Ê®°ÂºèÈÄâÊã© -->
                        <div class="flex gap-3">
                            <button type="button" onclick="setExpectMode('remain')" id="expectModeRemain" class="flex-1 py-3 text-sm font-bold transition-all text-white" style="background-color: var(--theme-btn-primary);">ÊåáÂÆöÂâ©‰ΩôÂ∏ßÊï∞</button>
                            <button type="button" onclick="setExpectMode('move')" id="expectModeMove" class="flex-1 py-3 text-sm font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white">ÊåáÂÆöÂéãÂà∂ÊãõÂºè</button>
                        </div>
                        
                        <!-- Ê®°ÂºèAÔºöÊåáÂÆöÂâ©‰ΩôÂ∏ßÊï∞ -->
                        <div id="expectRemainPanel" class="space-y-4">
                            <div>
                                <label class="block text-sm font-black uppercase mb-2 text-zinc-400">ÊúüÊúõÂâ©‰ΩôÂ∏ßÊï∞</label>
                                <input type="number" id="inputExpectRemain" class="w-full bg-black border p-4 text-2xl font-black" style="border-color: var(--theme-card-border); color: var(--theme-input-accent);" value="5" oninput="calculateExpectPlan()">
                                <p class="text-xs text-zinc-500 mt-2">Á≥ªÁªüÂ∞ÜËÆ°ÁÆóÂ¶Ç‰ΩïÂç°Â∏ßÂà∞Ââ©‰ΩôËøô‰∏™Â∏ßÊï∞</p>
                            </div>
                        </div>
                        
                        <!-- Ê®°ÂºèBÔºöÊåáÂÆöÂéãÂà∂ÊãõÂºè -->
                        <div id="expectMovePanel" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-black uppercase mb-2 text-zinc-400">ÈÄâÊã©ÂéãÂà∂ÊãõÂºè</label>
                                <select id="inputExpectMove" class="w-full bg-black border p-4 text-base font-bold" style="border-color: var(--theme-card-border); color: var(--theme-input-accent);" onchange="calculateExpectPlan()">
                                    <option value="">-- ÈÄâÊã©ÊãõÂºè --</option>
                                </select>
                                <p class="text-xs text-zinc-500 mt-2">Á≥ªÁªüÂ∞ÜËÆ°ÁÆóÂ¶Ç‰ΩïÂç°Â∏ß‰ΩøËØ•ÊãõÂºèËÉΩÂÅ∑Ëá≥Â∞ë 1 Â∏ß</p>
                            </div>
                        </div>
                        
                        <!-- ËÆ°ÁÆóÁªìÊûúÈ¢ÑËßà -->
                        <div id="expectResult" class="hidden">
                            <div class="text-sm font-black uppercase mb-3 text-zinc-400">ËÆ°ÁÆóÁªìÊûú</div>
                            <div id="expectResultContent" class="bg-black/50 border p-4 text-base" style="border-color: var(--theme-card-border);"></div>
                        </div>
                    </div>
                </details>
                
                <div class="flex gap-3">
                    <button onclick="saveNote()" class="flex-1 text-white py-4 font-bold text-base transition-all modal-btn-primary">ËÆ°ÁÆóÊñπÊ°à</button>
                    <button onclick="closeModal()" class="px-6 py-4 bg-zinc-800 text-zinc-400 font-bold text-base hover:text-white transition-all">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Character Select -->
    <div id="charModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden flex items-center justify-center p-2 sm:p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="charModalTitle">
        <div class="bg-zinc-900 border w-full max-w-3xl p-4 sm:p-6 md:p-8 max-h-[85vh] sm:max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h2 id="charModalTitle" class="impact-text text-xl sm:text-2xl md:text-3xl font-black" style="color: var(--theme-modal-title);">ÈÄâÊã©ËßíËâ≤</h2>
                <button onclick="closeCharModal()" class="text-zinc-500 hover:text-white text-2xl sm:text-3xl p-2 -m-2" title="ÂÖ≥Èó≠">&times;</button>
            </div>
            <div class="char-grid" id="charGrid"></div>
        </div>
    </div>

    <!-- MODAL: Add Rule -->
    <div id="ruleModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="ruleModalTitle">
        <div class="bg-zinc-900 border w-full max-w-md p-6 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-4">
                <h2 id="ruleModalTitle" class="impact-text text-2xl sm:text-3xl font-black" style="color: var(--theme-modal-title);">Ê∑ªÂä†ËßÑÂàô</h2>
                <button onclick="closeRuleModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="ÂÖ≥Èó≠">&times;</button>
            </div>
            
            <!-- ËßÑÂàôÁ±ªÂûãÈÄâÊã© Tab -->
            <div class="flex gap-2 mb-4 border-b border-zinc-800">
                <button onclick="switchRuleTab('disable')" id="ruleTab-disable" class="rule-tab-btn active px-4 py-2 text-xs font-bold transition-colors">
                    Á¶ÅÁî®ÂéãÂà∂
                </button>
                <button onclick="switchRuleTab('combo')" id="ruleTab-combo" class="rule-tab-btn px-4 py-2 text-xs font-bold transition-colors">
                    Á¶ÅÁî®ÁªÑÂêà
                </button>
                <button onclick="switchRuleTab('prefer')" id="ruleTab-prefer" class="rule-tab-btn px-4 py-2 text-xs font-bold transition-colors">
                    ÂÄæÂêëÂéãÂà∂
                </button>
            </div>
            
            <!-- Á¶ÅÁî®ÂéãÂà∂ËßÑÂàôË°®Âçï -->
            <div id="ruleForm-disable" class="space-y-4">
                <p class="text-zinc-500 text-xs mb-4">Á¶ÅÊ≠¢ÁâπÂÆöÊãõÂºèÁî®‰∫éÂç°Â∏ßÊàñÂéãÂà∂„ÄÇ</p>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ÈÄâÊã©ÊãõÂºè</label>
                    <select id="inputDisableMove" class="w-full bg-black border p-3 text-sm font-bold text-white" style="border-color: var(--theme-card-border);">
                        <option value="">-- ËØ∑ÈÄâÊã©ÊãõÂºè --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Á¶ÅÁî®Âú∫ÊôØ</label>
                    <select id="inputDisableUsage" class="w-full bg-black border p-3 text-sm text-white" style="border-color: var(--theme-card-border);">
                        <option value="kill">Áî®‰∫éÂç°Â∏ß</option>
                        <option value="meaty_after_kill">Áî®‰∫éÂç°Â∏ßÂêéÁöÑÂéãÂà∂</option>
                        <option value="meaty_direct">Áî®‰∫éÁõ¥Êé•ÂéãÂà∂</option>
                    </select>
                    <div class="mt-2 text-[10px] text-zinc-600" id="disableUsageHint">
                        Á¶ÅÊ≠¢Ê≠§ÊãõÂºèÁî®‰∫éÊ∂àËÄóÊúâÂà©Â∏ß
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ËØ¥Êòé (ÂèØÈÄâ)</label>
                    <input type="text" id="inputDisableDesc" class="w-full bg-black border p-3 text-sm text-zinc-400" style="border-color: var(--theme-card-border);" placeholder="‰æãÂ¶Ç: ÂÆπÊòìË¢´ÂèçÂáª">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="saveDisableRule()" class="flex-1 text-white py-3 font-bold text-sm transition-all modal-btn-primary">‰øùÂ≠òËßÑÂàô</button>
                    <button onclick="closeRuleModal()" class="px-4 py-3 bg-zinc-800 text-zinc-400 font-bold text-sm hover:text-white transition-all">ÂèñÊ∂à</button>
                </div>
            </div>
            
            <!-- Á¶ÅÁî®ÁªÑÂêàËßÑÂàôË°®Âçï -->
            <div id="ruleForm-combo" class="space-y-4 hidden">
                <p class="text-zinc-500 text-xs mb-4">Á¶ÅÊ≠¢‰∏§‰∏™ÊãõÂºèËøûÁª≠‰ΩøÁî®ÔºàÈó¥Èöî‰ΩøÁî®‰∏çÂèóÂΩ±ÂìçÔºâ„ÄÇ</p>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ÊãõÂºè 1</label>
                    <select id="inputComboMove1" class="w-full bg-black border p-3 text-sm font-bold text-white" style="border-color: var(--theme-card-border);">
                        <option value="">-- ËØ∑ÈÄâÊã©ÊãõÂºè --</option>
                    </select>
                </div>
                <div class="text-center text-zinc-600 text-xs">√ó Á¶ÅÊ≠¢ËøûÁª≠‰ΩøÁî® √ó</div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ÊãõÂºè 2</label>
                    <select id="inputComboMove2" class="w-full bg-black border p-3 text-sm font-bold text-white" style="border-color: var(--theme-card-border);">
                        <option value="">-- ËØ∑ÈÄâÊã©ÊãõÂºè --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ËØ¥Êòé (ÂèØÈÄâ)</label>
                    <input type="text" id="inputComboDesc" class="w-full bg-black border p-3 text-sm text-zinc-400" style="border-color: var(--theme-card-border);" placeholder="‰æãÂ¶Ç: ËøûÊãõ‰∏çÁ®≥ÂÆö">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="saveComboRule()" class="flex-1 text-white py-3 font-bold text-sm transition-all modal-btn-primary">‰øùÂ≠òËßÑÂàô</button>
                    <button onclick="closeRuleModal()" class="px-4 py-3 bg-zinc-800 text-zinc-400 font-bold text-sm hover:text-white transition-all">ÂèñÊ∂à</button>
                </div>
            </div>
            
            <!-- ÂÄæÂêëÂéãÂà∂ËßÑÂàôË°®Âçï -->
            <div id="ruleForm-prefer" class="space-y-4 hidden">
                <p class="text-zinc-500 text-xs mb-4">ËÆ©ÁâπÂÆöÊãõÂºèÁöÑÂéãÂà∂ÊñπÊ°à‰ºòÂÖàÊé®ËçêÔºà‰ªéÂ§áÈÄâÊèêÂçáÂà∞Êé®ËçêÂå∫Ôºâ„ÄÇ</p>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ÈÄâÊã©ÊãõÂºè</label>
                    <select id="inputPreferMove" class="w-full bg-black border p-3 text-sm font-bold text-white" style="border-color: var(--theme-card-border);">
                        <option value="">-- ËØ∑ÈÄâÊã©ÊãõÂºè --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ÁêÜÁî± (ÂèØÈÄâ)</label>
                    <input type="text" id="inputPreferDesc" class="w-full bg-black border p-3 text-sm text-zinc-400" style="border-color: var(--theme-card-border);" placeholder="‰æãÂ¶Ç: ‰º§ÂÆ≥È´ò„ÄÅÁ°ÆËÆ§ÁÆÄÂçï">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="savePreferRule()" class="flex-1 text-white py-3 font-bold text-sm transition-all modal-btn-primary">‰øùÂ≠òËßÑÂàô</button>
                    <button onclick="closeRuleModal()" class="px-4 py-3 bg-zinc-800 text-zinc-400 font-bold text-sm hover:text-white transition-all">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Add Move -->
    <div id="addMoveModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="addMoveModalTitle">
        <div class="bg-zinc-900 border w-full max-w-md p-6 sm:p-8 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-6">
                <h2 id="addMoveModalTitle" class="impact-text text-3xl sm:text-4xl font-black" style="color: var(--theme-modal-title);">Êñ∞Â¢ûÊãõÂºè</h2>
                <button onclick="closeAddMoveModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="ÂÖ≥Èó≠">&times;</button>
            </div>
            <div class="space-y-4">
                <!-- ÊãõÂºèÁ±ªÂûãÈÄâÊã© -->
                <div>
                    <label class="block text-[10px] font-black uppercase mb-2 text-zinc-500">ÊãõÂºèÁ±ªÂûã</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="setMoveType('normal')" id="moveTypeNormal" class="flex-1 py-2 text-xs font-bold transition-all text-white" style="background-color: var(--theme-btn-primary);">ÊôÆÈÄöÊãõÂºè</button>
                        <button type="button" onclick="setMoveType('throw')" id="moveTypeThrow" class="flex-1 py-2 text-xs font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white">ÊäïÊäÄ</button>
                        <button type="button" onclick="setMoveType('dash')" id="moveTypeDash" class="flex-1 py-2 text-xs font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white">Dash</button>
                    </div>
                </div>
                
                <!-- ÊãõÂºèÂêçÁß∞ -->
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ÊãõÂºèÂêçÁß∞</label>
                    <input type="text" id="inputMoveName" class="w-full bg-black border p-3 text-lg font-bold text-white uppercase" style="border-color: var(--theme-card-border);" placeholder="‰æãÂ¶Ç: 5HP, 2MK">
                </div>
                
                <!-- ÊôÆÈÄöÊãõÂºè/ÊäïÊäÄÁöÑÂ∏ßÊï∞ÊçÆ -->
                <div id="moveFrameFields" class="space-y-3">
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Startup</label>
                            <input type="number" id="inputMoveStartup" class="w-full bg-black border p-2 text-center font-mono text-white" style="border-color: var(--theme-card-border);" placeholder="7">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Active</label>
                            <input type="text" id="inputMoveActive" class="w-full bg-black border p-2 text-center font-mono text-white" style="border-color: var(--theme-card-border);" placeholder="7-9">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Recovery</label>
                            <input type="number" id="inputMoveRecovery" class="w-full bg-black border p-2 text-center font-mono text-white" style="border-color: var(--theme-card-border);" placeholder="15">
                        </div>
                    </div>
                    <div id="moveHitBlockFields" class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Hit (ÂëΩ‰∏≠)</label>
                            <input type="number" id="inputMoveHit" class="w-full bg-black border p-2 text-center font-mono text-cyan-400" style="border-color: var(--theme-card-border);" placeholder="+5">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Block (ÊâìÈò≤)</label>
                            <input type="number" id="inputMoveBlock" class="w-full bg-black border p-2 text-center font-mono text-pink-400" style="border-color: var(--theme-card-border);" placeholder="-2">
                        </div>
                    </div>
                    <div id="moveKnockdownField">
                        <label class="flex items-center gap-2 text-sm text-zinc-400 cursor-pointer">
                            <input type="checkbox" id="inputMoveKnockdown" class="w-4 h-4 accent-red-500">
                            <span>ÂáªÂÄíÊäÄ (Knockdown)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Dash ÁöÑÂ∏ßÊï∞ÊçÆ -->
                <div id="moveDashFields" class="hidden">
                    <div>
                        <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Dash ÊÄªÂ∏ßÊï∞</label>
                        <input type="number" id="inputMoveDashFrames" class="w-full bg-black border p-3 text-center font-mono text-white text-lg" style="border-color: var(--theme-card-border);" placeholder="19">
                    </div>
                </div>
                
                <div class="flex gap-2 pt-3">
                    <button onclick="saveNewMove()" class="flex-1 text-white py-3 font-bold text-sm transition-all modal-btn-primary">Ê∑ªÂä†ÊãõÂºè</button>
                    <button onclick="closeAddMoveModal()" class="px-4 py-3 bg-zinc-800 text-zinc-400 font-bold text-sm hover:text-white transition-all">ÂèñÊ∂à</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Help -->
    <div id="helpModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="bg-zinc-900 border w-full max-w-2xl p-6 sm:p-8 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-6">
                <h2 id="helpModalTitle" class="impact-text text-2xl sm:text-3xl font-black" style="color: var(--theme-modal-title);">‰ΩøÁî®ËØ¥Êòé</h2>
                <button onclick="closeHelpModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="ÂÖ≥Èó≠">&times;</button>
            </div>
            <div class="space-y-6 text-zinc-300 text-sm leading-relaxed">
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">üìå ËøôÊòØ‰ªÄ‰πàÔºü</h3>
                    <p>SF6 FRAME LAB ÊòØ‰∏ÄÊ¨æÂç°Â∏ßÂ•óË∑ØÂéãÂà∂ËÆ°ÁÆóÂ∑•ÂÖ∑ÔºåÂ∏ÆÂä©ÊâæÂà∞ÊúÄ‰ºòÁöÑ<strong class="text-cyan-400">Âç°Â∏ßÂéãÂà∂</strong>ÁªÑÂêàÊñπÊ°à„ÄÇ</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">üéÆ Â¶Ç‰Ωï‰ΩøÁî®</h3>
                    <ol class="list-decimal list-inside space-y-3 text-zinc-400">
                        <li><strong class="text-white">ÈÄâÊã©ËßíËâ≤</strong> - ÁÇπÂáª <span class="text-cyan-400">ËßíËâ≤</span> ÊåâÈíÆÊàñÈ°∂ÈÉ®ÊªöÂä®Ê®™ÂπÖÂàáÊç¢ËßíËâ≤</li>
                        <li>
                            <strong class="text-white">Êü•ÁúãÂç°Â∏ßÁ≠ñÁï•</strong> - <span class="text-cyan-400">ÊñπÊ°à</span> È°µÁ≠æÂ±ïÁ§∫ÂêÑÁßçÂáªÂÄíÊÉÖÂ¢É‰∏ãÁöÑÊúÄ‰ºòÊñπÊ°à
                            <p class="text-zinc-500 text-xs mt-1 ml-5">*‰ΩøÁî®ÊêúÁ¥¢Ê°ÜÊü•ÊâæÁâπÂÆöÂ∏ßÊï∞ÊàñÂú∫ÊôØÔºåÁÇπÂáªÊéíÂ∫èÊåâÈíÆÂàáÊç¢ÊéíÂ∫èÊñπÂêë</p>
                            <p class="text-zinc-500 text-xs ml-5">*ÁÇπÂáª <span class="text-yellow-400">‚òÜ</span> Êî∂ËóèÂñúÊ¨¢ÁöÑÊñπÊ°àÔºåÁÇπÂáª <span class="text-zinc-400">_</span> ÊúÄÂ∞èÂåñÂà∞Â§áÈÄâÂå∫</p>
                        </li>
                        <li>
                            <strong class="text-white">Êñ∞Â¢ûÂú∫ÊôØ</strong> - ÁÇπÂáª <span class="text-cyan-400">+ Êñ∞Â¢ûÂú∫ÊôØ</span> ËæìÂÖ•ÊúâÂà©Â∏ßÊï∞ÔºåÁ≥ªÁªüËá™Âä®ËÆ°ÁÆó
                            <p class="text-zinc-500 text-xs mt-1 ml-5">*ÂàáÊç¢„ÄåÊ®°Á≥ä„ÄçÊ®°ÂºèÂèØËæìÂÖ•Â∏ßÊï∞ËåÉÂõ¥ÔºåÁ≥ªÁªüËÆ°ÁÆóÈÄöÁî®ÊñπÊ°à</p>
                            <p class="text-zinc-500 text-xs ml-5">*ÂèØÂ±ïÂºÄ„ÄåÊúüÊúõÂêéÁª≠„ÄçÊåáÂÆöÂâ©‰ΩôÂ∏ßÊï∞ÊàñÂéãÂà∂ÊãõÂºèÔºåÁ≥ªÁªüÈ™åËØÅÂèØË°åÊÄß</p>
                        </li>
                        <li>
                            <strong class="text-white">ÁÆ°ÁêÜÂ∏ßÊï∞ÊçÆ</strong> - <span class="text-cyan-400">Êï∞ÊçÆ</span> È°µÁ≠æÂèØÊü•Áúã/ÂØºÂÖ•ËßíËâ≤ÊãõÂºèÊï∞ÊçÆ
                            <p class="text-zinc-500 text-xs mt-1 ml-5">*ÁÆ°ÁêÜÁªÑÂêàËßÑÂàôÔºö<span class="text-zinc-400">ÂÖ®Â±Ä</span> ËßÑÂàôÂÖ®ËßíËâ≤ÁîüÊïàÔºåÂÖ∂‰ªñËßÑÂàô‰ªÖÂΩìÂâçËßíËâ≤</p>
                        </li>
                    </ol>
                </section>
                
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">üí° ÊñπÊ°àËß£ËØª</h3>
                    <ul class="space-y-2 text-zinc-400">
                        <li><span class="text-yellow-500">Âç°Â∏ßÊãõÂºè</span> ‚Üí Áî®Êù•Ê∂àËÄóÂ§ö‰ΩôÁöÑÊúâÂà©Â∏ß</li>
                        <li><span class="text-white">ÂéãÂà∂ÊãõÂºè</span> ‚Üí ÂØπÊâãËµ∑Ë∫´Êó∂ÊîªÂáªÂëΩ‰∏≠ÁöÑÊãõÂºè</li>
                        <li><span class="text-cyan-400">H +X</span> / <span class="text-white">H 0</span> / <span class="text-rose-400">H -X</span> ‚Üí ÂëΩ‰∏≠Êó∂ÁöÑÂ∏ßÊï∞‰ºòÂäø</li>
                        <li><span class="text-cyan-400">B +X</span> / <span class="text-white">B 0</span> / <span class="text-rose-400">B -X</span> ‚ÜíÊâìÈò≤Êó∂ÁöÑÂ∏ßÊï∞‰ºòÂäø</li>
                        <li><span class="text-emerald-400">ÂÅ∑ XF</span> ‚Üí ÊØîÊ≠£Â∏∏Êõ¥Êó©ÂëΩ‰∏≠ÔºåÂ§öÂÅ∑ÁöÑÂ∏ßÊï∞</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">‚öôÔ∏è ËßÑÂàôÁÆ°ÁêÜ</h3>
                    <p class="text-zinc-400 mb-2">Âú®<span class="text-cyan-400">Êï∞ÊçÆ</span>È°µÁ≠æÂèØÊ∑ªÂä†Ëá™ÂÆö‰πâËßÑÂàôÔºö</p>
                    <ul class="space-y-2 text-zinc-400 text-sm">
                        <li><span class="text-red-400">Á¶ÅÁî®ÊãõÂºè</span> ‚Üí Á¶ÅÊ≠¢ÊüêÊãõÂºèÁî®‰∫éÂç°Â∏ß„ÄÅÂéãÂà∂ÊàñÁõ¥Êé•ÂéãÂà∂</li>
                        <li><span class="text-red-400">Á¶ÅÊ≠¢ÁªÑÂêà</span> ‚Üí Á¶ÅÊ≠¢‰∏§‰∏™ÊãõÂºèËøûÁª≠‰ΩøÁî®ÔºàÂ¶Ç 5LP √ó 5LPÔºâ</li>
                        <li><span class="text-green-400">ÂÅèÂ•ΩÂéãÂà∂</span> ‚Üí ‰ºòÂÖàÊé®ËçêÊüêÊãõÂºè‰Ωú‰∏∫ÂéãÂà∂ÊãõÂºè</li>
                    </ul>
                    <p class="text-zinc-500 text-xs mt-2">*<span class="text-zinc-400">ÂÖ®Â±Ä</span>ËßÑÂàôÔºàÂ¶Ç LP+LPÔºâÂØπÊâÄÊúâËßíËâ≤ÁîüÊïà‰∏î‰∏çÂèØÂà†Èô§</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">üìù ÂÜôÂú®ÊúÄÂêé</h3>
                    <p class="text-zinc-400">Êú¨ÁΩëÈ°µ‰ªçÂ§Ñ‰∫éÊµãËØïÊó©ÊúüÁâàÊú¨ÔºåÂ¶ÇÊúâÂèçÈ¶àÂíåÂª∫ËÆÆÔºåËØ∑BÁ´ôÁßÅ‰ø° <strong class="text-cyan-400">Cold_Visions</strong>ÔºåÂçÅÂàÜÊÑüË∞¢ÔºÅ</p>
                </section>
                
                <div class="pt-4 border-t border-zinc-800 text-center text-zinc-600 text-xs">
                    Made by Yuetian
                </div>
            </div>
        </div>
    </div>

    <!-- ËßíËâ≤Êï∞ÊçÆÂ≠òÂÇ®ÔºàÂÖ®Â±ÄÂèòÈáèÔºåÁî±ÂêÑËßíËâ≤JSÊñá‰ª∂Â°´ÂÖÖÔºâ -->
    <script>const CHARACTER_DATA = {};</script>
    <!-- Âä†ËΩΩËßíËâ≤Êï∞ÊçÆÊñá‰ª∂ -->
    <script src="data/ryu.js"></script>
    <script src="data/blanka.js"></script>
    <script src="data/sagat.js"></script>
    <script src="data/juri.js"></script>

    <script>
        // ==================== ÈÖçÁΩÆÂ∏∏Èáè ====================
        const CONFIG = {
            // SF6 ÂÖ®ËßíËâ≤ÂàóË°®
            ALL_CHARACTERS: [
                "RYU", "LUKE", "KEN", "CHUN-LI", "GUILE", "KIMBERLY",
                "JURI", "JAMIE", "BLANKA", "DHALSIM", "E.HONDA", "DEE JAY",
                "MANON", "MARISA", "JP", "ZANGIEF", "LILY", "CAMMY",
                "RASHID", "A.K.I.", "ED", "GOUKI", "VEGA", "TERRY",
                "MAI", "ELENA", "SAGAT", "C.VIPER"
            ],
            // Â∑≤ÊúâJSONÊï∞ÊçÆÁöÑËßíËâ≤
            CHARACTERS_WITH_DATA: ["RYU", "BLANKA", "SAGAT", "JURI"],
            // ÂÆâÂÖ®Ë∑≥ÊâÄÈúÄÂ∏ßÊï∞ÔºàÂ§ßÈÉ®ÂàÜËßíËâ≤42FÔºâ
            SAFE_JUMP_FRAMES: {
                "DEFAULT": 42,
                "ZANGIEF": 43,
                "LILY": 44,
                "A.K.I.": 44,
                "CHUN-LI": 46,
                "DHALSIM": 75
            },
            // ÂÖ®Â±ÄËßÑÂàôÔºàÈÄÇÁî®‰∫éÊâÄÊúâËßíËâ≤Ôºå‰∏çÂèØÁºñËæëÔºâ
            GLOBAL_RULES: [
                {
                    id: "global_lp_lp",
                    pattern1: "LP",
                    pattern2: "LP",
                    description: "ËΩªÊã≥‰∏ç‰ºöÂíåËΩªÊã≥ÁªÑÂêàÔºàËøûÁÇπÂèñÊ∂à‰∏çËÉΩÁ≤æÂáÜÂç°Â∏ßÔºâ"
                },
                {
                    id: "global_2lp_2lp",
                    pattern1: "2LP",
                    pattern2: "2LP",
                    description: "‰∏ãËΩªÊã≥‰∏ç‰ºöÂíå‰∏ãËΩªÊã≥ÁªÑÂêàÔºàËøûÁÇπÂèñÊ∂à‰∏çËÉΩÁ≤æÂáÜÂç°Â∏ßÔºâ"
                },
                {
                    id: "global_2lp_lp",
                    pattern1: "2LP",
                    pattern2: "LP",
                    description: "‰∏ãËΩªÊã≥‰∏ç‰ºöÂíåËΩªÊã≥ÁªÑÂêàÔºàËøûÁÇπÂèñÊ∂à‰∏çËÉΩÁ≤æÂáÜÂç°Â∏ßÔºâ"
                },
                {
                    id: "global_lp_2lp",
                    pattern1: "LP",
                    pattern2: "2LP",
                    description: "ËΩªÊã≥‰∏ç‰ºöÂíå‰∏ãËΩªÊã≥ÁªÑÂêàÔºàËøûÁÇπÂèñÊ∂à‰∏çËÉΩÁ≤æÂáÜÂç°Â∏ßÔºâ"
                }
            ],
            // ËßíËâ≤È¢ÑËÆæËßÑÂàôÔºàËßíËâ≤‰∏ìÂ±ûÔºå‰∏çÂèØÂà†Èô§Ôºâ
            CHARACTER_PRESET_RULES: {
                "RYU": [
                    {
                        id: "ryu_preset_6hp_meaty_after",
                        type: "disable",
                        moveName: "6HP",
                        usage: "meaty_after_kill",
                        description: "‰∏§ÊÆµÊîªÂáª"
                    },
                    {
                        id: "ryu_preset_6hp_meaty_direct",
                        type: "disable",
                        moveName: "6HP",
                        usage: "meaty_direct",
                        description: "‰∏§ÊÆµÊîªÂáª"
                    },
                    {
                        id: "ryu_preset_5mk_meaty_after",
                        type: "disable",
                        moveName: "5MK",
                        usage: "meaty_after_kill",
                        description: "Êó†Ê≥ïÂèñÊ∂àÔºå‰∏çÈÄÇÂêàÁî®‰∫éÂéãÂà∂"
                    },
                    {
                        id: "ryu_preset_5mk_meaty_direct",
                        type: "disable",
                        moveName: "5MK",
                        usage: "meaty_direct",
                        description: "Êó†Ê≥ïÂèñÊ∂àÔºå‰∏çÈÄÇÂêàÁî®‰∫éÂéãÂà∂"
                    }
                ]
            },
            // ËßíËâ≤ÂõæÊ†áÊò†Â∞Ñ
            CHAR_ICONS: {
                "RYU": "ü•ã", "LUKE": "ü•ä", "KEN": "üî•", "CHUN-LI": "ü¶µ", "GUILE": "‚úàÔ∏è", "KIMBERLY": "ü•∑",
                "JURI": "üï∑Ô∏è", "JAMIE": "üç∏", "BLANKA": "‚ö°", "DHALSIM": "üßò", "E.HONDA": "ü§º", "DEE JAY": "üéµ",
                "MANON": "ü©∞", "MARISA": "üóø", "JP": "üé©", "ZANGIEF": "üêª", "LILY": "ü™∂", "CAMMY": "üê±",
                "RASHID": "üå™Ô∏è", "A.K.I.": "üêç", "ED": "üëä", "GOUKI": "üëπ", "VEGA": "ü¶Ç", "TERRY": "üß¢",
                "MAI": "üå∏", "ELENA": "üå∫", "SAGAT": "üêØ", "C.VIPER": "üï∂Ô∏è"
            },
            // localStorage ÈîÆÂêçÂâçÁºÄ
            STORAGE_KEY: "sf6_frame_lab",
            // ==================== ËßíËâ≤‰∏ªÈ¢òÈÖçËâ≤ÊñπÊ°à ====================
            // „ÄêÈÖçËâ≤ÂèòÈáèÁî®ÈÄîËØ¥Êòé„Äë
            // primary    - ‰∏ªÈ¢òËâ≤ÔºöÂç°ÁâáËæπÊ°Ü/ËÉåÊôØÊ∑∑Âêà„ÄÅÂèëÂÖâÊïàÊûú„ÄÅÊåâÈíÆÊÇ¨ÂÅúËÉåÊôØ
            // secondary  - È´ò‰∫ÆÊñáÊú¨Ëâ≤ÔºöÂ∏ßÊï∞Êï∞Â≠ó"+XXF"„ÄÅÂ§ßÊ†áÈ¢òÔºàÂøÖÈ°ªÊòØ‰∫ÆËâ≤ÔºÅÊ∑±Ëâ≤ËÉåÊôØ‰∏äÁöÑÊñáÂ≠óÔºâ
            // accent     - ÁÇπÁºÄËâ≤ÔºöGlitchÊïàÊûúÂØπÊØîËâ≤„ÄÅÁéØÂ¢ÉÂÖâ„ÄÅË£ÖÈ•∞ÂÖÉÁ¥†
            // modalTitle - ModalÂØπËØùÊ°ÜÊ†áÈ¢òÈ¢úËâ≤
            // btnPrimary - ‰∏ªÊåâÈíÆËÉåÊôØËâ≤
            // btnPrimaryHover - ‰∏ªÊåâÈíÆÊÇ¨ÂÅúËâ≤
            // inputAccent - ËæìÂÖ•Ê°ÜÂº∫Ë∞ÉËâ≤
            // cardBg     - Âç°ÁâáËÉåÊôØÔºàÊ∑±Ëâ≤Ôºâ
            // cardBorder - Âç°ÁâáËæπÊ°ÜÈ¢úËâ≤
            // bgImage    - ËÉåÊôØÂõæÁâáË∑ØÂæÑ
            CHAR_THEMES: {
                "RYU": {
                    primary: "#6b2020",      // ÈÅìÊúçÊöóÁ∫¢
                    secondary: "#d4a574",    // ÈÅìÊúçÁ±≥Ëâ≤ÔºàÊñáÊú¨È´ò‰∫ÆÔºâ
                    accent: "#1a1a1a",       // Ê∞¥Â¢®ÈªëÔºàGlitchÂØπÊØîÔºâ
                    modalTitle: "#a04040",
                    btnPrimary: "#6b2020",
                    btnPrimaryHover: "#4a1515",
                    inputAccent: "#a04040",
                    cardBg: "#1a1210",       // Ê∑±Ê£ïÁ∫¢
                    cardBorder: "#3d2218",
                    bgImage: "asset/ryu_ss01.jpg"
                },
                "BLANKA": {
                    primary: "#228b22",      // ‰∏õÊûóÁªø
                    secondary: "#ffd700",    // Èó™ÁîµÈªÑÔºàÊñáÊú¨È´ò‰∫ÆÔºâ
                    accent: "#f97316",       // ÊØõÂèëÊ©ôÔºàGlitchÂØπÊØîÔºâ
                    modalTitle: "#32cd32",
                    btnPrimary: "#228b22",
                    btnPrimaryHover: "#1a6b1a",
                    inputAccent: "#32cd32",
                    cardBg: "#141c14",       // Ê∑±Áªø
                    cardBorder: "#2a4a2a",
                    bgImage: "asset/blanka_ss01.jpg"
                },
                "SAGAT": {
                    primary: "#d49500",      // ËôéÈªÑ/Ê≤ôÈáëÔºàÈ•±Êª°ÊúâÂäõÔºâ
                    secondary: "#e8e4d8",    // ÁªëÂ∏¶‰∫ÆÁÅ∞ÁôΩÔºàÊñáÊú¨È´ò‰∫ÆÔºâ
                    accent: "#e5a000",       // ËôéÈªÑÔºàGlitchÂØπÊØî - ÂíåprimaryÂëºÂ∫îÔºâ
                    modalTitle: "#e8e4d8",   // ÁªëÂ∏¶‰∫ÆÁÅ∞ÁôΩ
                    btnPrimary: "#b88000",   // Ê∑±Ê≤ôÈáëÊåâÈíÆ
                    btnPrimaryHover: "#9a6a00",
                    inputAccent: "#d49500",  // ËôéÈªÑÂº∫Ë∞É
                    cardBg: "#0a0a08",       // Á∫ØÈªëÔºà‰ΩìÁé∞ÈªëËâ≤Ê¨°Ëâ≤Ë∞ÉÔºâ
                    cardBorder: "#2a2820",   // ÊöóÁÅ∞ËæπÊ°Ü
                    bgImage: "asset/sagat_ss01.jpg"
                },
                "JURI": {
                    primary: "#9932cc",      // Ê∑±Á¥´Ëâ≤ÔºàË°£Êúç‰∏ªËâ≤Ôºâ
                    secondary: "#ff1493",    // Áé´Á∫¢Ëâ≤ÔºàÊñáÊú¨È´ò‰∫ÆÔºåËÉåÊôØÈ£ûÊ∫ÖÊïàÊûúÔºâ
                    accent: "#00ced1",       // ÈùíËâ≤ÔºàÊåáÁî≤„ÄÅÂèëÈ•∞ÁÇπÁºÄÔºâ
                    modalTitle: "#da70d6",   // ‰∫ÆÁ¥´/ÂÖ∞Ëä±Á¥´
                    btnPrimary: "#8b008b",   // Ê∑±Áé´Á∫¢Á¥´
                    btnPrimaryHover: "#6a006a",
                    inputAccent: "#ff69b4",  // ‰∫ÆÁ≤âËâ≤
                    cardBg: "#150a14",       // Ê∑±Á¥´Èªë
                    cardBorder: "#3d1a3d",   // Á¥´Ëâ≤ËæπÊ°Ü
                    bgImage: "asset/juri_ss01.jpg"
                },
                // ÈªòËÆ§‰∏ªÈ¢òÔºàÁî®‰∫éÊó†ÁâπÂÆö‰∏ªÈ¢òÁöÑËßíËâ≤Ôºâ
                "_DEFAULT": {
                    primary: "#ff007a",      // ÈúìËôπÁ≤â
                    secondary: "#00f2ff",    // ÈùíËâ≤ÔºàÊñáÊú¨È´ò‰∫ÆÔºâ
                    accent: "#ffd700",       // ÈáëËâ≤ÔºàGlitchÂØπÊØîÔºâ
                    modalTitle: "#ec4899",
                    btnPrimary: "#db2777",
                    btnPrimaryHover: "#be185d",
                    inputAccent: "#f472b6",
                    cardBg: "#141416",
                    cardBorder: "#2a2a2e",
                    bgImage: null
                }
            }
        };

        // ==================== Â∫îÁî®Áä∂ÊÄÅ ====================
        const state = {
            currentCharacter: "JURI",
            moveLibrary: [],
            notes: [],
            // ËßíËâ≤Êï∞ÊçÆÁºìÂ≠òÔºö{ moves: [], scenarios: [] }
            characterCache: {},
            // Êî∂ËóèÁöÑÊñπÊ°à { "charName:adv:planKey": true }
            favorites: {},
            // ÊúÄÂ∞èÂåñÁöÑÊñπÊ°à { "charName:adv:planKey": true }
            minimized: {},
            // ÊéíÂ∫èÊñπÂêëÔºö'asc' ‰ªéÂ∞èÂà∞Â§ßÔºå'desc' ‰ªéÂ§ßÂà∞Â∞è
            sortOrder: 'asc',
            // ËßíËâ≤‰∏ìÂ±ûËßÑÂàô { charName: [rules] }
            characterRules: {},
            // Â∑≤Âà†Èô§ÁöÑÈ¢ÑËÆæËßÑÂàô { "charName:ruleId": true }
            deletedPresetRules: {},
            // ÂΩìÂâçÂ±ïÂºÄÁöÑÊúâÂà©Â∏ßÔºàSetÔºåÊîØÊåÅÂ§ö‰∏™ÂêåÊó∂Â±ïÂºÄÔºâ
            expandedAdvSet: new Set(),
            // ÂÖ®Â±ÄÂ±ïÂºÄËØ¶ÊÉÖÂºÄÂÖ≥
            allDetailsExpanded: false,
            // ÊòØÂê¶Âè™ÊòæÁ§∫Êî∂ËóèÊñπÊ°à
            showOnlyFavorites: false,
            // ÊâìÊäïÊã©Êî∂Ëóè { "charName:adv:remain:killDesc": true }
            mixupFavorites: {},
            // ÊâìÊäïÊã©ÈöêËóèÁöÑÊñπÊ°à { "charName:adv:remain:killDesc": true }
            mixupHidden: {}
        };

        // ==================== Â∑•ÂÖ∑ÂáΩÊï∞ ====================
        // HTML ËΩ¨‰πâÔºåÈò≤Ê≠¢ XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ÊòæÁ§∫Êìç‰ΩúÊèêÁ§∫ÔºàËΩªÈáèÁ∫ß toastÔºâ
        function showToast(message, type = 'success') {
            // ÁßªÈô§Â∑≤ÊúâÁöÑ toast
            const existing = document.getElementById('toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = `fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded text-sm font-bold z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600 text-white' : 
                type === 'error' ? 'bg-red-600 text-white' : 
                'bg-zinc-700 text-white'
            }`;
            toast.textContent = message;
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(-50%) translateY(10px)';
            
            document.body.appendChild(toast);
            
            // ÊòæÁ§∫Âä®Áîª
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            });
            
            // Ëá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 1500);
        }
        
        // ÊêúÁ¥¢Èò≤Êäñ
        let searchDebounceTimer = null;
        function debounce(func, delay = 150) {
            return function(...args) {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        function getCharIcon(char) {
            return CONFIG.CHAR_ICONS[char] || "üë§";
        }
        
        // Â∫îÁî®ËßíËâ≤‰∏ªÈ¢òËâ≤
        function applyTheme(char) {
            const theme = CONFIG.CHAR_THEMES[char] || CONFIG.CHAR_THEMES["_DEFAULT"];
            const root = document.documentElement;
            
            root.style.setProperty('--theme-primary', theme.primary);
            root.style.setProperty('--theme-secondary', theme.secondary);
            root.style.setProperty('--theme-accent', theme.accent);
            root.style.setProperty('--theme-card-bg', theme.cardBg);
            root.style.setProperty('--theme-card-border', theme.cardBorder);
            root.style.setProperty('--theme-modal-title', theme.modalTitle);
            root.style.setProperty('--theme-btn-primary', theme.btnPrimary);
            root.style.setProperty('--theme-btn-primary-hover', theme.btnPrimaryHover);
            root.style.setProperty('--theme-input-accent', theme.inputAccent);
            root.style.setProperty('--theme-fuzzy', '#f59e0b');  // Ê®°Á≥äÂú∫ÊôØÊ†áÁ≠æËâ≤ÔºàÂõ∫ÂÆöÊ©ôËâ≤Ôºâ
            
            // Â∫îÁî®ËÉåÊôØÂõæ
            const bgOverlay = document.getElementById('bgOverlay');
            if (theme.bgImage) {
                bgOverlay.style.backgroundImage = `url('${theme.bgImage}')`;
                bgOverlay.style.opacity = '1';
            } else {
                bgOverlay.style.backgroundImage = 'none';
                bgOverlay.style.opacity = '0';
            }
            
            console.log(`[‰∏ªÈ¢ò] Â∫îÁî® ${char} ‰∏ªÈ¢ò:`, theme);
        }

        // Ëß£ÊûêactiveÂ≠óÁ¨¶‰∏≤‰∏∫ÊÆµÊï∞ÁªÑÔºàÊîØÊåÅÂ§öÊÆµÂ¶Ç "10-14,20-23"Ôºâ
        function parseActiveRanges(activeStr) {
            if (typeof activeStr === 'number') return [{ start: activeStr, end: activeStr }];
            if (typeof activeStr !== 'string') return [{ start: 0, end: 0 }];
            
            return activeStr.split(',').map(segment => {
                const parts = segment.trim().split('-').map(Number);
                return {
                    start: parts[0],
                    end: parts.length === 2 ? parts[1] : parts[0]
                };
            });
        }

        // Ëé∑ÂèñÊúÄÂêé‰∏Ä‰∏™activeÂ∏ßÔºàÁî®‰∫éËÆ°ÁÆóÂç°Â∏ßÊãõÂºèÁöÑÊÄªËÄóÊó∂Ôºâ
        function getLastActiveFrame(activeStr) {
            const ranges = parseActiveRanges(activeStr);
            return Math.max(...ranges.map(r => r.end));
        }

        // Ê£ÄÊü•targetFrameÊòØÂê¶ÂëΩ‰∏≠Êüê‰∏™activeÊÆµÔºåËøîÂõûÂëΩ‰∏≠‰ø°ÊÅØÊàñnull
        function checkActiveHit(activeStr, targetFrame) {
            const ranges = parseActiveRanges(activeStr);
            for (const range of ranges) {
                if (range.start <= targetFrame && targetFrame <= range.end) {
                    return {
                        hitAtActive: targetFrame - range.start + 1,
                        stolen: targetFrame - range.start,
                        rangeStart: range.start,
                        rangeEnd: range.end
                    };
                }
            }
            return null; // Êú™ÂëΩ‰∏≠‰ªª‰ΩïactiveÊÆµ
        }

        // ==================== localStorage Â≠òÂèñ ====================
        function getStorageKey(char, type) {
            return `${CONFIG.STORAGE_KEY}_${char}_${type}`;
        }
        
        function getGlobalStorageKey(type) {
            return `${CONFIG.STORAGE_KEY}_global_${type}`;
        }

        // ========== ÂΩìÂâçËßíËâ≤Â≠òÂÇ® ==========
        function saveCurrentCharacter(char) {
            try {
                localStorage.setItem(getGlobalStorageKey('currentCharacter'), char);
            } catch (e) {
                console.warn('‰øùÂ≠òÂΩìÂâçËßíËâ≤Â§±Ë¥•:', e);
            }
        }
        
        function loadCurrentCharacter() {
            try {
                return localStorage.getItem(getGlobalStorageKey('currentCharacter')) || 'JURI';
            } catch (e) {
                return 'JURI';
            }
        }

        // ========== ÊãõÂºèÊï∞ÊçÆÂ≠òÂÇ® ==========
        function saveMoves(char, moves) {
            try {
                // Âè™‰øùÂ≠òÁî®Êà∑‰øÆÊîπËøáÁöÑÊï∞ÊçÆÔºà‰∏éÈ¢ÑËÆæ‰∏çÂêåÔºâ
                localStorage.setItem(getStorageKey(char, 'moves'), JSON.stringify(moves));
            } catch (e) {
                console.warn('‰øùÂ≠òÊãõÂºèÊï∞ÊçÆÂ§±Ë¥•:', e);
            }
        }
        
        function loadMovesFromStorage(char) {
            try {
                const saved = localStorage.getItem(getStorageKey(char, 'moves'));
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('ËØªÂèñÊãõÂºèÊï∞ÊçÆÂ§±Ë¥•:', e);
            }
            return null;
        }
        
        function clearSavedMoves(char) {
            localStorage.removeItem(getStorageKey(char, 'moves'));
        }

        // ========== Scenarios Â≠òÂÇ® ==========
        // ‰øùÂ≠òËßíËâ≤ÁöÑ scenarios Âà∞ localStorage (Âè™Â≠òÂÇ®Áî®Êà∑Ëá™ÂÆö‰πâÁöÑÈÉ®ÂàÜ)
        function saveScenarios(char, allScenarios) {
            try {
                // ÂàÜÁ¶ªÂá∫Áî®Êà∑Ëá™ÂÆö‰πâÁöÑÂú∫ÊôØÔºàÂ∏¶Êúâ isUserAdded Ê†áËÆ∞ÁöÑÔºâ
                const userScenarios = allScenarios.filter(s => s.isUserAdded === true);
                localStorage.setItem(getStorageKey(char, 'scenarios'), JSON.stringify(userScenarios));
            } catch (e) {
                console.warn('‰øùÂ≠ò scenario Â§±Ë¥•:', e);
            }
        }

        // Ëé∑ÂèñËßíËâ≤ÁöÑÈ¢ÑËÆæ scenarios (‰ªéJSONÁºìÂ≠ò)
        function getDefaultScenarios(char) {
            const cache = state.characterCache[char];
            return cache?.scenarios ? [...cache.scenarios] : [];
        }
        
        // Ëé∑ÂèñËßíËâ≤ÁöÑÈ¢ÑËÆæ moves (‰ªéJSONÁºìÂ≠ò)
        function getDefaultMoves(char) {
            const data = CHARACTER_DATA[char];
            return data?.moves ? [...data.moves] : [];
        }

        // Âä†ËΩΩËßíËâ≤ÁöÑ scenariosÔºåÂêàÂπ∂È¢ÑËÆæ + Áî®Êà∑Ëá™ÂÆö‰πâ
        function loadScenariosFromStorage(char) {
            try {
                const saved = localStorage.getItem(getStorageKey(char, 'scenarios'));
                if (saved) {
                    const userScenarios = JSON.parse(saved);
                    // Á°Æ‰øùÁî®Êà∑Âú∫ÊôØÈÉΩÊúâ isUserAdded Ê†áËÆ∞
                    userScenarios.forEach(s => s.isUserAdded = true);
                    return userScenarios;
                }
            } catch (e) {
                console.warn('ËØªÂèñ scenario Â§±Ë¥•:', e);
            }
            return []; // ËøîÂõûÁ©∫Êï∞ÁªÑË°®Á§∫Ê≤°ÊúâÁî®Êà∑Ëá™ÂÆö‰πâ
        }

        // Âä†ËΩΩÂÆåÊï¥ÁöÑ scenariosÔºöÈ¢ÑËÆæ + Áî®Êà∑Ëá™ÂÆö‰πâ
        function loadAllScenarios(char) {
            const defaultScenarios = getDefaultScenarios(char);
            const userScenarios = loadScenariosFromStorage(char);
            return [...defaultScenarios, ...userScenarios];
        }

        // ÈáçÁΩÆËßíËâ≤ scenarios ‰∏∫È¢ÑËÆæÔºàÊ∏ÖÈô§Áî®Êà∑Ëá™ÂÆö‰πâÔºâ
        function resetScenarios(char) {
            localStorage.removeItem(getStorageKey(char, 'scenarios'));
            return getDefaultScenarios(char);
        }
        
        // ÈáçÁΩÆËßíËâ≤ moves ‰∏∫È¢ÑËÆæ
        function resetMoves(char) {
            clearSavedMoves(char);
            return getDefaultMoves(char);
        }

        // ========== ËßÑÂàôÂ≠òÂÇ® ==========
        // ‰øùÂ≠òËßíËâ≤‰∏ìÂ±ûËßÑÂàô
        function saveCharacterRules(char, rules) {
            try {
                localStorage.setItem(getStorageKey(char, 'rules'), JSON.stringify(rules));
            } catch (e) {
                console.warn('‰øùÂ≠òËßÑÂàôÂ§±Ë¥•:', e);
            }
        }
        
        // Âä†ËΩΩËßíËâ≤‰∏ìÂ±ûËßÑÂàô
        function loadCharacterRules(char) {
            try {
                const saved = localStorage.getItem(getStorageKey(char, 'rules'));
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('ËØªÂèñËßÑÂàôÂ§±Ë¥•:', e);
            }
            return [];
        }
        
        // Ëé∑ÂèñÂΩìÂâçËßíËâ≤ÁöÑÊâÄÊúâËßÑÂàôÔºàÂÖ®Â±Ä + ËßíËâ≤È¢ÑËÆæ + Áî®Êà∑Ëá™ÂÆö‰πâÔºâ
        function getAllRulesForCharacter(char) {
            const globalRules = CONFIG.GLOBAL_RULES.map(r => ({ ...r, isGlobal: true, isPreset: true }));
            // ËßíËâ≤È¢ÑËÆæËßÑÂàôÔºåËøáÊª§ÊéâÂ∑≤Âà†Èô§ÁöÑ
            const charPresetRules = (CONFIG.CHARACTER_PRESET_RULES[char] || [])
                .filter(r => !state.deletedPresetRules[`${char}:${r.id}`])
                .map(r => ({ ...r, isGlobal: false, isPreset: true }));
            const charRules = (state.characterRules[char] || []).map(r => ({ ...r, isGlobal: false, isPreset: false }));
            return [...globalRules, ...charPresetRules, ...charRules];
        }
        
        // Ê£ÄÊü•ÊãõÂºèÊòØÂê¶Ë¢´Á¶ÅÁî®ÔºàÁî®‰∫éÁâπÂÆöÁî®ÈÄîÔºâ
        function isMoveDisabled(move, usage, rules) {
            if (!move) return false;
            const moveName = (move.name || '').toUpperCase();
            
            for (const rule of rules) {
                if (rule.type === 'disable' && rule.moveName && rule.usage === usage) {
                    if (moveName === rule.moveName.toUpperCase()) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // Ê£ÄÊü•‰∏§‰∏™ÊãõÂºèÊòØÂê¶Ë¢´ËßÑÂàôÁ¶ÅÊ≠¢ÁªÑÂêà
        function isComboForbidden(move1, move2, rules) {
            if (!move1 || !move2) return false;
            const name1 = (move1.name || '').toUpperCase();
            const name2 = (move2.name || '').toUpperCase();
            
            for (const rule of rules) {
                // Á¶ÅÁî®ÁªÑÂêàËßÑÂàô
                if (rule.type === 'combo' && rule.move1 && rule.move2) {
                    const m1 = rule.move1.toUpperCase();
                    const m2 = rule.move2.toUpperCase();
                    // ÂèåÂêëÊ£ÄÊü•
                    if ((name1 === m1 && name2 === m2) || (name1 === m2 && name2 === m1)) {
                        return true;
                    }
                }
                // ÂÖºÂÆπÊóßÁöÑ pattern ËßÑÂàôÔºàÂÖ≥ÈîÆËØçÂåπÈÖçÔºâ
                else if (rule.pattern1 && rule.pattern2) {
                    const p1 = rule.pattern1.toUpperCase();
                    const p2 = rule.pattern2.toUpperCase();
                    if ((name1.includes(p1) && name2.includes(p2)) ||
                        (name1.includes(p2) && name2.includes(p1))) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // ========== Êî∂Ëóè/ÊúÄÂ∞èÂåñÁä∂ÊÄÅÂ≠òÂÇ® ==========
        function saveFavorites() {
            try {
                localStorage.setItem(getGlobalStorageKey('favorites'), JSON.stringify(state.favorites));
            } catch (e) {
                console.warn('‰øùÂ≠òÊî∂ËóèÁä∂ÊÄÅÂ§±Ë¥•:', e);
            }
        }
        
        function loadFavorites() {
            try {
                const saved = localStorage.getItem(getGlobalStorageKey('favorites'));
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                return {};
            }
        }
        
        function saveMinimized() {
            try {
                localStorage.setItem(getGlobalStorageKey('minimized'), JSON.stringify(state.minimized));
            } catch (e) {
                console.warn('‰øùÂ≠òÊúÄÂ∞èÂåñÁä∂ÊÄÅÂ§±Ë¥•:', e);
            }
        }
        
        function loadMinimized() {
            try {
                const saved = localStorage.getItem(getGlobalStorageKey('minimized'));
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                return {};
            }
        }

        // ==================== Ê†∏ÂøÉËÆ°ÁÆóÈÄªËæë ====================
        // Ëé∑ÂèñËßíËâ≤ÁöÑÂÆâÂÖ®Ë∑≥Â∏ßÊï∞Ë¶ÅÊ±Ç
        function getSafeJumpFrames(character) {
            return CONFIG.SAFE_JUMP_FRAMES[character] || CONFIG.SAFE_JUMP_FRAMES["DEFAULT"];
        }
        
        // Ê£ÄÊü•ÊñπÊ°àÊòØÂê¶‰∏∫ÂÆâÂÖ®Ë∑≥Êàñ‰º™ÂÆâÂÖ®Ë∑≥
        // ËøîÂõû: 'safe_jump' | 'pseudo_safe_jump' | null
        function checkSafeJump(plan, character) {
            if (!plan || plan.isThrow) return null;
            
            const safeJumpFrames = getSafeJumpFrames(character);
            
            // Áõ¥Êé•ÂéãÂà∂Êó∂Ôºåremain Â∞±ÊòØ advÔºàÊúâÂà©Â∏ßÊï∞Êú¨Ë∫´Ôºâ
            // Âç°Â∏ßÂêéÔºåremain ÊòØÂç°Â∏ßÂêéÂâ©‰ΩôÁöÑÂ∏ßÊï∞
            if (plan.remain === safeJumpFrames) {
                return 'safe_jump';
            } else if (plan.remain === safeJumpFrames - 1) {
                return 'pseudo_safe_jump';
            }
            
            return null;
        }
        
        // Ëé∑ÂèñÂÅ∑Â∏ßÊï∞ÁöÑÈ¢úËâ≤Á±ªÔºà‰∏é Hit/Block Â∏ßÊï∞‰∏ÄËá¥Ôºâ
        function getStolenColorClass(stolen) {
            if (stolen >= 3) return 'text-green-400';      // ÂÅ∑3Â∏ß‰ª•‰∏äÔºåÊ∑±Áªø
            if (stolen >= 1) return 'text-emerald-400';    // ÂÅ∑1-2Â∏ßÔºåÊµÖÁªø
            return 'text-yellow-400';                       // ÂÅ∑0Â∏ßÔºåÈªÑËâ≤
        }
        
        // Ëé∑ÂèñÂ∏ßÊï∞‰ºòÂäøÁöÑÈ¢úËâ≤Á±ª
        function getFrameColorClass(frames) {
            if (frames > 0) return 'text-cyan-400';         // Ê≠£Â∏ßÔºåÊµÖËìù
            if (frames === 0) return 'text-white';          // 0Â∏ßÔºåÁôΩËâ≤
            return 'text-rose-400';                         // Ë¥üÂ∏ßÔºåÁé´Áë∞Á∫¢
        }
        
        // Ê£ÄÊµãÂéãÂà∂ÊãõÂºèÁöÑÊîªÂáªÁ≠âÁ∫ßÔºöheavy / medium / light / other
        function getMoveStrength(move) {
            if (!move || !move.name) return 'other';
            const name = move.name.toUpperCase();
            // ÈáçÊîªÂáªÔºöHP, HKÔºàÂåÖÊã¨Â∏¶ÊñπÂêëÁöÑÂ¶Ç 6HP, 4HK Á≠âÔºâ
            if (name.includes('HP') || name.includes('HK')) return 'heavy';
            // ‰∏≠ÊîªÂáªÔºöMP, MK
            if (name.includes('MP') || name.includes('MK')) return 'medium';
            // ËΩªÊîªÂáªÔºöLP, LK
            if (name.includes('LP') || name.includes('LK')) return 'light';
            return 'other';
        }
        
        // Ëé∑ÂèñÊñπÊ°àÁöÑÂéãÂà∂ÊãõÂºèÁ≠âÁ∫ß
        function getPlanStrength(plan) {
            return getMoveStrength(plan.meatyMove);
        }

        function calculateBestPlan(adv) {
            const possiblePlans = [];
            // Ëé∑ÂèñÂΩìÂâçËßíËâ≤ÁöÑÊâÄÊúâËßÑÂàô
            const rules = getAllRulesForCharacter(state.currentCharacter);
            
            // ========== ÊñπÊ°àA: Áõ¥Êé•ÂéãÂà∂Ôºà‰∏çÈúÄË¶ÅÂç°Â∏ßÔºâ==========
            // ÂØπÊñπÂú® adv+1 Â∏ßËµ∑Ë∫´ÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÊãõÂºèÁöÑ active ËÉΩË¶ÜÁõñ
            const directTargetFrame = adv + 1;
            
            state.moveLibrary
                .filter(m => !m.isDash && m.active)
                .filter(m => !isMoveDisabled(m, 'meaty_direct', rules))  // ËøáÊª§Ë¢´Á¶ÅÁî®ÁöÑÁõ¥Êé•ÂéãÂà∂ÊãõÂºè
                .forEach(meatyMove => {
                    // ‰ΩøÁî®Êñ∞ÁöÑÂ§öÊÆµactiveÊ£ÄÊü•ÂáΩÊï∞
                    const hitInfo = checkActiveHit(meatyMove.active, directTargetFrame);
                    
                    if (hitInfo) {
                        // ÊäïÊäÄÁâπÊÆäÂ§ÑÁêÜÔºöÊ≤°Êúâ hit/block Ê¶ÇÂøµ
                        const isThrowPlan = meatyMove.isThrow === true;
                        
                        possiblePlans.push({
                            isDirect: true,  // Ê†áËÆ∞‰∏∫Áõ¥Êé•ÂéãÂà∂
                            isThrow: isThrowPlan,  // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÊäïÊäÄÊñπÊ°à
                            killMove: null,
                            killTotal: 0,
                            remain: adv,
                            meatyMove,
                            stolen: hitInfo.stolen,
                            finalHit: isThrowPlan ? null : (meatyMove.hit || 0) + hitInfo.stolen,
                            finalBlock: isThrowPlan ? null : (meatyMove.block || 0) + hitInfo.stolen
                        });
                    }
                });
            
            // ========== ÊñπÊ°àB: Âç°Â∏ßÂêéÂéãÂà∂ ==========
            state.moveLibrary.forEach(killMove => {
                // Ê£ÄÊü•ÊòØÂê¶Ë¢´Á¶ÅÁî®Áî®‰∫éÂç°Â∏ß
                if (isMoveDisabled(killMove, 'kill', rules)) return;
                
                // Dash Âè™ËÉΩÂç°Â∏ßÔºåÊ≤°Êúâ active Âà§Êñ≠
                if (killMove.isDash) {
                    const killTotal = killMove.dashFrames || 19;
                    if (killTotal >= adv) return;
                    
                    const remain = adv - killTotal;
                    const targetFrame = remain + 1;
                    
                    // Dash ÂêéÊé•ÂéãÂà∂ÊãõÂºè
                    state.moveLibrary
                        .filter(m => !m.isDash && m.active)
                        .filter(m => !isMoveDisabled(m, 'meaty_after_kill', rules))  // ËøáÊª§Ë¢´Á¶ÅÁî®ÁöÑÂç°Â∏ßÂêéÂéãÂà∂ÊãõÂºè
                        .forEach(meatyMove => {
                            const hitInfo = checkActiveHit(meatyMove.active, targetFrame);
                            if (hitInfo) {
                                const isThrowPlan = meatyMove.isThrow === true;
                                possiblePlans.push({
                                    isDirect: false,
                                    isThrow: isThrowPlan,
                                    killMove,
                                    killMove2: null,  // ÂçïÊ≠•Âç°Â∏ßÊó†Á¨¨‰∫åÊ≠•
                                    killTotal,
                                    killTotal2: 0,
                                    remain,
                                    meatyMove,
                                    stolen: hitInfo.stolen,
                                    finalHit: isThrowPlan ? null : (meatyMove.hit || 0) + hitInfo.stolen,
                                    finalBlock: isThrowPlan ? null : (meatyMove.block || 0) + hitInfo.stolen
                                });
                            }
                        });
                    return;
                }
                
                if (!killMove.active) return;
                
                // ÊôÆÈÄöÊãõÂºèÂç°Â∏ß
                const lastActive = getLastActiveFrame(killMove.active);
                const killTotal = lastActive + killMove.recovery;

                if (killTotal >= adv) return;

                const remain = adv - killTotal;
                const targetFrame = remain + 1;
                
                state.moveLibrary
                    .filter(m => !m.isDash && m.active)
                    .filter(m => !isMoveDisabled(m, 'meaty_after_kill', rules))  // ËøáÊª§Ë¢´Á¶ÅÁî®ÁöÑÂç°Â∏ßÂêéÂéãÂà∂ÊãõÂºè
                    .forEach(meatyMove => {
                        const hitInfo = checkActiveHit(meatyMove.active, targetFrame);
                        
                        if (hitInfo) {
                            // ‰ΩøÁî®ËßÑÂàôÁ≥ªÁªüÊ£ÄÊü•ÊòØÂê¶Á¶ÅÊ≠¢ÁªÑÂêà
                            if (isComboForbidden(killMove, meatyMove, rules)) {
                                return;
                            }
                            
                            const isThrowPlan = meatyMove.isThrow === true;
                            possiblePlans.push({
                                isDirect: false,
                                isThrow: isThrowPlan,
                                killMove,
                                killMove2: null,  // ÂçïÊ≠•Âç°Â∏ßÊó†Á¨¨‰∫åÊ≠•
                                killTotal,
                                killTotal2: 0,
                                remain,
                                meatyMove,
                                stolen: hitInfo.stolen,
                                finalHit: isThrowPlan ? null : (meatyMove.hit || 0) + hitInfo.stolen,
                                finalBlock: isThrowPlan ? null : (meatyMove.block || 0) + hitInfo.stolen
                            });
                        }
                    });
            });

            // ========== ÊñπÊ°àC: ‰∏§Ê≠•Âç°Â∏ßÂêéÂéãÂà∂ ==========
            state.moveLibrary.forEach(killMove1 => {
                // Ê£ÄÊü•Á¨¨‰∏ÄÊ≠•ÊòØÂê¶Ë¢´Á¶ÅÁî®Áî®‰∫éÂç°Â∏ß
                if (isMoveDisabled(killMove1, 'kill', rules)) return;
                
                // ËÆ°ÁÆóÁ¨¨‰∏ÄÊ≠•Âç°Â∏ßÊ∂àËÄó
                let killTotal1;
                if (killMove1.isDash) {
                    killTotal1 = killMove1.dashFrames || 19;
                } else if (killMove1.active) {
                    const lastActive1 = getLastActiveFrame(killMove1.active);
                    killTotal1 = lastActive1 + killMove1.recovery;
                } else {
                    return;
                }
                
                if (killTotal1 >= adv) return;
                const remain1 = adv - killTotal1;
                
                // ÈÅçÂéÜÁ¨¨‰∫åÊ≠•Âç°Â∏ßÊãõÂºè
                state.moveLibrary.forEach(killMove2 => {
                    // Ê£ÄÊü•Á¨¨‰∫åÊ≠•ÊòØÂê¶Ë¢´Á¶ÅÁî®Áî®‰∫éÂç°Â∏ß
                    if (isMoveDisabled(killMove2, 'kill', rules)) return;
                    
                    // ËÆ°ÁÆóÁ¨¨‰∫åÊ≠•Âç°Â∏ßÊ∂àËÄó
                    let killTotal2;
                    if (killMove2.isDash) {
                        killTotal2 = killMove2.dashFrames || 19;
                    } else if (killMove2.active) {
                        const lastActive2 = getLastActiveFrame(killMove2.active);
                        killTotal2 = lastActive2 + killMove2.recovery;
                    } else {
                        return;
                    }
                    
                    if (killTotal2 >= remain1) return;
                    const remain2 = remain1 - killTotal2;
                    const targetFrame2 = remain2 + 1;
                    
                    // ‰ΩøÁî®ËßÑÂàôÁ≥ªÁªüÊ£ÄÊü•Á¨¨‰∏ÄÊ≠•+Á¨¨‰∫åÊ≠•ÊòØÂê¶Á¶ÅÊ≠¢ÁªÑÂêà
                    if (isComboForbidden(killMove1, killMove2, rules)) {
                        return;
                    }
                    
                    // ÊâæÂéãÂà∂ÊãõÂºè
                    state.moveLibrary
                        .filter(m => !m.isDash && m.active)
                        .filter(m => !isMoveDisabled(m, 'meaty_after_kill', rules))  // ËøáÊª§Ë¢´Á¶ÅÁî®ÁöÑÂç°Â∏ßÂêéÂéãÂà∂ÊãõÂºè
                        .forEach(meatyMove => {
                            const hitInfo = checkActiveHit(meatyMove.active, targetFrame2);
                            
                            if (hitInfo) {
                                // ‰ΩøÁî®ËßÑÂàôÁ≥ªÁªüÊ£ÄÊü•Á¨¨‰∫åÊ≠•+ÂéãÂà∂ÊòØÂê¶Á¶ÅÊ≠¢ÁªÑÂêà
                                if (isComboForbidden(killMove2, meatyMove, rules)) {
                                    return;
                                }
                                
                                const isThrowPlan = meatyMove.isThrow === true;
                                possiblePlans.push({
                                    isDirect: false,
                                    isThrow: isThrowPlan,
                                    killMove: killMove1,
                                    killMove2: killMove2,  // ‰∏§Ê≠•Âç°Â∏ß
                                    killTotal: killTotal1,
                                    killTotal2: killTotal2,
                                    remain: remain2,
                                    meatyMove,
                                    stolen: hitInfo.stolen,
                                    finalHit: isThrowPlan ? null : (meatyMove.hit || 0) + hitInfo.stolen,
                                    finalBlock: isThrowPlan ? null : (meatyMove.block || 0) + hitInfo.stolen
                                });
                            }
                        });
                });
            });

            // ========== Ê†áËÆ∞‰∏§Ê≠•Âç°Â∏ßÊòØÂê¶ÂèØ‰∫§Êç¢È°∫Â∫è ==========
            // Ê£ÄÊµãÊØè‰∏™‰∏§Ê≠•Âç°Â∏ßÊñπÊ°àÔºåÂ¶ÇÊûúÂèçÂêëÁªÑÂêà‰πüÂ≠òÂú®ÔºåÂàôÊ†áËÆ∞‰∏∫ÂèØ‰∫§Êç¢
            possiblePlans.forEach(plan => {
                if (plan.killMove2) {
                    // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÂèçÂêëÁªÑÂêàÔºàkillMove2 ‚Üí killMove1 ‚Üí ÂêåÊ†∑ÁöÑÂéãÂà∂Ôºâ
                    const hasReverse = possiblePlans.some(otherPlan => 
                        otherPlan.killMove2 &&
                        otherPlan !== plan &&
                        otherPlan.killMove.name === plan.killMove2.name &&
                        otherPlan.killMove2.name === plan.killMove.name &&
                        otherPlan.meatyMove.name === plan.meatyMove.name &&
                        otherPlan.remain === plan.remain
                    );
                    // Ê†áËÆ∞ÊòØÂê¶ÂèØ‰∫§Êç¢
                    plan.isCommutative = hasReverse;
                }
            });

            // Êåâ finalBlock ÈôçÂ∫èÔºåÂÜçÊåâ finalHit ÈôçÂ∫èÔºàÊäïÊäÄÊñπÊ°àÊéíÂú®ÊôÆÈÄöÊñπÊ°à‰πãÂêéÔºâ
            return possiblePlans.sort((a, b) => {
                // ÊäïÊäÄÊñπÊ°àÁªü‰∏ÄÊîæÂêéÈù¢
                if (a.isThrow !== b.isThrow) return a.isThrow ? 1 : -1;
                // ÈùûÊäïÊäÄÊñπÊ°àÔºöÊåâ block > hit ÊéíÂ∫è
                if (!a.isThrow && !b.isThrow) {
                    if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                    return b.finalHit - a.finalHit;
                }
                // ÊäïÊäÄÊñπÊ°àÔºöÁõ¥Êé•ÂéãÂà∂‰ºòÂÖà
                return (b.isDirect ? 1 : 0) - (a.isDirect ? 1 : 0);
            });
        }

        // ==================== Êï∞ÊçÆÂä†ËΩΩ ====================
        // ‰ªéÂÖ®Â±Ä CHARACTER_DATA Âä†ËΩΩËßíËâ≤Êï∞ÊçÆÔºàÁî±Â§ñÈÉ® .js Êñá‰ª∂Â°´ÂÖÖÔºâ
        function loadCharacterData(char) {
            console.log(`[Âä†ËΩΩ] ËßíËâ≤: ${char}`);
            
            // 1. ‰ºòÂÖà‰ªé localStorage Âä†ËΩΩÁî®Êà∑‰øùÂ≠òÁöÑÊï∞ÊçÆ
            const savedMoves = loadMovesFromStorage(char);
            if (savedMoves && savedMoves.length > 0) {
                console.log(`[localStorage] ‰ΩøÁî®Áî®Êà∑‰øùÂ≠òÁöÑÊãõÂºèÊï∞ÊçÆ: ${savedMoves.length} ‰∏™`);
                state.moveLibrary = savedMoves;
                state.characterCache[char] = {
                    moves: savedMoves,
                    scenarios: CHARACTER_DATA[char]?.scenarios || []
                };
                return true;
            }
            
            // 2. Ê£ÄÊü•ÂÜÖÂ≠òÁºìÂ≠ò
            if (state.characterCache[char]?.moves?.length > 0) {
                console.log(`[ÁºìÂ≠ò] ‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆ`);
                state.moveLibrary = [...state.characterCache[char].moves];
                return true;
            }

            // 3. ‰ªéÂÖ®Â±ÄÂèòÈáèËØªÂèñÔºàÁî± <script src="xxx.js"> Âä†ËΩΩÔºâ
            const data = CHARACTER_DATA[char];
            
            if (data && data.moves) {
                state.characterCache[char] = {
                    moves: [...data.moves],
                    scenarios: data.scenarios ? [...data.scenarios] : []
                };
                state.moveLibrary = [...data.moves];
                console.log(`[ÊàêÂäü] Âä†ËΩΩÈ¢ÑËÆæ ${data.moves.length} ‰∏™ÊãõÂºè, ${data.scenarios?.length || 0} ‰∏™Âú∫ÊôØ`);
                return true;
            } else {
                console.warn(`[Ë≠¶Âëä] Êú™ÊâæÂà∞ ${char} ÁöÑÊï∞ÊçÆÔºåËØ∑Á°Æ‰øùÂ∑≤Âä†ËΩΩÂØπÂ∫îÁöÑ .js Êñá‰ª∂`);
                state.moveLibrary = [];
                state.characterCache[char] = { moves: [], scenarios: [] };
                return false;
            }
        }

        // ==================== ËßíËâ≤ÂàáÊç¢ ====================
        function selectCharacter(char) {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊï∞ÊçÆÔºåÊó†Êï∞ÊçÆËßíËâ≤‰∏çÂèØÈÄâ
            const hasData = CONFIG.CHARACTERS_WITH_DATA.includes(char);
            if (!hasData) {
                console.log(`[ËßíËâ≤] ${char} ÊöÇÊó†Êï∞ÊçÆÔºåÊó†Ê≥ïÈÄâÊã©`);
                return; // ÈòªÊ≠¢ÈÄâÊã©
            }
            
            state.currentCharacter = char;
            
            // Ê∏ÖÁ©∫Â±ïÂºÄÁä∂ÊÄÅ
            state.expandedAdvSet.clear();
            state.allDetailsExpanded = false;
            updateToggleAllBtn();
            
            // ÈáçÁΩÆÊî∂ËóèÁ≠õÈÄâÁä∂ÊÄÅ
            state.showOnlyFavorites = false;
            updateShowFavoritesBtn();
            
            // ‰øùÂ≠òÂΩìÂâçËßíËâ≤ÈÄâÊã©Âà∞ localStorage
            saveCurrentCharacter(char);
            
            // Â∫îÁî®ËßíËâ≤‰∏ªÈ¢ò
            applyTheme(char);
            
            // Êõ¥Êñ∞UI - Âè™Êõ¥Êñ∞ÂõæÊ†á
            document.getElementById('currentCharIcon').textContent = getCharIcon(char);
            
            // Âä†ËΩΩËßíËâ≤Êï∞ÊçÆ (moves + scenarios)
            loadCharacterData(char);
            
            // Âä†ËΩΩ scenarios: È¢ÑËÆæ + Áî®Êà∑Ëá™ÂÆö‰πâ
            state.notes = loadAllScenarios(char);
            
            // Âä†ËΩΩËßíËâ≤‰∏ìÂ±ûËßÑÂàô
            state.characterRules[char] = loadCharacterRules(char);
            
            // Êõ¥Êñ∞Â∞ÅÊù°ÊªöÂä®ÂÜÖÂÆπ
            updateMarqueeTape();
            
            closeCharModal();
            renderAll();
            
            // Ëá™Âä®Ëß¶ÂèëÊ†áÈ¢ò Glitch ÊïàÊûú
            triggerTitleGlitch();
            // Ëß¶ÂèëËßíËâ≤ÊåâÈíÆÂä®Áîª
            triggerCharBtnAnimation();
        }
        
        // Ëß¶ÂèëÊ†áÈ¢ò Glitch ÊïàÊûú
        function triggerTitleGlitch() {
            const title = document.querySelector('.glitch-hover');
            if (title) {
                title.classList.add('glitch-active');
                setTimeout(() => {
                    title.classList.remove('glitch-active');
                }, 1000);
            }
        }
        
        // Ëß¶ÂèëËßíËâ≤ÊåâÈíÆÂä®Áîª
        function triggerCharBtnAnimation() {
            const btn = document.querySelector('.champion-btn');
            if (btn) {
                btn.classList.remove('char-switch-active');
                // Âº∫Âà∂ÈáçÁªò‰ª•ÈáçÊñ∞Ëß¶ÂèëÂä®Áîª
                void btn.offsetWidth;
                btn.classList.add('char-switch-active');
                setTimeout(() => {
                    btn.classList.remove('char-switch-active');
                }, 800);
            }
        }

        function initCharacterGrid() {
            const grid = document.getElementById('charGrid');
            grid.innerHTML = CONFIG.ALL_CHARACTERS.map(char => {
                const hasData = CONFIG.CHARACTERS_WITH_DATA.includes(char);
                const isSelected = char === state.currentCharacter;
                
                // Êó†Êï∞ÊçÆËßíËâ≤‰∏çÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                const clickHandler = hasData ? `onclick="selectCharacter('${char}')"` : '';
                
                return `
                    <div class="char-item ${isSelected ? 'selected' : ''} ${!hasData ? 'no-data' : ''}" 
                         ${clickHandler}
                         title="${hasData ? 'ÁÇπÂáªÈÄâÊã©' : 'ÊöÇÊó†Êï∞ÊçÆ'}">
                        <div class="char-icon">${getCharIcon(char)}</div>
                        <div class="char-name">${char}</div>
                    </div>
                `;
            }).join('');
        }

        // ==================== Ê∏≤ÊüìÂáΩÊï∞ ====================
        // ËΩ¨‰πâÂ≠óÁ¨¶‰∏≤‰ª•ÂÆâÂÖ®ÂµåÂÖ•Âà∞JSÂ≠óÁ¨¶‰∏≤‰∏≠ÔºàÈò≤Ê≠¢XSSÔºâ
        function escapeJsString(str) {
            if (!str) return '';
            return str.replace(/\\/g, '\\\\')
                      .replace(/'/g, "\\'")
                      .replace(/"/g, '\\"')
                      .replace(/`/g, '\\`')
                      .replace(/\$/g, '\\$');
        }
        
        // ÁîüÊàêÊñπÊ°àÂîØ‰∏ÄÊ†áËØÜÔºàÁî®‰∫éÂéªÈáçÔºâ
        function getPlanKey(plan) {
            if (!plan) return '';
            const kill1Name = plan.killMove ? plan.killMove.name : 'DIRECT';
            const kill2Name = plan.killMove2 ? plan.killMove2.name : '';
            return `${kill1Name}|${kill2Name}|${plan.meatyMove.name}`;
        }
        
        // Ëé∑ÂèñÂÆâÂÖ®ÁöÑplanKeyÔºàÁî®‰∫éÂµåÂÖ•HTMLÂ±ûÊÄßÔºâ
        function getSafePlanKey(plan) {
            return escapeJsString(getPlanKey(plan));
        }

        // ÁîüÊàêÊé®ËçêÁêÜÁî±ËØ¥ÊòéÊñáÊú¨
        function getRecommendReasons(plan, reasons) {
            if (!reasons || reasons.length === 0) return '';
            
            const reasonTexts = {
                'safe_jump': 'ü¶ò ÂÆâÂÖ®Ë∑≥ÂéãÂà∂ÔºåÈò≤5Â∏ßÂèä‰ª•‰∏äÂáπÊãõ',
                'pseudo_safe_jump': 'ü¶ò ‰º™ÂÆâÂÖ®Ë∑≥ÂéãÂà∂ÔºåÈò≤6Â∏ßÂèä‰ª•‰∏äÂáπÊãõ',
                'best_block': 'üõ°Ô∏è ÊâìÈò≤Êî∂ÁõäÊúÄ‰ºò',
                'best_hit': '‚öîÔ∏è ÂëΩ‰∏≠Êî∂ÁõäÊúÄ‰ºò',
                'best_nonheavy_block': 'üéØ ‰∏≠/Âº±ÊîªÂáªÊâìÈò≤ÊúÄ‰ºò',
                'best_nonheavy_hit': 'üéØ ‰∏≠/Âº±ÊîªÂáªÂëΩ‰∏≠ÊúÄ‰ºò',
                'most_stolen': '‚è±Ô∏è ÂÅ∑Â∏ßÊúÄÂ§ö',
                'throw': 'ü§º ÊäïÊäÄÊñπÊ°à',
                'mixup': 'üé≤ ÊâìÊäï‰∫åÊã©',
                'favorite': '‚≠ê Áî®Êà∑Êî∂Ëóè',
                'prefer': 'üëç Áî®Êà∑ËßÑÂàôÂÄæÂêëÂéãÂà∂'  // Âä®ÊÄÅÊ∑ªÂä†ÊãõÂºèÂêç
            };
            
            // ËøáÊª§ËßÑÂàôÔºöÂ¶ÇÊûúÂêåÊó∂Êª°Ë∂≥1Âíå3ÔºåÂè™ÊòæÁ§∫1ÔºõÂêåÊó∂Êª°Ë∂≥2Âíå4ÔºåÂè™ÊòæÁ§∫2
            let filteredReasons = [...reasons];
            if (reasons.includes('best_block') && reasons.includes('best_nonheavy_block')) {
                filteredReasons = filteredReasons.filter(r => r !== 'best_nonheavy_block');
            }
            if (reasons.includes('best_hit') && reasons.includes('best_nonheavy_hit')) {
                filteredReasons = filteredReasons.filter(r => r !== 'best_nonheavy_hit');
            }
            
            return filteredReasons.map(r => {
                if (r.startsWith('prefer:')) {
                    const moveName = r.split(':')[1];
                    return `üëç Áî®Êà∑ËßÑÂàôÂÄæÂêëÂéãÂà∂Ôºö${moveName}`;
                }
                return reasonTexts[r] || '';
            }).filter(t => t).join('\n');
        }

        // ÁîüÊàêÊñπÊ°àÂ§çÂà∂ÊñáÊú¨
        function generatePlanCopyText(plan, adv, label) {
            // Ëé∑ÂèñÊâÄÊúâÂú∫ÊôØÊèèËø∞ÔºåÁî®"/"ËøûÊé•Â§ö‰∏™Âú∫ÊôØ
            const contexts = state.notes.filter(n => n.adv === adv && n.context).map(n => n.context);
            const contextStr = contexts.length > 0 ? contexts.join('/') : '';
            
            // ÁîüÊàêÊñπÊ°àÊèèËø∞
            let planDesc;
            if (plan.isDirect) {
                planDesc = `Áõ¥Êé• ${plan.meatyMove.name}`;
            } else if (plan.killMove2) {
                const separator = plan.isCommutative ? '+' : '‚Üí';
                planDesc = `${plan.killMove.name}${separator}${plan.killMove2.name}‚Üí${plan.meatyMove.name}`;
            } else {
                planDesc = `${plan.killMove.name}‚Üí${plan.meatyMove.name}`;
            }
            
            // Ê†πÊçÆÊ†áÁ≠æÁ±ªÂûãÁîüÊàê‰∏çÂêåÊ†ºÂºè
            let result;
            if (label === 'ÊâìÊäïÊã©') {
                result = `+${adv}F ${contextStr}Ôºö${planDesc} ‚Äî‚Äî ${plan.remain}F ÊâìÊäïÊã©`;
            } else if (plan.isThrow) {
                result = `+${adv}F ${contextStr}Ôºö${planDesc} ‚Äî‚Äî ÊäïÊäÄÊîæÂÄí`;
            } else {
                const hitStr = plan.finalHit >= 0 ? `+${plan.finalHit}` : plan.finalHit;
                const blockStr = plan.finalBlock >= 0 ? `+${plan.finalBlock}` : plan.finalBlock;
                result = `+${adv}F ${contextStr}Ôºö${planDesc} ‚Äî‚Äî ÂÅ∑${plan.stolen}FÔºåÊâì‰∏≠${hitStr}ÔºåÊâìÈò≤${blockStr}`;
            }
            
            // ËΩ¨‰πâÁâπÊÆäÂ≠óÁ¨¶ÔºåÁ°Æ‰øùÂÆâÂÖ®
            return result.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }
        
        // Â§çÂà∂ÊñπÊ°à‰ø°ÊÅØÂà∞Ââ™Ë¥¥Êùø
        function copyPlanInfo(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Â∑≤Â§çÂà∂ÊñπÊ°à‰ø°ÊÅØ');
            }).catch(err => {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                showToast('Â§çÂà∂Â§±Ë¥•');
            });
        }
        
        // Ê∏≤Êüì‰∏ªË¶ÅÊñπÊ°àÔºàÁ¥ßÂáëÁâàÔºåÂ∏¶Êî∂ËóèÂíåÊúÄÂ∞èÂåñÊåâÈíÆÔºâ
        function renderMainPlan(plan, label, adv, reasons = []) {
            if (!plan) return '';
            
            const planKey = getPlanKey(plan);
            const safePlanKey = getSafePlanKey(plan);  // Áî®‰∫éÂµåÂÖ•HTML
            const isFavorite = isPlanFavorite(adv, planKey);
            const isThrow = plan.isThrow;
            const accentColor = 'text-white';
            
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÂÆâÂÖ®Ë∑≥/‰º™ÂÆâÂÖ®Ë∑≥
            const isSafeJump = reasons.includes('safe_jump');
            const isPseudoSafeJump = reasons.includes('pseudo_safe_jump');
            const safeJumpLabel = isSafeJump ? 'ÂÆâÂÖ®Ë∑≥' : (isPseudoSafeJump ? '‰º™ÂÆâÂÖ®Ë∑≥' : null);
            const safeJumpColor = isSafeJump ? 'text-green-400' : 'text-yellow-400';
            
            // ÁîüÊàêÊé®ËçêÁêÜÁî±ÊèêÁ§∫
            const recommendReasons = getRecommendReasons(plan, reasons);
            const tooltipHtml = recommendReasons ? `<div class="recommend-tooltip">${recommendReasons.replace(/\n/g, '<br>')}</div>` : '';
            
            // ÂÆâÂÖ®Ë∑≥‰ΩøÁî®ÁâπÊÆäËæπÊ°ÜÈ¢úËâ≤
            let borderColor, bgColor;
            if (isFavorite) {
                borderColor = 'border-yellow-500';
                bgColor = 'bg-yellow-900/10';
            } else if (isSafeJump) {
                borderColor = 'border-green-600';
                bgColor = 'bg-green-900/10';
            } else if (isPseudoSafeJump) {
                borderColor = 'border-yellow-600';
                bgColor = 'bg-yellow-900/5';
            } else {
                borderColor = 'border-zinc-800';
                bgColor = 'bg-zinc-900/50';
            }
            
            let stepsHtml;
            
            const stolenColor = getStolenColorClass(plan.stolen);
            
            if (plan.isDirect) {
                // Áõ¥Êé•ÂéãÂà∂/Êäï
                stepsHtml = `<div class="text-center">
                       <div class="text-[9px] text-zinc-600 uppercase mb-1">Áõ¥Êé•${isThrow ? 'Êäï' : ''} (${plan.remain}F)</div>
                       <div class="impact-text text-4xl sm:text-5xl font-black ${accentColor} leading-none glitch-text">${plan.meatyMove.name}</div>
                       ${!isThrow ? `<div class="text-xs mt-1"><span class="text-zinc-500">ÂÅ∑</span><span class="${stolenColor} font-bold">${plan.stolen}F</span></div>` : ''}
                   </div>`;
            } else if (plan.killMove2) {
                // ‰∏§Ê≠•Âç°Â∏ß
                const remain1 = adv - plan.killTotal;
                const separator = plan.isCommutative ? '+' : '‚Üí';  // ÂèØ‰∫§Êç¢Áî®+ÔºåÊúâÈ°∫Â∫èÈôêÂà∂Áî®‚Üí
                
                // ÂÆâÂÖ®Ë∑≥Êó∂ÊúÄÂêéÊòæÁ§∫"ÂÆâÂÖ®Ë∑≥"ËÄå‰∏çÊòØÊãõÂºèÂêç
                const finalDisplay = safeJumpLabel 
                    ? `<div class="impact-text text-xl sm:text-2xl font-black ${safeJumpColor} leading-none">${safeJumpLabel}</div>`
                    : `<div class="impact-text text-xl sm:text-2xl font-black ${accentColor} leading-none glitch-text">${plan.meatyMove.name}</div>
                       ${!isThrow ? `<div class="text-[9px]"><span class="text-zinc-500">ÂÅ∑</span><span class="${stolenColor} font-bold">${plan.stolen}F</span></div>` : ''}`;
                
                stepsHtml = `<div class="flex items-center justify-center gap-2 sm:gap-3 flex-wrap">
                       <div class="text-center min-w-[55px]">
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.killMove.name}</div>
                           <div class="text-[9px] text-zinc-500">-${plan.killTotal}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-lg">${separator}</div>
                           <div class="text-[9px] text-yellow-500">${remain1}F</div>
                       </div>
                       <div class="text-center min-w-[55px]">
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.killMove2.name}</div>
                           <div class="text-[9px] text-zinc-500">-${plan.killTotal2}F</div>
                       </div>
                       <div class="text-zinc-600 text-lg">‚Üí</div>
                       <div class="text-center min-w-[55px]">
                           ${finalDisplay}
                       </div>
                   </div>`;
            } else {
                // ‰∏ÄÊ≠•Âç°Â∏ß
                // ÂÆâÂÖ®Ë∑≥Êó∂ÊúÄÂêéÊòæÁ§∫"ÂÆâÂÖ®Ë∑≥"ËÄå‰∏çÊòØÊãõÂºèÂêç
                const finalDisplay = safeJumpLabel 
                    ? `<div class="impact-text text-2xl sm:text-4xl font-black ${safeJumpColor} leading-none">${safeJumpLabel}</div>`
                    : `<div class="impact-text text-2xl sm:text-4xl font-black ${accentColor} leading-none glitch-text">${plan.meatyMove.name}</div>
                       ${!isThrow ? `<div class="text-[10px]"><span class="text-zinc-500">ÂÅ∑</span><span class="${stolenColor} font-bold">${plan.stolen}F</span></div>` : ''}`;
                
                stepsHtml = `<div class="flex items-center justify-center gap-3 sm:gap-5">
                       <div class="text-center min-w-[70px]">
                           <div class="impact-text text-2xl sm:text-4xl font-black text-white leading-none">${plan.killMove.name}</div>
                           <div class="text-[10px] text-zinc-500">-${plan.killTotal}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-xl sm:text-2xl">‚Üí</div>
                           <div class="text-[9px] text-yellow-500">${plan.remain}F</div>
                       </div>
                       <div class="text-center min-w-[70px]">
                           ${finalDisplay}
                       </div>
                   </div>`;
            }

            // ÊäïÊäÄÊòæÁ§∫"ÊîæÂÄí"ÔºåÊôÆÈÄöÊãõÂºèÊòæÁ§∫ Hit/Block
            const hitColor = getFrameColorClass(plan.finalHit);
            const blockColor = getFrameColorClass(plan.finalBlock);
            const statsHtml = isThrow 
                ? `<span class="text-zinc-400 text-xs">ÊîæÂÄí</span>`
                : `<span class="text-sm text-zinc-500">H</span><span class="text-lg font-bold ${hitColor} ml-1">${plan.finalHit >= 0 ? '+' : ''}${plan.finalHit}</span>
                   <span class="text-sm text-zinc-500 ml-3">B</span><span class="text-lg font-bold ${blockColor} ml-1">${plan.finalBlock >= 0 ? '+' : ''}${plan.finalBlock}</span>`;

            // Êî∂ËóèÊòüÂíåÊúÄÂ∞èÂåñÊåâÈíÆ
            const starIcon = isFavorite ? '‚òÖ' : '‚òÜ';
            const starClass = isFavorite ? 'text-yellow-400' : 'text-zinc-400 hover:text-yellow-400';
            
            // Êî∂ËóèÂç∞Á´†
            const stampHtml = isFavorite ? '<div class="favorite-stamp">FAVE</div>' : '';
            
            // ÊñπÊ°àÊ†áÁ≠æÔºàÂ¶Ç"ÊâìÊäïÊã©"Ôºâ
            const labelHtml = label ? `<div class="absolute top-1 left-1 sm:top-2 sm:left-2 text-[9px] font-bold px-1.5 py-0.5 bg-amber-600/80 text-white uppercase">${label}</div>` : '';

            // ÁîüÊàêÂ§çÂà∂ÊñáÊú¨
            const copyText = generatePlanCopyText(plan, adv, label);
            
            return `
                <div class="mb-3 p-4 border ${borderColor} ${bgColor} relative group overflow-visible recommend-card">
                    ${stampHtml}
                    ${labelHtml}
                    ${tooltipHtml}
                    <div class="absolute top-1 right-1 sm:top-2 sm:right-2 flex gap-1 opacity-80 group-hover:opacity-100 transition-opacity">
                        <button onclick="copyPlanInfo(\`${copyText}\`)" class="text-zinc-500 hover:text-cyan-400 text-base sm:text-sm p-2 sm:p-1 transition-colors opacity-70 hover:opacity-100" title="Â§çÂà∂ÊñπÊ°à">üìã</button>
                        <button onclick="toggleFavorite(${adv}, '${safePlanKey}')" class="${starClass} text-xl sm:text-lg p-2 sm:p-1 transition-colors" title="Êî∂Ëóè">${starIcon}</button>
                        <button onclick="minimizePlan(${adv}, '${safePlanKey}')" class="text-zinc-400 hover:text-zinc-200 text-base sm:text-sm p-2 sm:p-1 transition-colors" title="ÊäòÂè†Ëá≥Â§áÈÄâ">‚ñº</button>
                    </div>
                    <div class="mb-2">
                        ${stepsHtml}
                    </div>
                    <div class="text-center border-t border-zinc-800/50 pt-2">
                        ${statsHtml}
                    </div>
                </div>
            `;
        }

        // Ê∏≤ÊüìÂ§áÈÄâÊñπÊ°àÔºàÂèØÂ±ïÂºÄËØ¶ÊÉÖÔºåÂ∏¶ÊúÄÂ§ßÂåñÊåâÈíÆÔºâ
        function renderAltPlan(plan, adv) {
            if (!plan) return '';
            
            const planKey = getPlanKey(plan);
            const safePlanKey = getSafePlanKey(plan);  // Áî®‰∫éÂµåÂÖ•HTML
            const isFavorite = isPlanFavorite(adv, planKey);
            
            let desc;
            if (plan.isDirect) {
                desc = `Áõ¥Êé• ${plan.meatyMove.name}`;
            } else if (plan.killMove2) {
                const separator = plan.isCommutative ? '+' : '‚Üí';
                desc = `${plan.killMove.name} ${separator} ${plan.killMove2.name} ‚Üí ${plan.meatyMove.name}`;
            } else {
                desc = `${plan.killMove.name} ‚Üí ${plan.meatyMove.name}`;
            }
            
            // ÁîüÊàêÂ±ïÂºÄÂêéÁöÑËØ¶ÊÉÖ
            let detailHtml = renderAltPlanDetail(plan, adv);
            
            // Êî∂ËóèÊòüÊ†∑Âºè
            const starIcon = isFavorite ? '‚òÖ' : '‚òÜ';
            const starClass = isFavorite ? 'text-yellow-400' : 'text-zinc-400 hover:text-yellow-400';
            const rowBg = isFavorite ? 'bg-yellow-900/10' : '';

            const stolenColorAlt = getStolenColorClass(plan.stolen);
            
            // ÁîüÊàêÂ§çÂà∂ÊñáÊú¨
            const copyText = generatePlanCopyText(plan, adv, '');
            
            return `
                <details class="border-b border-zinc-800/50 ${rowBg}">
                    <summary class="flex items-center justify-between py-2 cursor-pointer hover:bg-zinc-800/30 transition-colors group">
                        <span class="text-sm text-zinc-400">${desc}</span>
                        <div class="flex gap-1 sm:gap-2 text-sm font-bold items-center">
                            <span class="${stolenColorAlt} text-xs sm:text-sm">ÂÅ∑${plan.stolen}F</span>
                            <span class="${getFrameColorClass(plan.finalHit)} text-xs sm:text-sm">H${plan.finalHit >= 0 ? '+' : ''}${plan.finalHit}</span>
                            <span class="${getFrameColorClass(plan.finalBlock)} text-xs sm:text-sm">B${plan.finalBlock >= 0 ? '+' : ''}${plan.finalBlock}</span>
                            <button onclick="event.stopPropagation(); copyPlanInfo(\`${copyText}\`)" class="text-zinc-500 hover:text-cyan-400 transition-colors p-1.5 sm:p-1 text-base sm:text-sm opacity-70 hover:opacity-100" title="Â§çÂà∂ÊñπÊ°à">üìã</button>
                            <button onclick="event.stopPropagation(); toggleFavorite(${adv}, '${safePlanKey}')" class="${starClass} transition-colors p-1.5 sm:p-1 text-base sm:text-sm" title="Êî∂Ëóè">${starIcon}</button>
                            <button onclick="event.stopPropagation(); maximizePlan(${adv}, '${safePlanKey}')" class="text-zinc-400 hover:text-zinc-200 transition-colors p-1.5 sm:p-1 text-base sm:text-sm" title="ÁΩÆÈ°∂ÊòæÁ§∫">‚ñ≤</button>
                        </div>
                    </summary>
                    <div class="py-2 px-2 bg-zinc-800/20">
                        ${detailHtml}
                    </div>
                </details>
            `;
        }
        
        // Ê∏≤ÊüìÂ§áÈÄâÊñπÊ°àÂ±ïÂºÄËØ¶ÊÉÖ
        function renderAltPlanDetail(plan, adv) {
            const isThrow = plan.isThrow;
            const stolenColorDetail = getStolenColorClass(plan.stolen);
            
            let stepsHtml;
            
            if (plan.isDirect) {
                stepsHtml = `<div class="text-center">
                       <div class="text-[10px] text-zinc-600 uppercase mb-2">Áõ¥Êé•${isThrow ? 'Êäï' : 'ÂéãÂà∂'} (Ââ©‰Ωô ${plan.remain}F)</div>
                       <div class="impact-text text-3xl sm:text-4xl font-black text-white leading-none">${plan.meatyMove.name}</div>
                       ${!isThrow ? `<div class="text-sm mt-2"><span class="text-zinc-500">ÂÅ∑</span><span class="${stolenColorDetail} font-bold">${plan.stolen}F</span></div>` : ''}
                   </div>`;
            } else if (plan.killMove2) {
                const remain1 = adv - plan.killTotal;
                const separator = plan.isCommutative ? '+' : '‚Üí';
                
                stepsHtml = `<div class="flex items-center justify-center gap-2 sm:gap-3 flex-wrap">
                       <div class="text-center min-w-[60px]">
                           <div class="text-[9px] text-zinc-600 uppercase mb-1">Âç°Â∏ß‚ë†</div>
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.killMove.name}</div>
                           <div class="text-[10px] text-zinc-500 mt-1">-${plan.killTotal}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-lg">${separator}</div>
                           <div class="text-[9px] text-yellow-500">${remain1}F</div>
                       </div>
                       <div class="text-center min-w-[60px]">
                           <div class="text-[9px] text-zinc-600 uppercase mb-1">Âç°Â∏ß‚ë°</div>
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.killMove2.name}</div>
                           <div class="text-[10px] text-zinc-500 mt-1">-${plan.killTotal2}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-lg">‚Üí</div>
                           <div class="text-[9px] text-yellow-500">${plan.remain}F</div>
                       </div>
                       <div class="text-center min-w-[60px]">
                           <div class="text-[9px] text-zinc-500 uppercase mb-1">${isThrow ? 'Êäï' : 'ÂéãÂà∂'}</div>
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.meatyMove.name}</div>
                           ${!isThrow ? `<div class="text-[10px] mt-1"><span class="text-zinc-500">ÂÅ∑</span><span class="${stolenColorDetail} font-bold">${plan.stolen}F</span></div>` : ''}
                       </div>
                   </div>`;
            } else {
                stepsHtml = `<div class="flex items-center justify-center gap-3 sm:gap-5">
                       <div class="text-center min-w-[70px]">
                           <div class="text-[9px] text-zinc-600 uppercase mb-1">Âç°Â∏ß</div>
                           <div class="impact-text text-2xl sm:text-3xl font-black text-white leading-none">${plan.killMove.name}</div>
                           <div class="text-xs text-zinc-500 mt-1">-${plan.killTotal}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-xl">‚Üí</div>
                           <div class="text-[10px] text-yellow-500">Ââ©${plan.remain}F</div>
                       </div>
                       <div class="text-center min-w-[70px]">
                           <div class="text-[9px] text-zinc-500 uppercase mb-1">${isThrow ? 'Êäï' : 'ÂéãÂà∂'}</div>
                           <div class="impact-text text-2xl sm:text-3xl font-black text-white leading-none">${plan.meatyMove.name}</div>
                           ${!isThrow ? `<div class="text-xs mt-1"><span class="text-zinc-500">ÂÅ∑</span><span class="${stolenColorDetail} font-bold">${plan.stolen}F</span></div>` : ''}
                       </div>
                   </div>`;
            }

            const statsHtml = isThrow 
                ? `<div class="text-center text-zinc-400 text-xs font-bold mt-3">
                       ÊîæÂÄí
                   </div>`
                : `<div class="flex justify-center gap-6 mt-3">
                       <div class="text-center">
                           <span class="text-xs text-zinc-600 uppercase">Hit</span>
                           <span class="text-xl font-black ${getFrameColorClass(plan.finalHit)} ml-1">${plan.finalHit >= 0 ? '+' : ''}${plan.finalHit}</span>
                       </div>
                       <div class="text-center">
                           <span class="text-xs text-zinc-600 uppercase">Block</span>
                           <span class="text-xl font-black ${getFrameColorClass(plan.finalBlock)} ml-1">${plan.finalBlock >= 0 ? '+' : ''}${plan.finalBlock}</span>
                       </div>
                   </div>`;

            return `
                <div class="py-2">
                    ${stepsHtml}
                    ${statsHtml}
                </div>
            `;
        }
        
        // Ê∏≤ÊüìÊäïÊäÄÂ§áÈÄâÊñπÊ°àÔºàÂèØÂ±ïÂºÄËØ¶ÊÉÖÔºâ
        function renderAltThrowPlan(plan, adv) {
            if (!plan) return '';
            
            const planKey = getPlanKey(plan);
            const safePlanKey = getSafePlanKey(plan);  // Áî®‰∫éÂµåÂÖ•HTML
            const isFavorite = isPlanFavorite(adv, planKey);
            
            let desc;
            if (plan.isDirect) {
                desc = `Áõ¥Êé• ${plan.meatyMove.name}`;
            } else if (plan.killMove2) {
                const separator = plan.isCommutative ? '+' : '‚Üí';
                desc = `${plan.killMove.name} ${separator} ${plan.killMove2.name} ‚Üí ${plan.meatyMove.name}`;
            } else {
                desc = `${plan.killMove.name} ‚Üí ${plan.meatyMove.name}`;
            }
            
            let detailHtml = renderAltPlanDetail(plan, adv);
            
            const starIcon = isFavorite ? '‚òÖ' : '‚òÜ';
            const starClass = isFavorite ? 'text-yellow-400' : 'text-zinc-400 hover:text-yellow-400';
            const rowBg = isFavorite ? 'bg-yellow-900/10' : '';

            return `
                <details class="border-b border-zinc-800/50 ${rowBg}">
                    <summary class="flex items-center justify-between py-2 cursor-pointer hover:bg-zinc-800/30 transition-colors">
                        <span class="text-sm text-zinc-400">${desc}</span>
                        <div class="flex gap-1 sm:gap-2 items-center">
                            <span class="text-[10px] sm:text-xs text-zinc-500">${plan.remain}F</span>
                            <button onclick="event.stopPropagation(); toggleFavorite(${adv}, '${safePlanKey}')" class="${starClass} transition-colors p-1.5 sm:p-1 text-base sm:text-sm" title="Êî∂Ëóè">${starIcon}</button>
                            <button onclick="event.stopPropagation(); maximizePlan(${adv}, '${safePlanKey}')" class="text-zinc-400 hover:text-zinc-200 transition-colors p-1.5 sm:p-1 text-base sm:text-sm" title="ÁΩÆÈ°∂ÊòæÁ§∫">‚ñ≤</button>
                        </div>
                    </summary>
                    <div class="py-2 px-2 bg-zinc-800/20">
                        ${detailHtml}
                    </div>
                </details>
            `;
        }

        // ÊêúÁ¥¢ËøáÊª§ÂáΩÊï∞
        function filterSolutions() {
            renderNotes();
        }
        
        // Ê∏ÖÈô§ÊêúÁ¥¢
        function clearSearch() {
            const input = document.getElementById('solutionSearch');
            input.value = '';
            updateClearBtn();
            filterSolutions();
        }
        
        // Êõ¥Êñ∞Ê∏ÖÈô§ÊåâÈíÆÊòæÁ§∫Áä∂ÊÄÅ
        function updateClearBtn() {
            const input = document.getElementById('solutionSearch');
            const btn = document.getElementById('clearSearchBtn');
            if (input.value.trim()) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }
        
        // ÂàáÊç¢ÊéíÂ∫èÊñπÂêë
        function toggleSortOrder() {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
            updateSortOrderUI();
            renderNotes();
        }
        
        // Êõ¥Êñ∞ÊéíÂ∫èÊåâÈíÆ UI
        function updateSortOrderUI() {
            const icon = document.getElementById('sortOrderIcon');
            const btn = document.getElementById('sortOrderBtn');
            if (state.sortOrder === 'asc') {
                icon.textContent = '‚Üë';
                btn.title = 'ÂΩìÂâçÔºö‰ªéÂ∞èÂà∞Â§ßÔºåÁÇπÂáªÂàáÊç¢';
            } else {
                icon.textContent = '‚Üì';
                btn.title = 'ÂΩìÂâçÔºö‰ªéÂ§ßÂà∞Â∞èÔºåÁÇπÂáªÂàáÊç¢';
            }
        }
        
        // ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅ
        function toggleFavorite(adv, planKey) {
            const stateKey = `${state.currentCharacter}:${adv}:${planKey}`;
            state.favorites[stateKey] = !state.favorites[stateKey];
            if (!state.favorites[stateKey]) delete state.favorites[stateKey]; // Ê∏ÖÁêÜ false ÂÄº
            saveFavorites();
            renderNotes();
        }
        
        // ÊúÄÂ∞èÂåñÊñπÊ°àÔºàÁßªÂà∞Â§áÈÄâÂàóË°®Ôºâ
        function minimizePlan(adv, planKey) {
            const stateKey = `${state.currentCharacter}:${adv}:${planKey}`;
            state.minimized[stateKey] = true;
            saveMinimized();
            renderNotes();
        }
        
        // ÊúÄÂ§ßÂåñÊñπÊ°àÔºà‰ªéÂ§áÈÄâÁßªÂà∞‰∏ªÊòæÁ§∫Ôºâ
        function maximizePlan(adv, planKey) {
            const stateKey = `${state.currentCharacter}:${adv}:${planKey}`;
            delete state.minimized[stateKey];
            saveMinimized();
            renderNotes();
        }
        
        // Ê£ÄÊü•ÊñπÊ°àÊòØÂê¶Ë¢´ÊúÄÂ∞èÂåñ
        function isPlanMinimized(adv, planKey) {
            return state.minimized[`${state.currentCharacter}:${adv}:${planKey}`] === true;
        }
        
        // Ê£ÄÊü•ÊñπÊ°àÊòØÂê¶Ë¢´Êî∂Ëóè
        function isPlanFavorite(adv, planKey) {
            return state.favorites[`${state.currentCharacter}:${adv}:${planKey}`] === true;
        }
        
        // ========== ÊâìÊäïÊã©Êî∂ËóèÁõ∏ÂÖ≥ÂáΩÊï∞ ==========
        // ÁîüÊàêÊâìÊäïÊã©Êî∂ËóèÁöÑkey
        function getMixupKey(adv, remain, killDesc) {
            return `${state.currentCharacter}:${adv}:${remain}:${killDesc}`;
        }
        
        // Ê£ÄÊü•ÊâìÊäïÊã©ÊñπÊ°àÊòØÂê¶Ë¢´Êî∂Ëóè
        function isMixupFavorite(adv, remain, killDesc) {
            return state.mixupFavorites[getMixupKey(adv, remain, killDesc)] === true;
        }
        
        // Ê£ÄÊü•Êüê‰∏™advÊòØÂê¶Êúâ‰ªª‰ΩïÊâìÊäïÊã©Êî∂Ëóè
        function hasMixupFavoriteForAdv(adv) {
            const prefix = `${state.currentCharacter}:${adv}:`;
            return Object.keys(state.mixupFavorites).some(key => key.startsWith(prefix));
        }
        
        // ÂàáÊç¢ÊâìÊäïÊã©Êî∂Ëóè
        function toggleMixupFavorite(adv, remain, killDesc) {
            const key = getMixupKey(adv, remain, killDesc);
            if (state.mixupFavorites[key]) {
                delete state.mixupFavorites[key];
            } else {
                state.mixupFavorites[key] = true;
            }
            saveMixupFavorites();
            renderThrowMixupContent();
        }
        
        // Ê£ÄÊü•ÊâìÊäïÊã©ÊñπÊ°àÊòØÂê¶Ë¢´ÈöêËóè
        function isMixupHidden(adv, remain, killDesc) {
            return state.mixupHidden[getMixupKey(adv, remain, killDesc)] === true;
        }
        
        // ÂàáÊç¢ÊâìÊäïÊã©ÊñπÊ°àÈöêËóè
        function toggleMixupHidden(adv, remain, killDesc) {
            const key = getMixupKey(adv, remain, killDesc);
            if (state.mixupHidden[key]) {
                delete state.mixupHidden[key];
            } else {
                state.mixupHidden[key] = true;
            }
            saveMixupHidden();
            renderThrowMixupContent();
        }
        
        // ‰øùÂ≠ò/Âä†ËΩΩÊâìÊäïÊã©Êî∂Ëóè
        function saveMixupFavorites() {
            localStorage.setItem('sf6_mixup_favorites', JSON.stringify(state.mixupFavorites));
        }
        function loadMixupFavorites() {
            try {
                const saved = localStorage.getItem('sf6_mixup_favorites');
                return saved ? JSON.parse(saved) : {};
            } catch(e) { return {}; }
        }
        
        // ‰øùÂ≠ò/Âä†ËΩΩÊâìÊäïÊã©ÈöêËóè
        function saveMixupHidden() {
            localStorage.setItem('sf6_mixup_hidden', JSON.stringify(state.mixupHidden));
        }
        function loadMixupHidden() {
            try {
                const saved = localStorage.getItem('sf6_mixup_hidden');
                return saved ? JSON.parse(saved) : {};
            } catch(e) { return {}; }
        }
        
        // ÂàáÊç¢ÊúâÂà©Â∏ßÂ±ïÂºÄ/Êî∂Ëµ∑ÔºàÊîØÊåÅÂ§öÈ°πÂêåÊó∂Â±ïÂºÄÔºâ
        function toggleAdvExpand(adv) {
            if (state.expandedAdvSet.has(adv)) {
                state.expandedAdvSet.delete(adv);  // Êî∂Ëµ∑
                // Â¶ÇÊûúÊúâÊî∂Ëµ∑ÁöÑÔºåÊõ¥Êñ∞ÂÖ®Â±ÄÁä∂ÊÄÅ
                if (state.allDetailsExpanded) {
                    state.allDetailsExpanded = false;
                    updateToggleAllBtn();
                }
            } else {
                state.expandedAdvSet.add(adv);   // Â±ïÂºÄ
            }
            renderNotes();
        }
        
        // ÂàáÊç¢ÂÖ®ÈÉ®Â±ïÂºÄ/Êî∂Ëµ∑
        function toggleAllDetails() {
            state.allDetailsExpanded = !state.allDetailsExpanded;
            if (state.allDetailsExpanded) {
                // Êî∂ÈõÜÂΩìÂâçÊâÄÊúâÂèØËßÅÁöÑÂú∫ÊôØadv
                const searchInput = document.getElementById('solutionSearch');
                const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
                
                state.notes.forEach((note, idx) => {
                    if (note.isFuzzy && note.advRange) {
                        const fuzzyKey = `fuzzy_${idx}`;
                        // Ê£ÄÊü•ÊòØÂê¶Á¨¶ÂêàÊêúÁ¥¢Êù°‰ª∂
                        if (!searchTerm || matchesFuzzySearch(note, searchTerm)) {
                            state.expandedAdvSet.add(fuzzyKey);
                        }
                    } else {
                        // Ê£ÄÊü•ÊòØÂê¶Á¨¶ÂêàÊêúÁ¥¢Êù°‰ª∂
                        if (!searchTerm || matchesExactSearch(note, searchTerm)) {
                            state.expandedAdvSet.add(note.adv);
                        }
                    }
                });
            } else {
                state.expandedAdvSet.clear();
            }
            updateToggleAllBtn();
            renderNotes();
        }
        
        // Ê£ÄÊü•Ê®°Á≥äÂú∫ÊôØÊòØÂê¶ÂåπÈÖçÊêúÁ¥¢
        function matchesFuzzySearch(note, searchTerm) {
            const advStr = `${note.advRange[0]}-${note.advRange[1]}`;
            return advStr.includes(searchTerm) || 
                   (note.context && note.context.toLowerCase().includes(searchTerm));
        }
        
        // Ê£ÄÊü•Á≤æÁ°ÆÂú∫ÊôØÊòØÂê¶ÂåπÈÖçÊêúÁ¥¢
        function matchesExactSearch(note, searchTerm) {
            const advStr = String(note.adv);
            return advStr.includes(searchTerm) || 
                   (note.context && note.context.toLowerCase().includes(searchTerm));
        }
        
        // Êõ¥Êñ∞ÂÖ®Â±ÄÂ±ïÂºÄÊåâÈíÆÁä∂ÊÄÅ
        function updateToggleAllBtn() {
            const btn = document.getElementById('toggleAllDetailsBtn');
            const icon = document.getElementById('toggleAllIcon');
            const text = document.getElementById('toggleAllText');
            if (btn && icon && text) {
                if (state.allDetailsExpanded) {
                    icon.textContent = '‚ñ≤';
                    text.textContent = 'Êî∂Ëµ∑';
                    btn.title = 'Êî∂Ëµ∑ÊâÄÊúâËØ¶ÊÉÖ';
                } else {
                    icon.textContent = '‚ñº';
                    text.textContent = 'Â±ïÂºÄ';
                    btn.title = 'Â±ïÂºÄÊâÄÊúâËØ¶ÊÉÖ';
                }
            }
        }
        
        // ÂàáÊç¢Âè™ÊòæÁ§∫Êî∂ËóèÊñπÊ°à
        function toggleShowOnlyFavorites() {
            state.showOnlyFavorites = !state.showOnlyFavorites;
            updateShowFavoritesBtn();
            renderNotes();
        }
        
        // Êõ¥Êñ∞Êî∂ËóèÁ≠õÈÄâÊåâÈíÆÁä∂ÊÄÅ
        function updateShowFavoritesBtn() {
            const btn = document.getElementById('showFavoritesBtn');
            const icon = document.getElementById('showFavoritesIcon');
            if (btn && icon) {
                if (state.showOnlyFavorites) {
                    icon.textContent = '‚òÖ';
                    btn.classList.add('active');
                    btn.title = 'ÂΩìÂâçÔºöÂè™ÊòæÁ§∫Êî∂ËóèÔºåÁÇπÂáªÊòæÁ§∫ÂÖ®ÈÉ®';
                    btn.style.background = 'color-mix(in srgb, var(--theme-primary) 30%, transparent)';
                    btn.style.borderColor = 'var(--theme-primary)';
                    icon.style.color = '#facc15';
                } else {
                    icon.textContent = '‚òÜ';
                    btn.classList.remove('active');
                    btn.title = 'Âè™ÊòæÁ§∫Êî∂ËóèÊñπÊ°à';
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    icon.style.color = '';
                }
            }
        }
        
        // ========== Ê®°Á≥äÂú∫ÊôØÊ∏≤Êüì ==========
        function renderFuzzyScenario(group, cardIndex) {
            const minAdv = group.advRange[0];
            const maxAdv = group.advRange[1];
            const result = calculateFuzzyBestPlans(minAdv, maxAdv);
            const note = state.notes[group.idx];
            const isPreset = !note.isUserAdded;
            const deleteTitle = isPreset ? "Ê≠§‰∏∫È¢ÑËÆæÂú∫ÊôØÔºåÂà†Èô§ÂêéÂèØÈÄöËøáÈáçÁΩÆÊÅ¢Â§ç" : "Âà†Èô§Ê≠§Áî®Êà∑Âú∫ÊôØ";
            
            // Ê®°Á≥äÊ†áÁ≠æ
            const fuzzyBadge = `<span class="fuzzy-badge" title="Ê®°Á≥äÂ∏ßÊï∞Âú∫ÊôØ">üé≤ Ê®°Á≥ä</span>`;
            
            // Âà§Êñ≠ÊòØÂê¶Â±ïÂºÄ
            const isExpanded = state.expandedAdvSet.has(`fuzzy_${group.idx}`);
            
            // ========== Á¥ßÂáëÂàóË°®ËßÜÂõæ ==========
            if (!isExpanded) {
                let bestPlanDesc = '';
                if (result.bestByBlock) {
                    const plan = result.bestByBlock;
                    bestPlanDesc = plan.killDesc 
                        ? `${plan.killDesc} ‚Üí ${plan.meatyMove.name}`
                        : `Áõ¥Êé• ${plan.meatyMove.name}`;
                } else {
                    bestPlanDesc = 'Êó†Á¨¶ÂêàÊù°‰ª∂ÁöÑÊñπÊ°à';
                }
                
                return `
                    <div class="trend-card py-3 px-4 cursor-pointer hover:bg-opacity-80 transition-all fuzzy-scenario-card" onclick="toggleAdvExpand('fuzzy_${group.idx}')" style="animation-delay: ${cardIndex * 0.02}s">
                        <div class="flex items-center gap-2 sm:gap-3">
                            <span class="impact-text text-xl sm:text-2xl font-black min-w-[80px] sm:min-w-[90px] flex-shrink-0" style="color: var(--theme-secondary);">${minAdv}~${maxAdv}F</span>
                            <span class="compact-context-tag">${escapeHtml(group.context)}</span>
                            ${fuzzyBadge}
                            <span class="text-zinc-600 mx-1 flex-shrink-0">‚Üí</span>
                            <span class="text-white font-bold compact-plan-desc flex-1 min-w-0">${bestPlanDesc}</span>
                            <span class="text-zinc-600 text-xs ml-2 flex-shrink-0">‚ñº</span>
                        </div>
                    </div>
                `;
            }
            
            // ========== Â±ïÂºÄÁöÑËØ¶ÁªÜËßÜÂõæ ==========
            const leftPanel = `
                <div class="flex flex-col min-w-0 sm:min-w-[160px] items-start lg:border-r border-zinc-800 lg:pr-6 w-full lg:w-auto">
                    <div class="flex items-center gap-3 sm:block">
                        <div class="impact-text text-3xl sm:text-4xl md:text-5xl leading-none frame-number" style="color: var(--theme-secondary);">${minAdv}~${maxAdv}F</div>
                        <div class="sm:hidden">${fuzzyBadge}</div>
                    </div>
                    <div class="hidden sm:block mt-2">${fuzzyBadge}</div>
                    <div class="flex flex-wrap sm:flex-col gap-2 sm:gap-1 mt-2 sm:mt-3 w-full">
                        <div class="flex items-center gap-1 sm:gap-2 group/ctx">
                            <div class="expanded-context-tag text-xs sm:text-sm font-black uppercase tracking-wide px-2 py-1 border-l-2 flex-1 ${isPreset ? 'context-tag-preset' : 'context-tag'}">${escapeHtml(group.context)}</div>
                            <button onclick="event.stopPropagation(); removeNote(${group.idx})" class="text-zinc-600 hover:text-red-500 text-lg sm:text-base p-1.5 sm:p-1 opacity-70 sm:opacity-0 sm:group-hover/ctx:opacity-100 transition-all flex-shrink-0" title="${deleteTitle}">‚úï</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Êó†‰ªª‰ΩïÂèØÁî®ÊñπÊ°à
            if (!result.bestByBlock && !result.bestByHit) {
                return `
                    <div class="trend-card fuzzy-scenario-card">
                        <div onclick="toggleAdvExpand('fuzzy_${group.idx}')" class="px-4 sm:px-5 py-3 cursor-pointer text-zinc-300 hover:text-white text-sm font-bold transition-colors select-none flex items-center gap-2 border-b" style="border-color: var(--theme-card-border);">
                            <span class="text-zinc-500 text-xs">‚ñº</span>
                            Êî∂Ëµ∑ ${minAdv}~${maxAdv}F ËØ¶ÁªÜÊñπÊ°à
                        </div>
                        <div class="p-4 sm:p-6 flex flex-col lg:flex-row items-center gap-4 sm:gap-6">
                            ${leftPanel}
                            <div class="flex-1 text-zinc-600 font-bold italic">
                                Êú™ÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑÂéãÂà∂ÊñπÊ°à<br>
                                <span class="text-xs text-zinc-700">Á∫¶Êùü: ‚ë†‰∏çË¢´4Â∏ßÊä¢ ‚ë°‰∏çÊå•Á©∫</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Ê∏≤ÊüìÊñπÊ°àÂàóË°®
            let plansHtml = '';
            const allValidPlans = result.allPlans || [];
            
            if (allValidPlans.length <= 2) {
                // ‚â§2 ‰∏™ÊñπÊ°àÔºåÁõ¥Êé•ÊòæÁ§∫ÂÖ®ÈÉ®
                plansHtml = allValidPlans.map((plan, i) => renderFuzzyPlanCard(plan, i === 0 ? 'Êé®Ëçê' : '')).join('');
            } else {
                // >2 ‰∏™ÊñπÊ°àÔºåÊòæÁ§∫‰∏§‰∏™ÊúÄ‰ºò
                if (result.bestByBlock) {
                    plansHtml += renderFuzzyPlanCard(result.bestByBlock, 'üõ°Ô∏è Èò≤Âæ°ÊúÄ‰ºò');
                }
                if (result.bestByHit && result.bestByHit.key !== result.bestByBlock?.key) {
                    plansHtml += renderFuzzyPlanCard(result.bestByHit, '‚öîÔ∏è ÂëΩ‰∏≠ÊúÄ‰ºò');
                }
                plansHtml += `<div class="text-xs text-zinc-600 mt-2">ÂÖ± ${allValidPlans.length} ‰∏™Á¨¶ÂêàÊù°‰ª∂ÁöÑÊñπÊ°à</div>`;
            }
            
            return `
                <div class="trend-card fuzzy-scenario-card">
                    <div onclick="toggleAdvExpand('fuzzy_${group.idx}')" class="px-4 sm:px-5 py-3 cursor-pointer text-zinc-300 hover:text-white text-sm font-bold transition-colors select-none flex items-center gap-2 border-b" style="border-color: var(--theme-card-border);">
                        <span class="text-zinc-500 text-xs">‚ñº</span>
                        Êî∂Ëµ∑ ${minAdv}~${maxAdv}F ËØ¶ÁªÜÊñπÊ°à
                    </div>
                    <div class="p-4 sm:p-6 flex flex-col lg:flex-row gap-4 sm:gap-6">
                        ${leftPanel}
                        <div class="flex-1 min-w-0">
                            <div class="space-y-3">
                                ${plansHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Ê∏≤ÊüìÂçï‰∏™Ê®°Á≥äÊñπÊ°àÂç°Áâá
        function renderFuzzyPlanCard(plan, label) {
            const safetyMargin = plan.startup - plan.maxStolen;
            const planDesc = plan.killDesc 
                ? `<span class="text-zinc-400">${plan.killDesc}</span> ‚Üí <span class="text-white font-bold">${plan.meatyMove.name}</span>`
                : `Áõ¥Êé• <span class="text-white font-bold">${plan.meatyMove.name}</span>`;
            
            return `
                <div class="fuzzy-plan-card">
                    ${label ? `<div class="fuzzy-plan-label">${label}</div>` : ''}
                    <div class="fuzzy-plan-content">
                        <div class="fuzzy-plan-desc">${planDesc}</div>
                        <div class="fuzzy-plan-stats">
                            <span>Âπ≥Âùá Block: <span class="${getFrameColorClass(plan.avgBlock)}">${plan.avgBlock >= 0 ? '+' : ''}${plan.avgBlock.toFixed(1)}F</span></span>
                            <span>Âπ≥Âùá Hit: <span class="${getFrameColorClass(plan.avgHit)}">${plan.avgHit >= 0 ? '+' : ''}${plan.avgHit.toFixed(1)}F</span></span>
                        </div>
                        <div class="fuzzy-plan-detail">
                            ÂÅ∑Â∏ß: ${plan.minStolen}~${plan.maxStolen}F | 
                            ÂÆâÂÖ®‰ΩôÈáè: <span class="${safetyMargin >= 4 ? 'text-green-400' : 'text-red-400'}">${safetyMargin}F</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderNotes() {
            const container = document.getElementById('noteListContainer');
            const searchInput = document.getElementById('solutionSearch');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            if (state.moveLibrary.length === 0) {
                container.innerHTML = `
                    <div class="trend-card p-8 text-center">
                        <div class="text-zinc-600 text-lg mb-2">üì≠ ÊöÇÊó† ${state.currentCharacter} ÁöÑÂ∏ßÊï∞ÊçÆ</div>
                        <div class="text-zinc-700 text-sm">ËØ∑ÂâçÂæÄ Êï∞ÊçÆ È°µÁ≠æÂØºÂÖ•Êï∞ÊçÆ</div>
                    </div>
                `;
                return;
            }

            // ========== Êåâ adv ÂàÜÁªÑÔºåÂêàÂπ∂Áõ∏ÂêåÂ∏ßÊï∞ÁöÑ context ==========
            // Á≤æÁ°ÆÂú∫ÊôØÂàÜÁªÑ
            const advGroups = {};
            // Ê®°Á≥äÂú∫ÊôØÂçïÁã¨Â§ÑÁêÜÔºà‰∏çÂêàÂπ∂Ôºâ
            const fuzzyGroups = [];
            
            state.notes.forEach((note, idx) => {
                if (note.isFuzzy && note.advRange) {
                    // Ê®°Á≥äÂú∫ÊôØ
                    fuzzyGroups.push({
                        advRange: note.advRange,
                        context: note.context,
                        idx: idx,
                        isFuzzy: true
                    });
                } else {
                    // Á≤æÁ°ÆÂú∫ÊôØ
                    if (!advGroups[note.adv]) {
                        advGroups[note.adv] = { adv: note.adv, contexts: [], indices: [], isFuzzy: false };
                    }
                    advGroups[note.adv].contexts.push(note.context);
                    advGroups[note.adv].indices.push(idx);
                }
            });
            
            // ÂêàÂπ∂Á≤æÁ°ÆÂú∫ÊôØÂíåÊ®°Á≥äÂú∫ÊôØ
            let allGroups = [
                ...Object.values(advGroups),
                ...fuzzyGroups
            ];
            
            // Êåâ adv ÊéíÂ∫èÔºàÊ®°Á≥äÂú∫ÊôØÁî®ËåÉÂõ¥ÁöÑËµ∑ÂßãÂÄºÊéíÂ∫èÔºâ
            allGroups.sort((a, b) => {
                const advA = a.isFuzzy ? a.advRange[0] : a.adv;
                const advB = b.isFuzzy ? b.advRange[0] : b.adv;
                return state.sortOrder === 'asc' ? advA - advB : advB - advA;
            });
            
            // ========== ÊêúÁ¥¢ËøáÊª§ ==========
            if (searchTerm) {
                allGroups = allGroups.filter(group => {
                    if (group.isFuzzy) {
                        // Ê®°Á≥äÂú∫ÊôØÔºöÂåπÈÖçËåÉÂõ¥Êàñ context
                        if (String(group.advRange[0]).includes(searchTerm) || 
                            String(group.advRange[1]).includes(searchTerm)) return true;
                        if (group.context.toLowerCase().includes(searchTerm)) return true;
                    } else {
                        // Á≤æÁ°ÆÂú∫ÊôØÔºöÂåπÈÖçÂ∏ßÊï∞Êàñ context
                        if (String(group.adv).includes(searchTerm)) return true;
                        if (group.contexts.some(ctx => ctx.toLowerCase().includes(searchTerm))) return true;
                    }
                    return false;
                });
            }
            
            // ========== Êî∂ËóèÁ≠õÈÄâ ==========
            if (state.showOnlyFavorites) {
                allGroups = allGroups.filter(group => {
                    if (group.isFuzzy) {
                        // Ê®°Á≥äÂú∫ÊôØÊöÇ‰∏çÊîØÊåÅÊî∂ËóèÁ≠õÈÄâ
                        return false;
                    } else {
                        // Ê£ÄÊü•ËØ•Âú∫ÊôØÊòØÂê¶Êúâ‰ªª‰ΩïÊî∂ËóèÁöÑÊñπÊ°à
                        const allPlans = calculateBestPlan(group.adv);
                        const hasFavoritePlan = allPlans.some(plan => 
                            isPlanFavorite(group.adv, getPlanKey(plan))
                        );
                        // ‰πüÊ£ÄÊü•ÊâìÊäïÊã©Êî∂Ëóè
                        const hasFavoriteMixup = hasMixupFavoriteForAdv(group.adv);
                        return hasFavoritePlan || hasFavoriteMixup;
                    }
                });
            }
            
            let sortedGroups = allGroups;
            
            // Êó†ÂåπÈÖçÁªìÊûú
            if (sortedGroups.length === 0) {
                // Âå∫ÂàÜÊó†Êï∞ÊçÆ„ÄÅÊî∂ËóèÁ≠õÈÄâÊó†ÁªìÊûúÂíåÊêúÁ¥¢Êó†ÁªìÊûú
                const isEmptyNotes = state.notes.length === 0;
                let emptyHtml;
                
                if (isEmptyNotes) {
                    emptyHtml = `
                        <div class="trend-card p-8 text-center">
                            <div class="text-zinc-600 text-lg mb-2">üìã ÊöÇÊó† Scenario</div>
                            <div class="text-zinc-700 text-sm">ÁÇπÂáª + Êñ∞Â¢ûÂú∫ÊôØ Ê∑ªÂä†ÊúâÂà©Â∏ßÊÉÖÂ¢É</div>
                        </div>
                    `;
                } else if (state.showOnlyFavorites) {
                    emptyHtml = `
                        <div class="trend-card p-8 text-center">
                            <div class="text-zinc-600 text-lg mb-2">‚≠ê ÊöÇÊó†Êî∂ËóèÊñπÊ°à</div>
                            <div class="text-zinc-700 text-sm">ÁÇπÂáªÊñπÊ°àÂç°ÁâáÁöÑ ‚òÜ Êî∂ËóèÂñúÊ¨¢ÁöÑÊñπÊ°à</div>
                            <button onclick="toggleShowOnlyFavorites()" class="mt-4 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-white text-sm transition-colors">ÊòæÁ§∫ÂÖ®ÈÉ®ÊñπÊ°à</button>
                        </div>
                    `;
                } else {
                    emptyHtml = `
                        <div class="trend-card p-8 text-center">
                            <div class="text-zinc-600 text-lg mb-2">üîç Êú™ÊâæÂà∞ÂåπÈÖçÁöÑ Scenario</div>
                            <div class="text-zinc-700 text-sm">Â∞ùËØïÂÖ∂‰ªñÊêúÁ¥¢ËØçÔºåÊàñÊ∏ÖÁ©∫ÊêúÁ¥¢Ê°ÜÊü•ÁúãÂÖ®ÈÉ®</div>
                        </div>
                    `;
                }
                
                container.innerHTML = emptyHtml;
                return;
            }

            container.innerHTML = sortedGroups.map((group, cardIndex) => {
                // ========== Ê®°Á≥äÂú∫ÊôØÂçïÁã¨Â§ÑÁêÜ ==========
                if (group.isFuzzy) {
                    return renderFuzzyScenario(group, cardIndex);
                }
                
                const allPlans = calculateBestPlan(group.adv);
                
                // ÂàÜÁ¶ªÊäïÊäÄÊñπÊ°àÂíåÊôÆÈÄöÊñπÊ°à
                const throwPlans = allPlans.filter(p => p.isThrow && p.remain >= 4 && p.remain <= 5);
                const normalPlans = allPlans.filter(p => !p.isThrow && p.finalBlock > 0);
                
                // ÂÆâÂÖ®Ë∑≥Âà§Êñ≠
                const safeJumpFramesForPanel = getSafeJumpFrames(state.currentCharacter);
                let safeJumpBadgeHtml = '';
                let safeJumpCompactHtml = '';
                
                if (group.adv === safeJumpFramesForPanel) {
                    safeJumpBadgeHtml = `<div class="safe-jump-badge mt-2" title="ÂÆâÂÖ®Ë∑≥ÂéãÂà∂ÔºåÈò≤5Â∏ßÂèä‰ª•‰∏äÂáπÊãõ">
                        <span class="safe-jump-badge-inner safe-jump-true">ü¶ò ÂÆâÂÖ®Ë∑≥</span>
                    </div>`;
                    safeJumpCompactHtml = `<span class="safe-jump-badge-inner safe-jump-true text-[10px] ml-2">ü¶ò ÂÆâÂÖ®Ë∑≥</span>`;
                } else if (group.adv === safeJumpFramesForPanel - 1) {
                    safeJumpBadgeHtml = `<div class="safe-jump-badge mt-2" title="‰º™ÂÆâÂÖ®Ë∑≥ÂéãÂà∂ÔºåÈò≤6Â∏ßÂèä‰ª•‰∏äÂáπÊãõ">
                        <span class="safe-jump-badge-inner safe-jump-pseudo">ü¶ò ‰º™ÂÆâÂÖ®Ë∑≥</span>
                    </div>`;
                    safeJumpCompactHtml = `<span class="safe-jump-badge-inner safe-jump-pseudo text-[10px] ml-2">ü¶ò ‰º™ÂÆâÂÖ®Ë∑≥</span>`;
                }
                
                // Âà§Êñ≠ÊòØÂê¶Â±ïÂºÄ
                const isExpanded = state.expandedAdvSet.has(group.adv);
                
                // ========== Á¥ßÂáëÂàóË°®ËßÜÂõæ ==========
                if (!isExpanded) {
                    // Ëé∑ÂèñÊúÄ‰Ω≥ÊñπÊ°àÁöÑÁÆÄË¶ÅÊèèËø∞
                    let bestPlanDesc = '';
                    if (normalPlans.length > 0) {
                        const best = normalPlans[0];
                        if (best.isDirect) {
                            bestPlanDesc = `Áõ¥Êé• ${best.meatyMove.name}`;
                        } else if (best.killMove) {
                            bestPlanDesc = best.killMove2 
                                ? `${best.killMove.name} ‚Üí ${best.killMove2.name} ‚Üí ${best.meatyMove.name}`
                                : `${best.killMove.name} ‚Üí ${best.meatyMove.name}`;
                        }
                    } else if (throwPlans.length > 0) {
                        bestPlanDesc = 'ÊäïÊäÄÊñπÊ°à';
                    } else {
                        bestPlanDesc = 'Êó†ÊúâÂà©ÊñπÊ°à';
                    }
                    
                    // Á¥ßÂáëÁöÑ context ÊòæÁ§∫ - Ê°åÈù¢Á´ØÊòæÁ§∫2‰∏™ÔºåÁßªÂä®Á´ØÊòæÁ§∫1‰∏™
                    // ‰ΩøÁî®CSS media queryÊéßÂà∂ÔºåËøôÈáåÁîüÊàê‰∏§Â•óHTML
                    const firstContext = group.contexts[0] ? `<span class="compact-context-tag">${escapeHtml(group.contexts[0])}</span>` : '';
                    const secondContext = group.contexts[1] ? `<span class="compact-context-tag hidden sm:inline-block">${escapeHtml(group.contexts[1])}</span>` : '';
                    const moreCount = group.contexts.length - 1;
                    const moreContextsMobile = moreCount > 0 ? `<span class="text-xs text-zinc-400 ml-1 sm:hidden">+${moreCount}</span>` : '';
                    const moreContextsDesktop = group.contexts.length > 2 ? `<span class="text-xs text-zinc-400 ml-1 hidden sm:inline">+${group.contexts.length - 2}</span>` : '';
                    
                    return `
                        <div class="trend-card py-3 px-4 cursor-pointer hover:bg-opacity-80 transition-all" onclick="toggleAdvExpand(${group.adv})" style="animation-delay: ${cardIndex * 0.02}s">
                            <div class="flex items-center gap-2 sm:gap-3">
                                <span class="impact-text text-xl sm:text-2xl font-black min-w-[60px] sm:min-w-[70px] flex-shrink-0" style="color: var(--theme-secondary);">+${group.adv}F</span>
                                <div class="flex gap-1 items-center flex-shrink-0">
                                    ${firstContext}
                                    ${secondContext}
                                    ${moreContextsMobile}
                                    ${moreContextsDesktop}
                                </div>
                                ${safeJumpCompactHtml}
                                <span class="text-zinc-600 mx-1 flex-shrink-0">‚Üí</span>
                                <span class="text-white font-bold compact-plan-desc flex-1 min-w-0">${bestPlanDesc}</span>
                                <span class="text-zinc-600 text-xs ml-2 flex-shrink-0">‚ñº</span>
                            </div>
                        </div>
                    `;
                }
                
                // ========== Â±ïÂºÄÁöÑËØ¶ÁªÜËßÜÂõæ ==========
                // Ê∏≤ÊüìÂ∑¶‰æßÊúâÂà©Â∏ß‰ø°ÊÅØÂå∫
                const contextsHtml = group.indices.map((idx, i) => {
                    const ctx = group.contexts[i];
                    const note = state.notes[idx];
                    const isPreset = !note.isUserAdded;
                    const deleteTitle = isPreset ? "Ê≠§‰∏∫È¢ÑËÆæÂú∫ÊôØÔºåÂà†Èô§ÂêéÂèØÈÄöËøáÈáçÁΩÆÊÅ¢Â§ç" : "Âà†Èô§Ê≠§Áî®Êà∑Âú∫ÊôØ";
                    const contextClass = isPreset ? "context-tag-preset" : "context-tag";
                    return `<div class="flex items-center gap-1 sm:gap-2 group/ctx">
                        <div class="expanded-context-tag text-xs sm:text-sm font-black uppercase tracking-wide px-2 py-1 border-l-2 flex-1 ${contextClass}">${escapeHtml(ctx)}</div>
                        <button onclick="event.stopPropagation(); removeNote(${idx})" class="text-zinc-600 hover:text-red-500 text-lg sm:text-base p-1.5 sm:p-1 opacity-70 sm:opacity-0 sm:group-hover/ctx:opacity-100 transition-all flex-shrink-0" title="${deleteTitle}">‚úï</button>
                    </div>`;
                }).join('');
                
                const leftPanel = `
                    <div class="flex flex-col min-w-0 sm:min-w-[160px] items-start lg:border-r border-zinc-800 lg:pr-6 w-full lg:w-auto">
                        <div class="flex items-center gap-3 sm:block">
                            <div class="impact-text text-3xl sm:text-4xl md:text-5xl leading-none frame-number" style="color: var(--theme-secondary);">+${group.adv}F</div>
                            <div class="sm:hidden">${safeJumpBadgeHtml}</div>
                        </div>
                        <div class="hidden sm:block">${safeJumpBadgeHtml}</div>
                        <div class="flex flex-wrap sm:flex-col gap-2 sm:gap-1 mt-2 sm:mt-3 w-full">
                            ${contextsHtml}
                        </div>
                    </div>
                `;
                
                // Êó†‰ªª‰ΩïÂèØÁî®ÊñπÊ°à
                if (normalPlans.length === 0 && throwPlans.length === 0) {
                    return `
                        <div class="trend-card">
                            <div onclick="toggleAdvExpand(${group.adv})" class="px-5 py-3 cursor-pointer text-zinc-300 hover:text-white text-sm font-bold transition-colors select-none flex items-center gap-2 border-b" style="border-color: var(--theme-card-border);">
                                <span class="text-zinc-500 text-xs">‚ñº</span>
                                Êî∂Ëµ∑ +${group.adv}F ËØ¶ÁªÜÊñπÊ°à
                            </div>
                            <div class="p-6 flex flex-col lg:flex-row items-center gap-6">
                                ${leftPanel}
                                <div class="flex-1 text-zinc-600 font-bold italic">Êú™ÊâæÂà∞ÊúâÂà©ÂéãÂà∂ÊñπÊ°à</div>
                            </div>
                        </div>
                    `;
                }

                const mainKeys = new Set();  // ‰∏ªÊòæÁ§∫Âå∫ÁöÑÊñπÊ°à
                const planReasons = new Map();  // ËÆ∞ÂΩïÊØè‰∏™ÊñπÊ°àÁöÑÊé®ËçêÁêÜÁî±
                let mainHtml = '';
                
                // Ê£ÄÊü•ÊñπÊ°àÊòØÂê¶Ë¢´ÊúÄÂ∞èÂåñ
                const isMinimized = (plan) => isPlanMinimized(group.adv, getPlanKey(plan));
                
                // ËøáÊª§ÊéâË¢´ÊúÄÂ∞èÂåñÁöÑÊñπÊ°à
                const availableNormal = normalPlans.filter(p => !isMinimized(p));
                const availableThrow = throwPlans.filter(p => !isMinimized(p));
                
                // Ê∑ªÂä†ÊñπÊ°àÂà∞‰∏ªÊòæÁ§∫Âå∫ÔºàËá™Âä®ÂéªÈáçÔºåËÆ∞ÂΩïÊé®ËçêÁêÜÁî±Ôºâ
                const addMainPlan = (plan, label = '', reason = '') => {
                    if (!plan) return false;
                    const key = getPlanKey(plan);
                    
                    // Â¶ÇÊûúÂ∑≤Â≠òÂú®ÔºåËøΩÂä†ÁêÜÁî±
                    if (mainKeys.has(key)) {
                        if (reason && !planReasons.get(key).includes(reason)) {
                            planReasons.get(key).push(reason);
                        }
                        return false;
                    }
                    
                    mainKeys.add(key);
                    planReasons.set(key, reason ? [reason] : []);
                    return true;
                };
                
                // ========== Ê£ÄÊü•ÊòØÂê¶ÊúâÊî∂ËóèÊñπÊ°àÔºàÊñ∞ÈÄªËæëÔºâ==========
                // Â¶ÇÊûúÂΩìÂâçÂú∫ÊôØÊúâÊî∂ËóèÊñπÊ°àÔºåÂàôÊé®ËçêÂå∫Âè™ÊòæÁ§∫Êî∂ËóèÊñπÊ°à
                const favoritePlans = allPlans.filter(plan => 
                    !isMinimized(plan) && 
                    isPlanFavorite(group.adv, getPlanKey(plan))
                );
                
                const hasFavorites = favoritePlans.length > 0;

                // ========== Â¶ÇÊûúÊúâÊî∂ËóèÊñπÊ°àÔºåÂè™ÊòæÁ§∫Êî∂ËóèÊñπÊ°à ==========
                if (hasFavorites) {
                    // Âè™ÊòæÁ§∫Êî∂ËóèÊñπÊ°à
                    favoritePlans.forEach(plan => {
                        const isSafeJump = !plan.isDirect && plan.remain === getSafeJumpFrames(state.currentCharacter);
                        const isPseudoSafeJump = !plan.isDirect && plan.remain === getSafeJumpFrames(state.currentCharacter) - 1;
                        let label = '';
                        if (isSafeJump) label = 'ÂÆâÂÖ®Ë∑≥';
                        else if (isPseudoSafeJump) label = '‰º™ÂÆâÂÖ®Ë∑≥';
                        addMainPlan(plan, label, 'favorite');
                    });
                } else {
                    // ========== Ê≤°ÊúâÊî∂ËóèÊó∂Ôºå‰ΩøÁî®ÈªòËÆ§Êé®ËçêÈÄªËæë ==========
                    
                    // ========== 0. Âç°Â∏ßËææÊàêÂÆâÂÖ®Ë∑≥ÁöÑÊñπÊ°à ==========
                    // Ê≥®ÊÑèÔºöÂú∫ÊôØÁ∫ßÂà´ÁöÑÂÆâÂÖ®Ë∑≥Âà§Êñ≠Â∑≤Âú® leftPanel Â§ÑÁêÜ
                    // ËøôÈáåÂè™Â§ÑÁêÜÈÄöËøáÂç°Â∏ßËææÂà∞ÂÆâÂÖ®Ë∑≥Â∏ßÊï∞ÁöÑÊñπÊ°à
                    const safeJumpFrames = getSafeJumpFrames(state.currentCharacter);
                    
                    // ÊâæÂç°Â∏ßÂêéËÉΩËææÂà∞ÂÆâÂÖ®Ë∑≥ÁöÑÊñπÊ°àÔºàÊéíÈô§Áõ¥Êé•ÂéãÂà∂ÔºåÂõ†‰∏∫ÈÇ£ÊòØÂú∫ÊôØÁ∫ßÂà´ÁöÑÂÆâÂÖ®Ë∑≥Ôºâ
                    const safeJumpPlans = availableNormal.filter(p => !p.isDirect && p.remain === safeJumpFrames);
                    if (safeJumpPlans.length > 0) {
                        const bestSafeJump = [...safeJumpPlans].sort((a, b) => {
                            if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                            return b.finalHit - a.finalHit;
                        })[0];
                        addMainPlan(bestSafeJump, 'ÂÆâÂÖ®Ë∑≥', 'safe_jump');
                    }
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÂÆâÂÖ®Ë∑≥ÊñπÊ°àÔºåÊâæ‰º™ÂÆâÂÖ®Ë∑≥ÊñπÊ°à
                    if (safeJumpPlans.length === 0) {
                        const pseudoSafeJumpPlans = availableNormal.filter(p => !p.isDirect && p.remain === safeJumpFrames - 1);
                        if (pseudoSafeJumpPlans.length > 0) {
                            const bestPseudoSafeJump = [...pseudoSafeJumpPlans].sort((a, b) => {
                                if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                                return b.finalHit - a.finalHit;
                            })[0];
                            addMainPlan(bestPseudoSafeJump, '‰º™ÂÆâÂÖ®Ë∑≥', 'pseudo_safe_jump');
                        }
                    }

                    // ========== 1. finalBlock ÊúÄÈ´òÁöÑÊñπÊ°à ==========
                    if (availableNormal.length > 0) {
                        const bestBlockPlan = [...availableNormal].sort((a, b) => {
                            if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                            return b.finalHit - a.finalHit;
                        })[0];
                        addMainPlan(bestBlockPlan, '', 'best_block');
                    }

                    // ========== 2. finalHit ÊúÄÈ´òÁöÑÊñπÊ°à ==========
                    if (availableNormal.length > 0) {
                        const bestHitPlan = [...availableNormal].sort((a, b) => {
                            if (b.finalHit !== a.finalHit) return b.finalHit - a.finalHit;
                            return b.finalBlock - a.finalBlock;
                        })[0];
                        addMainPlan(bestHitPlan, '', 'best_hit');
                    }

                    // ========== 3. ‰∏≠/Âº±ÊîªÂáª‰∏≠ finalBlock ÊúÄ‰ºò ==========
                    const nonHeavyPlans = availableNormal.filter(p => {
                        const strength = getPlanStrength(p);
                        return strength === 'medium' || strength === 'light' || strength === 'other';
                    });
                    if (nonHeavyPlans.length > 0) {
                        const bestNonHeavyBlock = [...nonHeavyPlans].sort((a, b) => {
                            if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                            return b.finalHit - a.finalHit;
                        })[0];
                        addMainPlan(bestNonHeavyBlock, '', 'best_nonheavy_block');
                    }

                    // ========== 4. ‰∏≠/Âº±ÊîªÂáª‰∏≠ finalHit ÊúÄ‰ºò ==========
                    if (nonHeavyPlans.length > 0) {
                        const bestNonHeavyHit = [...nonHeavyPlans].sort((a, b) => {
                            if (b.finalHit !== a.finalHit) return b.finalHit - a.finalHit;
                            return b.finalBlock - a.finalBlock;
                        })[0];
                        addMainPlan(bestNonHeavyHit, '', 'best_nonheavy_hit');
                    }

                    // ========== 5. ÂÅ∑Â∏ßÊúÄÂ§öÁöÑÊñπÊ°à ==========
                    if (availableNormal.length > 0) {
                        const bestStolenPlan = [...availableNormal].sort((a, b) => {
                            if (b.stolen !== a.stolen) return b.stolen - a.stolen;
                            if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                            return b.finalHit - a.finalHit;
                        })[0];
                        addMainPlan(bestStolenPlan, '', 'most_stolen');
                    }

                    // ========== 6. ÊäïÊäÄÊñπÊ°à ==========
                    let hasShownThrow = false;
                    if (availableThrow.length > 0) {
                        // ÊäïÊäÄÊñπÊ°àÊåâÁõ¥Êé•‰ºòÂÖàÔºåÁÑ∂ÂêéÊåâ remain Ë∂äÂ∞èË∂ä‰ºòÂÖà
                        const sortedThrow = [...availableThrow].sort((a, b) => {
                            if (b.isDirect !== a.isDirect) return (b.isDirect ? 1 : 0) - (a.isDirect ? 1 : 0);
                            return a.remain - b.remain;
                        });
                        
                        const bestThrow = sortedThrow[0];
                        if (addMainPlan(bestThrow, '', 'throw')) {
                            hasShownThrow = true;
                        }
                    }

                    // ========== 6'. Èõ∂Â∏ßÊâìÊäïÊã©ÊñπÊ°àÔºöÂΩìÊ≤°ÊúâÊ≠£Êî∂ÁõäÁöÑÊôÆÈÄöÊñπÊ°àÂú®‰∏ªÊòæÁ§∫Âå∫Ôºå‰ΩÜÊúâÊäïÊäÄÊó∂ÔºåÊòæÁ§∫ Block=0 ÁöÑÊñπÊ°àÂΩ¢ÊàêÊâìÊäïÊã© ==========
                    const hasNormalMainPlan = normalPlans.some(p => mainKeys.has(getPlanKey(p)));
                    if (!hasNormalMainPlan && hasShownThrow) {
                        // ‰ªé allPlans ‰∏≠ÊâæÂá∫ÊâÄÊúâ finalBlock === 0 ÁöÑÈùûÊäïÊäÄÊñπÊ°à‰∏îÊú™Ë¢´ÊúÄÂ∞èÂåñÁöÑ
                        const zeroBlockPlans = allPlans.filter(p => !p.isThrow && p.finalBlock === 0 && !isMinimized(p));
                        if (zeroBlockPlans.length > 0) {
                            // ÊåâÊîªÂáªÁ≠âÁ∫ßÊéíÂ∫èÔºöÈáç > ‰∏≠ > ËΩª
                            const strengthOrder = { heavy: 0, medium: 1, light: 2, other: 3 };
                            const sortedZeroPlans = [...zeroBlockPlans].sort((a, b) => {
                                const aStrength = strengthOrder[getPlanStrength(a)] ?? 3;
                                const bStrength = strengthOrder[getPlanStrength(b)] ?? 3;
                                if (aStrength !== bStrength) return aStrength - bStrength;
                                // ÂêåÁ≠âÁ∫ßÊåâ finalHit ÊéíÂ∫è
                                return b.finalHit - a.finalHit;
                            });
                            
                            // ÊòæÁ§∫ÊâÄÊúâ 0 Â∏ßÊñπÊ°àÔºàÊâìÊäïÊã©ÈÖçÂêàÔºâ
                            sortedZeroPlans.forEach(plan => {
                                addMainPlan(plan, 'ÊâìÊäïÊã©', 'mixup');
                            });
                        }
                    }
                    
                    // Ëé∑ÂèñÂΩìÂâçËßíËâ≤ÁöÑÊâÄÊúâËßÑÂàô
                    const rules = getAllRulesForCharacter(state.currentCharacter);
                    
                    // ========== 7. Áî®Êà∑ÂÄæÂêëÂéãÂà∂ËßÑÂàô ==========
                    // Êü•Êâæ‰ΩøÁî®‰∫ÜÂÄæÂêëÊãõÂºèÁöÑÊñπÊ°àÔºå‰ªéÂ§áÈÄâÊèêÂçáÂà∞Êé®Ëçê
                    const preferRules = rules.filter(r => r.type === 'prefer');
                    preferRules.forEach(rule => {
                        const preferMoveName = rule.moveName.toUpperCase();
                        // Âú®Â§áÈÄâ‰∏≠Êü•Êâæ‰ΩøÁî®ËØ•ÊãõÂºè‰Ωú‰∏∫ÂéãÂà∂ÁöÑÊñπÊ°àÔºàÊª°Ë∂≥ÂÅ∑Â∏ß‚â•1‰∏îfinalBlock‚â•1Ôºâ
                        const preferPlans = normalPlans.filter(p => 
                            !mainKeys.has(getPlanKey(p)) &&
                            !isMinimized(p) &&
                            p.meatyMove && 
                            p.meatyMove.name.toUpperCase() === preferMoveName &&
                            p.stolen >= 1 &&
                            p.finalBlock >= 1
                        );
                        
                        // Â¶ÇÊûúÊâæÂà∞ÔºåÊ∑ªÂä†ÊúÄ‰ºòÁöÑÂá†‰∏™
                        if (preferPlans.length > 0) {
                            const sorted = [...preferPlans].sort((a, b) => {
                                if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                                return b.finalHit - a.finalHit;
                            });
                            // ÊúÄÂ§öÊ∑ªÂä†Ââç2‰∏™ÊúÄ‰ºòÊñπÊ°à
                            sorted.slice(0, 2).forEach(plan => {
                                addMainPlan(plan, '', `prefer:${rule.moveName}`);
                            });
                        }
                    });
                }
                
                // ========== ÊúÄÁªàÊ∏≤ÊüìÔºöÊåâËÆ∞ÂΩïÁöÑÁêÜÁî±Ê∏≤ÊüìÊâÄÊúâÊñπÊ°à ==========
                mainHtml = '';
                mainKeys.forEach(key => {
                    // ‰ªé allPlans ‰∏≠ÊâæÂõûÊñπÊ°àÂØπË±°
                    const plan = allPlans.find(p => getPlanKey(p) === key);
                    if (plan) {
                        const reasons = planReasons.get(key) || [];
                        // Á°ÆÂÆöÊ†áÁ≠æ‰ºòÂÖàÁ∫ßÔºöÂÆâÂÖ®Ë∑≥ > ‰º™ÂÆâÂÖ®Ë∑≥ > ÊâìÊäïÊã©
                        let label = '';
                        if (reasons.includes('safe_jump')) {
                            label = 'ÂÆâÂÖ®Ë∑≥';
                        } else if (reasons.includes('pseudo_safe_jump')) {
                            label = '‰º™ÂÆâÂÖ®Ë∑≥';
                        } else if (reasons.includes('mixup')) {
                            label = 'ÊâìÊäïÊã©';
                        }
                        mainHtml += renderMainPlan(plan, label, group.adv, reasons);
                    }
                });

                // ========== 4. Â§áÈÄâÊñπÊ°àÊäòÂè†Âå∫ ==========
                // Â§áÈÄâÊñπÊ°à = ‰∏çÂú®‰∏ªÊòæÁ§∫Âå∫ÁöÑÊâÄÊúâÊñπÊ°àÔºàÂåÖÊã¨Ë¢´ÊúÄÂ∞èÂåñÁöÑÔºâ
                // Á≠õÈÄâÊù°‰ª∂ÔºöÂÅ∑Â∏ß‚â•1 ‰∏î finalBlock‚â•1
                const altNormalPlans = normalPlans.filter(p => 
                    !mainKeys.has(getPlanKey(p)) && 
                    p.stolen >= 1 && 
                    p.finalBlock >= 1
                );
                const altThrowPlans = throwPlans.filter(p => !mainKeys.has(getPlanKey(p)));
                
                let altHtml = '';
                
                // ÊôÆÈÄöÂ§áÈÄâÊñπÊ°à
                if (altNormalPlans.length > 0) {
                    const altContent = altNormalPlans.map(plan => renderAltPlan(plan, group.adv)).join('');
                    altHtml += `
                        <details class="mt-2">
                            <summary class="text-[11px] text-zinc-600 cursor-pointer hover:text-zinc-400 transition-colors py-2 flex items-center gap-1">
                                <span class="collapse-arrow transition-transform duration-200">‚ñ∂</span> ${altNormalPlans.length} ‰∏™Â§áÈÄâÊâìÂáªÊñπÊ°à (Block > 0)
                            </summary>
                            <div class="mt-2 bg-zinc-900/50 p-3 border border-zinc-800">
                                ${altContent}
                            </div>
                        </details>
                    `;
                }
                
                // ÊäïÊäÄÂ§áÈÄâÊñπÊ°à
                if (altThrowPlans.length > 0) {
                    const altThrowContent = altThrowPlans.map(plan => renderAltThrowPlan(plan, group.adv)).join('');
                    
                    altHtml += `
                        <details class="mt-2">
                            <summary class="text-[11px] text-zinc-600 cursor-pointer hover:text-zinc-400 transition-colors py-2 flex items-center gap-1">
                                <span class="collapse-arrow transition-transform duration-200">‚ñ∂</span> ${altThrowPlans.length} ‰∏™ÂÖ∂‰ªñÊäïÊäÄË∑ØÁ∫ø
                            </summary>
                            <div class="mt-2 bg-zinc-900/50 p-3 border border-zinc-800">
                                ${altThrowContent}
                            </div>
                        </details>
                    `;
                }

                return `
                    <div class="trend-card">
                        <div onclick="toggleAdvExpand(${group.adv})" class="px-4 sm:px-5 py-3 cursor-pointer text-zinc-300 hover:text-white text-sm font-bold transition-colors select-none flex items-center gap-2 border-b" style="border-color: var(--theme-card-border);">
                            <span class="text-zinc-500 text-xs">‚ñº</span>
                            Êî∂Ëµ∑ +${group.adv}F ËØ¶ÁªÜÊñπÊ°à
                        </div>
                        <div class="p-4 sm:p-6">
                            <div class="flex flex-col lg:flex-row gap-4 sm:gap-6">
                                ${leftPanel}
                                <div class="flex-1 min-w-0">
                                    ${mainHtml}
                                    ${altHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLibrary() {
            const body = document.getElementById('moveTableBody');
            
            if (state.moveLibrary.length === 0) {
                body.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-8 text-center text-zinc-600">
                            ÊöÇÊó†Êï∞ÊçÆÔºåËØ∑Á≤òË¥¥ JSON ÂØºÂÖ• ${state.currentCharacter} ÁöÑÂ∏ßÊï∞ÊçÆ
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ëé∑ÂèñÂéüÂßãÈ¢ÑËÆæÊï∞ÊçÆÁöÑÊãõÂºèÂêçÁß∞ÂàóË°®ÔºåÁî®‰∫éÂà§Êñ≠ÊòØÂê¶ÂèØÂà†Èô§
            const defaultMoves = getDefaultMoves(state.currentCharacter);
            const defaultMoveNames = new Set(defaultMoves.map(m => m.name.toUpperCase()));

            body.innerHTML = state.moveLibrary.map((m, idx) => {
                // Âà§Êñ≠ÊòØÂê¶‰∏∫Áî®Êà∑Ê∑ªÂä†ÁöÑÊãõÂºèÔºàÂèØÂà†Èô§Ôºâ
                const isUserAdded = m.isUserAdded || !defaultMoveNames.has(m.name.toUpperCase());
                const deleteBtn = isUserAdded 
                    ? `<button onclick="removeMove(${idx})" class="text-zinc-700 hover:text-red-500 transition-colors p-2 -m-1 text-base" title="Âà†Èô§">‚úï</button>`
                    : '';
                const userBadge = isUserAdded 
                    ? '<span class="ml-1 text-[9px] px-1 py-0.5 bg-emerald-900/50 text-emerald-400 rounded">NEW</span>' 
                    : '';
                
                // ÁâπÊÆäÂ§ÑÁêÜ Dash ÊãõÂºè
                if (m.isDash) {
                    return `
                        <tr class="border-b border-zinc-900 hover:bg-zinc-800/20">
                            <td class="p-4 text-zinc-300">${m.name}${userBadge} <span class="text-[10px] text-zinc-500">DASH</span></td>
                            <td class="p-4 text-center font-mono text-zinc-500" colspan="3">${m.dashFrames || 19}F ÊÄªÂ∏ßÊï∞ (‰ªÖÂç°Â∏ßÁî®)</td>
                            <td class="p-4 text-center font-mono text-zinc-600">-</td>
                            <td class="p-4 text-center font-mono text-zinc-600">-</td>
                            <td class="p-4 text-right">${deleteBtn}</td>
                        </tr>
                    `;
                }
                
                // ÁâπÊÆäÂ§ÑÁêÜÊäïÊäÄ
                if (m.isThrow) {
                    return `
                        <tr class="border-b border-zinc-900 hover:bg-zinc-800/20">
                            <td class="p-4 text-zinc-300">${m.name}${userBadge} <span class="text-[10px] text-zinc-500">THROW</span></td>
                            <td class="p-4 text-center font-mono text-zinc-500">${m.startup}</td>
                            <td class="p-4 text-center font-mono text-zinc-500">${m.active}</td>
                            <td class="p-4 text-center font-mono text-zinc-500">${m.recovery}</td>
                            <td class="p-4 text-center font-mono text-zinc-600">-</td>
                            <td class="p-4 text-center font-mono text-zinc-600">-</td>
                            <td class="p-4 text-right">${deleteBtn}</td>
                        </tr>
                    `;
                }
                
                // ÊôÆÈÄöÊãõÂºè
                const knockdownBadge = m.isKnockdown 
                    ? '<span class="ml-1 text-[9px] px-1 py-0.5 bg-red-900/50 text-red-400 rounded">KD</span>' 
                    : '';
                    
                return `
                    <tr class="border-b border-zinc-900 hover:bg-zinc-800/20">
                        <td class="p-4 text-zinc-300">${m.name}${userBadge}${knockdownBadge}</td>
                        <td class="p-4 text-center font-mono text-zinc-500">${m.startup}</td>
                        <td class="p-4 text-center font-mono text-zinc-500">${m.active}</td>
                        <td class="p-4 text-center font-mono text-zinc-500">${m.recovery}</td>
                        <td class="p-4 text-center font-mono ${getFrameColorClass(m.hit)}">${m.hit >= 0 ? '+' : ''}${m.hit}</td>
                        <td class="p-4 text-center font-mono ${getFrameColorClass(m.block)}">${m.block >= 0 ? '+' : ''}${m.block}</td>
                        <td class="p-4 text-right">${deleteBtn}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderAll() {
            renderThrowMixups();
            renderNotes();
            renderLibrary();
            renderRules();
        }
        
        // ==================== ÊâìÊäïÊã©ÊñπÊ°àËÆ°ÁÆó ====================
        // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊâìÊäïÊã©Tab
        let currentMixupTab = 5;
        
        // Ëé∑ÂèñÂú∫ÊôØÁöÑ contextÔºàÁî®Êà∑Ëá™ÂÆö‰πâÊàñÈ¢ÑËÆæÔºâ
        function getContextForAdv(adv) {
            const contexts = [];
            state.notes.forEach(note => {
                if (note.adv === adv && note.context) {
                    contexts.push(note.context);
                }
            });
            return contexts;
        }
        
        // ËÆ°ÁÆóÊâÄÊúâËÉΩÂç°Âá∫ÁâπÂÆöÂâ©‰ΩôÂ∏ßÁöÑÂú∫ÊôØ
        function calculateThrowMixups() {
            const results = {
                3: [], 4: [], 5: []
            };
            
            if (state.moveLibrary.length === 0) return results;
            
            // ÈÅçÂéÜ 6-50 Â∏ß
            for (let adv = 6; adv <= 50; adv++) {
                const plans = calculateBestPlan(adv);
                
                // Êî∂ÈõÜÊØè‰∏™Ââ©‰ΩôÂ∏ßÊï∞ÁöÑÊâÄÊúâÂç°Â∏ßÊñπÂºè
                const remainPlans = { 3: [], 4: [], 5: [] };
                
                for (const plan of plans) {
                    // Ë∑≥ËøáÊäïÊäÄÊñπÊ°àÔºàÊäïÊäÄ‰∏çÈÄÇÂêàÊâìÊäïÊã©Ôºâ
                    if (plan.isThrow) continue;
                    // Ë∑≥ËøáÁõ¥Êé•ÂéãÂà∂Ôºà‰∏çÈúÄË¶ÅÂç°Â∏ßÔºâ
                    if (plan.isDirect) continue;
                    
                    const remain = plan.remain;
                    
                    // Âè™ÂÖ≥Ê≥® 3-5 Â∏ßÁöÑÂâ©‰Ωô
                    if (remain < 3 || remain > 5) continue;
                    
                    // ÁîüÊàêÂç°Â∏ßÊèèËø∞
                    // ÂØπ‰∫éÊâìÊäïÊã©ÔºåÊàë‰ª¨Âè™ÂÖ≥ÂøÉ"ËÉΩÂç°Âá∫ÁâπÂÆöÂ∏ßÊï∞"Ôºå‰∏çÂÖ≥ÂøÉÈ°∫Â∫è
                    // ÊâÄ‰ª•Áªü‰∏ÄÁî®ÊéíÂ∫èÂêéÁöÑÊ†ºÂºèÈÅøÂÖçÈáçÂ§çÔºàÂ¶Ç "5LP ‚Üí 66" Âíå "5LP + 66" ËßÜ‰∏∫Áõ∏ÂêåÔºâ
                    let killDesc;
                    if (plan.killMove2) {
                        // ‰∏§Ê≠•Âç°Â∏ßÁªü‰∏ÄÊéíÂ∫èÂêéÁî® "+" ËøûÊé•
                        const names = [plan.killMove.name, plan.killMove2.name].sort();
                        killDesc = names.join(' + ');
                    } else {
                        killDesc = plan.killMove.name;
                    }
                    
                    // ÈÅøÂÖçÂêå‰∏ÄÂ∏ßÊï∞ÁöÑÈáçÂ§çÂç°Â∏ßÊñπÂºè
                    if (!remainPlans[remain].includes(killDesc)) {
                        remainPlans[remain].push(killDesc);
                    }
                }
                
                // ‰∏∫ÊØè‰∏™ÊúâÊúâÊïàÊñπÊ°àÁöÑÂâ©‰ΩôÂ∏ßÂàõÂª∫Êù°ÁõÆ
                for (let r = 3; r <= 5; r++) {
                    if (remainPlans[r].length > 0) {
                        const contexts = getContextForAdv(adv);
                        results[r].push({
                            adv,
                            remain: r,
                            killDescs: remainPlans[r],  // Êîπ‰∏∫Êï∞ÁªÑÔºåÂåÖÂê´ÊâÄÊúâÂç°Â∏ßÊñπÂºè
                            contexts
                        });
                    }
                }
            }
            
            // ÊåâÊúâÂà©Â∏ßÊéíÂ∫è
            for (let i = 3; i <= 5; i++) {
                results[i].sort((a, b) => a.adv - b.adv);
            }
            
            return results;
        }
        
        // ÂàáÊç¢ÊâìÊäïÊã©Tab
        function switchMixupTab(frame) {
            currentMixupTab = frame;
            
            // Êõ¥Êñ∞ tab ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.mixup-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`mixupTab${frame}`).classList.add('active');
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂÜÖÂÆπ
            renderThrowMixupContent();
        }
        
        // Ê∏≤ÊüìÊâìÊäïÊã©ÊñπÊ°à
        function renderThrowMixups() {
            renderThrowMixupContent();
        }
        
        // Ê∏≤ÊüìÊâìÊäïÊã©ÂÜÖÂÆπ
        function renderThrowMixupContent() {
            const container = document.getElementById('throwMixupContent');
            
            if (state.moveLibrary.length === 0) {
                container.innerHTML = '<p class="text-zinc-600 text-sm">üì≠ ÊöÇÊó†ËßíËâ≤Êï∞ÊçÆ</p>';
                return;
            }
            
            const mixups = calculateThrowMixups();
            const items = mixups[currentMixupTab];
            
            // Â§ÑÁêÜÊØè‰∏™itemÁöÑkillDescsÔºåËøáÊª§ÊéâË¢´ÈöêËóèÁöÑ
            const processedItems = items.map(item => {
                const visibleDescs = item.killDescs.filter(desc => 
                    !isMixupHidden(item.adv, currentMixupTab, desc)
                );
                return { ...item, killDescs: visibleDescs };
            }).filter(item => item.killDescs.length > 0);
            
            // ÂàÜÁ¶ªÊúâÂú∫ÊôØÂíåÊó†Âú∫ÊôØÁöÑÊñπÊ°à
            const withContext = processedItems.filter(item => item.contexts.length > 0);
            const withoutContext = processedItems.filter(item => item.contexts.length === 0);
            
            // Ê£ÄÊü•Êüê‰∏™Âú∫ÊôØÊòØÂê¶Êúâ‰ªª‰ΩïÊî∂ËóèÁöÑÊñπÊ°à
            const hasAnyFavorite = (item) => {
                return item.killDescs.some(desc => isMixupFavorite(item.adv, currentMixupTab, desc));
            };
            
            let mainHtml = '';
            
            if (withContext.length > 0) {
                mainHtml = withContext.map(item => {
                    const hasFav = hasAnyFavorite(item);
                    const contextHtml = `<div class="mt-2 flex flex-wrap gap-1.5">
                        ${item.contexts.map(ctx => `<span class="text-xs px-2.5 py-1 bg-zinc-700/80 text-zinc-200 font-bold">${escapeHtml(ctx)}</span>`).join('')}
                    </div>`;
                    
                    // Â§öÁßçÂç°Â∏ßÊñπÂºèÁî®"Êàñ"ËøûÊé•ÔºåÊî∂ËóèÁöÑÊñπÊ°àÈ´ò‰∫ÆÊòæÁ§∫
                    const killDescsHtml = item.killDescs.map(desc => {
                        const isFav = isMixupFavorite(item.adv, currentMixupTab, desc);
                        const textClass = isFav ? 'text-yellow-300' : 'text-white';
                        if (desc.includes(' + ')) {
                            const parts = desc.split(' + ');
                            return parts.map(p => `<span class="${textClass} font-black text-lg">${p}</span>`).join('<span class="text-yellow-500 mx-1 font-bold">+</span>');
                        } else if (desc.includes(' ‚Üí ')) {
                            const parts = desc.split(' ‚Üí ');
                            return parts.map(p => `<span class="${textClass} font-black text-lg">${p}</span>`).join('<span class="text-zinc-600 mx-1 font-bold">‚Üí</span>');
                        }
                        return `<span class="${textClass} font-black text-lg">${desc}</span>`;
                    }).join('<span class="text-zinc-500 mx-2">Êàñ</span>');
                    
                    // ÁîüÊàêÂ§çÂà∂ÊñáÊú¨ÔºàÊâÄÊúâÂú∫ÊôØÁî®"/"ËøûÊé•ÔºåËΩ¨‰πâÁâπÊÆäÂ≠óÁ¨¶Ôºâ
                    const contextStr = item.contexts.length > 0 ? item.contexts.join('/') : '';
                    const killDescText = item.killDescs.join(' Êàñ ');
                    const mixupCopyText = `+${item.adv}F ${contextStr}Ôºö${killDescText} ‚Äî‚Äî ${currentMixupTab}F ÊâìÊäïÊã©`
                        .replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
                    
                    // Êî∂ËóèÊåâÈíÆÁä∂ÊÄÅ
                    const favIcon = hasFav ? '‚òÖ' : '‚òÜ';
                    const favClass = hasFav ? 'text-yellow-400' : 'text-zinc-400 hover:text-yellow-400';
                    const borderColor = hasFav ? 'border-yellow-500' : '';
                    const bgColor = hasFav ? 'bg-yellow-900/10' : 'bg-zinc-900/50';
                    
                    return `
                        <div class="py-3 px-4 ${bgColor} border-l-4 mb-3 relative group ${borderColor}" style="border-left-color: ${hasFav ? '#eab308' : 'var(--theme-primary)'};">
                            <div class="absolute top-1.5 sm:top-2 right-1.5 sm:right-2 flex gap-0.5 sm:gap-1 opacity-80 group-hover:opacity-100">
                                <button onclick="copyPlanInfo(\`${mixupCopyText}\`)" class="text-zinc-500 hover:text-cyan-400 transition-colors p-2 sm:p-1 text-base sm:text-sm opacity-70 hover:opacity-100" title="Â§çÂà∂ÊñπÊ°à">üìã</button>
                                <button onclick="openMixupEditModal(${item.adv}, ${currentMixupTab})" class="text-zinc-400 hover:text-cyan-400 transition-colors p-2 sm:p-1 text-base sm:text-sm" title="ÁºñËæëÊñπÊ°à">‚úèÔ∏è</button>
                                <button onclick="toggleMixupFavoriteAll(${item.adv}, ${currentMixupTab})" class="${favClass} transition-colors p-2 sm:p-1 text-lg sm:text-base" title="${hasFav ? 'ÂèñÊ∂àÊî∂Ëóè' : 'Êî∂ËóèÊñπÊ°à'}">${favIcon}</button>
                            </div>
                            <div class="flex items-center gap-3 flex-wrap pr-24 sm:pr-20">
                                <span class="impact-text text-2xl font-black" style="color: var(--theme-secondary);">+${item.adv}F</span>
                                ${killDescsHtml}
                            </div>
                            ${contextHtml}
                            ${hasFav ? '<div class="favorite-stamp">FAVE</div>' : ''}
                        </div>
                    `;
                }).join('');
            }
            
            // Êó†Âú∫ÊôØÊñπÊ°àÁöÑÊäòÂè†Âå∫Âüü
            let noContextHtml = '';
            if (withoutContext.length > 0) {
                const noContextItems = withoutContext.map(item => {
                    const hasFav = hasAnyFavorite(item);
                    const killDescsHtml = item.killDescs.map(desc => {
                        const isFav = isMixupFavorite(item.adv, currentMixupTab, desc);
                        const textClass = isFav ? 'text-yellow-300' : 'text-zinc-300';
                        if (desc.includes(' + ')) {
                            const parts = desc.split(' + ');
                            return parts.map(p => `<span class="${textClass} font-bold">${p}</span>`).join('<span class="text-yellow-600 mx-1 font-bold">+</span>');
                        } else if (desc.includes(' ‚Üí ')) {
                            const parts = desc.split(' ‚Üí ');
                            return parts.map(p => `<span class="${textClass} font-bold">${p}</span>`).join('<span class="text-zinc-600 mx-1 font-bold">‚Üí</span>');
                        }
                        return `<span class="${textClass} font-bold">${desc}</span>`;
                    }).join('<span class="text-zinc-500 mx-1">Êàñ</span>');
                    
                    const killDescText = item.killDescs.join(' Êàñ ');
                    const mixupCopyText = `+${item.adv}FÔºö${killDescText} ‚Äî‚Äî ${currentMixupTab}F ÊâìÊäïÊã©`
                        .replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');
                    
                    const favIcon = hasFav ? '‚òÖ' : '‚òÜ';
                    const favClass = hasFav ? 'text-yellow-400' : 'text-zinc-400 hover:text-yellow-400';
                    const bgColor = hasFav ? 'bg-yellow-900/10' : 'bg-black/20';
                    
                    return `
                        <div class="py-2 sm:py-1.5 px-3 ${bgColor} border-l-2 mb-1.5 sm:mb-1 relative group" style="border-left-color: ${hasFav ? '#eab308' : 'var(--theme-card-border)'};">
                            <div class="flex items-center gap-2 flex-wrap text-sm pr-20 sm:pr-16">
                                <span class="font-bold" style="color: var(--theme-secondary);">+${item.adv}F</span>
                                ${killDescsHtml}
                            </div>
                            <div class="absolute right-1.5 sm:right-2 top-1/2 -translate-y-1/2 flex gap-0.5 opacity-80 group-hover:opacity-100">
                                <button onclick="copyPlanInfo(\`${mixupCopyText}\`)" class="text-zinc-500 hover:text-cyan-400 transition-colors p-1.5 sm:p-0.5 text-sm sm:text-xs opacity-70 hover:opacity-100" title="Â§çÂà∂ÊñπÊ°à">üìã</button>
                                <button onclick="openMixupEditModal(${item.adv}, ${currentMixupTab})" class="text-zinc-400 hover:text-cyan-400 transition-colors p-1.5 sm:p-0.5 text-sm sm:text-xs" title="ÁºñËæëÊñπÊ°à">‚úèÔ∏è</button>
                                <button onclick="toggleMixupFavoriteAll(${item.adv}, ${currentMixupTab})" class="${favClass} transition-colors p-1.5 sm:p-0.5 text-sm sm:text-xs" title="${hasFav ? 'ÂèñÊ∂àÊî∂Ëóè' : 'Êî∂ËóèÊñπÊ°à'}">${favIcon}</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                noContextHtml = `
                    <details class="mt-4">
                        <summary class="cursor-pointer text-zinc-500 hover:text-zinc-300 text-xs font-bold transition-colors select-none py-2 flex items-center gap-1">
                            <span class="collapse-arrow transition-transform duration-200">‚ñ∂</span> Êó†ÂØπÂ∫îÂú∫ÊôØÁöÑÊâìÊäïÊã©Âç°Â∏ßÊñπÊ°à (${withoutContext.length})
                        </summary>
                        <div class="pt-2">
                            ${noContextItems}
                        </div>
                    </details>
                `;
            }
            
            // È°∂ÈÉ®ÊèêÁ§∫
            const countText = withContext.length > 0 
                ? `‚úì ÊâæÂà∞ ${withContext.length} ‰∏™ÊñπÊ°àÂèØÂç°Âá∫ ${currentMixupTab}F`
                : `ÊöÇÊó†ÂØπÂ∫îÂú∫ÊôØÁöÑ ${currentMixupTab}F ÊâìÊäïÊã©Âç°Â∏ßÊñπÊ°à`;
            
            container.innerHTML = `
                <div class="text-sm mb-4" style="color: var(--theme-primary);">${countText}</div>
                ${mainHtml}
                ${noContextHtml}
            `;
        }
        
        // Êî∂Ëóè/ÂèñÊ∂àÊî∂ËóèÊï¥‰∏™ÊâìÊäïÊã©Âú∫ÊôØÁöÑÊâÄÊúâÊñπÊ°à
        function toggleMixupFavoriteAll(adv, remain) {
            const mixups = calculateThrowMixups();
            const item = mixups[remain].find(m => m.adv === adv);
            if (!item) return;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÊñπÊ°àÈÉΩÂ∑≤Êî∂Ëóè
            const allFavorited = item.killDescs.every(desc => isMixupFavorite(adv, remain, desc));
            
            // Â¶ÇÊûúÂÖ®ÈÉ®Â∑≤Êî∂ËóèÔºåÂàôÂèñÊ∂àÂÖ®ÈÉ®ÔºõÂê¶ÂàôÊî∂ËóèÂÖ®ÈÉ®
            item.killDescs.forEach(desc => {
                const key = getMixupKey(adv, remain, desc);
                if (allFavorited) {
                    delete state.mixupFavorites[key];
                } else {
                    state.mixupFavorites[key] = true;
                }
            });
            
            saveMixupFavorites();
            renderThrowMixupContent();
        }
        
        // ÊâìÂºÄÊâìÊäïÊã©ÁºñËæëÂºπÁ™ó
        function openMixupEditModal(adv, remain) {
            const mixups = calculateThrowMixups();
            const originalItem = mixups[remain].find(m => m.adv === adv);
            if (!originalItem) return;
            
            // Ëé∑ÂèñÊâÄÊúâÂç°Â∏ßÊñπÂºèÔºàÂåÖÊã¨Â∑≤ÈöêËóèÁöÑÔºâ
            const allDescs = originalItem.killDescs;
            
            // ÂàõÂª∫ÂºπÁ™óHTML
            const modalHtml = `
                <div id="mixupEditModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-3 sm:p-4 z-50" onclick="if(event.target === this) closeMixupEditModal()">
                    <div class="bg-zinc-900 border w-full max-w-md p-5 sm:p-6 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
                        <div class="flex justify-between items-center mb-5 sm:mb-6">
                            <h2 class="text-lg sm:text-xl font-bold text-white">ÁºñËæëÊâìÊäïÊã©ÊñπÊ°à</h2>
                            <button onclick="closeMixupEditModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="ÂÖ≥Èó≠">&times;</button>
                        </div>
                        <div class="mb-4">
                            <div class="text-sm text-zinc-400 mb-2">+${adv}F ¬∑ ${remain}F ÊâìÊäïÊã©</div>
                            <div class="text-xs text-zinc-500 mb-4">ÂèñÊ∂àÂãæÈÄâÂèØÈöêËóè‰∏çÈúÄË¶ÅÁöÑÂç°Â∏ßÊñπÊ°à</div>
                        </div>
                        <div class="space-y-2 sm:space-y-3 mb-6">
                            ${allDescs.map((desc, i) => {
                                const isHidden = isMixupHidden(adv, remain, desc);
                                return `
                                    <label class="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 bg-zinc-800/50 border border-zinc-700 cursor-pointer hover:bg-zinc-800 active:bg-zinc-700 transition-colors min-h-[48px]">
                                        <input type="checkbox" ${!isHidden ? 'checked' : ''} 
                                            onchange="toggleMixupHidden(${adv}, ${remain}, '${desc.replace(/'/g, "\\'")}')"
                                            class="w-5 h-5 sm:w-4 sm:h-4 accent-cyan-500 flex-shrink-0">
                                        <span class="text-white font-bold text-sm sm:text-base">${desc}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                        <div class="flex gap-2 sm:gap-3">
                            <button onclick="resetMixupHidden(${adv}, ${remain})" class="flex-1 px-4 py-3 sm:py-2.5 bg-zinc-700 text-zinc-300 hover:bg-zinc-600 active:bg-zinc-500 transition-colors text-sm font-bold min-h-[44px]">ÊÅ¢Â§çÂÖ®ÈÉ®</button>
                            <button onclick="closeMixupEditModal()" class="flex-1 px-4 py-3 sm:py-2.5 bg-cyan-600 text-white hover:bg-cyan-500 active:bg-cyan-400 transition-colors text-sm font-bold min-h-[44px]">ÂÆåÊàê</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Ê∑ªÂä†ESCÂÖ≥Èó≠ÊîØÊåÅ
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    closeMixupEditModal();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }
        
        // ÂÖ≥Èó≠ÊâìÊäïÊã©ÁºñËæëÂºπÁ™ó
        function closeMixupEditModal() {
            const modal = document.getElementById('mixupEditModal');
            if (modal) modal.remove();
        }
        
        // ÊÅ¢Â§çÊüê‰∏™Âú∫ÊôØÁöÑÊâÄÊúâÈöêËóè
        function resetMixupHidden(adv, remain) {
            const mixups = calculateThrowMixups();
            const item = mixups[remain].find(m => m.adv === adv);
            if (!item) return;
            
            item.killDescs.forEach(desc => {
                const key = getMixupKey(adv, remain, desc);
                delete state.mixupHidden[key];
            });
            
            saveMixupHidden();
            closeMixupEditModal();
            openMixupEditModal(adv, remain);
            renderThrowMixupContent();
        }

        // ==================== ‰∫ã‰ª∂Â§ÑÁêÜ ====================
        function openCharacterModal() { 
            initCharacterGrid();
            document.getElementById('charModal').classList.remove('hidden'); 
        }
        
        function closeCharModal() { 
            document.getElementById('charModal').classList.add('hidden'); 
        }
        
        function openHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
        }
        
        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
        }
        
        function openRuleModal() {
            // Â°´ÂÖÖÊãõÂºè‰∏ãÊãâÂàóË°®
            populateMoveSelects();
            // ÈªòËÆ§ÊòæÁ§∫Á¶ÅÁî®ÂéãÂà∂tab
            switchRuleTab('disable');
            document.getElementById('ruleModal').classList.remove('hidden');
        }
        
        function closeRuleModal() {
            document.getElementById('ruleModal').classList.add('hidden');
            // Ê∏ÖÁ©∫ÊâÄÊúâËæìÂÖ•
            document.getElementById('inputDisableMove').value = '';
            document.getElementById('inputDisableUsage').value = 'kill';
            document.getElementById('inputDisableDesc').value = '';
            document.getElementById('inputComboMove1').value = '';
            document.getElementById('inputComboMove2').value = '';
            document.getElementById('inputComboDesc').value = '';
            document.getElementById('inputPreferMove').value = '';
            document.getElementById('inputPreferDesc').value = '';
        }
        
        // ÂàáÊç¢ËßÑÂàôÁ±ªÂûã tab
        function switchRuleTab(type) {
            // Êõ¥Êñ∞ tab ÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.rule-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`ruleTab-${type}`).classList.add('active');
            
            // ÊòæÁ§∫/ÈöêËóèË°®Âçï
            document.getElementById('ruleForm-disable').classList.toggle('hidden', type !== 'disable');
            document.getElementById('ruleForm-combo').classList.toggle('hidden', type !== 'combo');
            document.getElementById('ruleForm-prefer').classList.toggle('hidden', type !== 'prefer');
        }
        
        // Â°´ÂÖÖÊãõÂºè‰∏ãÊãâÂàóË°®
        function populateMoveSelects() {
            const moves = state.moveLibrary.map(m => m.name).sort();
            
            // Á¶ÅÁî®ÂéãÂà∂ËßÑÂàôÁöÑ‰∏ãÊãâ
            const disableSelect = document.getElementById('inputDisableMove');
            disableSelect.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã©ÊãõÂºè --</option>' +
                moves.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // Á¶ÅÁî®ÁªÑÂêàËßÑÂàôÁöÑ‰∏§‰∏™‰∏ãÊãâ
            const comboSelect1 = document.getElementById('inputComboMove1');
            const comboSelect2 = document.getElementById('inputComboMove2');
            const optionsHtml = '<option value="">-- ËØ∑ÈÄâÊã©ÊãõÂºè --</option>' +
                moves.map(m => `<option value="${m}">${m}</option>`).join('');
            comboSelect1.innerHTML = optionsHtml;
            comboSelect2.innerHTML = optionsHtml;
            
            // ÂÄæÂêëÂéãÂà∂ËßÑÂàôÁöÑ‰∏ãÊãâ
            const preferSelect = document.getElementById('inputPreferMove');
            preferSelect.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã©ÊãõÂºè --</option>' +
                moves.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        
        // ‰øùÂ≠òÁ¶ÅÁî®ÂéãÂà∂ËßÑÂàô
        function saveDisableRule() {
            const moveName = document.getElementById('inputDisableMove').value.trim();
            const usage = document.getElementById('inputDisableUsage').value;
            const description = document.getElementById('inputDisableDesc').value.trim();
            
            if (!moveName) {
                showToast('ËØ∑ÈÄâÊã©ÊãõÂºè', 'error');
                return;
            }
            
            const usageLabels = {
                'kill': 'Áî®‰∫éÂç°Â∏ß',
                'meaty_after_kill': 'Áî®‰∫éÂç°Â∏ßÂêéÂéãÂà∂',
                'meaty_direct': 'Áî®‰∫éÁõ¥Êé•ÂéãÂà∂'
            };
            
            const newRule = {
                id: `rule_${Date.now()}`,
                type: 'disable',
                moveName,
                usage,
                description: description || `Á¶ÅÊ≠¢ ${moveName} ${usageLabels[usage]}`
            };
            
            // Ê∑ªÂä†Âà∞ËßíËâ≤‰∏ìÂ±ûËßÑÂàô
            if (!state.characterRules[state.currentCharacter]) {
                state.characterRules[state.currentCharacter] = [];
            }
            state.characterRules[state.currentCharacter].push(newRule);
            
            // ‰øùÂ≠òÂà∞ localStorage
            saveCharacterRules(state.currentCharacter, state.characterRules[state.currentCharacter]);
            
            closeRuleModal();
            renderRules();
            renderNotes(); // ÈáçÊñ∞ËÆ°ÁÆóÊñπÊ°à
            showToast('ËßÑÂàôÂ∑≤Ê∑ªÂä†');
        }
        
        // ‰øùÂ≠òÁ¶ÅÁî®ÁªÑÂêàËßÑÂàô
        function saveComboRule() {
            const move1 = document.getElementById('inputComboMove1').value.trim();
            const move2 = document.getElementById('inputComboMove2').value.trim();
            const description = document.getElementById('inputComboDesc').value.trim();
            
            if (!move1 || !move2) {
                showToast('ËØ∑ÈÄâÊã©‰∏§‰∏™ÊãõÂºè', 'error');
                return;
            }
            
            if (move1 === move2) {
                showToast('ËØ∑ÈÄâÊã©‰∏çÂêåÁöÑÊãõÂºè', 'error');
                return;
            }
            
            const newRule = {
                id: `rule_${Date.now()}`,
                type: 'combo',
                move1,
                move2,
                description: description || `${move1} √ó ${move2} Á¶ÅÊ≠¢ËøûÁª≠‰ΩøÁî®`
            };
            
            // Ê∑ªÂä†Âà∞ËßíËâ≤‰∏ìÂ±ûËßÑÂàô
            if (!state.characterRules[state.currentCharacter]) {
                state.characterRules[state.currentCharacter] = [];
            }
            state.characterRules[state.currentCharacter].push(newRule);
            
            // ‰øùÂ≠òÂà∞ localStorage
            saveCharacterRules(state.currentCharacter, state.characterRules[state.currentCharacter]);
            
            closeRuleModal();
            renderRules();
            renderNotes(); // ÈáçÊñ∞ËÆ°ÁÆóÊñπÊ°à
            showToast('ËßÑÂàôÂ∑≤Ê∑ªÂä†');
        }
        
        // ‰øùÂ≠òÂÄæÂêëÂéãÂà∂ËßÑÂàô
        function savePreferRule() {
            const moveName = document.getElementById('inputPreferMove').value.trim();
            const description = document.getElementById('inputPreferDesc').value.trim();
            
            if (!moveName) {
                showToast('ËØ∑ÈÄâÊã©ÊãõÂºè', 'error');
                return;
            }
            
            const newRule = {
                id: `rule_${Date.now()}`,
                type: 'prefer',
                moveName,
                description: description || `ÂÄæÂêë‰ΩøÁî® ${moveName} ËøõË°åÂéãÂà∂`
            };
            
            // Ê∑ªÂä†Âà∞ËßíËâ≤‰∏ìÂ±ûËßÑÂàô
            if (!state.characterRules[state.currentCharacter]) {
                state.characterRules[state.currentCharacter] = [];
            }
            state.characterRules[state.currentCharacter].push(newRule);
            
            // ‰øùÂ≠òÂà∞ localStorage
            saveCharacterRules(state.currentCharacter, state.characterRules[state.currentCharacter]);
            
            closeRuleModal();
            renderRules();
            renderNotes(); // ÈáçÊñ∞ËÆ°ÁÆóÊñπÊ°à
            showToast('ËßÑÂàôÂ∑≤Ê∑ªÂä†');
        }
        
        function saveRule() {
            const pattern1 = document.getElementById('inputPattern1').value.trim().toUpperCase();
            const pattern2 = document.getElementById('inputPattern2').value.trim().toUpperCase();
            const description = document.getElementById('inputRuleDesc').value.trim();
            
            if (!pattern1 || !pattern2) {
                alert('ËØ∑Â°´ÂÜô‰∏§‰∏™ÊãõÂºèÂÖ≥ÈîÆËØç');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶‰∏éÁé∞ÊúâËßÑÂàôÈáçÂ§çÔºàÂåÖÊã¨ÂÖ®Â±ÄËßÑÂàôÔºâ
            const allRules = getAllRulesForCharacter(state.currentCharacter);
            const isDuplicate = allRules.some(r => {
                const p1 = r.pattern1.toUpperCase();
                const p2 = r.pattern2.toUpperCase();
                // ÂèåÂêëÂåπÈÖçÊ£ÄÊü•
                return (p1 === pattern1 && p2 === pattern2) || (p1 === pattern2 && p2 === pattern1);
            });
            
            if (isDuplicate) {
                alert('ËØ•ËßÑÂàôÂ∑≤Â≠òÂú®');
                return;
            }
            
            const newRule = {
                id: `rule_${Date.now()}`,
                pattern1,
                pattern2,
                description: description || `${pattern1} √ó ${pattern2} Á¶ÅÊ≠¢ÁªÑÂêà`
            };
            
            // Ê∑ªÂä†Âà∞ËßíËâ≤‰∏ìÂ±ûËßÑÂàô
            if (!state.characterRules[state.currentCharacter]) {
                state.characterRules[state.currentCharacter] = [];
            }
            state.characterRules[state.currentCharacter].push(newRule);
            
            // ‰øùÂ≠òÂà∞ localStorage
            saveCharacterRules(state.currentCharacter, state.characterRules[state.currentCharacter]);
            
            closeRuleModal();
            renderRules();
            renderNotes(); // ÈáçÊñ∞ËÆ°ÁÆóÊñπÊ°à
            showToast('ËßÑÂàôÂ∑≤Ê∑ªÂä†');
        }
        
        function removeRule(ruleId) {
            // ÂÖàÊ£ÄÊü•ÊòØÂê¶ÊòØÈ¢ÑËÆæËßÑÂàô
            const presetRules = CONFIG.CHARACTER_PRESET_RULES[state.currentCharacter] || [];
            const presetRule = presetRules.find(r => r.id === ruleId);
            
            if (presetRule) {
                // Âà†Èô§È¢ÑËÆæËßÑÂàô
                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§È¢ÑËÆæËßÑÂàôÂêóÔºü\n${presetRule.description || 'È¢ÑËÆæËßÑÂàô'}\n\nÔºàÂèØÈÄöËøá"ÈáçÁΩÆ"ÊÅ¢Â§çÔºâ`)) {
                    return;
                }
                // ËÆ∞ÂΩïÂ∑≤Âà†Èô§ÁöÑÈ¢ÑËÆæËßÑÂàô
                state.deletedPresetRules[`${state.currentCharacter}:${ruleId}`] = true;
                saveDeletedPresetRules();
                renderRules();
                renderNotes();
                showToast('È¢ÑËÆæËßÑÂàôÂ∑≤Âà†Èô§');
                return;
            }
            
            // Âà†Èô§Ëá™ÂÆö‰πâËßÑÂàô
            const rules = state.characterRules[state.currentCharacter] || [];
            const idx = rules.findIndex(r => r.id === ruleId);
            if (idx !== -1) {
                const rule = rules[idx];
                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ËßÑÂàôÂêóÔºü\n${rule.description || 'Ëá™ÂÆö‰πâËßÑÂàô'}`)) {
                    return;
                }
                rules.splice(idx, 1);
                saveCharacterRules(state.currentCharacter, rules);
                renderRules();
                renderNotes();
                showToast('ËßÑÂàôÂ∑≤Âà†Èô§');
            }
        }
        
        // ‰øùÂ≠òÂ∑≤Âà†Èô§ÁöÑÈ¢ÑËÆæËßÑÂàô
        function saveDeletedPresetRules() {
            try {
                localStorage.setItem(`${CONFIG.STORAGE_KEY}_deleted_preset_rules`, JSON.stringify(state.deletedPresetRules));
            } catch (e) {
                console.warn('‰øùÂ≠òÂ∑≤Âà†Èô§È¢ÑËÆæËßÑÂàôÂ§±Ë¥•:', e);
            }
        }
        
        // Âä†ËΩΩÂ∑≤Âà†Èô§ÁöÑÈ¢ÑËÆæËßÑÂàô
        function loadDeletedPresetRules() {
            try {
                const saved = localStorage.getItem(`${CONFIG.STORAGE_KEY}_deleted_preset_rules`);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Âä†ËΩΩÂ∑≤Âà†Èô§È¢ÑËÆæËßÑÂàôÂ§±Ë¥•:', e);
            }
            return {};
        }
        
        function clearAllRules() {
            const rules = state.characterRules[state.currentCharacter] || [];
            if (rules.length === 0) {
                showToast('Ê≤°ÊúâÂèØÊ∏ÖÈô§ÁöÑËßÑÂàô', 'info');
                return;
            }
            if (!confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ ${state.currentCharacter} ÁöÑÊâÄÊúâ ${rules.length} Êù°Ëá™ÂÆö‰πâËßÑÂàôÂêóÔºü\nÔºàÂÖ®Â±ÄËßÑÂàô‰∏çÂèóÂΩ±ÂìçÔºâ`)) {
                return;
            }
            state.characterRules[state.currentCharacter] = [];
            saveCharacterRules(state.currentCharacter, []);
            renderRules();
            renderNotes();
            showToast(`Â∑≤Ê∏ÖÈô§ ${rules.length} Êù°ËßÑÂàô`);
        }
        
        // ==================== Êñ∞Â¢ûÊãõÂºèÂºπÁ™ó ====================
        let currentMoveType = 'normal';  // normal, throw, dash
        
        function openAddMoveModal() {
            currentMoveType = 'normal';
            updateMoveTypeUI();
            document.getElementById('addMoveModal').classList.remove('hidden');
            document.getElementById('inputMoveName').focus();
        }
        
        function closeAddMoveModal() {
            document.getElementById('addMoveModal').classList.add('hidden');
            // Ê∏ÖÁ©∫ÊâÄÊúâËæìÂÖ•
            document.getElementById('inputMoveName').value = '';
            document.getElementById('inputMoveStartup').value = '';
            document.getElementById('inputMoveActive').value = '';
            document.getElementById('inputMoveRecovery').value = '';
            document.getElementById('inputMoveHit').value = '';
            document.getElementById('inputMoveBlock').value = '';
            document.getElementById('inputMoveKnockdown').checked = false;
            document.getElementById('inputMoveDashFrames').value = '';
        }
        
        function setMoveType(type) {
            currentMoveType = type;
            updateMoveTypeUI();
        }
        
        function updateMoveTypeUI() {
            const normalBtn = document.getElementById('moveTypeNormal');
            const throwBtn = document.getElementById('moveTypeThrow');
            const dashBtn = document.getElementById('moveTypeDash');
            const frameFields = document.getElementById('moveFrameFields');
            const dashFields = document.getElementById('moveDashFields');
            const hitBlockFields = document.getElementById('moveHitBlockFields');
            const knockdownField = document.getElementById('moveKnockdownField');
            
            // ÈáçÁΩÆÊåâÈíÆÊ†∑Âºè
            [normalBtn, throwBtn, dashBtn].forEach(btn => {
                btn.style.backgroundColor = '';
                btn.className = 'flex-1 py-2 text-xs font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white';
            });
            
            // ËÆæÁΩÆÈÄâ‰∏≠ÊåâÈíÆÊ†∑Âºè
            const selectedBtn = currentMoveType === 'normal' ? normalBtn : 
                               currentMoveType === 'throw' ? throwBtn : dashBtn;
            selectedBtn.style.backgroundColor = 'var(--theme-btn-primary)';
            selectedBtn.className = 'flex-1 py-2 text-xs font-bold transition-all text-white';
            
            // ÊòæÁ§∫/ÈöêËóèÂ≠óÊÆµ
            if (currentMoveType === 'dash') {
                frameFields.classList.add('hidden');
                dashFields.classList.remove('hidden');
            } else {
                frameFields.classList.remove('hidden');
                dashFields.classList.add('hidden');
                
                // ÊäïÊäÄÈöêËóè Hit/Block Âíå Knockdown ÈÄâÈ°π
                if (currentMoveType === 'throw') {
                    hitBlockFields.classList.add('hidden');
                    knockdownField.classList.add('hidden');
                } else {
                    hitBlockFields.classList.remove('hidden');
                    knockdownField.classList.remove('hidden');
                }
            }
        }
        
        function saveNewMove() {
            const name = document.getElementById('inputMoveName').value.trim().toUpperCase();
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•ÊãõÂºèÂêçÁß∞');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÈáçÂ§ç
            const exists = state.moveLibrary.some(m => m.name.toUpperCase() === name);
            if (exists) {
                alert('ËØ•ÊãõÂºèÂ∑≤Â≠òÂú®');
                return;
            }
            
            let newMove;
            
            if (currentMoveType === 'dash') {
                const dashFrames = parseInt(document.getElementById('inputMoveDashFrames').value);
                if (!dashFrames || dashFrames <= 0) {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ Dash Â∏ßÊï∞');
                    return;
                }
                newMove = {
                    name,
                    isDash: true,
                    dashFrames,
                    isUserAdded: true  // Ê†áËÆ∞‰∏∫Áî®Êà∑Ê∑ªÂä†
                };
            } else {
                const startup = parseInt(document.getElementById('inputMoveStartup').value);
                const active = document.getElementById('inputMoveActive').value.trim();
                const recovery = parseInt(document.getElementById('inputMoveRecovery').value);
                
                if (!startup || startup <= 0) {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ Startup');
                    return;
                }
                if (!active) {
                    alert('ËØ∑ËæìÂÖ• Active Â∏ßÔºàÂ¶Ç: 7-9 Êàñ 5-7,12-14Ôºâ');
                    return;
                }
                if (!recovery || recovery < 0) {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ Recovery');
                    return;
                }
                
                // È™åËØÅ active Ê†ºÂºè
                const activeRegex = /^\d+(-\d+)?(,\d+(-\d+)?)*$/;
                if (!activeRegex.test(active)) {
                    alert('Active Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑‰ΩøÁî®Â¶Ç 7-9 Êàñ 5-7,12-14 ÁöÑÊ†ºÂºè');
                    return;
                }
                
                if (currentMoveType === 'throw') {
                    newMove = {
                        name,
                        startup,
                        active,
                        recovery,
                        isThrow: true,
                        isKnockdown: true,
                        isUserAdded: true
                    };
                } else {
                    const hit = parseInt(document.getElementById('inputMoveHit').value) || 0;
                    const block = parseInt(document.getElementById('inputMoveBlock').value) || 0;
                    const isKnockdown = document.getElementById('inputMoveKnockdown').checked;
                    
                    newMove = {
                        name,
                        startup,
                        active,
                        recovery,
                        hit,
                        block,
                        isKnockdown,
                        isUserAdded: true
                    };
                }
            }
            
            // Ê∑ªÂä†Âà∞ÊãõÂºèÂ∫ì
            state.moveLibrary.push(newMove);
            
            // Êõ¥Êñ∞ÁºìÂ≠ò
            if (state.characterCache[state.currentCharacter]) {
                state.characterCache[state.currentCharacter].moves = [...state.moveLibrary];
            }
            
            // ‰øùÂ≠òÂà∞ localStorage
            saveMoves(state.currentCharacter, state.moveLibrary);
            
            closeAddMoveModal();
            renderAll();
            showToast(`Â∑≤Ê∑ªÂä† ${name}`);
        }
        
        function renderRules() {
            const container = document.getElementById('rulesContainer');
            if (!container) return;
            
            const allRules = getAllRulesForCharacter(state.currentCharacter);
            
            if (allRules.length === 0) {
                container.innerHTML = '<div class="text-zinc-600 italic">ÊöÇÊó†ËßÑÂàô</div>';
                return;
            }
            
            container.innerHTML = allRules.map(rule => {
                const isGlobal = rule.isGlobal;
                const isPreset = rule.isPreset;
                const tagClass = isGlobal ? 'bg-zinc-700 text-zinc-400' : 'bg-cyan-900/50 text-cyan-400';
                const tagText = isGlobal ? 'ÂÖ®Â±Ä' : state.currentCharacter;
                // Âè™ÊúâÂÖ®Â±ÄËßÑÂàô‰∏çËÉΩÂà†Èô§ÔºåËßíËâ≤È¢ÑËÆæÂíåËá™ÂÆö‰πâËßÑÂàôÈÉΩÂèØ‰ª•Âà†Èô§
                const deleteBtn = isGlobal ? '' : `<button onclick="removeRule('${rule.id}')" class="text-zinc-600 hover:text-red-500 transition-colors p-2 -m-1 text-base" title="Âà†Èô§ËßÑÂàô">‚úï</button>`;
                
                // Ê†πÊçÆËßÑÂàôÁ±ªÂûãÊ∏≤Êüì‰∏çÂêåÁöÑÂÜÖÂÆπ
                let content = '';
                let typeLabel = '';
                let typeColor = '';
                
                if (rule.type === 'disable') {
                    // Á¶ÅÁî®ÂéãÂà∂ËßÑÂàô
                    const usageLabels = {
                        'kill': 'Âç°Â∏ß',
                        'meaty_after_kill': 'Âç°Â∏ßÂêéÂéãÂà∂',
                        'meaty_direct': 'Áõ¥Êé•ÂéãÂà∂'
                    };
                    typeLabel = 'Á¶ÅÁî®';
                    typeColor = 'text-red-400';
                    content = `
                        <span class="${typeColor} font-bold">${escapeHtml(rule.moveName)}</span>
                        <span class="text-zinc-600 mx-1">‚Üí</span>
                        <span class="text-zinc-400">Á¶ÅÊ≠¢${usageLabels[rule.usage] || rule.usage}</span>
                    `;
                } else if (rule.type === 'combo') {
                    // Á¶ÅÁî®ÁªÑÂêàËßÑÂàô
                    typeLabel = 'Á¶ÅÁî®';
                    typeColor = 'text-red-400';
                    content = `
                        <span class="${typeColor} font-mono">${escapeHtml(rule.move1)}</span>
                        <span class="text-zinc-600 mx-1">√ó</span>
                        <span class="${typeColor} font-mono">${escapeHtml(rule.move2)}</span>
                    `;
                } else if (rule.type === 'prefer') {
                    // ÂÄæÂêëÂéãÂà∂ËßÑÂàô
                    typeLabel = 'ÂÄæÂêë';
                    typeColor = 'text-green-400';
                    content = `
                        <span class="${typeColor} font-bold">${escapeHtml(rule.moveName)}</span>
                        <span class="text-zinc-400 ml-2">‰ºòÂÖàÊé®Ëçê‰∏∫ÂéãÂà∂ÊãõÂºè</span>
                    `;
                } else {
                    // ÊóßÁöÑ pattern ËßÑÂàôÔºàÂÖºÂÆπÔºâ
                    typeLabel = 'Á¶ÅÁî®';
                    typeColor = 'text-red-400';
                    content = `
                        <span class="text-zinc-300 font-mono">${escapeHtml(rule.pattern1)}</span>
                        <span class="text-zinc-600 mx-1">√ó</span>
                        <span class="text-zinc-300 font-mono">${escapeHtml(rule.pattern2)}</span>
                    `;
                }
                
                return `
                    <div class="flex items-center justify-between py-1.5 px-2 bg-zinc-800/30 border-l-2 ${isGlobal ? 'border-zinc-600' : 'border-cyan-600'}">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-[9px] px-1.5 py-0.5 ${tagClass} uppercase tracking-wide">${tagText}</span>
                            <span class="text-[9px] px-1.5 py-0.5 bg-zinc-700/50 ${typeColor} uppercase">${typeLabel}</span>
                            ${content}
                            ${rule.description ? `<span class="text-zinc-500 text-xs ml-2">‚Äî ${escapeHtml(rule.description)}</span>` : ''}
                        </div>
                        ${deleteBtn}
                    </div>
                `;
            }).join('');
        }
        
        // ==================== Ê®°Á≥äÂ∏ßÊï∞ÂäüËÉΩ ====================
        // Ê®°Á≥äÊ®°ÂºèÂºÄÂÖ≥Áä∂ÊÄÅ
        let fuzzyMode = false;
        // Ê®°Á≥äÊ®°ÂºèËÆ°ÁÆóÁªìÊûú
        let fuzzyPreviewResult = null;
        
        // ÂàáÊç¢Ê®°Á≥äÊ®°Âºè
        function toggleFuzzyMode() {
            fuzzyMode = !fuzzyMode;
            const switchEl = document.getElementById('fuzzySwitch');
            const labelExact = document.getElementById('fuzzyLabelExact');
            const labelFuzzy = document.getElementById('fuzzyLabelFuzzy');
            const exactGroup = document.getElementById('exactInputGroup');
            const fuzzyGroup = document.getElementById('fuzzyInputGroup');
            const hint = document.getElementById('advHint');
            const expectDetails = document.getElementById('expectDetails');
            
            if (fuzzyMode) {
                switchEl.classList.add('active');
                labelExact.classList.add('fuzzy-switch-label-inactive');
                labelFuzzy.classList.remove('fuzzy-switch-label-inactive');
                exactGroup.classList.add('hidden');
                fuzzyGroup.classList.remove('hidden');
                hint.textContent = 'ËæìÂÖ•Â∏ßÊï∞ËåÉÂõ¥ÔºåÁ≥ªÁªüÂ∞ÜËÆ°ÁÆóË¶ÜÁõñÊâÄÊúâÊÉÖÂÜµÁöÑÊúÄ‰ºòÊñπÊ°à';
                // ÈöêËóèÊúüÊúõÂêéÁª≠ÔºàÊ®°Á≥äÊ®°Âºè‰∏çÊîØÊåÅÔºâ
                expectDetails.classList.add('hidden');
                // ÂàùÂßãÂåñËÆ°ÁÆó
                calculateFuzzyPreview();
            } else {
                switchEl.classList.remove('active');
                labelExact.classList.remove('fuzzy-switch-label-inactive');
                labelFuzzy.classList.add('fuzzy-switch-label-inactive');
                exactGroup.classList.remove('hidden');
                fuzzyGroup.classList.add('hidden');
                hint.textContent = 'ËåÉÂõ¥ 1~99';
                // ÊòæÁ§∫ÊúüÊúõÂêéÁª≠
                expectDetails.classList.remove('hidden');
                // ÁßªÈô§Ê®°Á≥äÈ¢ÑËßà
                removeFuzzyPreview();
            }
        }
        
        // Ê∏ÖÁêÜÊ®°Á≥äËæìÂÖ•
        function sanitizeFuzzyInput(inputId) {
            const input = document.getElementById(inputId);
            let val = input.value.replace(/[^0-9]/g, '');
            if (val.length > 2) val = val.slice(0, 2);
            if (parseInt(val) > 99) val = '99';
            if (val.length > 1 && val.startsWith('0')) val = val.replace(/^0+/, '');
            input.value = val;
        }
        
        // ÁßªÈô§Ê®°Á≥äÈ¢ÑËßà
        function removeFuzzyPreview() {
            const existing = document.getElementById('fuzzyPreviewContainer');
            if (existing) existing.remove();
            fuzzyPreviewResult = null;
        }
        
        // ËÆ°ÁÆóÊ®°Á≥äÂ∏ßÊï∞È¢ÑËßà
        function calculateFuzzyPreview() {
            const minAdv = parseInt(document.getElementById('inputAdvMin').value);
            const maxAdv = parseInt(document.getElementById('inputAdvMax').value);
            
            removeFuzzyPreview();
            
            if (!minAdv || !maxAdv || minAdv < 1 || maxAdv < 1 || minAdv > maxAdv) {
                return;
            }
            
            // ÈôêÂà∂ËåÉÂõ¥Â§ßÂ∞èÔºàÈÅøÂÖçËÆ°ÁÆóÈáèËøáÂ§ßÔºâ
            if (maxAdv - minAdv > 10) {
                showFuzzyPreviewError('ËåÉÂõ¥ËøáÂ§ßÔºåËØ∑ÈôêÂà∂Âú®10Â∏ß‰ª•ÂÜÖ');
                return;
            }
            
            const result = calculateFuzzyBestPlans(minAdv, maxAdv);
            fuzzyPreviewResult = result;
            
            if (!result.bestByBlock && !result.bestByHit) {
                showFuzzyPreviewError('Ê≤°ÊúâÁ¨¶ÂêàÊù°‰ª∂ÁöÑÊñπÊ°à<br><span class="text-xs text-zinc-500">Á∫¶Êùü: ‚ë†‰∏çË¢´4Â∏ßÊä¢(ÂèëÁîü-ÂÅ∑Â∏ß‚â•4) ‚ë°‰∏çÊå•Á©∫</span>');
                return;
            }
            
            showFuzzyPreviewResult(result, minAdv, maxAdv);
        }
        
        // ÊòæÁ§∫Ê®°Á≥äÈ¢ÑËßàÈîôËØØ
        function showFuzzyPreviewError(message) {
            const container = document.createElement('div');
            container.id = 'fuzzyPreviewContainer';
            container.className = 'fuzzy-preview';
            container.innerHTML = `
                <div class="text-red-400 font-bold text-sm">‚ùå ${message}</div>
            `;
            document.getElementById('fuzzyInputGroup').after(container);
        }
        
        // ÊòæÁ§∫Ê®°Á≥äÈ¢ÑËßàÁªìÊûú
        function showFuzzyPreviewResult(result, minAdv, maxAdv) {
            const container = document.createElement('div');
            container.id = 'fuzzyPreviewContainer';
            container.className = 'fuzzy-preview';
            
            const allValidPlans = result.allPlans || [];
            let html = `<div class="fuzzy-preview-title">Êé®ËçêÊñπÊ°à (${minAdv}~${maxAdv}F) - ÂÖ±${allValidPlans.length}‰∏™</div>`;
            
            if (allValidPlans.length <= 2) {
                // ‚â§2 ‰∏™ÊñπÊ°àÔºåÊòæÁ§∫ÂÖ®ÈÉ®
                allValidPlans.forEach((plan, i) => {
                    html += renderFuzzyPreviewItem(plan, i === 0 ? 'Êé®Ëçê' : 'Â§áÈÄâ');
                });
            } else {
                // >2 ‰∏™ÊñπÊ°àÔºåÊòæÁ§∫ÊúÄ‰ºò‰∏§‰∏™
                if (result.bestByBlock) {
                    html += renderFuzzyPreviewItem(result.bestByBlock, 'üõ°Ô∏è Èò≤Âæ°ÊúÄ‰ºò');
                }
                if (result.bestByHit && result.bestByHit.key !== result.bestByBlock?.key) {
                    html += renderFuzzyPreviewItem(result.bestByHit, '‚öîÔ∏è ÂëΩ‰∏≠ÊúÄ‰ºò');
                }
            }
            
            container.innerHTML = html;
            document.getElementById('fuzzyInputGroup').after(container);
        }
        
        // Ê∏≤ÊüìÂçï‰∏™Ê®°Á≥äÈ¢ÑËßàÈ°π
        function renderFuzzyPreviewItem(plan, label) {
            const safetyMargin = plan.startup - plan.maxStolen;
            return `
                <div class="fuzzy-preview-item">
                    <div class="fuzzy-preview-label">${label}</div>
                    <div class="fuzzy-preview-plan">${formatFuzzyPlan(plan)}</div>
                    <div class="fuzzy-preview-avg">
                        Âπ≥Âùá Block: <span class="${getFrameColorClass(plan.avgBlock)}">${plan.avgBlock >= 0 ? '+' : ''}${plan.avgBlock.toFixed(1)}F</span>
                        | Hit: <span class="${getFrameColorClass(plan.avgHit)}">${plan.avgHit >= 0 ? '+' : ''}${plan.avgHit.toFixed(1)}F</span>
                    </div>
                    <div class="fuzzy-preview-detail">
                        ÂÅ∑Â∏ß: ${plan.minStolen}~${plan.maxStolen}F | 
                        ÂÆâÂÖ®‰ΩôÈáè: <span class="${safetyMargin >= 4 ? 'text-green-400' : 'text-red-400'}">${safetyMargin}F</span> (ÂèëÁîü${plan.startup}-ÂÅ∑${plan.maxStolen})
                    </div>
                </div>
            `;
        }
        
        // Ê†ºÂºèÂåñÊ®°Á≥äÊñπÊ°àÊòæÁ§∫
        function formatFuzzyPlan(plan) {
            let result = '';
            if (plan.killDesc) {
                result += `<span class="text-zinc-400">${plan.killDesc} ‚Üí</span> `;
            }
            result += plan.meatyMove.name;
            return result;
        }
        
        // ==================== Ê®°Á≥äÂ∏ßÊï∞Ê†∏ÂøÉËÆ°ÁÆó ====================
        // ËÆ°ÁÆóÊ®°Á≥äÂ∏ßÊï∞ÁöÑÊúÄ‰ºòÊñπÊ°à
        // Á∫¶Êùü1: ‰∏çË¢´Êä¢ - startup - stolen >= 4ÔºàÂØπÊñπÊúÄÈÄü4Â∏ßÊã≥ËÑöÊä¢‰∏çÂà∞Ôºâ
        // Á∫¶Êùü2: ‰∏çÊå•Á©∫ - ÊãõÂºèactiveÁªìÊùüÂâçÂØπÊñπ‰∏ÄÂÆöËµ∑Ë∫´
        function calculateFuzzyBestPlans(minAdv, maxAdv) {
            const allPlans = [];
            const rules = getAllRulesForCharacter(state.currentCharacter);
            
            // Ëé∑ÂèñÂèØÁî®ÁöÑÂéãÂà∂ÊãõÂºèÔºàÊúâ active ‰∏î‰∏çÊòØ dash/throwÔºâ
            const meatyMoves = state.moveLibrary.filter(m => 
                m.active && !m.isDash && !m.isThrow && !isMoveDisabled(m, 'meaty', rules)
            );
            
            // Ëé∑ÂèñÊâÄÊúâÂç°Â∏ßÊñπÊ°àÔºàÂåÖÊã¨‰∏çÂç°Â∏ß„ÄÅÂçïÊ≠•Âç°Â∏ß„ÄÅÂèåÊ≠•Âç°Â∏ßÔºâ
            const killPlans = generateAllKillPlans(rules);
            
            for (const meatyMove of meatyMoves) {
                const ranges = parseActiveRanges(meatyMove.active);
                const startup = ranges[0].start;  // ÊãõÂºèÂèëÁîüÂ∏ß
                const lastActiveEnd = ranges[ranges.length - 1].end;  // active ÊúÄÂêé‰∏ÄÂ∏ß
                
                for (const killPlan of killPlans) {
                    const killTotal = killPlan.total;
                    
                    // ËÆ°ÁÆóÂâ©‰ΩôÂ∏ßËåÉÂõ¥
                    const minRemain = minAdv - killTotal;
                    const maxRemain = maxAdv - killTotal;
                    
                    // Âü∫Á°ÄÊ£ÄÊü•ÔºöÂâ©‰ΩôÂ∏ßÂøÖÈ°ªÂ§ß‰∫é0
                    if (minRemain <= 0) continue;
                    
                    // Á∫¶Êùü3: ËÉΩÂëΩ‰∏≠ - ÂØπÊñπÊúÄÊó©Ëµ∑Ë∫´Êó∂ active Â∑≤ÂºÄÂßã
                    // minRemain + 1 >= startup ‚Üí minRemain >= startup - 1
                    if (minRemain < startup - 1) continue;
                    
                    // Á∫¶Êùü2: ‰∏çÊå•Á©∫ - ÂØπÊñπÊúÄÊôöËµ∑Ë∫´Êó∂ active ËøòÊ≤°ÁªìÊùü
                    // maxRemain + 1 <= lastActiveEnd ‚Üí maxRemain <= lastActiveEnd - 1
                    if (maxRemain > lastActiveEnd - 1) continue;
                    
                    // Á∫¶Êùü1: ‰∏çË¢´Êä¢ - ÂØπÊñπËµ∑Ë∫´ÊúÄÊôöÊó∂ startup - stolen >= 4
                    // maxStolen = maxRemain + 1 - startup
                    // startup - maxStolen >= 4
                    // startup - (maxRemain + 1 - startup) >= 4
                    // 2 * startup - maxRemain - 1 >= 4
                    // maxRemain <= 2 * startup - 5
                    if (maxRemain > 2 * startup - 5) continue;
                    
                    // ÊâÄÊúâÁ∫¶ÊùüÈÄöËøáÔºåËÆ°ÁÆóÂπ≥ÂùáÂ∏ßÊï∞
                    let totalHit = 0, totalBlock = 0;
                    
                    for (let remain = minRemain; remain <= maxRemain; remain++) {
                        const targetFrame = remain + 1;
                        const hitInfo = checkActiveHit(meatyMove.active, targetFrame);
                        
                        if (hitInfo) {
                            totalHit += (meatyMove.hit || 0) + hitInfo.stolen;
                            totalBlock += (meatyMove.block || 0) + hitInfo.stolen;
                        }
                    }
                    
                    const count = maxRemain - minRemain + 1;
                    const key = `${killPlan.desc}|${meatyMove.name}`;
                    
                    // ËÆ°ÁÆóËåÉÂõ¥ÂÜÖÁöÑÂÅ∑Â∏ßÊÉÖÂÜµÔºàÁî®‰∫éÊòæÁ§∫Ôºâ
                    const minStolen = minRemain + 1 - startup;
                    const maxStolen = maxRemain + 1 - startup;
                    
                    allPlans.push({
                        key,
                        killPlan,
                        killDesc: killPlan.desc,
                        meatyMove,
                        avgHit: totalHit / count,
                        avgBlock: totalBlock / count,
                        minRemain,
                        maxRemain,
                        minStolen,
                        maxStolen,
                        startup
                    });
                }
            }
            
            if (allPlans.length === 0) {
                return { bestByBlock: null, bestByHit: null };
            }
            
            // ÊåâÂπ≥Âùá Block ÈôçÂ∫èÊéíÂ∫è
            const sortedByBlock = [...allPlans].sort((a, b) => b.avgBlock - a.avgBlock);
            // ÊåâÂπ≥Âùá Hit ÈôçÂ∫èÊéíÂ∫è
            const sortedByHit = [...allPlans].sort((a, b) => b.avgHit - a.avgHit);
            
            return {
                bestByBlock: sortedByBlock[0],
                bestByHit: sortedByHit[0],
                allPlans
            };
        }
        
        // ÁîüÊàêÊâÄÊúâÂèØËÉΩÁöÑÂç°Â∏ßÊñπÊ°à
        function generateAllKillPlans(rules) {
            const plans = [];
            
            // ‰∏çÂç°Â∏ßÔºàÁõ¥Êé•ÂéãÂà∂Ôºâ
            plans.push({ total: 0, desc: '', moves: [] });
            
            // ÂçïÊ≠•Âç°Â∏ß
            for (const killMove of state.moveLibrary) {
                if (isMoveDisabled(killMove, 'kill', rules)) continue;
                
                let killTotal;
                if (killMove.isDash) {
                    killTotal = killMove.dashFrames || 19;
                } else if (killMove.active) {
                    const lastActive = getLastActiveFrame(killMove.active);
                    killTotal = lastActive + killMove.recovery;
                } else {
                    continue;
                }
                
                plans.push({ 
                    total: killTotal, 
                    desc: killMove.name, 
                    moves: [killMove] 
                });
            }
            
            // ÂèåÊ≠•Âç°Â∏ß
            for (const killMove1 of state.moveLibrary) {
                if (isMoveDisabled(killMove1, 'kill', rules)) continue;
                
                let killTotal1;
                if (killMove1.isDash) {
                    killTotal1 = killMove1.dashFrames || 19;
                } else if (killMove1.active) {
                    killTotal1 = getLastActiveFrame(killMove1.active) + killMove1.recovery;
                } else {
                    continue;
                }
                
                for (const killMove2 of state.moveLibrary) {
                    if (isMoveDisabled(killMove2, 'kill', rules)) continue;
                    if (isComboForbidden(killMove1, killMove2, rules)) continue;
                    
                    let killTotal2;
                    if (killMove2.isDash) {
                        killTotal2 = killMove2.dashFrames || 19;
                    } else if (killMove2.active) {
                        killTotal2 = getLastActiveFrame(killMove2.active) + killMove2.recovery;
                    } else {
                        continue;
                    }
                    
                    const total = killTotal1 + killTotal2;
                    // ÈÅøÂÖçÈáçÂ§çÔºàA+B Âíå B+A Âè™‰øùÁïô‰∏Ä‰∏™Ôºâ
                    const names = [killMove1.name, killMove2.name].sort();
                    const desc = `${names[0]} + ${names[1]}`;
                    
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÊñπÊ°à
                    if (!plans.some(p => p.desc === desc)) {
                        plans.push({
                            total,
                            desc,
                            moves: [killMove1, killMove2]
                        });
                    }
                }
            }
            
            return plans;
        }
        
        // ==================== ÊúüÊúõÂêéÁª≠ÂäüËÉΩ ====================
        // ÂΩìÂâçÊúüÊúõÊ®°ÂºèÔºö'remain' Êàñ 'move'
        let expectMode = 'remain';
        // ÂΩìÂâçËÆ°ÁÆóÂá∫ÁöÑÊúüÊúõÊñπÊ°à
        let currentExpectPlan = null;
        
        function setExpectMode(mode) {
            expectMode = mode;
            
            // Êõ¥Êñ∞ÊåâÈíÆÊ†∑Âºè
            const remainBtn = document.getElementById('expectModeRemain');
            const moveBtn = document.getElementById('expectModeMove');
            const remainPanel = document.getElementById('expectRemainPanel');
            const movePanel = document.getElementById('expectMovePanel');
            
            if (mode === 'remain') {
                remainBtn.className = 'flex-1 py-3 text-sm font-bold transition-all modal-btn-active text-white';
                moveBtn.className = 'flex-1 py-3 text-sm font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white';
                remainPanel.classList.remove('hidden');
                movePanel.classList.add('hidden');
            } else {
                remainBtn.className = 'flex-1 py-3 text-sm font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white';
                moveBtn.className = 'flex-1 py-3 text-sm font-bold transition-all modal-btn-active text-white';
                remainPanel.classList.add('hidden');
                movePanel.classList.remove('hidden');
            }
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÁªìÊûú
            currentExpectPlan = null;
            document.getElementById('expectResult').classList.add('hidden');
            
            // ÈáçÊñ∞ËÆ°ÁÆó
            calculateExpectPlan();
        }
        
        // Ë∞ÉÊï¥ÊúâÂà©Â∏ßÊï∞ÂÄºÔºà+/- ÊåâÈíÆÔºâ
        function adjustAdv(delta) {
            const input = document.getElementById('inputAdv');
            let currentVal = parseInt(input.value);
            
            // Â¶ÇÊûúËæìÂÖ•Ê°Ü‰∏∫Á©∫Ôºå‰ªé placeholder ÂÄºÂºÄÂßã
            if (isNaN(currentVal) || input.value === '') {
                currentVal = 40; // placeholder ÈªòËÆ§ÂÄº
            }
            
            const newVal = currentVal + delta;
            
            // ËåÉÂõ¥ÈôêÂà∂Ôºö1~99
            if (newVal < 1 || newVal > 99) {
                return; // Ë∂ÖÂá∫ËåÉÂõ¥Ôºå‰∏çÊâßË°å
            }
            
            input.value = newVal;
            updateExpectOptions();
        }
        
        // Ê∏ÖÁêÜËæìÂÖ•ÔºåÂè™ÂÖÅËÆ∏Êï∞Â≠ó‰∏îËåÉÂõ¥ 1~99
        function sanitizeAdvInput() {
            const input = document.getElementById('inputAdv');
            // ÁßªÈô§ÈùûÊï∞Â≠óÂ≠óÁ¨¶
            let val = input.value.replace(/[^0-9]/g, '');
            
            // ÈôêÂà∂ÊúÄÂ§ß‰∏§‰ΩçÊï∞
            if (val.length > 2) {
                val = val.slice(0, 2);
            }
            
            // Â¶ÇÊûúËæìÂÖ•ÁöÑÊï∞Â≠óË∂ÖËøá99ÔºåÊà™Êñ≠‰∏∫99
            if (parseInt(val) > 99) {
                val = '99';
            }
            
            // ÁßªÈô§ÂâçÂØºÈõ∂Ôºà‰ΩÜ‰øùÁïôÂçïÁã¨ÁöÑ 0 ‰ª•‰æøÁªßÁª≠ËæìÂÖ•Ôºâ
            if (val.length > 1 && val.startsWith('0')) {
                val = val.replace(/^0+/, '');
            }
            
            input.value = val;
        }
        
        // Êõ¥Êñ∞ÊúüÊúõÈÄâÈ°πÔºàÂΩìÊúâÂà©Â∏ßÂèòÂåñÊó∂Ôºâ
        function updateExpectOptions() {
            // Êõ¥Êñ∞ÊãõÂºè‰∏ãÊãâÊ°ÜÈÄâÈ°π
            const select = document.getElementById('inputExpectMove');
            
            // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠ÁöÑÂÄº
            const previousValue = select.value;
            
            select.innerHTML = '<option value="">-- ÈÄâÊã©ÊãõÂºè --</option>';
            
            // Âè™ÊòæÁ§∫Êúâ active ‰∏î‰∏çÊòØ dash/throw ÁöÑÊãõÂºè
            const availableMoves = state.moveLibrary.filter(m => m.active && !m.isDash && !m.isThrow);
            availableMoves.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name;
                opt.textContent = `${m.name} (ÂèëÁîü ${m.startup}F, ÊåÅÁª≠ ${m.active}F)`;
                select.appendChild(opt);
            });
            
            // ÊÅ¢Â§ç‰πãÂâçÈÄâ‰∏≠ÁöÑÂÄºÔºàÂ¶ÇÊûúËØ•ÈÄâÈ°π‰ªçÁÑ∂Â≠òÂú®Ôºâ
            if (previousValue && availableMoves.some(m => m.name === previousValue)) {
                select.value = previousValue;
            }
            
            // ÈáçÊñ∞ËÆ°ÁÆóÊúüÊúõÊñπÊ°à
            calculateExpectPlan();
        }
        
        // ËÆ°ÁÆóÊúüÊúõÊñπÊ°à
        function calculateExpectPlan() {
            const adv = parseInt(document.getElementById('inputAdv').value);
            const resultDiv = document.getElementById('expectResult');
            const resultContent = document.getElementById('expectResultContent');
            
            if (!adv || adv <= 0) {
                resultDiv.classList.add('hidden');
                currentExpectPlan = null;
                return;
            }
            
            let plan = null;
            
            if (expectMode === 'remain') {
                const targetRemain = parseInt(document.getElementById('inputExpectRemain').value);
                if (!targetRemain || targetRemain <= 0 || targetRemain >= adv) {
                    resultDiv.classList.add('hidden');
                    currentExpectPlan = null;
                    return;
                }
                plan = findFrameKillPlan(adv, targetRemain);
            } else {
                const moveName = document.getElementById('inputExpectMove').value;
                if (!moveName) {
                    resultDiv.classList.add('hidden');
                    currentExpectPlan = null;
                    return;
                }
                const move = state.moveLibrary.find(m => m.name === moveName);
                if (!move) {
                    resultDiv.classList.add('hidden');
                    currentExpectPlan = null;
                    return;
                }
                plan = findMoveKillPlan(adv, move);
            }
            
            currentExpectPlan = plan;
            resultDiv.classList.remove('hidden');
            
            if (plan) {
                resultContent.innerHTML = renderExpectPlanPreview(plan);
            } else {
                resultContent.innerHTML = `<div class="text-red-400 font-bold">‚ùå Ê≤°ÊúâÂØπÂ∫îÂç°Â∏ßËß£ÂÜ≥ÊñπÊ°à</div>
                    <div class="text-zinc-500 text-xs mt-1">Êó†ËÆ∫‰∏ÄÊ≠•ËøòÊòØ‰∏§Ê≠•Âç°Â∏ßÈÉΩÊó†Ê≥ïËææÊàêÊ≠§ÁõÆÊ†á</div>`;
            }
        }
        
        // Êü•ÊâæËÉΩÂç°Â∏ßÂà∞ÊåáÂÆöÂâ©‰ΩôÂ∏ßÊï∞ÁöÑÊñπÊ°à
        function findFrameKillPlan(adv, targetRemain) {
            const neededKill = adv - targetRemain;
            if (neededKill <= 0) return null;
            
            const rules = getAllRulesForCharacter(state.currentCharacter);
            
            // ÊñπÊ°àAÔºö‰∏ÄÊ≠•Âç°Â∏ß
            for (const killMove of state.moveLibrary) {
                // Ê£ÄÊü•ÊòØÂê¶Ë¢´Á¶ÅÁî®Áî®‰∫éÂç°Â∏ß
                if (isMoveDisabled(killMove, 'kill', rules)) continue;
                
                let killTotal;
                if (killMove.isDash) {
                    killTotal = killMove.dashFrames || 19;
                } else if (killMove.active) {
                    const lastActive = getLastActiveFrame(killMove.active);
                    killTotal = lastActive + killMove.recovery;
                } else {
                    continue;
                }
                
                if (killTotal === neededKill) {
                    return {
                        type: 'single',
                        killMove,
                        killTotal,
                        remain: targetRemain,
                        displayMeaty: `+${targetRemain}F`
                    };
                }
            }
            
            // ÊñπÊ°àCÔºö‰∏§Ê≠•Âç°Â∏ß
            for (const killMove1 of state.moveLibrary) {
                // Ê£ÄÊü•Á¨¨‰∏ÄÊ≠•ÊòØÂê¶Ë¢´Á¶ÅÁî®Áî®‰∫éÂç°Â∏ß
                if (isMoveDisabled(killMove1, 'kill', rules)) continue;
                
                let killTotal1;
                if (killMove1.isDash) {
                    killTotal1 = killMove1.dashFrames || 19;
                } else if (killMove1.active) {
                    const lastActive1 = getLastActiveFrame(killMove1.active);
                    killTotal1 = lastActive1 + killMove1.recovery;
                } else {
                    continue;
                }
                
                if (killTotal1 >= neededKill) continue;
                
                for (const killMove2 of state.moveLibrary) {
                    // Ê£ÄÊü•Á¨¨‰∫åÊ≠•ÊòØÂê¶Ë¢´Á¶ÅÁî®Áî®‰∫éÂç°Â∏ß
                    if (isMoveDisabled(killMove2, 'kill', rules)) continue;
                    
                    // Ê£ÄÊü•ËßÑÂàôÁ¶ÅÊ≠¢ÁªÑÂêà
                    if (isComboForbidden(killMove1, killMove2, rules)) continue;
                    
                    let killTotal2;
                    if (killMove2.isDash) {
                        killTotal2 = killMove2.dashFrames || 19;
                    } else if (killMove2.active) {
                        const lastActive2 = getLastActiveFrame(killMove2.active);
                        killTotal2 = lastActive2 + killMove2.recovery;
                    } else {
                        continue;
                    }
                    
                    if (killTotal1 + killTotal2 === neededKill) {
                        return {
                            type: 'double',
                            killMove: killMove1,
                            killMove2,
                            killTotal: killTotal1,
                            killTotal2,
                            remain: targetRemain,
                            displayMeaty: `+${targetRemain}F`
                        };
                    }
                }
            }
            
            return null;
        }
        
        // Êü•ÊâæËÉΩÁî®ÊåáÂÆöÊãõÂºèÂéãÂà∂ÔºàÂÅ∑Ëá≥Â∞ë1Â∏ßÔºâÁöÑÂç°Â∏ßÊñπÊ°à
        function findMoveKillPlan(adv, targetMove) {
            const rules = getAllRulesForCharacter(state.currentCharacter);
            const bestPlans = [];
            
            // Ê£ÄÊü•ÂêÑÁßçÂèØËÉΩÁöÑÂâ©‰ΩôÂ∏ßÊï∞Ôºå‰ªéÂ§ßÂà∞Â∞èÔºàÂÅ∑Â∏ßË∂äÂ§öË∂äÂ•ΩÔºâ
            const ranges = parseActiveRanges(targetMove.active);
            const firstActiveStart = ranges[0].start;
            const lastActiveEnd = ranges[ranges.length - 1].end;
            
            // ËÆ°ÁÆóÂèØËÉΩÁöÑÂâ©‰ΩôÂ∏ßËåÉÂõ¥ÔºöËÆ© remain+1 ËêΩÂú® active ËåÉÂõ¥ÂÜÖ
            // remain+1 >= firstActiveStart ‰∏î remain+1 <= lastActiveEnd
            // Âç≥ remain >= firstActiveStart - 1 ‰∏î remain <= lastActiveEnd - 1
            // ‰ΩÜÊàë‰ª¨Ë¶ÅÂÅ∑Ëá≥Â∞ë1Â∏ßÔºåÂç≥ remain+1 > firstActiveStartÔºåÂç≥ remain >= firstActiveStart
            for (let remain = firstActiveStart; remain <= lastActiveEnd - 1; remain++) {
                const targetFrame = remain + 1;
                const hitInfo = checkActiveHit(targetMove.active, targetFrame);
                
                if (hitInfo && hitInfo.stolen >= 1) {
                    const neededKill = adv - remain;
                    
                    // ÁâπÊÆäÊÉÖÂÜµÔºö‰∏çÈúÄË¶ÅÂç°Â∏ßÔºåÁõ¥Êé•ÂéãÂà∂
                    if (neededKill === 0) {
                        // Ê£ÄÊü•ÊòØÂê¶Ë¢´Á¶ÅÁî®‰∫éÁõ¥Êé•ÂéãÂà∂
                        if (!isMoveDisabled(targetMove, 'meaty_direct', rules)) {
                            bestPlans.push({
                                type: 'direct',
                                remain: remain,
                                meatyMove: targetMove,
                                stolen: hitInfo.stolen,
                                finalHit: (targetMove.hit || 0) + hitInfo.stolen,
                                finalBlock: (targetMove.block || 0) + hitInfo.stolen,
                                displayMeaty: targetMove.name
                            });
                        }
                        continue;
                    }
                    
                    // Â∞ùËØïÊâæÂà∞Âç°Â∏ßÊñπÊ°à
                    const plan = findFrameKillPlan(adv, remain);
                    if (plan) {
                        // Ê£ÄÊü•targetMoveÊòØÂê¶Ë¢´Á¶ÅÁî®‰∫éÂç°Â∏ßÂêéÂéãÂà∂
                        if (!isMoveDisabled(targetMove, 'meaty_after_kill', rules)) {
                            bestPlans.push({
                                ...plan,
                                meatyMove: targetMove,
                                stolen: hitInfo.stolen,
                                finalHit: (targetMove.hit || 0) + hitInfo.stolen,
                                finalBlock: (targetMove.block || 0) + hitInfo.stolen,
                                displayMeaty: targetMove.name
                            });
                        }
                    }
                }
            }
            
            // ÊåâÂÅ∑Â∏ßÊï∞ÈôçÂ∫èÊéíÂ∫èÔºåËøîÂõûÊúÄ‰ºòÊñπÊ°à
            if (bestPlans.length === 0) return null;
            bestPlans.sort((a, b) => b.stolen - a.stolen);
            return bestPlans[0];
        }
        
        // Ê∏≤ÊüìÊúüÊúõÊñπÊ°àÈ¢ÑËßà
        function renderExpectPlanPreview(plan) {
            let stepsHtml = '';
            
            if (plan.type === 'direct') {
                stepsHtml = `<div class="text-center">
                    <span class="text-zinc-500">Áõ¥Êé•</span>
                    <span class="text-cyan-400 font-black text-xl ml-2">${plan.displayMeaty}</span>
                </div>`;
            } else if (plan.type === 'single') {
                stepsHtml = `<div class="flex items-center justify-center gap-2">
                    <span class="text-white font-bold">${plan.killMove.name}</span>
                    <span class="text-zinc-600">(-${plan.killTotal}F)</span>
                    <span class="text-zinc-500">‚Üí</span>
                    <span class="text-cyan-400 font-black text-xl">${plan.displayMeaty}</span>
                </div>`;
            } else if (plan.type === 'double') {
                const remain1 = plan.killTotal;  // Á¨¨‰∏ÄÊ≠•ÂêéÁöÑÂâ©‰Ωô
                stepsHtml = `<div class="flex items-center justify-center gap-2 flex-wrap">
                    <span class="text-white font-bold">${plan.killMove.name}</span>
                    <span class="text-zinc-600">(-${plan.killTotal}F)</span>
                    <span class="text-zinc-500">‚Üí</span>
                    <span class="text-white font-bold">${plan.killMove2.name}</span>
                    <span class="text-zinc-600">(-${plan.killTotal2}F)</span>
                    <span class="text-zinc-500">‚Üí</span>
                    <span class="text-cyan-400 font-black text-xl">${plan.displayMeaty}</span>
                </div>`;
            }
            
            // Â¶ÇÊûúÊúâÊãõÂºè‰ø°ÊÅØÔºåÊòæÁ§∫Â∏ßÊï∞‰ºòÂäø
            let statsHtml = '';
            if (plan.meatyMove) {
                const stolenColorPreview = getStolenColorClass(plan.stolen);
                const hitColorPreview = getFrameColorClass(plan.finalHit);
                const blockColorPreview = getFrameColorClass(plan.finalBlock);
                statsHtml = `<div class="mt-2 pt-2 border-t border-zinc-700 text-center text-xs">
                    <span class="text-zinc-500">ÂÅ∑</span><span class="${stolenColorPreview} font-bold ml-1">${plan.stolen}F</span>
                    <span class="text-zinc-500 ml-3">H</span><span class="${hitColorPreview} font-bold ml-1">${plan.finalHit >= 0 ? '+' : ''}${plan.finalHit}</span>
                    <span class="text-zinc-500 ml-3">B</span><span class="${blockColorPreview} font-bold ml-1">${plan.finalBlock >= 0 ? '+' : ''}${plan.finalBlock}</span>
                </div>`;
            }
            
            return `<div class="text-green-400 font-bold mb-2">‚úì ÊâæÂà∞ÂèØË°åÊñπÊ°à</div>${stepsHtml}${statsHtml}`;
        }
        
        function openNoteModal() { 
            // ÈáçÁΩÆÊúüÊúõÂêéÁª≠Áä∂ÊÄÅ
            expectMode = 'remain';
            currentExpectPlan = null;
            document.getElementById('expectDetails').removeAttribute('open');
            document.getElementById('inputExpectRemain').value = '5';
            document.getElementById('inputExpectMove').value = '';
            document.getElementById('expectResult').classList.add('hidden');
            setExpectMode('remain');
            
            // Êõ¥Êñ∞ÊãõÂºè‰∏ãÊãâÊ°Ü
            updateExpectOptions();
            
            document.getElementById('noteModal').classList.remove('hidden'); 
            document.getElementById('inputAdv').focus();
        }
        
        function closeModal() { 
            document.getElementById('noteModal').classList.add('hidden');
            // Ê∏ÖÁêÜÁä∂ÊÄÅ
            currentExpectPlan = null;
            // ÈáçÁΩÆÊ®°Á≥äÊ®°Âºè
            if (fuzzyMode) {
                toggleFuzzyMode();
            }
            removeFuzzyPreview();
        }

        function switchTab(tab) {
            const viewNotes = document.getElementById('view-notes');
            const viewLibrary = document.getElementById('view-library');
            
            // ÁßªÈô§‰πãÂâçÁöÑÂä®ÁîªÁ±ª
            viewNotes.classList.remove('view-transition');
            viewLibrary.classList.remove('view-transition');
            
            viewNotes.classList.toggle('hidden', tab !== 'notes');
            viewLibrary.classList.toggle('hidden', tab !== 'library');
            document.getElementById('tab-notes').classList.toggle('active', tab === 'notes');
            document.getElementById('tab-library').classList.toggle('active', tab === 'library');
            
            // Ê∑ªÂä†ÂÖ•Âú∫Âä®Áîª
            requestAnimationFrame(() => {
                if (tab === 'notes') viewNotes.classList.add('view-transition');
                else viewLibrary.classList.add('view-transition');
            });
            
            // Êõ¥Êñ∞ÊªëÂä®ÊåáÁ§∫Âô®‰ΩçÁΩÆ
            updateTabIndicator(tab);
        }
        
        function updateTabIndicator(tab) {
            const indicator = document.getElementById('tabIndicator');
            const activeTab = document.getElementById(`tab-${tab}`);
            if (indicator && activeTab) {
                indicator.style.left = activeTab.offsetLeft + 'px';
                indicator.style.width = activeTab.offsetWidth + 'px';
            }
        }

        function saveNote() {
            const ctx = document.getElementById('inputContext').value.trim();
            
            // Ê®°Á≥äÊ®°ÂºèÂ§ÑÁêÜ
            if (fuzzyMode) {
                const minAdv = parseInt(document.getElementById('inputAdvMin').value);
                const maxAdv = parseInt(document.getElementById('inputAdvMax').value);
                
                if (!minAdv || !maxAdv || minAdv < 1 || maxAdv < 1) {
                    alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÂ∏ßÊï∞ËåÉÂõ¥ (1~99)');
                    return;
                }
                
                if (minAdv > maxAdv) {
                    alert('Ëµ∑ÂßãÂ∏ßÊï∞‰∏çËÉΩÂ§ß‰∫éÁªìÊùüÂ∏ßÊï∞');
                    return;
                }
                
                if (maxAdv - minAdv > 10) {
                    alert('Â∏ßÊï∞ËåÉÂõ¥‰∏çËÉΩË∂ÖËøá10Â∏ß');
                    return;
                }
                
                if (!fuzzyPreviewResult || (!fuzzyPreviewResult.bestByBlock && !fuzzyPreviewResult.bestByHit)) {
                    alert('Ê≤°ÊúâÊâæÂà∞ËÉΩË¶ÜÁõñÊï¥‰∏™ËåÉÂõ¥ÁöÑÊñπÊ°àÔºåËØ∑Ë∞ÉÊï¥Â∏ßÊï∞ËåÉÂõ¥');
                    return;
                }
                
                // Ê∑ªÂä†ËåÉÂõ¥ÂÜÖÁöÑÊâÄÊúâÂú∫ÊôØ
                const contextPrefix = ctx || `Ê®°Á≥äÂú∫ÊôØ ${minAdv}~${maxAdv}F`;
                for (let adv = minAdv; adv <= maxAdv; adv++) {
                    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåÂ∏ßÊï∞ÁöÑÂú∫ÊôØ
                    const exists = state.notes.some(n => n.adv === adv && n.context === contextPrefix);
                    if (!exists) {
                        state.notes.push({ 
                            adv, 
                            context: contextPrefix, 
                            isUserAdded: true,
                            isFuzzy: true,  // Ê†áËÆ∞‰∏∫Ê®°Á≥äÂú∫ÊôØ
                            fuzzyRange: { min: minAdv, max: maxAdv }
                        });
                    }
                }
                
                saveScenarios(state.currentCharacter, state.notes);
                document.getElementById('inputAdvMin').value = '';
                document.getElementById('inputAdvMax').value = '';
                removeFuzzyPreview();
                closeModal();
                renderNotes();
                showToast(`Â∑≤Ê∑ªÂä† ${minAdv}~${maxAdv}F Ê®°Á≥äÂú∫ÊôØ`);
                return;
            }
            
            // Á≤æÁ°ÆÊ®°ÂºèÂ§ÑÁêÜ
            const adv = parseInt(document.getElementById('inputAdv').value);
            
            if (!adv || adv < 1 || adv > 99) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊúâÂà©Â∏ßÊï∞ (1~99)');
                return;
            }
            
            // ÂêàÁêÜËåÉÂõ¥Ê£ÄÊü•ÔºàË∂ÖËøá70Â∏ßÁöÑÊúâÂà©ÂæàÂ∞ëËßÅÔºâ
            if (adv > 70) {
                if (!confirm(`+${adv}F ÊòØ‰∏Ä‰∏™ÈùûÂ∏∏Â§ßÁöÑÊúâÂà©Â∏ßÊï∞ÔºåÁ°ÆÂÆöË¶ÅÊ∑ªÂä†ÂêóÔºü`)) {
                    return;
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÂêØÁî®‰∫ÜÊúüÊúõÂêéÁª≠ÂäüËÉΩ
            const expectDetailsOpen = document.getElementById('expectDetails').hasAttribute('open');
            if (expectDetailsOpen) {
                // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ËæìÂÖ•‰∫ÜÊúüÊúõ
                let hasExpectInput = false;
                if (expectMode === 'remain') {
                    hasExpectInput = !!document.getElementById('inputExpectRemain').value;
                } else {
                    hasExpectInput = !!document.getElementById('inputExpectMove').value;
                }
                
                // Â¶ÇÊûúÁî®Êà∑ËæìÂÖ•‰∫ÜÊúüÊúõ‰ΩÜÊ≤°ÊúâÂèØË°åÊñπÊ°àÔºåÈòªÊ≠¢Ê∑ªÂä†
                if (hasExpectInput && !currentExpectPlan) {
                    alert('ÊúüÊúõÂêéÁª≠Ê≤°ÊúâÂèØË°åÁöÑÂç°Â∏ßÊñπÊ°àÔºåËØ∑‰øÆÊîπÊúüÊúõÊàñÊäòÂè†ÊúüÊúõÂêéÁª≠ÈÄâÈ°πÂêéÂÜçÊ∑ªÂä†');
                    return;
                }
            }
            
            state.notes.push({ adv, context: ctx || "Ëá™ÂÆö‰πâÂú∫ÊôØ", isUserAdded: true });
            saveScenarios(state.currentCharacter, state.notes); // Âè™‰øùÂ≠òÁî®Êà∑Ëá™ÂÆö‰πâÁöÑÈÉ®ÂàÜ
            document.getElementById('inputAdv').value = '';
            document.getElementById('inputContext').value = '';
            closeModal();
            renderNotes();
            showToast(`Â∑≤Ê∑ªÂä† +${adv}F Âú∫ÊôØ`);
        }

        function removeNote(idx) {
            const note = state.notes[idx];
            const isPreset = !note.isUserAdded;
            
            // Â¶ÇÊûúÊòØÈ¢ÑËÆæÂú∫ÊôØÔºåÁªôÂá∫ÊèêÁ§∫
            if (isPreset) {
                if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§È¢ÑËÆæÂú∫ÊôØ "${note.context}" ÂêóÔºü\n\nÊ≠§Âú∫ÊôØÂèØÈÄöËøá"ÈáçÁΩÆ"ÊåâÈíÆÊÅ¢Â§ç„ÄÇ`)) {
                    return;
                }
            }
            
            state.notes.splice(idx, 1);
            saveScenarios(state.currentCharacter, state.notes); // Âè™‰øùÂ≠òÁî®Êà∑Ëá™ÂÆö‰πâÁöÑÈÉ®ÂàÜ
            renderNotes();
            
            const tipMsg = isPreset ? 'Â∑≤ÈöêËóèÈ¢ÑËÆæÂú∫ÊôØÔºàÂèØÈÄöËøáÈáçÁΩÆÊÅ¢Â§çÔºâ' : 'Â∑≤Âà†Èô§Âú∫ÊôØ';
            showToast(tipMsg);
        }

        function resetToDefault() {
            const userCount = state.notes.filter(n => n.isUserAdded).length;
            const confirmMsg = userCount > 0 
                ? `ÈáçÁΩÆ ${state.currentCharacter} ÁöÑ Scenarios ‰∏∫È¢ÑËÆæÂÄºÔºü\nÔºàÂ∞ÜÊ∏ÖÈô§ ${userCount} ‰∏™Áî®Êà∑Ëá™ÂÆö‰πâÂú∫ÊôØÔºå‰øùÁïôÊâÄÊúâÈ¢ÑËÆæÂú∫ÊôØÔºâ`
                : `ÈáçÁΩÆ ${state.currentCharacter} ÁöÑ Scenarios ‰∏∫È¢ÑËÆæÂÄºÔºü`;
            
            if (confirm(confirmMsg)) {
                state.notes = resetScenarios(state.currentCharacter);
                renderNotes();
                showToast('Â∑≤ÈáçÁΩÆ‰∏∫È¢ÑËÆæÂú∫ÊôØ');
            }
        }
        
        function removeMove(idx) { 
            const move = state.moveLibrary[idx];
            if (!move) return;
            
            // È¢ÑËÆæÊãõÂºè‰∏çËÉΩÂà†Èô§
            if (!move.isUserAdded) {
                showToast('È¢ÑËÆæÊãõÂºè‰∏çÂèØÂà†Èô§');
                return;
            }
            
            // Áî®Êà∑Ê∑ªÂä†ÁöÑÊãõÂºèÈúÄË¶ÅÁ°ÆËÆ§
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÊãõÂºè "${move.name}" ÂêóÔºü`)) {
                return;
            }
            
            const moveName = move.name;
            state.moveLibrary.splice(idx, 1);
            // ÂêåÊ≠•Êõ¥Êñ∞ÁºìÂ≠ò
            if (state.characterCache[state.currentCharacter]) {
                state.characterCache[state.currentCharacter].moves = [...state.moveLibrary];
            }
            // ‰øùÂ≠òÂà∞ localStorage
            saveMoves(state.currentCharacter, state.moveLibrary);
            renderAll(); 
            showToast(`Â∑≤Âà†Èô§ ${moveName}`);
        }

        function clearLibrary() {
            if (confirm(`Á°ÆÂÆöÊ∏ÖÁ©∫ ${state.currentCharacter} ÁöÑÊâÄÊúâÂ∏ßÊï∞ÊçÆÔºü`)) {
                state.moveLibrary = [];
                if (state.characterCache[state.currentCharacter]) {
                    state.characterCache[state.currentCharacter].moves = [];
                }
                // Ê∏ÖÈô§ localStorage ‰∏≠ÁöÑ‰øùÂ≠ò
                clearSavedMoves(state.currentCharacter);
                renderAll();
            }
        }
        
        function resetMovesToDefault() {
            if (confirm(`ÈáçÁΩÆ ${state.currentCharacter} ÁöÑÊãõÂºèÊï∞ÊçÆ‰∏∫È¢ÑËÆæÂÄºÔºü`)) {
                state.moveLibrary = resetMoves(state.currentCharacter);
                if (state.characterCache[state.currentCharacter]) {
                    state.characterCache[state.currentCharacter].moves = [...state.moveLibrary];
                }
                renderAll();
            }
        }

        function loadTemplate() {
            const template = `[
  {"name": "5MP", "startup": 6, "active": "6-9", "recovery": 15, "hit": 5, "block": 0},
  {"name": "5LP", "startup": 4, "active": "4-6", "recovery": 7, "hit": 4, "block": -1}
]`;
            document.getElementById('rawPaste').value = template;
            document.getElementById('rawPaste').focus();
        }

        function importJson() {
            const input = document.getElementById('rawPaste').value.trim();
            if (!input) {
                alert('ËØ∑ÂÖàÁ≤òË¥¥ JSON Êï∞ÊçÆ');
                return;
            }
            
            try {
                const data = JSON.parse(input);
                const newMoves = Array.isArray(data) ? data : [data];
                
                // È™åËØÅÊï∞ÊçÆÊ†ºÂºè
                for (const move of newMoves) {
                    if (!move.name || move.startup === undefined) {
                        throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØÔºöÁº∫Â∞ë name Êàñ startup Â≠óÊÆµ');
                    }
                }
                
                state.moveLibrary = [...state.moveLibrary, ...newMoves];
                
                // ÂéªÈáç (Âü∫‰∫é name)
                const seen = new Set();
                state.moveLibrary = state.moveLibrary.filter(m => {
                    if (seen.has(m.name)) return false;
                    seen.add(m.name);
                    return true;
                });
                
                // Êõ¥Êñ∞ÁºìÂ≠ò
                if (state.characterCache[state.currentCharacter]) {
                    state.characterCache[state.currentCharacter].moves = [...state.moveLibrary];
                }
                
                // ‰øùÂ≠òÂà∞ localStorage
                saveMoves(state.currentCharacter, state.moveLibrary);
                
                document.getElementById('rawPaste').value = '';
                renderAll();
                showToast(`Â∑≤ÂØºÂÖ• ${newMoves.length} ‰∏™ÊãõÂºè`);
            } catch (e) {
                showToast('JSON Ê†ºÂºèÈîôËØØ', 'error');
                console.error('JSON Ëß£ÊûêÈîôËØØ:', e);
            }
        }

        // ==================== ÈîÆÁõò‰∫ã‰ª∂ ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeCharModal();
                closeHelpModal();
                closeRuleModal();
                closeAddMoveModal();
            }
            // Enter ÈîÆ‰øùÂ≠ò
            if (e.key === 'Enter') {
                if (!document.getElementById('noteModal').classList.contains('hidden')) {
                    saveNote();
                } else if (!document.getElementById('ruleModal').classList.contains('hidden')) {
                    saveRule();
                } else if (!document.getElementById('addMoveModal').classList.contains('hidden')) {
                    saveNewMove();
                }
            }
        });

        // ==================== ÂàùÂßãÂåñ ====================
        window.onload = function() {
            console.log('=== SF6 FRAME LAB ÂàùÂßãÂåñ ===');
            
            // ËÆæÁΩÆÁ¶ÅÁî®Âú∫ÊôØËØ¥ÊòéÁõëÂê¨Âô®
            const usageSelect = document.getElementById('inputDisableUsage');
            const hintDiv = document.getElementById('disableUsageHint');
            
            if (usageSelect && hintDiv) {
                usageSelect.addEventListener('change', () => {
                    const hints = {
                        'kill': 'Á¶ÅÊ≠¢Ê≠§ÊãõÂºèÁî®‰∫éÊ∂àËÄóÊúâÂà©Â∏ß',
                        'meaty_after_kill': 'Á¶ÅÊ≠¢Ê≠§ÊãõÂºèÂú®Âç°Â∏ßÂêé‰Ωú‰∏∫ÂéãÂà∂ÊãõÂºè',
                        'meaty_direct': 'Á¶ÅÊ≠¢Ê≠§ÊãõÂºèÁõ¥Êé•ÂéãÂà∂Ôºà‰∏çÂç°Â∏ßÔºâ'
                    };
                    hintDiv.textContent = hints[usageSelect.value] || '';
                });
            }
            
            // 0. ‰ªé localStorage ÊÅ¢Â§ç‰∏äÊ¨°ÈÄâÊã©ÁöÑËßíËâ≤
            let savedCharacter = loadCurrentCharacter();
            // Á°Æ‰øù‰øùÂ≠òÁöÑËßíËâ≤ÊúâÊï∞ÊçÆÔºåÂê¶ÂàôÂõûÈÄÄÂà∞JURI
            if (!CONFIG.CHARACTERS_WITH_DATA.includes(savedCharacter)) {
                savedCharacter = 'JURI';
            }
            state.currentCharacter = savedCharacter;
            document.getElementById('currentCharIcon').textContent = getCharIcon(savedCharacter);
            
            // Â∫îÁî®ËßíËâ≤‰∏ªÈ¢ò
            applyTheme(savedCharacter);
            console.log(`[ËßíËâ≤] ÊÅ¢Â§ç‰∏äÊ¨°ÈÄâÊã©: ${savedCharacter}`);
            
            console.log(`CHARACTER_DATA Â∑≤Âä†ËΩΩËßíËâ≤:`, Object.keys(CHARACTER_DATA));
            
            // 1. Âä†ËΩΩËßíËâ≤Êï∞ÊçÆ (‰ºòÂÖà localStorageÔºåÂÖ∂Ê¨°ÂÖ®Â±ÄÂèòÈáè CHARACTER_DATA)
            const loadSuccess = loadCharacterData(state.currentCharacter);
            console.log(`Êï∞ÊçÆÂä†ËΩΩ${loadSuccess ? 'ÊàêÂäü' : 'Â§±Ë¥•'}`);
            
            // 2. Âä†ËΩΩscenarios: È¢ÑËÆæ + Áî®Êà∑Ëá™ÂÆö‰πâ
            state.notes = loadAllScenarios(state.currentCharacter);
            console.log(`[Scenarios] Âä†ËΩΩÂÆåÊàê: È¢ÑËÆæ ${getDefaultScenarios(state.currentCharacter).length} ‰∏™ + Áî®Êà∑Ëá™ÂÆö‰πâ ${loadScenariosFromStorage(state.currentCharacter).length} ‰∏™`);
            
            // 3. Âä†ËΩΩËßíËâ≤‰∏ìÂ±ûËßÑÂàô
            state.characterRules[state.currentCharacter] = loadCharacterRules(state.currentCharacter);
            console.log(`[Rules] Âä†ËΩΩ ${state.characterRules[state.currentCharacter].length} ‰∏™ËßíËâ≤ËßÑÂàô`);
            
            // 4. Âä†ËΩΩÂ∑≤Âà†Èô§ÁöÑÈ¢ÑËÆæËßÑÂàô
            state.deletedPresetRules = loadDeletedPresetRules();
            console.log(`[Rules] Âä†ËΩΩ ${Object.keys(state.deletedPresetRules).length} ‰∏™Â∑≤Âà†Èô§È¢ÑËÆæËßÑÂàô`);
            
            // 5. Âä†ËΩΩÊî∂ËóèÂíåÊúÄÂ∞èÂåñÁä∂ÊÄÅ
            state.favorites = loadFavorites();
            state.minimized = loadMinimized();
            console.log(`[UI] Âä†ËΩΩ ${Object.keys(state.favorites).length} ‰∏™Êî∂Ëóè, ${Object.keys(state.minimized).length} ‰∏™ÊúÄÂ∞èÂåñ`);
            
            // 6. Âä†ËΩΩÊâìÊäïÊã©Êî∂ËóèÂíåÈöêËóèÁä∂ÊÄÅ
            state.mixupFavorites = loadMixupFavorites();
            state.mixupHidden = loadMixupHidden();
            console.log(`[Mixup] Âä†ËΩΩ ${Object.keys(state.mixupFavorites).length} ‰∏™ÊâìÊäïÊã©Êî∂Ëóè, ${Object.keys(state.mixupHidden).length} ‰∏™ÈöêËóè`);
            
            console.log(`ÊúÄÁªàÁä∂ÊÄÅ: ${state.moveLibrary.length} ÊãõÂºè, ${state.notes.length} Âú∫ÊôØ`);
            console.log('=== ÂàùÂßãÂåñÂÆåÊàê ===');
            
            updateSortOrderUI();
            renderAll();
            
            // ÂàùÂßãÂåñ Tab ÊåáÁ§∫Âô®‰ΩçÁΩÆ
            setTimeout(() => updateTabIndicator('notes'), 100);
            
            // ÂàùÂßãÂåñÂ∞ÅÊù°ÊªöÂä®ÂÜÖÂÆπ
            updateMarqueeTape();
            
            // Ê†áËÆ∞Âä†ËΩΩÂÆåÊàêÔºåÂêØÁî®È°µÈù¢ËøáÊ∏°
            requestAnimationFrame(() => {
                document.documentElement.classList.add('loaded');
                // È¶ñÊ¨°Âä†ËΩΩÊó∂Ëß¶ÂèëËßíËâ≤ÊåâÈíÆÂä®ÁîªÔºàÂª∂Ëøü‰∏ÄÁÇπËÆ©È°µÈù¢ÂÖàÊ∏≤ÊüìÔºâ
                setTimeout(() => {
                    triggerCharBtnAnimation();
                }, 300);
            });
            
            // ÂàùÂßãÂåñ Lucide ÂõæÊ†á
            lucide.createIcons();
        };
        
        // ÂàùÂßãÂåñ/Êõ¥Êñ∞Â∞ÅÊù°ÊªöÂä®ÊïàÊûú
        function updateMarqueeTape() {
            const charName = state.currentCharacter;
            const charIcon = getCharIcon(charName);
            
            // Â∞ÅÊù°ÂÜÖÂÆπÔºöemoji + ËßíËâ≤ÂêçÔºå‰∫§ÊõøÊòæÁ§∫
            // Â¢ûÂä†ÈáçÂ§çÊ¨°Êï∞Á°Æ‰øùÂÜÖÂÆπË∂≥Â§üÈïøÔºåÈÅøÂÖçÊªöÂä®Êó∂Âá∫Áé∞Á©∫ÁôΩ
            const repeatCount = 20;
            const content = Array(repeatCount).fill(`<span>${charIcon} ${charName}</span>`).join('');
            
            document.getElementById('marqueeContent1').innerHTML = content;
            document.getElementById('marqueeContent1Clone').innerHTML = content;
            document.getElementById('marqueeContent2').innerHTML = content;
            document.getElementById('marqueeContent2Clone').innerHTML = content;
        }
        
        // ==================== SF6 ÂØºËà™ËèúÂçïÊéßÂà∂ ====================
        const sf6MenuBtn = document.getElementById('sf6MenuBtn');
        const sf6CloseMenu = document.getElementById('sf6CloseMenu');
        const sf6FullscreenMenu = document.getElementById('sf6FullscreenMenu');
        
        sf6MenuBtn.addEventListener('click', () => {
            sf6FullscreenMenu.classList.add('active');
        });
        
        sf6CloseMenu.addEventListener('click', closeSf6Menu);
        
        function closeSf6Menu() {
            sf6FullscreenMenu.classList.remove('active');
        }
        
        // ESC ÈîÆÂÖ≥Èó≠ËèúÂçï
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sf6FullscreenMenu.classList.contains('active')) {
                closeSf6Menu();
            }
        });
    </script>
</body>
</html>
