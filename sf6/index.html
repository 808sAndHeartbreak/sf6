<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>SF6 FRAME LAB - è¡—éœ¸6 å¸§æ•°è®¡ç®—å™¨</title>
    <meta name="description" content="Street Fighter 6 å¸§æ•°å‹åˆ¶è®¡ç®—å·¥å…·ï¼Œè‡ªåŠ¨è®¡ç®—æœ€ä¼˜å¡å¸§æ–¹æ¡ˆå’ŒæŠ•æŠ€æ—¶æœº">
    <meta name="keywords" content="SF6, Street Fighter 6, è¡—éœ¸6, å¸§æ•°, Frame Data, å‹èµ·èº«, Meaty, Okizeme">
    <!-- Open Graph ç¤¾äº¤åˆ†äº« -->
    <meta property="og:title" content="SF6 FRAME LAB - å¸§æ•°è®¡ç®—å™¨">
    <meta property="og:description" content="Street Fighter 6 å‹èµ·èº«å¸§æ•°è®¡ç®—å·¥å…·">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼Œæ— éœ€å¤–éƒ¨åŠ è½½ */
        :root {
            --theme-primary: #ff007a;
            --theme-secondary: #00f2ff;
            --theme-accent: #ffd700;
            --theme-bg: #0a0a0c;
            --theme-card-bg: #111114;
            --theme-card-border: #222;
        }

        html {
            scrollbar-gutter: stable;
        }

        body { 
            background-color: var(--theme-bg); 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", "PingFang SC", sans-serif;
        }
        
        .impact-text { 
            font-family: "Arial Black", "Helvetica Neue", Impact, sans-serif; 
            text-transform: uppercase; 
            font-style: italic; 
        }
        
        /* ========== é˜¶æ®µAï¼šGlitch åŠ¨æ€æ•ˆæœ ========== */
        /* ä¸»æ ‡é¢˜ - å¸¸é©»å‘å…‰ + å‘¼å¸æ•ˆæœ */
        .glitch-hover {
            position: relative;
            cursor: default;
            user-select: none;
            display: inline-block;
            /* å¸¸é©»æŸ”å’Œå‘å…‰ */
            text-shadow: 
                0 0 10px var(--theme-primary),
                0 0 20px color-mix(in srgb, var(--theme-primary) 60%, transparent),
                0 0 30px color-mix(in srgb, var(--theme-primary) 30%, transparent);
            animation: glow-breathe 3s ease-in-out infinite;
        }
        
        /* å‘¼å¸å‘å…‰åŠ¨ç”» */
        @keyframes glow-breathe {
            0%, 100% {
                text-shadow: 
                    0 0 8px var(--theme-primary),
                    0 0 16px color-mix(in srgb, var(--theme-primary) 50%, transparent),
                    0 0 24px color-mix(in srgb, var(--theme-primary) 25%, transparent);
            }
            50% {
                text-shadow: 
                    0 0 12px var(--theme-primary),
                    0 0 25px color-mix(in srgb, var(--theme-primary) 70%, transparent),
                    0 0 40px color-mix(in srgb, var(--theme-primary) 40%, transparent);
            }
        }
        
        /* æ‚¬åœ/åˆ‡æ¢æ—¶ï¼šæŠ–åŠ¨ + å¼ºåŒ–å‘å…‰ */
        html.loaded .glitch-hover:hover,
        html.loaded .glitch-hover.glitch-active {
            animation: glitch-chaotic 1s steps(1) infinite !important;
            text-shadow: 
                4px 0 var(--theme-primary), 
                -4px 0 var(--theme-secondary),
                0 0 30px var(--theme-primary),
                0 0 60px var(--theme-primary),
                0 0 100px color-mix(in srgb, var(--theme-primary) 70%, transparent),
                0 0 150px color-mix(in srgb, var(--theme-primary) 40%, transparent) !important;
        }
        
        /* æ‚¬åœç¦»å¼€åç«‹å³é™æ­¢ï¼Œæ¢å¤å¸¸é©»å‘å…‰ */
        html.loaded .glitch-hover:not(:hover):not(.glitch-active) {
            animation: none !important;
            transform: none;
            /* ä¿ç•™å¸¸é©»å‘å…‰ï¼Œé€šè¿‡ç»§æ‰¿ .glitch-hover çš„ text-shadow */
        }
        
        @keyframes glitch-chaotic {
            /* 0-80%: å¿«é€ŸæŠ–åŠ¨é—ªçƒï¼ˆçº¦0.8ç§’ï¼‰ */
            0% { transform: translate(0) skewX(0); }
            5% { transform: translate(-4px, 3px) skewX(-3deg); }
            7% { transform: translate(0) skewX(0); }
            13% { transform: translate(3px, -2px) skewX(2deg); }
            15% { transform: translate(0) skewX(0); }
            21% { transform: translate(-2px, -3px) skewX(-1deg); }
            23% { transform: translate(0) skewX(0); }
            29% { transform: translate(5px, 1px) skewX(4deg); }
            31% { transform: translate(0) skewX(0); }
            37% { transform: translate(-3px, 2px) skewX(-2deg); }
            39% { transform: translate(0) skewX(0); }
            45% { transform: translate(2px, -4px) skewX(3deg); }
            47% { transform: translate(0) skewX(0); }
            53% { transform: translate(-1px, 1px) skewX(-1deg); }
            55% { transform: translate(0) skewX(0); }
            61% { transform: translate(4px, -1px) skewX(2deg); }
            63% { transform: translate(0) skewX(0); }
            69% { transform: translate(-3px, -2px) skewX(-2deg); }
            71% { transform: translate(0) skewX(0); }
            77% { transform: translate(2px, 3px) skewX(1deg); }
            80% { transform: translate(0) skewX(0); }
            /* 80-100%: æ…¢é€Ÿå¼±æŠ–åŠ¨æ”¶å°¾ï¼ˆçº¦0.2ç§’ï¼‰ */
            87% { transform: translate(0.8px, -0.4px) skewX(0.4deg); }
            94% { transform: translate(-0.4px, 0.3px) skewX(-0.2deg); }
            100% { transform: translate(0) skewX(0); }
        }
        
        /* æ‹›å¼åæ‚¬åœ - ä¼˜é›…å¾®åŠ¨æ•ˆ + å‘å…‰ */
        .glitch-text {
            cursor: default;
            display: inline-block;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-size: 0.93em; /* æ•´ä½“ç¨å°ï¼Œè§†è§‰å¹³è¡¡ä¸­æ–‡ */
        }
        
        .glitch-text:hover {
            transform: translateY(-2px);
            text-shadow: 0 0 15px var(--theme-primary), 0 4px 12px rgba(0, 0, 0, 0.5);
            filter: brightness(1.15);
        }
        
        /* å¸§æ•°æ•°å­—æ‚¬åœæ•ˆæœ */
        .frame-number {
            cursor: default;
            display: inline-block;
        }
        
        .frame-number:hover {
            animation: glitch-number 0.2s ease;
            color: var(--theme-primary);
            text-shadow: 0 0 20px var(--theme-primary), 0 0 40px var(--theme-primary);
        }
        
        @keyframes glitch-number {
            0%, 100% { transform: translate(0); opacity: 1; }
            33% { transform: translate(2px, -1px); opacity: 0.8; }
            66% { transform: translate(-2px, 1px); opacity: 0.9; }
        }
        
        /* ========== ç¬¬ä¸€é˜¶æ®µï¼šNew-Brutalism ç»“æ„å¼ºåŒ– ========== */
        .trend-card { 
            background: color-mix(in srgb, var(--theme-primary) 10%, #0a0a0c);
            border: 3px solid color-mix(in srgb, var(--theme-primary) 40%, #333);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .trend-card:hover { 
            border-color: var(--theme-primary); 
            background: color-mix(in srgb, var(--theme-primary) 15%, #0a0a0c);
            /* New-Brutalism åŠç¡¬é˜´å½±ï¼šæœ‰ä½ç§» + è½»å¾®æ¨¡ç³Š */
            box-shadow: 6px 6px 0 color-mix(in srgb, var(--theme-primary) 60%, transparent);
            transform: translate(-2px, -2px);
        }
        
        .trend-card:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0 color-mix(in srgb, var(--theme-primary) 40%, transparent);
        }

        .btn-hype {
            background: var(--theme-secondary);
            color: #000;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 900;
        }

        .btn-hype:hover {
            background: var(--theme-primary);
            color: #fff;
            box-shadow: 0 0 25px var(--theme-primary), 0 0 50px color-mix(in srgb, var(--theme-primary) 50%, transparent);
        }
        
        /* æ¬¡è¦æŒ‰é’® - æš—è‰²ä¸»é¢˜è‰² */
        .btn-secondary {
            background: color-mix(in srgb, var(--theme-primary) 70%, #000);
            color: #fff;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 900;
        }
        
        .btn-secondary:hover {
            background: var(--theme-primary);
            box-shadow: 0 0 15px color-mix(in srgb, var(--theme-primary) 50%, transparent);
        }
        
        .btn-secondary:active {
            transform: translateY(2px);
            filter: brightness(0.9);
        }
        
        /* ========== ç¬¬ä¸‰é˜¶æ®µï¼šç‰©ç†ç‚¹å‡»åé¦ˆ ========== */
        .btn-hype:active {
            transform: translateY(3px);
            box-shadow: none;
            filter: brightness(0.85);
        }

        /* ========== æ¨èç†ç”±æç¤ºæ¡† ========== */
        .recommend-card {
            position: relative;
        }
        
        .recommend-tooltip {
            position: absolute;
            top: 50%;
            left: -10px;
            transform: translate(-100%, -50%);
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.95) 0%, rgba(59, 130, 246, 0.95) 100%);
            color: #000;
            font-size: 11px;
            font-weight: 700;
            line-height: 1.6;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s, transform 0.25s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        
        .recommend-tooltip::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -6px;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 0 6px 6px;
            border-color: transparent transparent transparent rgba(59, 130, 246, 0.95);
        }
        
        .recommend-card:hover .recommend-tooltip {
            opacity: 1;
            transform: translate(-100%, -50%) translateX(-8px);
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šæç¤ºæ¡†æ˜¾ç¤ºåœ¨ä¸Šæ–¹ */
        @media (max-width: 1024px) {
            .recommend-tooltip {
                top: -10px;
                left: 50%;
                transform: translate(-50%, -100%);
            }
            
            .recommend-tooltip::after {
                top: 100%;
                right: auto;
                left: 50%;
                transform: translateX(-50%);
                border-width: 6px 6px 0 6px;
                border-color: rgba(59, 130, 246, 0.95) transparent transparent transparent;
            }
            
            .recommend-card:hover .recommend-tooltip {
                transform: translate(-50%, -100%) translateY(-8px);
            }
        }
        
        /* ========== ç¬¬äº”é˜¶æ®µï¼šæ”¶è—å°ç« æ ‡ç­¾ ========== */
        .favorite-stamp {
            position: absolute;
            top: -4px;
            left: -4px;
            background: #f59e0b;
            color: #000;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 10px;
            transform: rotate(-8deg);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            z-index: 5;
            pointer-events: none;
        }

        /* Tab çŸ©å½¢å¼€å…³æŒ‰é’®ç»„ */
        .tab-btn {
            font-family: "Arial Black", "Helvetica Neue", Impact, sans-serif;
            font-style: italic;
            font-size: 0.9rem;
            color: #555;
            background: transparent;
            border: none;
            padding: 0.55rem 1rem;
            transition: color 0.25s, transform 0.15s;
            position: relative;
        }
        
        /* ä¸‹åˆ’çº¿å±•å¼€æ•ˆæœ */
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 6px;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--theme-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-50%);
        }
        
        .tab-btn:hover:not(.active)::after {
            width: 70%;
        }
        
        /* è§„åˆ™ç±»å‹ Tab æŒ‰é’® */
        .rule-tab-btn {
            color: #71717a;
            border-bottom: 2px solid transparent;
            transition: all 0.25s;
        }
        
        .rule-tab-btn:hover {
            color: #a1a1aa;
        }
        
        .rule-tab-btn.active {
            color: var(--theme-secondary);
            border-bottom-color: var(--theme-secondary);
        }
        
        /* æ‰“æŠ•æ‹© Tab æŒ‰é’® */
        .mixup-tab-btn {
            color: #71717a;
            border-bottom: 2px solid transparent;
            transition: all 0.25s;
            background: transparent;
        }
        
        .mixup-tab-btn:hover {
            color: #a1a1aa;
        }
        
        .mixup-tab-btn.active {
            color: var(--theme-primary);
            border-bottom-color: var(--theme-primary);
        }
        
        /* æ‰“æŠ•æ‹©æ–¹æ¡ˆç®­å¤´æ—‹è½¬ */
        #mixupDetails[open] .mixup-arrow {
            transform: rotate(90deg);
        }
        
        .tab-btn:hover:not(.active) {
            color: #aaa;
        }
        
        .tab-btn:active {
            transform: scale(0.96);
        }

        .tab-btn.active { 
            color: #000;
            font-weight: 900;
        }
        
        .tab-btn.active::after {
            width: 0;
        }

        /* JSON æç¤ºåŒº */
        .json-hint {
            background: color-mix(in srgb, var(--theme-secondary) 5%, transparent);
            border: 1px dashed var(--theme-secondary);
            padding: 8px;
            font-size: 11px;
            color: var(--theme-secondary);
        }

        /* è§’è‰²é€‰æ‹©æŒ‰é’® - Opium/Trap è±å½¢é£æ ¼ */
        .champion-btn {
            font-family: "Arial Black", "Helvetica Neue", Impact, sans-serif;
            font-style: italic;
            font-size: 1.4rem;
            color: #fff;
            transition: all 0.3s;
            background: color-mix(in srgb, var(--theme-primary) 20%, #000);
            border: 2px solid var(--theme-primary);
            padding: 0.7rem 1.8rem;
            position: relative;
            cursor: pointer;
            /* è±å½¢æ–œåˆ‡ */
            clip-path: polygon(12px 0, 100% 0, calc(100% - 12px) 100%, 0 100%);
            margin-right: auto;
        }
        
        /* å†…å‘å…‰è¾¹æ¡†æ•ˆæœ */
        .champion-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(0,0,0,0.2) 100%);
            pointer-events: none;
        }
        
        .champion-btn:hover {
            background: color-mix(in srgb, var(--theme-primary) 40%, #000);
            border-color: var(--theme-primary);
            box-shadow: 
                0 0 20px color-mix(in srgb, var(--theme-primary) 50%, transparent),
                inset 0 0 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);
            color: #fff;
            text-shadow: 0 0 10px var(--theme-primary);
        }
        
        .champion-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        
        .champion-btn .char-icon {
            transition: transform 0.3s;
        }
        
        .champion-btn:hover .char-icon {
            transform: scale(1.15);
        }

        /* è§’è‰²é€‰æ‹©ç½‘æ ¼ - å“åº”å¼ */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            padding-bottom: 8px; /* ä¸ºhoveræ”¾å¤§æ•ˆæœé¢„ç•™ç©ºé—´ï¼Œé¿å…å‡ºç°æ»šåŠ¨æ¡ */
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ–ï¼š3åˆ—æ›´æ˜“ç‚¹å‡» */
        @media (max-width: 359px) {
            .char-grid { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 6px;
            }
        }
        
        @media (min-width: 640px) {
            .char-grid { 
                grid-template-columns: repeat(5, 1fr); 
                gap: 8px;
            }
        }
        
        @media (min-width: 768px) {
            .char-grid { 
                grid-template-columns: repeat(6, 1fr); 
                gap: 10px;
            }
        }

        .char-item {
            aspect-ratio: 1.1;
            background: #1a1a2e;
            border: 2px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
        }
        
        .char-item:hover {
            border-color: var(--theme-secondary);
            transform: scale(1.05);
        }
        
        .char-item.selected {
            border-color: var(--theme-primary);
            background: var(--theme-card-bg);
            box-shadow: 0 0 15px color-mix(in srgb, var(--theme-primary) 30%, transparent);
        }
        
        .char-item.no-data { 
            opacity: 0.3; 
            cursor: not-allowed;
            filter: grayscale(0.8);
        }
        .char-item.no-data:hover { 
            opacity: 0.35; 
            transform: none;
            border-color: #333;
        }
        
        .char-name {
            font-family: "Arial Black", "Helvetica Neue", Impact, sans-serif;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            margin-top: 2px;
            line-height: 1.1;
            text-align: center;
        }
        
        .char-icon { font-size: 20px; }
        
        /* è¾ƒå¤§å±å¹•æ¢å¤å°ºå¯¸ */
        @media (min-width: 480px) {
            .char-item {
                aspect-ratio: 1.2;
                padding: 6px;
            }
            .char-name {
                font-size: 11px;
                margin-top: 4px;
            }
            .char-icon { font-size: 24px; }
        }
        
        /* ========== ç§»åŠ¨ç«¯ä¼˜åŒ– ========== */
        /* è§¦æ‘¸è®¾å¤‡ä¸Šç§»é™¤ hover å˜æ¢æ•ˆæœï¼Œé¿å… sticky hover */
        @media (hover: none) {
            .char-item:hover { transform: none; }
            .trend-card:hover { 
                border-color: color-mix(in srgb, var(--theme-primary) 40%, #333); 
                background: color-mix(in srgb, var(--theme-primary) 10%, #0a0a0c);
                box-shadow: none;
                transform: none;
            }
        }
        
        /* ç§»åŠ¨ç«¯å§‹ç»ˆæ˜¾ç¤ºæ“ä½œæŒ‰é’®ï¼ˆä¸ä¾èµ– hoverï¼‰ */
        @media (hover: none), (max-width: 640px) {
            .group .group-hover\:opacity-100 {
                opacity: 1 !important;
            }
            .sm\:opacity-0 {
                opacity: 0.7 !important;
            }
            .sm\:group-hover\/ctx\:opacity-100 {
                opacity: 1 !important;
            }
        }
        
        /* é˜²æ­¢ iOS è¾“å…¥æ¡†ç¼©æ”¾ */
        input, textarea, select {
            font-size: 16px;
        }
        @media (min-width: 640px) {
            input, textarea, select {
                font-size: inherit;
            }
        }
        
        /* ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
        .overflow-x-auto, .overflow-y-auto {
            -webkit-overflow-scrolling: touch;
        }
        
        /* é˜²æ­¢é•¿æŒ‰å¼¹å‡ºèœå• */
        button, a {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* ========== å¯è®¿é—®æ€§ä¼˜åŒ– ========== */
        /* ç»Ÿä¸€ç„¦ç‚¹æ ·å¼ */
        button:focus-visible, 
        input:focus-visible, 
        textarea:focus-visible,
        select:focus-visible,
        a:focus-visible,
        details summary:focus-visible {
            outline: 2px solid var(--theme-secondary);
            outline-offset: 2px;
        }
        
        /* å‡å°‘åŠ¨ç”»ï¼ˆç”¨æˆ·åå¥½ï¼‰ */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
        @media (prefers-contrast: high) {
            .trend-card {
                border-width: 3px;
            }
            button {
                border: 2px solid currentColor;
            }
        }
        
        /* æŒ‰é’®ç‚¹å‡»åé¦ˆ */
        button:active:not(:disabled) {
            transform: scale(0.97);
        }
        
        /* ä¸»é¢˜è‰² Modal æŒ‰é’® */
        .modal-btn-primary {
            background-color: var(--theme-btn-primary);
        }
        .modal-btn-primary:hover {
            background-color: var(--theme-btn-primary-hover);
        }
        .modal-btn-active {
            background-color: var(--theme-btn-primary);
        }
        
        /* æ’åºæŒ‰é’®æ ·å¼ */
        .sort-btn {
            background: #18181b;
            border-color: color-mix(in srgb, var(--theme-secondary) 60%, #333);
            color: var(--theme-secondary);
        }
        .sort-btn:hover {
            background: color-mix(in srgb, var(--theme-primary) 20%, #18181b);
            border-color: var(--theme-primary);
            color: var(--theme-primary);
        }
        
        /* Context æ ‡ç­¾æ ·å¼ */
        .context-tag {
            color: var(--theme-primary);
            background: color-mix(in srgb, var(--theme-secondary) 15%, transparent);
            border-color: var(--theme-secondary);
        }
        
        /* é¢„è®¾åœºæ™¯æ ‡ç­¾æ ·å¼ - ç¨å¾®æš—æ·¡ä¸€äº› */
        .context-tag-preset {
            color: #a0a0a0;
            background: color-mix(in srgb, var(--theme-secondary) 8%, transparent);
            border-color: #505060;
        }
        
        /* å®‰å…¨è·³æ ‡ç­¾ - æ–œåˆ‡è±å½¢é£æ ¼ */
        .safe-jump-badge {
            display: inline-block;
        }
        .safe-jump-badge-inner {
            display: inline-block;
            font-size: 11px;
            font-weight: 900;
            padding: 4px 12px 4px 10px;
            letter-spacing: 0.5px;
            position: relative;
            clip-path: polygon(8px 0, 100% 0, calc(100% - 8px) 100%, 0 100%);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .safe-jump-true {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 50%, #16a34a 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        }
        .safe-jump-pseudo {
            background: linear-gradient(135deg, #ca8a04 0%, #eab308 50%, #ca8a04 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(234, 179, 8, 0.4);
        }
        .safe-jump-badge-inner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 50%);
            clip-path: inherit;
            pointer-events: none;
        }
        
        /* å¸§æ•°è¾“å…¥ç»„ä»¶ */
        .adv-input-group {
            display: flex;
            border: 1px solid var(--theme-card-border);
        }
        .adv-input-group .adv-btn {
            width: 56px;
            background: #27272a;
            color: #a1a1aa;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.15s;
            user-select: none;
            border: none;
        }
        .adv-input-group .adv-btn:hover {
            background: #3f3f46;
            color: white;
        }
        .adv-input-group .adv-btn:first-child {
            border-right: 1px solid var(--theme-card-border);
        }
        .adv-input-group .adv-btn:last-child {
            border-left: 1px solid var(--theme-card-border);
        }
        .adv-input-group .adv-input {
            flex: 1;
            min-width: 0;
            background: black;
            padding: 1rem;
            font-size: 2.25rem;
            font-weight: 900;
            text-align: center;
            color: var(--theme-input-accent);
            border: none;
            outline: none;
        }
        .adv-input-group .adv-input::placeholder {
            color: #52525b;
        }
        
        /* iPhone å®‰å…¨åŒºåŸŸé€‚é… */
        body {
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Modal åº•éƒ¨å®‰å…¨åŒºåŸŸ */
        .fixed.inset-0 > div {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* é¡µé¢åŠ è½½è¿‡æ¸¡ï¼Œé˜²æ­¢ FOUC */
        html:not(.loaded) body {
            opacity: 0;
        }
        html.loaded body {
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }
        
        /* ========== æ ‡é¢˜è¿›å…¥åŠ¨ç”» ========== */
        @keyframes title-glitch-in {
            0% {
                opacity: 0;
                transform: translateX(-20px) skewX(-10deg);
                filter: blur(10px);
                clip-path: inset(0 100% 0 0);
            }
            30% {
                opacity: 1;
                transform: translateX(5px) skewX(5deg);
                filter: blur(0);
                clip-path: inset(0 0 0 0);
            }
            50% {
                transform: translateX(-3px) skewX(-2deg);
                text-shadow: 3px 0 var(--theme-primary), -3px 0 var(--theme-secondary);
            }
            70% {
                transform: translateX(2px) skewX(1deg);
                text-shadow: -2px 0 var(--theme-primary), 2px 0 var(--theme-secondary);
            }
            100% {
                transform: translateX(0) skewX(0);
                text-shadow: none;
            }
        }
        
        html.loaded .title-animate {
            animation: title-glitch-in 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        html:not(.loaded) .title-animate {
            opacity: 0;
        }
        
        /* ========== Tab çŸ©å½¢å¼€å…³å®¹å™¨ ========== */
        .tab-container {
            position: relative;
            display: flex;
            gap: 0;
            background: #111;
            padding: 4px;
            border: 2px solid #333;
        }
        
        /* æ»‘åŠ¨é«˜äº®æŒ‡ç¤ºå™¨ - çŸ©å½¢ */
        .tab-indicator {
            position: absolute;
            top: 4px;
            bottom: 4px;
            background: var(--theme-primary);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
            box-shadow: 
                0 0 20px color-mix(in srgb, var(--theme-primary) 60%, transparent),
                0 0 40px color-mix(in srgb, var(--theme-primary) 30%, transparent);
        }
        
        .tab-btn {
            position: relative;
            z-index: 1;
        }
        
        .tab-btn.active {
            z-index: 2;
        }
        
        /* ========== å°æ¡èƒ¶å¸¦æ»šåŠ¨æ•ˆæœ (Marquee Tape) ========== */
        /* å•æ¡å°æ¡ - é¡µé¢é¡¶éƒ¨ï¼Œéšé¡µé¢æ»šåŠ¨ */
        .marquee-tape {
            position: relative;
            width: 100vw;
            left: 50%;
            transform: translateX(-50%);
            margin-top: -1rem;
            margin-bottom: 1.5rem;
            height: 52px;
            background: 
                linear-gradient(90deg, 
                    transparent 0%, 
                    rgba(255,255,255,0.05) 25%, 
                    transparent 50%,
                    rgba(0,0,0,0.05) 75%,
                    transparent 100%
                ),
                var(--theme-primary);
            overflow: hidden;
            z-index: 10;
            box-shadow: 
                0 4px 20px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.2);
            pointer-events: auto;
            cursor: pointer;
            border-bottom: 2px solid rgba(0,0,0,0.3);
        }
        
        .marquee-tape:hover {
            filter: brightness(1.1);
        }
        
        @media (min-width: 768px) {
            .marquee-tape {
                margin-top: -2.5rem;
            }
        }
        
        .marquee-track {
            display: flex;
            animation: marquee-scroll 80s linear infinite;
            white-space: nowrap;
            width: fit-content;
        }
        
        .marquee-content {
            display: flex;
            align-items: center;
            height: 52px;
            flex-shrink: 0;
        }
        
        .marquee-content span {
            font-family: "Arial Black", Impact, sans-serif;
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #000;
            padding: 0 50px;
        }
        
        .marquee-content span::after {
            content: "âœ¦";
            margin-left: 50px;
            opacity: 0.5;
            font-size: 22px;
        }
        
        @keyframes marquee-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        /* ç¬¬äºŒæ¡èƒ¶å¸¦ - éšè— */
        .marquee-tape-2 {
            display: none;
        }
        
        /* é¡µé¢å†…å®¹æ­£å¸¸å¸ƒå±€ */
        .main-content {
            padding-top: 20px;
        }
        
        .marquee-track-reverse {
            display: flex;
            animation: marquee-scroll-reverse 35s linear infinite;
            white-space: nowrap;
        }
        
        .marquee-content-2 {
            display: flex;
            align-items: center;
            height: 44px;
        }
        
        .marquee-content-2 span {
            font-family: "Arial Black", Impact, sans-serif;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #000;
            padding: 0 50px;
        }
        
        .marquee-content-2 span::after {
            content: "âœ¦";
            margin-left: 50px;
            opacity: 0.3;
        }
        
        @keyframes marquee-scroll-reverse {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(0); }
        }
        
        /* ========== é˜¶æ®µFï¼šèƒŒæ™¯æ°›å›´å±‚ ========== */
        .ambient-layer {
            position: fixed;
            inset: 0;
            z-index: -8;
            pointer-events: none;
            opacity: 0.4;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 80%, var(--theme-primary), transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 20%, var(--theme-secondary), transparent 50%);
            animation: ambient-drift 20s ease-in-out infinite alternate;
            filter: blur(80px);
        }
        
        @keyframes ambient-drift {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }
            50% {
                transform: translate(-5%, 3%) scale(1.1);
                opacity: 0.5;
            }
            100% {
                transform: translate(5%, -3%) scale(1);
                opacity: 0.35;
            }
        }
        
        /* ========== é˜¶æ®µGï¼šé¡µé¢è¿‡æ¸¡åŠ¨ç”» ========== */
        /* å¡ç‰‡å…¥åœºåŠ¨ç”» */
        .card-enter {
            opacity: 0;
            transform: translateY(20px);
            animation: card-fade-in 0.4s ease forwards;
        }
        
        @keyframes card-fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Tab å†…å®¹åˆ‡æ¢åŠ¨ç”» */
        .view-transition {
            animation: view-fade-in 0.3s ease;
        }
        
        @keyframes view-fade-in {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* ========== é¡¶éƒ¨å›ºå®šå¯¼èˆªæ  ========== */
        .sf6-top-nav {
            position: fixed;
            top: 0;
            right: 0;
            z-index: 200;
            padding: 5px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sf6-nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--theme-primary);
            color: var(--theme-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            backdrop-filter: blur(8px);
            clip-path: polygon(6px 0, 100% 0, calc(100% - 6px) 100%, 0 100%);
        }
        
        .sf6-nav-btn:hover {
            background: var(--theme-primary);
            color: #000;
            box-shadow: 0 0 20px var(--theme-primary), 0 0 40px color-mix(in srgb, var(--theme-primary) 50%, transparent);
        }
        
        .sf6-nav-btn svg {
            width: 22px;
            height: 22px;
        }
        
        /* ========== å…¨å±èœå• ========== */
        .sf6-fullscreen-menu {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.97);
            z-index: 300;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.2rem;
        }
        
        .sf6-fullscreen-menu.active {
            display: flex;
        }
        
        .sf6-menu-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 48px;
            height: 48px;
            background: transparent;
            border: 2px solid var(--theme-primary);
            color: var(--theme-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            clip-path: polygon(6px 0, 100% 0, calc(100% - 6px) 100%, 0 100%);
        }
        
        .sf6-menu-close-btn:hover {
            background: var(--theme-primary);
            color: #000;
            box-shadow: 0 0 20px var(--theme-primary);
        }
        
        .sf6-menu-close-btn svg {
            width: 26px;
            height: 26px;
        }
        
        .sf6-menu-link {
            font-family: 'Syne', sans-serif;
            font-size: clamp(1.6rem, 5vw, 3rem);
            font-weight: 900;
            font-style: italic;
            letter-spacing: -0.02em;
            color: #fff;
            text-decoration: none;
            text-transform: uppercase;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .sf6-menu-link:hover {
            color: var(--theme-primary);
            text-shadow: 
                0 0 20px var(--theme-primary),
                0 0 40px color-mix(in srgb, var(--theme-primary) 50%, transparent);
        }
        
        .sf6-menu-link.current {
            color: var(--theme-secondary);
            text-shadow: 0 0 15px var(--theme-secondary);
        }
        
        /* èœå•é¡¹è£…é¥°çº¿ */
        .sf6-menu-link::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            width: 0;
            height: 3px;
            background: var(--theme-primary);
            transform: translateY(-50%);
            transition: width 0.3s ease;
        }
        
        .sf6-menu-link:hover::before {
            width: 15px;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .sf6-top-nav {
                padding: 7px 12px;
            }
            .sf6-nav-btn {
                width: 38px;
                height: 38px;
            }
            .sf6-nav-btn svg {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-10">
    <!-- é¡¶éƒ¨å›ºå®šå¯¼èˆªæ  -->
    <nav class="sf6-top-nav">
        <a href="../" class="sf6-nav-btn" title="è¿”å›ä¸»é¡µ">
            <i data-lucide="home"></i>
        </a>
        <button class="sf6-nav-btn" id="sf6MenuBtn" title="èœå•">
            <i data-lucide="menu"></i>
        </button>
    </nav>
    
    <!-- å…¨å±èœå• -->
    <div class="sf6-fullscreen-menu" id="sf6FullscreenMenu">
        <button class="sf6-menu-close-btn" id="sf6CloseMenu">
            <i data-lucide="x"></i>
        </button>
        <a href="../" class="sf6-menu-link">HOME</a>
        <a href="./" class="sf6-menu-link current">SF6 FRAME LAB</a>
        <a href="../gojuon/" class="sf6-menu-link">GOJUON</a>
        <a href="../gallery/" class="sf6-menu-link">MY GALLERY</a>
        <a href="javascript:void(0)" onclick="closeSf6Menu(); alert('å¼€å‘ä¸­')" class="sf6-menu-link">I AM MUSIC</a>
    </div>
    
    <!-- èƒŒæ™¯æ°›å›´å±‚ -->
    <div class="ambient-layer"></div>
    
    <!-- è§’è‰²èƒŒæ™¯å›¾å±‚ -->
    <div id="bgOverlay" class="fixed inset-0 -z-10 bg-cover bg-center bg-no-repeat opacity-0 transition-opacity duration-500" style="background-position: center 20%;"></div>
    <div class="fixed inset-0 -z-10 bg-gradient-to-b from-black/90 via-black/80 to-black/70"></div>
    
    <!-- å°æ¡èƒ¶å¸¦æ»šåŠ¨æ•ˆæœ (Fixed å®šä½ï¼Œæ¨ªå‘æ— é™) -->
    <div class="marquee-tape" id="marqueeTape1" onclick="openCharacterModal()" style="cursor: pointer;" title="ç‚¹å‡»åˆ‡æ¢è§’è‰²">
        <div class="marquee-track">
            <div class="marquee-content" id="marqueeContent1"></div>
            <div class="marquee-content" id="marqueeContent1Clone"></div>
        </div>
    </div>
    <div class="marquee-tape-2">
        <div class="marquee-track-reverse">
            <div class="marquee-content-2" id="marqueeContent2"></div>
            <div class="marquee-content-2" id="marqueeContent2Clone"></div>
        </div>
    </div>
    
    <div class="max-w-6xl mx-auto main-content">
        <!-- HEADER -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-16 border-b-2 border-zinc-800 pb-6">
                <div class="flex flex-col">
                <div class="flex items-center gap-3">
                    <h1 class="impact-text text-5xl sm:text-6xl tracking-tighter title-animate glitch-hover">SF6 FRAME LAB</h1>
                    <button onclick="openHelpModal()" class="group px-3 py-1 bg-gradient-to-r from-cyan-600/20 to-pink-600/20 border border-cyan-500/50 hover:border-cyan-400 text-cyan-400 hover:text-cyan-300 text-xs font-bold tracking-wider uppercase transition-all hover:shadow-[0_0_15px_rgba(0,255,255,0.3)] flex items-center gap-1 whitespace-nowrap" title="ä½¿ç”¨è¯´æ˜">
                        <span class="text-sm">?</span>
                        <span>è¯´æ˜</span>
                    </button>
                </div>
                <span class="text-zinc-500 font-bold text-xs tracking-widest mt-1">made by Yuetian</span>
            </div>
            <nav class="flex items-end gap-6 sm:gap-8 w-full sm:w-auto">
                <button onclick="openCharacterModal()" class="champion-btn tracking-widest uppercase flex items-center gap-2">
                    <span class="char-icon text-lg" id="currentCharIcon">ğŸ¥‹</span>
                    <span>è§’è‰²</span>
                </button>
                <div class="flex gap-1 sm:gap-2 tab-container relative ml-auto sm:ml-0" id="tabContainer">
                    <button onclick="switchTab('notes')" id="tab-notes" class="tab-btn active uppercase tracking-widest text-base sm:text-xl pb-2">æ–¹æ¡ˆ</button>
                    <button onclick="switchTab('library')" id="tab-library" class="tab-btn uppercase tracking-widest text-base sm:text-xl pb-2">æ•°æ®</button>
                    <div class="tab-indicator" id="tabIndicator"></div>
                </div>
            </nav>
        </header>

        <!-- VIEW: æ–¹æ¡ˆ -->
        <div id="view-notes" class="space-y-6 pt-4">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
                <h2 class="impact-text text-4xl sm:text-5xl font-black" style="color: var(--theme-secondary);">å¡å¸§ç­–ç•¥</h2>
                <div class="flex gap-2">
                    <button onclick="resetToDefault()" class="px-4 py-3 text-xs bg-zinc-800 text-zinc-500 hover:bg-zinc-700 hover:text-white transition-all font-bold">é‡ç½®</button>
                    <button onclick="openNoteModal()" class="btn-hype px-6 sm:px-8 py-3 text-sm font-bold">+ æ–°å¢åœºæ™¯</button>
                </div>
            </div>
            
            <!-- æ¨¡å—ï¼šæ‰“æŠ•æ‹©æ–¹æ¡ˆ -->
            <div class="mb-10">
                <h3 class="text-xl sm:text-2xl font-black text-zinc-300 mb-2 border-l-4 pl-4" style="border-color: var(--theme-primary);">æ‰“æŠ•æ‹©æ–¹æ¡ˆ</h3>
                <p class="text-xs text-zinc-500 mb-4 pl-4">å¯»æ‰¾èƒ½å¡å‡ºç‰¹å®šæœ‰åˆ©å¸§ï¼ˆæ‰“æŠ•æ‹©æ—¶æœºï¼‰çš„åœºæ™¯ Â· èŒƒå›´ 6~50F</p>
                
                <!-- æŠ˜å åŒºåŸŸ -->
                <details class="trend-card" id="mixupDetails">
                    <summary class="px-5 py-3 cursor-pointer text-zinc-300 hover:text-white text-sm font-bold transition-colors select-none flex items-center gap-2">
                        <span class="text-zinc-500 text-xs mixup-arrow transition-transform duration-200">â–¶</span>
                        å±•å¼€æŸ¥çœ‹æ‰“æŠ•æ‹©æ–¹æ¡ˆ
                    </summary>
                    <div class="px-5 pb-5 pt-3 border-t" style="border-color: var(--theme-card-border);">
                        <!-- Tab åˆ‡æ¢ -->
                        <div class="flex gap-3 mb-4 border-b-2 pb-1" style="border-color: var(--theme-card-border);">
                            <button onclick="switchMixupTab(5)" id="mixupTab5" class="mixup-tab-btn active px-6 py-3 text-lg font-black transition-colors">5F</button>
                            <button onclick="switchMixupTab(4)" id="mixupTab4" class="mixup-tab-btn px-6 py-3 text-lg font-black transition-colors">4F</button>
                            <button onclick="switchMixupTab(3)" id="mixupTab3" class="mixup-tab-btn px-6 py-3 text-lg font-black transition-colors">3F</button>
                            <button onclick="switchMixupTab(2)" id="mixupTab2" class="mixup-tab-btn px-6 py-3 text-lg font-black transition-colors">2F</button>
                        </div>
                        
                        <!-- å†…å®¹åŒº -->
                        <div id="throwMixupContent" class="min-h-[80px]"></div>
                    </div>
                </details>
            </div>
            
            <!-- æ¨¡å—ï¼šå‹åˆ¶æ–¹æ¡ˆ -->
            <div>
                <h3 class="text-xl sm:text-2xl font-black text-zinc-300 mb-4 border-l-4 pl-4" style="border-color: var(--theme-primary);">å‹åˆ¶æ–¹æ¡ˆ</h3>
            </div>
            
            <!-- æœç´¢æ¡†å’Œæ’åºæŒ‰é’® -->
            <div class="mb-6 flex gap-3">
                <div class="flex-1 relative">
                    <input type="text" id="solutionSearch" 
                        class="w-full bg-black border border-zinc-700 p-3 pr-10 text-sm text-white placeholder-zinc-600 focus:border-cyan-500 focus:outline-none transition-colors"
                        placeholder="æœç´¢å¸§æ•° (å¦‚ 32) æˆ–æƒ…å¢ƒ (å¦‚ å‡é¾™)..."
                        aria-label="æœç´¢åœºæ™¯"
                        oninput="debounce(filterSolutions)(); updateClearBtn()">
                    <button id="clearSearchBtn" onclick="clearSearch()" 
                        class="absolute right-2 top-1/2 -translate-y-1/2 text-zinc-600 hover:text-white text-xl p-1 hidden transition-colors"
                        title="æ¸…é™¤æœç´¢">Ã—</button>
                </div>
                <button onclick="toggleSortOrder()" id="sortOrderBtn" 
                    class="sort-btn px-4 py-3 border transition-all flex items-center gap-2 text-sm font-bold"
                    title="åˆ‡æ¢æ’åºæ–¹å‘">
                    <span id="sortOrderIcon">â†‘</span>
                    <span id="sortOrderText" class="hidden sm:inline">å¸§æ•°</span>
                </button>
            </div>
            <div id="noteListContainer" class="grid grid-cols-1 gap-6"></div>
        </div>

        <!-- VIEW: æ•°æ® -->
        <div id="view-library" class="hidden space-y-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8 pt-4">
                <h2 class="impact-text text-4xl sm:text-5xl font-black" style="color: var(--theme-secondary);">è§’è‰²æ•°æ®</h2>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4 bg-zinc-900 p-6 border border-zinc-800">
                    <!-- æ–°å¢æ‹›å¼æŒ‰é’® -->
                    <button onclick="openAddMoveModal()" class="btn-secondary w-full py-2 mb-4 text-sm font-bold">
                        + æ–°å¢æ‹›å¼
                    </button>
                    
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="impact-text text-2xl font-black" style="color: var(--theme-primary);">æ‰¹é‡å¯¼å…¥</h3>
                        <button onclick="loadTemplate()" class="text-xs text-zinc-500 hover:text-cyan-400 underline transition-colors">
                            JSON æ ¼å¼
                        </button>
                    </div>

                    <textarea id="rawPaste" class="w-full h-40 bg-black border border-zinc-700 p-4 text-xs font-mono text-cyan-500 resize-none" placeholder='ç²˜è´´ JSON æ•°æ®...'></textarea>
                    <button onclick="importJson()" class="btn-secondary w-full mt-4 py-2 text-sm font-bold">æ‰¹é‡å¯¼å…¥</button>
                    <button onclick="resetMovesToDefault()" class="w-full mt-2 py-2 bg-zinc-800 text-zinc-500 text-xs font-bold hover:bg-blue-900 hover:text-white transition-all">é‡ç½®é¢„è®¾</button>
                </div>
                <div class="lg:col-span-8 overflow-x-auto relative bg-black/60 p-4 border border-zinc-800/50">
                    <!-- ç§»åŠ¨ç«¯æ»šåŠ¨æç¤º -->
                    <div class="lg:hidden text-[10px] text-zinc-600 text-right mb-1 italic">â† å·¦å³æ»‘åŠ¨æŸ¥çœ‹ â†’</div>
                    <table class="w-full text-left min-w-[500px]">
                        <thead class="text-zinc-600 text-[10px] font-black uppercase tracking-widest border-b border-zinc-800">
                            <tr>
                                <th class="p-4">Name</th>
                                <th class="p-4 text-center">Start</th>
                                <th class="p-4 text-center">Active</th>
                                <th class="p-4 text-center">Recov</th>
                                <th class="p-4 text-center">Hit</th>
                                <th class="p-4 text-center">Blk</th>
                                <th class="p-4 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="moveTableBody" class="text-sm font-bold"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- è§„åˆ™åŒºåŸŸ -->
            <div class="mt-8 p-4 bg-zinc-900/50 border border-zinc-800/50">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-sm font-bold text-zinc-400 uppercase tracking-widest">è¿‡æ»¤è§„åˆ™</h4>
                    <button onclick="openRuleModal()" class="text-[10px] px-3 py-1.5 bg-zinc-800 text-zinc-400 hover:text-white hover:bg-zinc-700 transition-all font-bold">+ æ·»åŠ è§„åˆ™</button>
                </div>
                <div id="rulesContainer" class="space-y-1 text-xs"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: Add Scenario -->
    <div id="noteModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="noteModalTitle">
        <div class="bg-zinc-900 border w-full max-w-lg p-8 sm:p-10 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-8">
                <h2 id="noteModalTitle" class="impact-text text-4xl sm:text-5xl font-black" style="color: var(--theme-modal-title);">æ–°å¢åœºæ™¯</h2>
                <button onclick="closeModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="å…³é—­">&times;</button>
            </div>
            <div class="space-y-8">
                <div>
                    <label class="block text-sm font-black uppercase mb-3 text-zinc-400">åˆå§‹æœ‰åˆ©å¸§</label>
                    <div class="adv-input-group">
                        <button type="button" onclick="adjustAdv(-1)" class="adv-btn">âˆ’</button>
                        <input type="text" id="inputAdv" inputmode="numeric" pattern="[0-9]*" maxlength="2"
                            class="adv-input" placeholder="40" oninput="sanitizeAdvInput(); updateExpectOptions()">
                        <button type="button" onclick="adjustAdv(1)" class="adv-btn">+</button>
                    </div>
                    <p class="text-xs text-zinc-500 mt-2">èŒƒå›´ 1~99</p>
                </div>
                <div>
                    <label class="block text-sm font-black uppercase mb-3 text-zinc-400">æƒ…å¢ƒè¯´æ˜</label>
                    <input type="text" id="inputContext" class="w-full bg-black border p-4 text-base font-bold text-white" style="border-color: var(--theme-card-border);" placeholder="ä¾‹å¦‚ï¼š2HKæ”¾å€’">
                </div>
                
                <!-- æœŸæœ›åç»­ - è¿›é˜¶é€‰é¡¹ -->
                <details id="expectDetails" class="border bg-zinc-900/50" style="border-color: var(--theme-card-border);">
                    <summary class="px-5 py-4 cursor-pointer text-zinc-400 hover:text-zinc-200 text-base font-bold transition-colors select-none">
                        â–¶ æœŸæœ›åç»­ (è¿›é˜¶)
                    </summary>
                    <div class="p-5 border-t space-y-5" style="border-color: var(--theme-card-border);">
                        <!-- æ¨¡å¼é€‰æ‹© -->
                        <div class="flex gap-3">
                            <button type="button" onclick="setExpectMode('remain')" id="expectModeRemain" class="flex-1 py-3 text-sm font-bold transition-all text-white" style="background-color: var(--theme-btn-primary);">æŒ‡å®šå‰©ä½™å¸§æ•°</button>
                            <button type="button" onclick="setExpectMode('move')" id="expectModeMove" class="flex-1 py-3 text-sm font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white">æŒ‡å®šå‹åˆ¶æ‹›å¼</button>
                        </div>
                        
                        <!-- æ¨¡å¼Aï¼šæŒ‡å®šå‰©ä½™å¸§æ•° -->
                        <div id="expectRemainPanel" class="space-y-4">
                            <div>
                                <label class="block text-sm font-black uppercase mb-2 text-zinc-400">æœŸæœ›å‰©ä½™å¸§æ•°</label>
                                <input type="number" id="inputExpectRemain" class="w-full bg-black border p-4 text-2xl font-black" style="border-color: var(--theme-card-border); color: var(--theme-input-accent);" value="5" oninput="calculateExpectPlan()">
                                <p class="text-xs text-zinc-500 mt-2">ç³»ç»Ÿå°†è®¡ç®—å¦‚ä½•å¡å¸§åˆ°å‰©ä½™è¿™ä¸ªå¸§æ•°</p>
                            </div>
                        </div>
                        
                        <!-- æ¨¡å¼Bï¼šæŒ‡å®šå‹åˆ¶æ‹›å¼ -->
                        <div id="expectMovePanel" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-black uppercase mb-2 text-zinc-400">é€‰æ‹©å‹åˆ¶æ‹›å¼</label>
                                <select id="inputExpectMove" class="w-full bg-black border p-4 text-base font-bold" style="border-color: var(--theme-card-border); color: var(--theme-input-accent);" onchange="calculateExpectPlan()">
                                    <option value="">-- é€‰æ‹©æ‹›å¼ --</option>
                                </select>
                                <p class="text-xs text-zinc-500 mt-2">ç³»ç»Ÿå°†è®¡ç®—å¦‚ä½•å¡å¸§ä½¿è¯¥æ‹›å¼èƒ½å·è‡³å°‘ 1 å¸§</p>
                            </div>
                        </div>
                        
                        <!-- è®¡ç®—ç»“æœé¢„è§ˆ -->
                        <div id="expectResult" class="hidden">
                            <div class="text-sm font-black uppercase mb-3 text-zinc-400">è®¡ç®—ç»“æœ</div>
                            <div id="expectResultContent" class="bg-black/50 border p-4 text-base" style="border-color: var(--theme-card-border);"></div>
                        </div>
                    </div>
                </details>
                
                <div class="flex gap-3">
                    <button onclick="saveNote()" class="flex-1 text-white py-4 font-bold text-base transition-all modal-btn-primary">è®¡ç®—æ–¹æ¡ˆ</button>
                    <button onclick="closeModal()" class="px-6 py-4 bg-zinc-800 text-zinc-400 font-bold text-base hover:text-white transition-all">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Character Select -->
    <div id="charModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden flex items-center justify-center p-2 sm:p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="charModalTitle">
        <div class="bg-zinc-900 border w-full max-w-3xl p-4 sm:p-6 md:p-8 max-h-[85vh] sm:max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h2 id="charModalTitle" class="impact-text text-xl sm:text-2xl md:text-3xl font-black" style="color: var(--theme-modal-title);">é€‰æ‹©è§’è‰²</h2>
                <button onclick="closeCharModal()" class="text-zinc-500 hover:text-white text-2xl sm:text-3xl p-2 -m-2" title="å…³é—­">&times;</button>
            </div>
            <div class="char-grid" id="charGrid"></div>
        </div>
    </div>

    <!-- MODAL: Add Rule -->
    <div id="ruleModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="ruleModalTitle">
        <div class="bg-zinc-900 border w-full max-w-md p-6 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-4">
                <h2 id="ruleModalTitle" class="impact-text text-2xl sm:text-3xl font-black" style="color: var(--theme-modal-title);">æ·»åŠ è§„åˆ™</h2>
                <button onclick="closeRuleModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="å…³é—­">&times;</button>
            </div>
            
            <!-- è§„åˆ™ç±»å‹é€‰æ‹© Tab -->
            <div class="flex gap-2 mb-4 border-b border-zinc-800">
                <button onclick="switchRuleTab('disable')" id="ruleTab-disable" class="rule-tab-btn active px-4 py-2 text-xs font-bold transition-colors">
                    ç¦ç”¨å‹åˆ¶
                </button>
                <button onclick="switchRuleTab('combo')" id="ruleTab-combo" class="rule-tab-btn px-4 py-2 text-xs font-bold transition-colors">
                    ç¦ç”¨ç»„åˆ
                </button>
                <button onclick="switchRuleTab('prefer')" id="ruleTab-prefer" class="rule-tab-btn px-4 py-2 text-xs font-bold transition-colors">
                    å€¾å‘å‹åˆ¶
                </button>
            </div>
            
            <!-- ç¦ç”¨å‹åˆ¶è§„åˆ™è¡¨å• -->
            <div id="ruleForm-disable" class="space-y-4">
                <p class="text-zinc-500 text-xs mb-4">ç¦æ­¢ç‰¹å®šæ‹›å¼ç”¨äºå¡å¸§æˆ–å‹åˆ¶ã€‚</p>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">é€‰æ‹©æ‹›å¼</label>
                    <select id="inputDisableMove" class="w-full bg-black border p-3 text-sm font-bold text-white" style="border-color: var(--theme-card-border);">
                        <option value="">-- è¯·é€‰æ‹©æ‹›å¼ --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ç¦ç”¨åœºæ™¯</label>
                    <select id="inputDisableUsage" class="w-full bg-black border p-3 text-sm text-white" style="border-color: var(--theme-card-border);">
                        <option value="kill">ç”¨äºå¡å¸§</option>
                        <option value="meaty_after_kill">ç”¨äºå¡å¸§åçš„å‹åˆ¶</option>
                        <option value="meaty_direct">ç”¨äºç›´æ¥å‹åˆ¶</option>
                    </select>
                    <div class="mt-2 text-[10px] text-zinc-600" id="disableUsageHint">
                        ç¦æ­¢æ­¤æ‹›å¼ç”¨äºæ¶ˆè€—æœ‰åˆ©å¸§
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">è¯´æ˜ (å¯é€‰)</label>
                    <input type="text" id="inputDisableDesc" class="w-full bg-black border p-3 text-sm text-zinc-400" style="border-color: var(--theme-card-border);" placeholder="ä¾‹å¦‚: å®¹æ˜“è¢«åå‡»">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="saveDisableRule()" class="flex-1 text-white py-3 font-bold text-sm transition-all modal-btn-primary">ä¿å­˜è§„åˆ™</button>
                    <button onclick="closeRuleModal()" class="px-4 py-3 bg-zinc-800 text-zinc-400 font-bold text-sm hover:text-white transition-all">å–æ¶ˆ</button>
                </div>
            </div>
            
            <!-- ç¦ç”¨ç»„åˆè§„åˆ™è¡¨å• -->
            <div id="ruleForm-combo" class="space-y-4 hidden">
                <p class="text-zinc-500 text-xs mb-4">ç¦æ­¢ä¸¤ä¸ªæ‹›å¼è¿ç»­ä½¿ç”¨ï¼ˆé—´éš”ä½¿ç”¨ä¸å—å½±å“ï¼‰ã€‚</p>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">æ‹›å¼ 1</label>
                    <select id="inputComboMove1" class="w-full bg-black border p-3 text-sm font-bold text-white" style="border-color: var(--theme-card-border);">
                        <option value="">-- è¯·é€‰æ‹©æ‹›å¼ --</option>
                    </select>
                </div>
                <div class="text-center text-zinc-600 text-xs">Ã— ç¦æ­¢è¿ç»­ä½¿ç”¨ Ã—</div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">æ‹›å¼ 2</label>
                    <select id="inputComboMove2" class="w-full bg-black border p-3 text-sm font-bold text-white" style="border-color: var(--theme-card-border);">
                        <option value="">-- è¯·é€‰æ‹©æ‹›å¼ --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">è¯´æ˜ (å¯é€‰)</label>
                    <input type="text" id="inputComboDesc" class="w-full bg-black border p-3 text-sm text-zinc-400" style="border-color: var(--theme-card-border);" placeholder="ä¾‹å¦‚: è¿æ‹›ä¸ç¨³å®š">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="saveComboRule()" class="flex-1 text-white py-3 font-bold text-sm transition-all modal-btn-primary">ä¿å­˜è§„åˆ™</button>
                    <button onclick="closeRuleModal()" class="px-4 py-3 bg-zinc-800 text-zinc-400 font-bold text-sm hover:text-white transition-all">å–æ¶ˆ</button>
                </div>
            </div>
            
            <!-- å€¾å‘å‹åˆ¶è§„åˆ™è¡¨å• -->
            <div id="ruleForm-prefer" class="space-y-4 hidden">
                <p class="text-zinc-500 text-xs mb-4">è®©ç‰¹å®šæ‹›å¼çš„å‹åˆ¶æ–¹æ¡ˆä¼˜å…ˆæ¨èï¼ˆä»å¤‡é€‰æå‡åˆ°æ¨èåŒºï¼‰ã€‚</p>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">é€‰æ‹©æ‹›å¼</label>
                    <select id="inputPreferMove" class="w-full bg-black border p-3 text-sm font-bold text-white" style="border-color: var(--theme-card-border);">
                        <option value="">-- è¯·é€‰æ‹©æ‹›å¼ --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">ç†ç”± (å¯é€‰)</label>
                    <input type="text" id="inputPreferDesc" class="w-full bg-black border p-3 text-sm text-zinc-400" style="border-color: var(--theme-card-border);" placeholder="ä¾‹å¦‚: ä¼¤å®³é«˜ã€ç¡®è®¤ç®€å•">
                </div>
                <div class="text-[10px] text-cyan-400 bg-cyan-900/20 border border-cyan-800/50 p-2">
                    ğŸ’¡ è¯¥è§„åˆ™ä¼šå°†ä½¿ç”¨æ­¤æ‹›å¼ä½œä¸ºå‹åˆ¶çš„æ–¹æ¡ˆä»å¤‡é€‰åŒºæå‡åˆ°æ¨èåŒº
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="savePreferRule()" class="flex-1 text-white py-3 font-bold text-sm transition-all modal-btn-primary">ä¿å­˜è§„åˆ™</button>
                    <button onclick="closeRuleModal()" class="px-4 py-3 bg-zinc-800 text-zinc-400 font-bold text-sm hover:text-white transition-all">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Add Move -->
    <div id="addMoveModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="addMoveModalTitle">
        <div class="bg-zinc-900 border w-full max-w-md p-6 sm:p-8 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-6">
                <h2 id="addMoveModalTitle" class="impact-text text-3xl sm:text-4xl font-black" style="color: var(--theme-modal-title);">æ–°å¢æ‹›å¼</h2>
                <button onclick="closeAddMoveModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="å…³é—­">&times;</button>
            </div>
            <div class="space-y-4">
                <!-- æ‹›å¼ç±»å‹é€‰æ‹© -->
                <div>
                    <label class="block text-[10px] font-black uppercase mb-2 text-zinc-500">æ‹›å¼ç±»å‹</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="setMoveType('normal')" id="moveTypeNormal" class="flex-1 py-2 text-xs font-bold transition-all text-white" style="background-color: var(--theme-btn-primary);">æ™®é€šæ‹›å¼</button>
                        <button type="button" onclick="setMoveType('throw')" id="moveTypeThrow" class="flex-1 py-2 text-xs font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white">æŠ•æŠ€</button>
                        <button type="button" onclick="setMoveType('dash')" id="moveTypeDash" class="flex-1 py-2 text-xs font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white">Dash</button>
                    </div>
                </div>
                
                <!-- æ‹›å¼åç§° -->
                <div>
                    <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">æ‹›å¼åç§°</label>
                    <input type="text" id="inputMoveName" class="w-full bg-black border p-3 text-lg font-bold text-white uppercase" style="border-color: var(--theme-card-border);" placeholder="ä¾‹å¦‚: 5HP, 2MK">
                </div>
                
                <!-- æ™®é€šæ‹›å¼/æŠ•æŠ€çš„å¸§æ•°æ® -->
                <div id="moveFrameFields" class="space-y-3">
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Startup</label>
                            <input type="number" id="inputMoveStartup" class="w-full bg-black border p-2 text-center font-mono text-white" style="border-color: var(--theme-card-border);" placeholder="7">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Active</label>
                            <input type="text" id="inputMoveActive" class="w-full bg-black border p-2 text-center font-mono text-white" style="border-color: var(--theme-card-border);" placeholder="7-9">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Recovery</label>
                            <input type="number" id="inputMoveRecovery" class="w-full bg-black border p-2 text-center font-mono text-white" style="border-color: var(--theme-card-border);" placeholder="15">
                        </div>
                    </div>
                    <div id="moveHitBlockFields" class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Hit (å‘½ä¸­)</label>
                            <input type="number" id="inputMoveHit" class="w-full bg-black border p-2 text-center font-mono text-cyan-400" style="border-color: var(--theme-card-border);" placeholder="+5">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Block (æ‰“é˜²)</label>
                            <input type="number" id="inputMoveBlock" class="w-full bg-black border p-2 text-center font-mono text-pink-400" style="border-color: var(--theme-card-border);" placeholder="-2">
                        </div>
                    </div>
                    <div id="moveKnockdownField">
                        <label class="flex items-center gap-2 text-sm text-zinc-400 cursor-pointer">
                            <input type="checkbox" id="inputMoveKnockdown" class="w-4 h-4 accent-red-500">
                            <span>å‡»å€’æŠ€ (Knockdown)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Dash çš„å¸§æ•°æ® -->
                <div id="moveDashFields" class="hidden">
                    <div>
                        <label class="block text-[10px] font-black uppercase mb-1 text-zinc-500">Dash æ€»å¸§æ•°</label>
                        <input type="number" id="inputMoveDashFrames" class="w-full bg-black border p-3 text-center font-mono text-white text-lg" style="border-color: var(--theme-card-border);" placeholder="19">
                    </div>
                </div>
                
                <div class="flex gap-2 pt-3">
                    <button onclick="saveNewMove()" class="flex-1 text-white py-3 font-bold text-sm transition-all modal-btn-primary">æ·»åŠ æ‹›å¼</button>
                    <button onclick="closeAddMoveModal()" class="px-4 py-3 bg-zinc-800 text-zinc-400 font-bold text-sm hover:text-white transition-all">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Help -->
    <div id="helpModal" class="fixed inset-0 bg-black/95 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="bg-zinc-900 border w-full max-w-2xl p-6 sm:p-8 max-h-[90vh] overflow-y-auto" style="border-color: var(--theme-card-border);">
            <div class="flex justify-between items-center mb-6">
                <h2 id="helpModalTitle" class="impact-text text-2xl sm:text-3xl font-black" style="color: var(--theme-modal-title);">ä½¿ç”¨è¯´æ˜</h2>
                <button onclick="closeHelpModal()" class="text-zinc-500 hover:text-white text-3xl sm:text-2xl p-2 -m-2" title="å…³é—­">&times;</button>
            </div>
            <div class="space-y-6 text-zinc-300 text-sm leading-relaxed">
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">ğŸ“Œ è¿™æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
                    <p>SF6 FRAME LAB æ˜¯ä¸€æ¬¾å¡å¸§å¥—è·¯å‹åˆ¶è®¡ç®—å·¥å…·ï¼Œå¸®åŠ©æ‰¾åˆ°æœ€ä¼˜çš„<strong class="text-cyan-400">å¡å¸§å‹åˆ¶</strong>ç»„åˆæ–¹æ¡ˆã€‚</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">ğŸ® å¦‚ä½•ä½¿ç”¨</h3>
                    <ol class="list-decimal list-inside space-y-3 text-zinc-400">
                        <li><strong class="text-white">é€‰æ‹©è§’è‰²</strong> - ç‚¹å‡» <span class="text-cyan-400">è§’è‰²</span> æŒ‰é’®åˆ‡æ¢è§’è‰²</li>
                        <li>
                            <strong class="text-white">æŸ¥çœ‹å¡å¸§ç­–ç•¥</strong> - <span class="text-cyan-400">æ–¹æ¡ˆ</span> é¡µç­¾å±•ç¤ºå„ç§å‡»å€’æƒ…å¢ƒä¸‹çš„æœ€ä¼˜æ–¹æ¡ˆ
                            <p class="text-zinc-500 text-xs mt-1 ml-5">*ä½¿ç”¨æœç´¢æ¡†æŸ¥æ‰¾ç‰¹å®šå¸§æ•°æˆ–åœºæ™¯ï¼Œç‚¹å‡»æ’åºæŒ‰é’®åˆ‡æ¢æ’åºæ–¹å‘</p>
                            <p class="text-zinc-500 text-xs ml-5">*ç‚¹å‡» <span class="text-yellow-400">â˜†</span> æ”¶è—å–œæ¬¢çš„æ–¹æ¡ˆï¼Œç‚¹å‡» <span class="text-zinc-400">_</span> æœ€å°åŒ–åˆ°å¤‡é€‰åŒº</p>
                        </li>
                        <li>
                            <strong class="text-white">æ–°å¢åœºæ™¯</strong> - ç‚¹å‡» <span class="text-cyan-400">+ æ–°å¢åœºæ™¯</span> è¾“å…¥æœ‰åˆ©å¸§æ•°ï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®—
                            <p class="text-zinc-500 text-xs mt-1 ml-5">*å¯å±•å¼€ã€ŒæœŸæœ›åç»­ã€æŒ‡å®šå‰©ä½™å¸§æ•°æˆ–å‹åˆ¶æ‹›å¼ï¼Œç³»ç»ŸéªŒè¯å¯è¡Œæ€§</p>
                        </li>
                        <li>
                            <strong class="text-white">ç®¡ç†å¸§æ•°æ®</strong> - <span class="text-cyan-400">æ•°æ®</span> é¡µç­¾å¯æŸ¥çœ‹/å¯¼å…¥è§’è‰²æ‹›å¼æ•°æ®
                            <p class="text-zinc-500 text-xs mt-1 ml-5">*ç®¡ç†ç»„åˆè§„åˆ™ï¼š<span class="text-zinc-400">å…¨å±€</span> è§„åˆ™å…¨è§’è‰²ç”Ÿæ•ˆï¼Œå…¶ä»–è§„åˆ™ä»…å½“å‰è§’è‰²</p>
                        </li>
                    </ol>
                </section>
                
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">ğŸ’¡ æ–¹æ¡ˆè§£è¯»</h3>
                    <ul class="space-y-2 text-zinc-400">
                        <li><span class="text-yellow-500">å¡å¸§æ‹›å¼</span> â†’ ç”¨æ¥æ¶ˆè€—å¤šä½™çš„æœ‰åˆ©å¸§</li>
                        <li><span class="text-white">å‹åˆ¶æ‹›å¼</span> â†’ å¯¹æ‰‹èµ·èº«æ—¶æ”»å‡»å‘½ä¸­çš„æ‹›å¼</li>
                        <li><span class="text-cyan-400">H +X</span> / <span class="text-white">H 0</span> / <span class="text-rose-400">H -X</span> â†’ å‘½ä¸­æ—¶çš„å¸§æ•°ä¼˜åŠ¿</li>
                        <li><span class="text-cyan-400">B +X</span> / <span class="text-white">B 0</span> / <span class="text-rose-400">B -X</span> â†’æ‰“é˜²æ—¶çš„å¸§æ•°ä¼˜åŠ¿</li>
                        <li><span class="text-emerald-400">å· XF</span> â†’ æ¯”æ­£å¸¸æ›´æ—©å‘½ä¸­ï¼Œå¤šå·çš„å¸§æ•°</li>
                    </ul>
                </section>
                
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">âš™ï¸ è§„åˆ™ç®¡ç†</h3>
                    <p class="text-zinc-400 mb-2">åœ¨<span class="text-cyan-400">æ•°æ®</span>é¡µç­¾å¯æ·»åŠ è‡ªå®šä¹‰è§„åˆ™ï¼š</p>
                    <ul class="space-y-2 text-zinc-400 text-sm">
                        <li><span class="text-red-400">ç¦ç”¨æ‹›å¼</span> â†’ ç¦æ­¢æŸæ‹›å¼ç”¨äºå¡å¸§ã€å‹åˆ¶æˆ–ç›´æ¥å‹åˆ¶</li>
                        <li><span class="text-red-400">ç¦æ­¢ç»„åˆ</span> â†’ ç¦æ­¢ä¸¤ä¸ªæ‹›å¼è¿ç»­ä½¿ç”¨ï¼ˆå¦‚ 5LP Ã— 5LPï¼‰</li>
                        <li><span class="text-green-400">åå¥½å‹åˆ¶</span> â†’ ä¼˜å…ˆæ¨èæŸæ‹›å¼ä½œä¸ºå‹åˆ¶æ‹›å¼</li>
                    </ul>
                    <p class="text-zinc-500 text-xs mt-2">*<span class="text-zinc-400">å…¨å±€</span>è§„åˆ™ï¼ˆå¦‚ LP+LPï¼‰å¯¹æ‰€æœ‰è§’è‰²ç”Ÿæ•ˆä¸”ä¸å¯åˆ é™¤</p>
                </section>
                
                <section>
                    <h3 class="text-lg font-bold text-white mb-2">ğŸ“ å†™åœ¨æœ€å</h3>
                    <p class="text-zinc-400">æœ¬ç½‘é¡µä»å¤„äºæµ‹è¯•æ—©æœŸç‰ˆæœ¬ï¼Œå¦‚æœ‰åé¦ˆå’Œå»ºè®®ï¼Œè¯·Bç«™ç§ä¿¡ <strong class="text-cyan-400">Cold_Visions</strong>ï¼Œååˆ†æ„Ÿè°¢ï¼</p>
                </section>
                
                <div class="pt-4 border-t border-zinc-800 text-center text-zinc-600 text-xs">
                    Made by Yuetian
                </div>
            </div>
        </div>
    </div>

    <!-- è§’è‰²æ•°æ®å­˜å‚¨ï¼ˆå…¨å±€å˜é‡ï¼Œç”±å„è§’è‰²JSæ–‡ä»¶å¡«å……ï¼‰ -->
    <script>const CHARACTER_DATA = {};</script>
    <!-- åŠ è½½è§’è‰²æ•°æ®æ–‡ä»¶ -->
    <script src="data/ryu.js"></script>
    <script src="data/blanka.js"></script>
    <script src="data/sagat.js"></script>

    <script>
        // ==================== é…ç½®å¸¸é‡ ====================
        const CONFIG = {
            // SF6 å…¨è§’è‰²åˆ—è¡¨
            ALL_CHARACTERS: [
                "RYU", "LUKE", "KEN", "CHUN-LI", "GUILE", "KIMBERLY",
                "JURI", "JAMIE", "BLANKA", "DHALSIM", "E.HONDA", "DEE JAY",
                "MANON", "MARISA", "JP", "ZANGIEF", "LILY", "CAMMY",
                "RASHID", "A.K.I.", "ED", "GOUKI", "VEGA", "TERRY",
                "MAI", "ELENA", "SAGAT", "C.VIPER"
            ],
            // å·²æœ‰JSONæ•°æ®çš„è§’è‰²
            CHARACTERS_WITH_DATA: ["RYU", "BLANKA", "SAGAT"],
            // å®‰å…¨è·³æ‰€éœ€å¸§æ•°ï¼ˆå¤§éƒ¨åˆ†è§’è‰²42Fï¼‰
            SAFE_JUMP_FRAMES: {
                "DEFAULT": 42,
                "ZANGIEF": 43,
                "LILY": 44,
                "A.K.I.": 44,
                "CHUN-LI": 46,
                "DHALSIM": 75
            },
            // å…¨å±€è§„åˆ™ï¼ˆé€‚ç”¨äºæ‰€æœ‰è§’è‰²ï¼Œä¸å¯ç¼–è¾‘ï¼‰
            GLOBAL_RULES: [
                {
                    id: "global_lp_lp",
                    pattern1: "LP",
                    pattern2: "LP",
                    description: "è½»æ‹³ä¸ä¼šå’Œè½»æ‹³ç»„åˆï¼ˆè¿ç‚¹å–æ¶ˆä¸èƒ½ç²¾å‡†å¡å¸§ï¼‰"
                },
                {
                    id: "global_2lp_2lp",
                    pattern1: "2LP",
                    pattern2: "2LP",
                    description: "ä¸‹è½»æ‹³ä¸ä¼šå’Œä¸‹è½»æ‹³ç»„åˆï¼ˆè¿ç‚¹å–æ¶ˆä¸èƒ½ç²¾å‡†å¡å¸§ï¼‰"
                },
                {
                    id: "global_2lp_lp",
                    pattern1: "2LP",
                    pattern2: "LP",
                    description: "ä¸‹è½»æ‹³ä¸ä¼šå’Œè½»æ‹³ç»„åˆï¼ˆè¿ç‚¹å–æ¶ˆä¸èƒ½ç²¾å‡†å¡å¸§ï¼‰"
                },
                {
                    id: "global_lp_2lp",
                    pattern1: "LP",
                    pattern2: "2LP",
                    description: "è½»æ‹³ä¸ä¼šå’Œä¸‹è½»æ‹³ç»„åˆï¼ˆè¿ç‚¹å–æ¶ˆä¸èƒ½ç²¾å‡†å¡å¸§ï¼‰"
                }
            ],
            // è§’è‰²å›¾æ ‡æ˜ å°„
            CHAR_ICONS: {
                "RYU": "ğŸ¥‹", "LUKE": "ğŸ¥Š", "KEN": "ğŸ”¥", "CHUN-LI": "ğŸ¦µ", "GUILE": "âœˆï¸", "KIMBERLY": "ğŸ¥·",
                "JURI": "ğŸ¦‹", "JAMIE": "ğŸ¸", "BLANKA": "âš¡", "DHALSIM": "ğŸ§˜", "E.HONDA": "ğŸ¤¼", "DEE JAY": "ğŸµ",
                "MANON": "ğŸ©°", "MARISA": "ğŸ—¿", "JP": "ğŸ©", "ZANGIEF": "ğŸ»", "LILY": "ğŸª¶", "CAMMY": "ğŸ±",
                "RASHID": "ğŸŒªï¸", "A.K.I.": "ğŸ", "ED": "ğŸ‘Š", "GOUKI": "ğŸ‘¹", "VEGA": "ğŸ¦‚", "TERRY": "ğŸ§¢",
                "MAI": "ğŸŒ¸", "ELENA": "ğŸŒº", "SAGAT": "ğŸ¯", "C.VIPER": "ğŸ•¶ï¸"
            },
            // localStorage é”®åå‰ç¼€
            STORAGE_KEY: "sf6_frame_lab",
            // ==================== è§’è‰²ä¸»é¢˜é…è‰²æ–¹æ¡ˆ ====================
            // ã€é…è‰²å˜é‡ç”¨é€”è¯´æ˜ã€‘
            // primary    - ä¸»é¢˜è‰²ï¼šå¡ç‰‡è¾¹æ¡†/èƒŒæ™¯æ··åˆã€å‘å…‰æ•ˆæœã€æŒ‰é’®æ‚¬åœèƒŒæ™¯
            // secondary  - é«˜äº®æ–‡æœ¬è‰²ï¼šå¸§æ•°æ•°å­—"+XXF"ã€å¤§æ ‡é¢˜ï¼ˆå¿…é¡»æ˜¯äº®è‰²ï¼æ·±è‰²èƒŒæ™¯ä¸Šçš„æ–‡å­—ï¼‰
            // accent     - ç‚¹ç¼€è‰²ï¼šGlitchæ•ˆæœå¯¹æ¯”è‰²ã€ç¯å¢ƒå…‰ã€è£…é¥°å…ƒç´ 
            // modalTitle - Modalå¯¹è¯æ¡†æ ‡é¢˜é¢œè‰²
            // btnPrimary - ä¸»æŒ‰é’®èƒŒæ™¯è‰²
            // btnPrimaryHover - ä¸»æŒ‰é’®æ‚¬åœè‰²
            // inputAccent - è¾“å…¥æ¡†å¼ºè°ƒè‰²
            // cardBg     - å¡ç‰‡èƒŒæ™¯ï¼ˆæ·±è‰²ï¼‰
            // cardBorder - å¡ç‰‡è¾¹æ¡†é¢œè‰²
            // bgImage    - èƒŒæ™¯å›¾ç‰‡è·¯å¾„
            CHAR_THEMES: {
                "RYU": {
                    primary: "#6b2020",      // é“æœæš—çº¢
                    secondary: "#d4a574",    // é“æœç±³è‰²ï¼ˆæ–‡æœ¬é«˜äº®ï¼‰
                    accent: "#1a1a1a",       // æ°´å¢¨é»‘ï¼ˆGlitchå¯¹æ¯”ï¼‰
                    modalTitle: "#a04040",
                    btnPrimary: "#6b2020",
                    btnPrimaryHover: "#4a1515",
                    inputAccent: "#a04040",
                    cardBg: "#1a1210",       // æ·±æ£•çº¢
                    cardBorder: "#3d2218",
                    bgImage: "asset/ryu_ss01.jpg"
                },
                "BLANKA": {
                    primary: "#228b22",      // ä¸›æ—ç»¿
                    secondary: "#ffd700",    // é—ªç”µé»„ï¼ˆæ–‡æœ¬é«˜äº®ï¼‰
                    accent: "#f97316",       // æ¯›å‘æ©™ï¼ˆGlitchå¯¹æ¯”ï¼‰
                    modalTitle: "#32cd32",
                    btnPrimary: "#228b22",
                    btnPrimaryHover: "#1a6b1a",
                    inputAccent: "#32cd32",
                    cardBg: "#141c14",       // æ·±ç»¿
                    cardBorder: "#2a4a2a",
                    bgImage: "asset/blanka_ss01.jpg"
                },
                "SAGAT": {
                    primary: "#d49500",      // è™é»„/æ²™é‡‘ï¼ˆé¥±æ»¡æœ‰åŠ›ï¼‰
                    secondary: "#e8e4d8",    // ç»‘å¸¦äº®ç°ç™½ï¼ˆæ–‡æœ¬é«˜äº®ï¼‰
                    accent: "#e5a000",       // è™é»„ï¼ˆGlitchå¯¹æ¯” - å’Œprimaryå‘¼åº”ï¼‰
                    modalTitle: "#e8e4d8",   // ç»‘å¸¦äº®ç°ç™½
                    btnPrimary: "#b88000",   // æ·±æ²™é‡‘æŒ‰é’®
                    btnPrimaryHover: "#9a6a00",
                    inputAccent: "#d49500",  // è™é»„å¼ºè°ƒ
                    cardBg: "#0a0a08",       // çº¯é»‘ï¼ˆä½“ç°é»‘è‰²æ¬¡è‰²è°ƒï¼‰
                    cardBorder: "#2a2820",   // æš—ç°è¾¹æ¡†
                    bgImage: "asset/sagat_ss01.jpg"
                },
                // é»˜è®¤ä¸»é¢˜ï¼ˆç”¨äºæ— ç‰¹å®šä¸»é¢˜çš„è§’è‰²ï¼‰
                "_DEFAULT": {
                    primary: "#ff007a",      // éœ“è™¹ç²‰
                    secondary: "#00f2ff",    // é’è‰²ï¼ˆæ–‡æœ¬é«˜äº®ï¼‰
                    accent: "#ffd700",       // é‡‘è‰²ï¼ˆGlitchå¯¹æ¯”ï¼‰
                    modalTitle: "#ec4899",
                    btnPrimary: "#db2777",
                    btnPrimaryHover: "#be185d",
                    inputAccent: "#f472b6",
                    cardBg: "#141416",
                    cardBorder: "#2a2a2e",
                    bgImage: null
                }
            }
        };

        // ==================== åº”ç”¨çŠ¶æ€ ====================
        const state = {
            currentCharacter: "RYU",
            moveLibrary: [],
            notes: [],
            // è§’è‰²æ•°æ®ç¼“å­˜ï¼š{ moves: [], scenarios: [] }
            characterCache: {},
            // æ”¶è—çš„æ–¹æ¡ˆ { "charName:adv:planKey": true }
            favorites: {},
            // æœ€å°åŒ–çš„æ–¹æ¡ˆ { "charName:adv:planKey": true }
            minimized: {},
            // æ’åºæ–¹å‘ï¼š'asc' ä»å°åˆ°å¤§ï¼Œ'desc' ä»å¤§åˆ°å°
            sortOrder: 'asc',
            // è§’è‰²ä¸“å±è§„åˆ™ { charName: [rules] }
            characterRules: {},
            // å½“å‰å±•å¼€çš„æœ‰åˆ©å¸§ï¼ˆnull è¡¨ç¤ºå…¨éƒ¨æ”¶èµ·ï¼‰
            expandedAdv: null
        };

        // ==================== å·¥å…·å‡½æ•° ====================
        // HTML è½¬ä¹‰ï¼Œé˜²æ­¢ XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ˜¾ç¤ºæ“ä½œæç¤ºï¼ˆè½»é‡çº§ toastï¼‰
        function showToast(message, type = 'success') {
            // ç§»é™¤å·²æœ‰çš„ toast
            const existing = document.getElementById('toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = `fixed bottom-20 left-1/2 -translate-x-1/2 px-4 py-2 rounded text-sm font-bold z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600 text-white' : 
                type === 'error' ? 'bg-red-600 text-white' : 
                'bg-zinc-700 text-white'
            }`;
            toast.textContent = message;
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(-50%) translateY(10px)';
            
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(-50%) translateY(0)';
            });
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 1500);
        }
        
        // æœç´¢é˜²æŠ–
        let searchDebounceTimer = null;
        function debounce(func, delay = 150) {
            return function(...args) {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        function getCharIcon(char) {
            return CONFIG.CHAR_ICONS[char] || "ğŸ‘¤";
        }
        
        // åº”ç”¨è§’è‰²ä¸»é¢˜è‰²
        function applyTheme(char) {
            const theme = CONFIG.CHAR_THEMES[char] || CONFIG.CHAR_THEMES["_DEFAULT"];
            const root = document.documentElement;
            
            root.style.setProperty('--theme-primary', theme.primary);
            root.style.setProperty('--theme-secondary', theme.secondary);
            root.style.setProperty('--theme-accent', theme.accent);
            root.style.setProperty('--theme-card-bg', theme.cardBg);
            root.style.setProperty('--theme-card-border', theme.cardBorder);
            root.style.setProperty('--theme-modal-title', theme.modalTitle);
            root.style.setProperty('--theme-btn-primary', theme.btnPrimary);
            root.style.setProperty('--theme-btn-primary-hover', theme.btnPrimaryHover);
            root.style.setProperty('--theme-input-accent', theme.inputAccent);
            
            // åº”ç”¨èƒŒæ™¯å›¾
            const bgOverlay = document.getElementById('bgOverlay');
            if (theme.bgImage) {
                bgOverlay.style.backgroundImage = `url('${theme.bgImage}')`;
                bgOverlay.style.opacity = '1';
            } else {
                bgOverlay.style.backgroundImage = 'none';
                bgOverlay.style.opacity = '0';
            }
            
            console.log(`[ä¸»é¢˜] åº”ç”¨ ${char} ä¸»é¢˜:`, theme);
        }

        // è§£æactiveå­—ç¬¦ä¸²ä¸ºæ®µæ•°ç»„ï¼ˆæ”¯æŒå¤šæ®µå¦‚ "10-14,20-23"ï¼‰
        function parseActiveRanges(activeStr) {
            if (typeof activeStr === 'number') return [{ start: activeStr, end: activeStr }];
            if (typeof activeStr !== 'string') return [{ start: 0, end: 0 }];
            
            return activeStr.split(',').map(segment => {
                const parts = segment.trim().split('-').map(Number);
                return {
                    start: parts[0],
                    end: parts.length === 2 ? parts[1] : parts[0]
                };
            });
        }

        // è·å–æœ€åä¸€ä¸ªactiveå¸§ï¼ˆç”¨äºè®¡ç®—å¡å¸§æ‹›å¼çš„æ€»è€—æ—¶ï¼‰
        function getLastActiveFrame(activeStr) {
            const ranges = parseActiveRanges(activeStr);
            return Math.max(...ranges.map(r => r.end));
        }

        // æ£€æŸ¥targetFrameæ˜¯å¦å‘½ä¸­æŸä¸ªactiveæ®µï¼Œè¿”å›å‘½ä¸­ä¿¡æ¯æˆ–null
        function checkActiveHit(activeStr, targetFrame) {
            const ranges = parseActiveRanges(activeStr);
            for (const range of ranges) {
                if (range.start <= targetFrame && targetFrame <= range.end) {
                    return {
                        hitAtActive: targetFrame - range.start + 1,
                        stolen: targetFrame - range.start,
                        rangeStart: range.start,
                        rangeEnd: range.end
                    };
                }
            }
            return null; // æœªå‘½ä¸­ä»»ä½•activeæ®µ
        }

        // ==================== localStorage å­˜å– ====================
        function getStorageKey(char, type) {
            return `${CONFIG.STORAGE_KEY}_${char}_${type}`;
        }
        
        function getGlobalStorageKey(type) {
            return `${CONFIG.STORAGE_KEY}_global_${type}`;
        }

        // ========== å½“å‰è§’è‰²å­˜å‚¨ ==========
        function saveCurrentCharacter(char) {
            try {
                localStorage.setItem(getGlobalStorageKey('currentCharacter'), char);
            } catch (e) {
                console.warn('ä¿å­˜å½“å‰è§’è‰²å¤±è´¥:', e);
            }
        }
        
        function loadCurrentCharacter() {
            try {
                return localStorage.getItem(getGlobalStorageKey('currentCharacter')) || 'RYU';
            } catch (e) {
                return 'RYU';
            }
        }

        // ========== æ‹›å¼æ•°æ®å­˜å‚¨ ==========
        function saveMoves(char, moves) {
            try {
                // åªä¿å­˜ç”¨æˆ·ä¿®æ”¹è¿‡çš„æ•°æ®ï¼ˆä¸é¢„è®¾ä¸åŒï¼‰
                localStorage.setItem(getStorageKey(char, 'moves'), JSON.stringify(moves));
            } catch (e) {
                console.warn('ä¿å­˜æ‹›å¼æ•°æ®å¤±è´¥:', e);
            }
        }
        
        function loadMovesFromStorage(char) {
            try {
                const saved = localStorage.getItem(getStorageKey(char, 'moves'));
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('è¯»å–æ‹›å¼æ•°æ®å¤±è´¥:', e);
            }
            return null;
        }
        
        function clearSavedMoves(char) {
            localStorage.removeItem(getStorageKey(char, 'moves'));
        }

        // ========== Scenarios å­˜å‚¨ ==========
        // ä¿å­˜è§’è‰²çš„ scenarios åˆ° localStorage (åªå­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„éƒ¨åˆ†)
        function saveScenarios(char, allScenarios) {
            try {
                // åˆ†ç¦»å‡ºç”¨æˆ·è‡ªå®šä¹‰çš„åœºæ™¯ï¼ˆå¸¦æœ‰ isUserAdded æ ‡è®°çš„ï¼‰
                const userScenarios = allScenarios.filter(s => s.isUserAdded === true);
                localStorage.setItem(getStorageKey(char, 'scenarios'), JSON.stringify(userScenarios));
            } catch (e) {
                console.warn('ä¿å­˜ scenario å¤±è´¥:', e);
            }
        }

        // è·å–è§’è‰²çš„é¢„è®¾ scenarios (ä»JSONç¼“å­˜)
        function getDefaultScenarios(char) {
            const cache = state.characterCache[char];
            return cache?.scenarios ? [...cache.scenarios] : [];
        }
        
        // è·å–è§’è‰²çš„é¢„è®¾ moves (ä»JSONç¼“å­˜)
        function getDefaultMoves(char) {
            const data = CHARACTER_DATA[char];
            return data?.moves ? [...data.moves] : [];
        }

        // åŠ è½½è§’è‰²çš„ scenariosï¼Œåˆå¹¶é¢„è®¾ + ç”¨æˆ·è‡ªå®šä¹‰
        function loadScenariosFromStorage(char) {
            try {
                const saved = localStorage.getItem(getStorageKey(char, 'scenarios'));
                if (saved) {
                    const userScenarios = JSON.parse(saved);
                    // ç¡®ä¿ç”¨æˆ·åœºæ™¯éƒ½æœ‰ isUserAdded æ ‡è®°
                    userScenarios.forEach(s => s.isUserAdded = true);
                    return userScenarios;
                }
            } catch (e) {
                console.warn('è¯»å– scenario å¤±è´¥:', e);
            }
            return []; // è¿”å›ç©ºæ•°ç»„è¡¨ç¤ºæ²¡æœ‰ç”¨æˆ·è‡ªå®šä¹‰
        }

        // åŠ è½½å®Œæ•´çš„ scenariosï¼šé¢„è®¾ + ç”¨æˆ·è‡ªå®šä¹‰
        function loadAllScenarios(char) {
            const defaultScenarios = getDefaultScenarios(char);
            const userScenarios = loadScenariosFromStorage(char);
            return [...defaultScenarios, ...userScenarios];
        }

        // é‡ç½®è§’è‰² scenarios ä¸ºé¢„è®¾ï¼ˆæ¸…é™¤ç”¨æˆ·è‡ªå®šä¹‰ï¼‰
        function resetScenarios(char) {
            localStorage.removeItem(getStorageKey(char, 'scenarios'));
            return getDefaultScenarios(char);
        }
        
        // é‡ç½®è§’è‰² moves ä¸ºé¢„è®¾
        function resetMoves(char) {
            clearSavedMoves(char);
            return getDefaultMoves(char);
        }

        // ========== è§„åˆ™å­˜å‚¨ ==========
        // ä¿å­˜è§’è‰²ä¸“å±è§„åˆ™
        function saveCharacterRules(char, rules) {
            try {
                localStorage.setItem(getStorageKey(char, 'rules'), JSON.stringify(rules));
            } catch (e) {
                console.warn('ä¿å­˜è§„åˆ™å¤±è´¥:', e);
            }
        }
        
        // åŠ è½½è§’è‰²ä¸“å±è§„åˆ™
        function loadCharacterRules(char) {
            try {
                const saved = localStorage.getItem(getStorageKey(char, 'rules'));
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('è¯»å–è§„åˆ™å¤±è´¥:', e);
            }
            return [];
        }
        
        // è·å–å½“å‰è§’è‰²çš„æ‰€æœ‰è§„åˆ™ï¼ˆå…¨å±€ + è§’è‰²ä¸“å±ï¼‰
        function getAllRulesForCharacter(char) {
            const globalRules = CONFIG.GLOBAL_RULES.map(r => ({ ...r, isGlobal: true }));
            const charRules = (state.characterRules[char] || []).map(r => ({ ...r, isGlobal: false }));
            return [...globalRules, ...charRules];
        }
        
        // æ£€æŸ¥æ‹›å¼æ˜¯å¦è¢«ç¦ç”¨ï¼ˆç”¨äºç‰¹å®šç”¨é€”ï¼‰
        function isMoveDisabled(move, usage, rules) {
            if (!move) return false;
            const moveName = (move.name || '').toUpperCase();
            
            for (const rule of rules) {
                if (rule.type === 'disable' && rule.moveName && rule.usage === usage) {
                    if (moveName === rule.moveName.toUpperCase()) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // æ£€æŸ¥ä¸¤ä¸ªæ‹›å¼æ˜¯å¦è¢«è§„åˆ™ç¦æ­¢ç»„åˆ
        function isComboForbidden(move1, move2, rules) {
            if (!move1 || !move2) return false;
            const name1 = (move1.name || '').toUpperCase();
            const name2 = (move2.name || '').toUpperCase();
            
            for (const rule of rules) {
                // ç¦ç”¨ç»„åˆè§„åˆ™
                if (rule.type === 'combo' && rule.move1 && rule.move2) {
                    const m1 = rule.move1.toUpperCase();
                    const m2 = rule.move2.toUpperCase();
                    // åŒå‘æ£€æŸ¥
                    if ((name1 === m1 && name2 === m2) || (name1 === m2 && name2 === m1)) {
                        return true;
                    }
                }
                // å…¼å®¹æ—§çš„ pattern è§„åˆ™ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
                else if (rule.pattern1 && rule.pattern2) {
                    const p1 = rule.pattern1.toUpperCase();
                    const p2 = rule.pattern2.toUpperCase();
                    if ((name1.includes(p1) && name2.includes(p2)) ||
                        (name1.includes(p2) && name2.includes(p1))) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // ========== æ”¶è—/æœ€å°åŒ–çŠ¶æ€å­˜å‚¨ ==========
        function saveFavorites() {
            try {
                localStorage.setItem(getGlobalStorageKey('favorites'), JSON.stringify(state.favorites));
            } catch (e) {
                console.warn('ä¿å­˜æ”¶è—çŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        function loadFavorites() {
            try {
                const saved = localStorage.getItem(getGlobalStorageKey('favorites'));
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                return {};
            }
        }
        
        function saveMinimized() {
            try {
                localStorage.setItem(getGlobalStorageKey('minimized'), JSON.stringify(state.minimized));
            } catch (e) {
                console.warn('ä¿å­˜æœ€å°åŒ–çŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        function loadMinimized() {
            try {
                const saved = localStorage.getItem(getGlobalStorageKey('minimized'));
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                return {};
            }
        }

        // ==================== æ ¸å¿ƒè®¡ç®—é€»è¾‘ ====================
        // è·å–è§’è‰²çš„å®‰å…¨è·³å¸§æ•°è¦æ±‚
        function getSafeJumpFrames(character) {
            return CONFIG.SAFE_JUMP_FRAMES[character] || CONFIG.SAFE_JUMP_FRAMES["DEFAULT"];
        }
        
        // æ£€æŸ¥æ–¹æ¡ˆæ˜¯å¦ä¸ºå®‰å…¨è·³æˆ–ä¼ªå®‰å…¨è·³
        // è¿”å›: 'safe_jump' | 'pseudo_safe_jump' | null
        function checkSafeJump(plan, character) {
            if (!plan || plan.isThrow) return null;
            
            const safeJumpFrames = getSafeJumpFrames(character);
            
            // ç›´æ¥å‹åˆ¶æ—¶ï¼Œremain å°±æ˜¯ advï¼ˆæœ‰åˆ©å¸§æ•°æœ¬èº«ï¼‰
            // å¡å¸§åï¼Œremain æ˜¯å¡å¸§åå‰©ä½™çš„å¸§æ•°
            if (plan.remain === safeJumpFrames) {
                return 'safe_jump';
            } else if (plan.remain === safeJumpFrames - 1) {
                return 'pseudo_safe_jump';
            }
            
            return null;
        }
        
        // è·å–å·å¸§æ•°çš„é¢œè‰²ç±»ï¼ˆä¸ Hit/Block å¸§æ•°ä¸€è‡´ï¼‰
        function getStolenColorClass(stolen) {
            if (stolen >= 3) return 'text-green-400';      // å·3å¸§ä»¥ä¸Šï¼Œæ·±ç»¿
            if (stolen >= 1) return 'text-emerald-400';    // å·1-2å¸§ï¼Œæµ…ç»¿
            return 'text-yellow-400';                       // å·0å¸§ï¼Œé»„è‰²
        }
        
        // è·å–å¸§æ•°ä¼˜åŠ¿çš„é¢œè‰²ç±»
        function getFrameColorClass(frames) {
            if (frames > 0) return 'text-cyan-400';         // æ­£å¸§ï¼Œæµ…è“
            if (frames === 0) return 'text-white';          // 0å¸§ï¼Œç™½è‰²
            return 'text-rose-400';                         // è´Ÿå¸§ï¼Œç«ç‘°çº¢
        }
        
        // æ£€æµ‹å‹åˆ¶æ‹›å¼çš„æ”»å‡»ç­‰çº§ï¼šheavy / medium / light / other
        function getMoveStrength(move) {
            if (!move || !move.name) return 'other';
            const name = move.name.toUpperCase();
            // é‡æ”»å‡»ï¼šHP, HKï¼ˆåŒ…æ‹¬å¸¦æ–¹å‘çš„å¦‚ 6HP, 4HK ç­‰ï¼‰
            if (name.includes('HP') || name.includes('HK')) return 'heavy';
            // ä¸­æ”»å‡»ï¼šMP, MK
            if (name.includes('MP') || name.includes('MK')) return 'medium';
            // è½»æ”»å‡»ï¼šLP, LK
            if (name.includes('LP') || name.includes('LK')) return 'light';
            return 'other';
        }
        
        // è·å–æ–¹æ¡ˆçš„å‹åˆ¶æ‹›å¼ç­‰çº§
        function getPlanStrength(plan) {
            return getMoveStrength(plan.meatyMove);
        }

        function calculateBestPlan(adv) {
            const possiblePlans = [];
            // è·å–å½“å‰è§’è‰²çš„æ‰€æœ‰è§„åˆ™
            const rules = getAllRulesForCharacter(state.currentCharacter);
            
            // ========== æ–¹æ¡ˆA: ç›´æ¥å‹åˆ¶ï¼ˆä¸éœ€è¦å¡å¸§ï¼‰==========
            // å¯¹æ–¹åœ¨ adv+1 å¸§èµ·èº«ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ‹›å¼çš„ active èƒ½è¦†ç›–
            const directTargetFrame = adv + 1;
            
            state.moveLibrary
                .filter(m => !m.isDash && m.active)
                .filter(m => !isMoveDisabled(m, 'meaty_direct', rules))  // è¿‡æ»¤è¢«ç¦ç”¨çš„ç›´æ¥å‹åˆ¶æ‹›å¼
                .forEach(meatyMove => {
                    // ä½¿ç”¨æ–°çš„å¤šæ®µactiveæ£€æŸ¥å‡½æ•°
                    const hitInfo = checkActiveHit(meatyMove.active, directTargetFrame);
                    
                    if (hitInfo) {
                        // æŠ•æŠ€ç‰¹æ®Šå¤„ç†ï¼šæ²¡æœ‰ hit/block æ¦‚å¿µ
                        const isThrowPlan = meatyMove.isThrow === true;
                        
                        possiblePlans.push({
                            isDirect: true,  // æ ‡è®°ä¸ºç›´æ¥å‹åˆ¶
                            isThrow: isThrowPlan,  // æ ‡è®°æ˜¯å¦ä¸ºæŠ•æŠ€æ–¹æ¡ˆ
                            killMove: null,
                            killTotal: 0,
                            remain: adv,
                            meatyMove,
                            stolen: hitInfo.stolen,
                            finalHit: isThrowPlan ? null : (meatyMove.hit || 0) + hitInfo.stolen,
                            finalBlock: isThrowPlan ? null : (meatyMove.block || 0) + hitInfo.stolen
                        });
                    }
                });
            
            // ========== æ–¹æ¡ˆB: å¡å¸§åå‹åˆ¶ ==========
            state.moveLibrary.forEach(killMove => {
                // æ£€æŸ¥æ˜¯å¦è¢«ç¦ç”¨ç”¨äºå¡å¸§
                if (isMoveDisabled(killMove, 'kill', rules)) return;
                
                // Dash åªèƒ½å¡å¸§ï¼Œæ²¡æœ‰ active åˆ¤æ–­
                if (killMove.isDash) {
                    const killTotal = killMove.dashFrames || 19;
                    if (killTotal >= adv) return;
                    
                    const remain = adv - killTotal;
                    const targetFrame = remain + 1;
                    
                    // Dash åæ¥å‹åˆ¶æ‹›å¼
                    state.moveLibrary
                        .filter(m => !m.isDash && m.active)
                        .filter(m => !isMoveDisabled(m, 'meaty_after_kill', rules))  // è¿‡æ»¤è¢«ç¦ç”¨çš„å¡å¸§åå‹åˆ¶æ‹›å¼
                        .forEach(meatyMove => {
                            const hitInfo = checkActiveHit(meatyMove.active, targetFrame);
                            if (hitInfo) {
                                const isThrowPlan = meatyMove.isThrow === true;
                                possiblePlans.push({
                                    isDirect: false,
                                    isThrow: isThrowPlan,
                                    killMove,
                                    killMove2: null,  // å•æ­¥å¡å¸§æ— ç¬¬äºŒæ­¥
                                    killTotal,
                                    killTotal2: 0,
                                    remain,
                                    meatyMove,
                                    stolen: hitInfo.stolen,
                                    finalHit: isThrowPlan ? null : (meatyMove.hit || 0) + hitInfo.stolen,
                                    finalBlock: isThrowPlan ? null : (meatyMove.block || 0) + hitInfo.stolen
                                });
                            }
                        });
                    return;
                }
                
                if (!killMove.active) return;
                
                // æ™®é€šæ‹›å¼å¡å¸§
                const lastActive = getLastActiveFrame(killMove.active);
                const killTotal = lastActive + killMove.recovery;

                if (killTotal >= adv) return;

                const remain = adv - killTotal;
                const targetFrame = remain + 1;
                
                state.moveLibrary
                    .filter(m => !m.isDash && m.active)
                    .filter(m => !isMoveDisabled(m, 'meaty_after_kill', rules))  // è¿‡æ»¤è¢«ç¦ç”¨çš„å¡å¸§åå‹åˆ¶æ‹›å¼
                    .forEach(meatyMove => {
                        const hitInfo = checkActiveHit(meatyMove.active, targetFrame);
                        
                        if (hitInfo) {
                            // ä½¿ç”¨è§„åˆ™ç³»ç»Ÿæ£€æŸ¥æ˜¯å¦ç¦æ­¢ç»„åˆ
                            if (isComboForbidden(killMove, meatyMove, rules)) {
                                return;
                            }
                            
                            const isThrowPlan = meatyMove.isThrow === true;
                            possiblePlans.push({
                                isDirect: false,
                                isThrow: isThrowPlan,
                                killMove,
                                killMove2: null,  // å•æ­¥å¡å¸§æ— ç¬¬äºŒæ­¥
                                killTotal,
                                killTotal2: 0,
                                remain,
                                meatyMove,
                                stolen: hitInfo.stolen,
                                finalHit: isThrowPlan ? null : (meatyMove.hit || 0) + hitInfo.stolen,
                                finalBlock: isThrowPlan ? null : (meatyMove.block || 0) + hitInfo.stolen
                            });
                        }
                    });
            });

            // ========== æ–¹æ¡ˆC: ä¸¤æ­¥å¡å¸§åå‹åˆ¶ ==========
            state.moveLibrary.forEach(killMove1 => {
                // æ£€æŸ¥ç¬¬ä¸€æ­¥æ˜¯å¦è¢«ç¦ç”¨ç”¨äºå¡å¸§
                if (isMoveDisabled(killMove1, 'kill', rules)) return;
                
                // è®¡ç®—ç¬¬ä¸€æ­¥å¡å¸§æ¶ˆè€—
                let killTotal1;
                if (killMove1.isDash) {
                    killTotal1 = killMove1.dashFrames || 19;
                } else if (killMove1.active) {
                    const lastActive1 = getLastActiveFrame(killMove1.active);
                    killTotal1 = lastActive1 + killMove1.recovery;
                } else {
                    return;
                }
                
                if (killTotal1 >= adv) return;
                const remain1 = adv - killTotal1;
                
                // éå†ç¬¬äºŒæ­¥å¡å¸§æ‹›å¼
                state.moveLibrary.forEach(killMove2 => {
                    // æ£€æŸ¥ç¬¬äºŒæ­¥æ˜¯å¦è¢«ç¦ç”¨ç”¨äºå¡å¸§
                    if (isMoveDisabled(killMove2, 'kill', rules)) return;
                    
                    // è®¡ç®—ç¬¬äºŒæ­¥å¡å¸§æ¶ˆè€—
                    let killTotal2;
                    if (killMove2.isDash) {
                        killTotal2 = killMove2.dashFrames || 19;
                    } else if (killMove2.active) {
                        const lastActive2 = getLastActiveFrame(killMove2.active);
                        killTotal2 = lastActive2 + killMove2.recovery;
                    } else {
                        return;
                    }
                    
                    if (killTotal2 >= remain1) return;
                    const remain2 = remain1 - killTotal2;
                    const targetFrame2 = remain2 + 1;
                    
                    // ä½¿ç”¨è§„åˆ™ç³»ç»Ÿæ£€æŸ¥ç¬¬ä¸€æ­¥+ç¬¬äºŒæ­¥æ˜¯å¦ç¦æ­¢ç»„åˆ
                    if (isComboForbidden(killMove1, killMove2, rules)) {
                        return;
                    }
                    
                    // æ‰¾å‹åˆ¶æ‹›å¼
                    state.moveLibrary
                        .filter(m => !m.isDash && m.active)
                        .filter(m => !isMoveDisabled(m, 'meaty_after_kill', rules))  // è¿‡æ»¤è¢«ç¦ç”¨çš„å¡å¸§åå‹åˆ¶æ‹›å¼
                        .forEach(meatyMove => {
                            const hitInfo = checkActiveHit(meatyMove.active, targetFrame2);
                            
                            if (hitInfo) {
                                // ä½¿ç”¨è§„åˆ™ç³»ç»Ÿæ£€æŸ¥ç¬¬äºŒæ­¥+å‹åˆ¶æ˜¯å¦ç¦æ­¢ç»„åˆ
                                if (isComboForbidden(killMove2, meatyMove, rules)) {
                                    return;
                                }
                                
                                const isThrowPlan = meatyMove.isThrow === true;
                                possiblePlans.push({
                                    isDirect: false,
                                    isThrow: isThrowPlan,
                                    killMove: killMove1,
                                    killMove2: killMove2,  // ä¸¤æ­¥å¡å¸§
                                    killTotal: killTotal1,
                                    killTotal2: killTotal2,
                                    remain: remain2,
                                    meatyMove,
                                    stolen: hitInfo.stolen,
                                    finalHit: isThrowPlan ? null : (meatyMove.hit || 0) + hitInfo.stolen,
                                    finalBlock: isThrowPlan ? null : (meatyMove.block || 0) + hitInfo.stolen
                                });
                            }
                        });
                });
            });

            // ========== æ ‡è®°ä¸¤æ­¥å¡å¸§æ˜¯å¦å¯äº¤æ¢é¡ºåº ==========
            // æ£€æµ‹æ¯ä¸ªä¸¤æ­¥å¡å¸§æ–¹æ¡ˆï¼Œå¦‚æœåå‘ç»„åˆä¹Ÿå­˜åœ¨ï¼Œåˆ™æ ‡è®°ä¸ºå¯äº¤æ¢
            possiblePlans.forEach(plan => {
                if (plan.killMove2) {
                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åå‘ç»„åˆï¼ˆkillMove2 â†’ killMove1 â†’ åŒæ ·çš„å‹åˆ¶ï¼‰
                    const hasReverse = possiblePlans.some(otherPlan => 
                        otherPlan.killMove2 &&
                        otherPlan !== plan &&
                        otherPlan.killMove.name === plan.killMove2.name &&
                        otherPlan.killMove2.name === plan.killMove.name &&
                        otherPlan.meatyMove.name === plan.meatyMove.name &&
                        otherPlan.remain === plan.remain
                    );
                    // æ ‡è®°æ˜¯å¦å¯äº¤æ¢
                    plan.isCommutative = hasReverse;
                }
            });

            // æŒ‰ finalBlock é™åºï¼Œå†æŒ‰ finalHit é™åºï¼ˆæŠ•æŠ€æ–¹æ¡ˆæ’åœ¨æ™®é€šæ–¹æ¡ˆä¹‹åï¼‰
            return possiblePlans.sort((a, b) => {
                // æŠ•æŠ€æ–¹æ¡ˆç»Ÿä¸€æ”¾åé¢
                if (a.isThrow !== b.isThrow) return a.isThrow ? 1 : -1;
                // éæŠ•æŠ€æ–¹æ¡ˆï¼šæŒ‰ block > hit æ’åº
                if (!a.isThrow && !b.isThrow) {
                    if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                    return b.finalHit - a.finalHit;
                }
                // æŠ•æŠ€æ–¹æ¡ˆï¼šç›´æ¥å‹åˆ¶ä¼˜å…ˆ
                return (b.isDirect ? 1 : 0) - (a.isDirect ? 1 : 0);
            });
        }

        // ==================== æ•°æ®åŠ è½½ ====================
        // ä»å…¨å±€ CHARACTER_DATA åŠ è½½è§’è‰²æ•°æ®ï¼ˆç”±å¤–éƒ¨ .js æ–‡ä»¶å¡«å……ï¼‰
        function loadCharacterData(char) {
            console.log(`[åŠ è½½] è§’è‰²: ${char}`);
            
            // 1. ä¼˜å…ˆä» localStorage åŠ è½½ç”¨æˆ·ä¿å­˜çš„æ•°æ®
            const savedMoves = loadMovesFromStorage(char);
            if (savedMoves && savedMoves.length > 0) {
                console.log(`[localStorage] ä½¿ç”¨ç”¨æˆ·ä¿å­˜çš„æ‹›å¼æ•°æ®: ${savedMoves.length} ä¸ª`);
                state.moveLibrary = savedMoves;
                state.characterCache[char] = {
                    moves: savedMoves,
                    scenarios: CHARACTER_DATA[char]?.scenarios || []
                };
                return true;
            }
            
            // 2. æ£€æŸ¥å†…å­˜ç¼“å­˜
            if (state.characterCache[char]?.moves?.length > 0) {
                console.log(`[ç¼“å­˜] ä½¿ç”¨ç¼“å­˜æ•°æ®`);
                state.moveLibrary = [...state.characterCache[char].moves];
                return true;
            }

            // 3. ä»å…¨å±€å˜é‡è¯»å–ï¼ˆç”± <script src="xxx.js"> åŠ è½½ï¼‰
            const data = CHARACTER_DATA[char];
            
            if (data && data.moves) {
                state.characterCache[char] = {
                    moves: [...data.moves],
                    scenarios: data.scenarios ? [...data.scenarios] : []
                };
                state.moveLibrary = [...data.moves];
                console.log(`[æˆåŠŸ] åŠ è½½é¢„è®¾ ${data.moves.length} ä¸ªæ‹›å¼, ${data.scenarios?.length || 0} ä¸ªåœºæ™¯`);
                return true;
            } else {
                console.warn(`[è­¦å‘Š] æœªæ‰¾åˆ° ${char} çš„æ•°æ®ï¼Œè¯·ç¡®ä¿å·²åŠ è½½å¯¹åº”çš„ .js æ–‡ä»¶`);
                state.moveLibrary = [];
                state.characterCache[char] = { moves: [], scenarios: [] };
                return false;
            }
        }

        // ==================== è§’è‰²åˆ‡æ¢ ====================
        function selectCharacter(char) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ï¼Œæ— æ•°æ®è§’è‰²ä¸å¯é€‰
            const hasData = CONFIG.CHARACTERS_WITH_DATA.includes(char);
            if (!hasData) {
                console.log(`[è§’è‰²] ${char} æš‚æ— æ•°æ®ï¼Œæ— æ³•é€‰æ‹©`);
                return; // é˜»æ­¢é€‰æ‹©
            }
            
            state.currentCharacter = char;
            
            // ä¿å­˜å½“å‰è§’è‰²é€‰æ‹©åˆ° localStorage
            saveCurrentCharacter(char);
            
            // åº”ç”¨è§’è‰²ä¸»é¢˜
            applyTheme(char);
            
            // æ›´æ–°UI - åªæ›´æ–°å›¾æ ‡
            document.getElementById('currentCharIcon').textContent = getCharIcon(char);
            
            // åŠ è½½è§’è‰²æ•°æ® (moves + scenarios)
            loadCharacterData(char);
            
            // åŠ è½½ scenarios: é¢„è®¾ + ç”¨æˆ·è‡ªå®šä¹‰
            state.notes = loadAllScenarios(char);
            
            // åŠ è½½è§’è‰²ä¸“å±è§„åˆ™
            state.characterRules[char] = loadCharacterRules(char);
            
            // æ›´æ–°å°æ¡æ»šåŠ¨å†…å®¹
            updateMarqueeTape();
            
            closeCharModal();
            renderAll();
            
            // è‡ªåŠ¨è§¦å‘æ ‡é¢˜ Glitch æ•ˆæœ 0.5 ç§’
            triggerTitleGlitch();
        }
        
        // è§¦å‘æ ‡é¢˜ Glitch æ•ˆæœ
        function triggerTitleGlitch() {
            const title = document.querySelector('.glitch-hover');
            if (title) {
                title.classList.add('glitch-active');
                setTimeout(() => {
                    title.classList.remove('glitch-active');
                }, 1000);
            }
        }

        function initCharacterGrid() {
            const grid = document.getElementById('charGrid');
            grid.innerHTML = CONFIG.ALL_CHARACTERS.map(char => {
                const hasData = CONFIG.CHARACTERS_WITH_DATA.includes(char);
                const isSelected = char === state.currentCharacter;
                
                // æ— æ•°æ®è§’è‰²ä¸æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const clickHandler = hasData ? `onclick="selectCharacter('${char}')"` : '';
                
                return `
                    <div class="char-item ${isSelected ? 'selected' : ''} ${!hasData ? 'no-data' : ''}" 
                         ${clickHandler}
                         title="${hasData ? 'ç‚¹å‡»é€‰æ‹©' : 'æš‚æ— æ•°æ®'}">
                        <div class="char-icon">${getCharIcon(char)}</div>
                        <div class="char-name">${char}</div>
                    </div>
                `;
            }).join('');
        }

        // ==================== æ¸²æŸ“å‡½æ•° ====================
        // ç”Ÿæˆæ–¹æ¡ˆå”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºå»é‡ï¼‰
        function getPlanKey(plan) {
            if (!plan) return '';
            const kill1Name = plan.killMove ? plan.killMove.name : 'DIRECT';
            const kill2Name = plan.killMove2 ? plan.killMove2.name : '';
            return `${kill1Name}|${kill2Name}|${plan.meatyMove.name}`;
        }

        // ç”Ÿæˆæ¨èç†ç”±è¯´æ˜æ–‡æœ¬
        function getRecommendReasons(plan, reasons) {
            if (!reasons || reasons.length === 0) return '';
            
            const reasonTexts = {
                'safe_jump': 'ğŸ¦˜ å®‰å…¨è·³å‹åˆ¶ï¼Œé˜²5å¸§åŠä»¥ä¸Šå‡¹æ‹›',
                'pseudo_safe_jump': 'ğŸ¦˜ ä¼ªå®‰å…¨è·³å‹åˆ¶ï¼Œé˜²6å¸§åŠä»¥ä¸Šå‡¹æ‹›',
                'best_block': 'ğŸ›¡ï¸ æ‰“é˜²æ”¶ç›Šæœ€ä¼˜',
                'best_hit': 'âš”ï¸ å‘½ä¸­æ”¶ç›Šæœ€ä¼˜',
                'best_nonheavy_block': 'ğŸ¯ ä¸­/å¼±æ”»å‡»æ‰“é˜²æœ€ä¼˜',
                'best_nonheavy_hit': 'ğŸ¯ ä¸­/å¼±æ”»å‡»å‘½ä¸­æœ€ä¼˜',
                'most_stolen': 'â±ï¸ å·å¸§æœ€å¤š',
                'throw': 'ğŸ¤¼ æŠ•æŠ€æ–¹æ¡ˆ',
                'mixup': 'ğŸ² æ‰“æŠ•äºŒæ‹©',
                'favorite': 'â­ ç”¨æˆ·æ”¶è—',
                'prefer': 'ğŸ‘ ç”¨æˆ·è§„åˆ™å€¾å‘å‹åˆ¶'  // åŠ¨æ€æ·»åŠ æ‹›å¼å
            };
            
            // è¿‡æ»¤è§„åˆ™ï¼šå¦‚æœåŒæ—¶æ»¡è¶³1å’Œ3ï¼Œåªæ˜¾ç¤º1ï¼›åŒæ—¶æ»¡è¶³2å’Œ4ï¼Œåªæ˜¾ç¤º2
            let filteredReasons = [...reasons];
            if (reasons.includes('best_block') && reasons.includes('best_nonheavy_block')) {
                filteredReasons = filteredReasons.filter(r => r !== 'best_nonheavy_block');
            }
            if (reasons.includes('best_hit') && reasons.includes('best_nonheavy_hit')) {
                filteredReasons = filteredReasons.filter(r => r !== 'best_nonheavy_hit');
            }
            
            return filteredReasons.map(r => {
                if (r.startsWith('prefer:')) {
                    const moveName = r.split(':')[1];
                    return `ğŸ‘ ç”¨æˆ·è§„åˆ™å€¾å‘å‹åˆ¶ï¼š${moveName}`;
                }
                return reasonTexts[r] || '';
            }).filter(t => t).join('\n');
        }

        // æ¸²æŸ“ä¸»è¦æ–¹æ¡ˆï¼ˆç´§å‡‘ç‰ˆï¼Œå¸¦æ”¶è—å’Œæœ€å°åŒ–æŒ‰é’®ï¼‰
        function renderMainPlan(plan, label, adv, reasons = []) {
            if (!plan) return '';
            
            const planKey = getPlanKey(plan);
            const isFavorite = isPlanFavorite(adv, planKey);
            const isThrow = plan.isThrow;
            const accentColor = 'text-white';
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨è·³/ä¼ªå®‰å…¨è·³
            const isSafeJump = reasons.includes('safe_jump');
            const isPseudoSafeJump = reasons.includes('pseudo_safe_jump');
            const safeJumpLabel = isSafeJump ? 'å®‰å…¨è·³' : (isPseudoSafeJump ? 'ä¼ªå®‰å…¨è·³' : null);
            const safeJumpColor = isSafeJump ? 'text-green-400' : 'text-yellow-400';
            
            // ç”Ÿæˆæ¨èç†ç”±æç¤º
            const recommendReasons = getRecommendReasons(plan, reasons);
            const tooltipHtml = recommendReasons ? `<div class="recommend-tooltip">${recommendReasons.replace(/\n/g, '<br>')}</div>` : '';
            
            // å®‰å…¨è·³ä½¿ç”¨ç‰¹æ®Šè¾¹æ¡†é¢œè‰²
            let borderColor, bgColor;
            if (isFavorite) {
                borderColor = 'border-yellow-500';
                bgColor = 'bg-yellow-900/10';
            } else if (isSafeJump) {
                borderColor = 'border-green-600';
                bgColor = 'bg-green-900/10';
            } else if (isPseudoSafeJump) {
                borderColor = 'border-yellow-600';
                bgColor = 'bg-yellow-900/5';
            } else {
                borderColor = 'border-zinc-800';
                bgColor = 'bg-zinc-900/50';
            }
            
            let stepsHtml;
            
            const stolenColor = getStolenColorClass(plan.stolen);
            
            if (plan.isDirect) {
                // ç›´æ¥å‹åˆ¶/æŠ•
                stepsHtml = `<div class="text-center">
                       <div class="text-[9px] text-zinc-600 uppercase mb-1">ç›´æ¥${isThrow ? 'æŠ•' : ''} (${plan.remain}F)</div>
                       <div class="impact-text text-4xl sm:text-5xl font-black ${accentColor} leading-none glitch-text">${plan.meatyMove.name}</div>
                       ${!isThrow ? `<div class="text-xs mt-1"><span class="text-zinc-500">å·</span><span class="${stolenColor} font-bold">${plan.stolen}F</span></div>` : ''}
                   </div>`;
            } else if (plan.killMove2) {
                // ä¸¤æ­¥å¡å¸§
                const remain1 = adv - plan.killTotal;
                const separator = plan.isCommutative ? '+' : 'â†’';  // å¯äº¤æ¢ç”¨+ï¼Œæœ‰é¡ºåºé™åˆ¶ç”¨â†’
                
                // å®‰å…¨è·³æ—¶æœ€åæ˜¾ç¤º"å®‰å…¨è·³"è€Œä¸æ˜¯æ‹›å¼å
                const finalDisplay = safeJumpLabel 
                    ? `<div class="impact-text text-xl sm:text-2xl font-black ${safeJumpColor} leading-none">${safeJumpLabel}</div>`
                    : `<div class="impact-text text-xl sm:text-2xl font-black ${accentColor} leading-none glitch-text">${plan.meatyMove.name}</div>
                       ${!isThrow ? `<div class="text-[9px]"><span class="text-zinc-500">å·</span><span class="${stolenColor} font-bold">${plan.stolen}F</span></div>` : ''}`;
                
                stepsHtml = `<div class="flex items-center justify-center gap-2 sm:gap-3 flex-wrap">
                       <div class="text-center min-w-[55px]">
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.killMove.name}</div>
                           <div class="text-[9px] text-zinc-500">-${plan.killTotal}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-lg">${separator}</div>
                           <div class="text-[9px] text-yellow-500">${remain1}F</div>
                       </div>
                       <div class="text-center min-w-[55px]">
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.killMove2.name}</div>
                           <div class="text-[9px] text-zinc-500">-${plan.killTotal2}F</div>
                       </div>
                       <div class="text-zinc-600 text-lg">â†’</div>
                       <div class="text-center min-w-[55px]">
                           ${finalDisplay}
                       </div>
                   </div>`;
            } else {
                // ä¸€æ­¥å¡å¸§
                // å®‰å…¨è·³æ—¶æœ€åæ˜¾ç¤º"å®‰å…¨è·³"è€Œä¸æ˜¯æ‹›å¼å
                const finalDisplay = safeJumpLabel 
                    ? `<div class="impact-text text-2xl sm:text-4xl font-black ${safeJumpColor} leading-none">${safeJumpLabel}</div>`
                    : `<div class="impact-text text-2xl sm:text-4xl font-black ${accentColor} leading-none glitch-text">${plan.meatyMove.name}</div>
                       ${!isThrow ? `<div class="text-[10px]"><span class="text-zinc-500">å·</span><span class="${stolenColor} font-bold">${plan.stolen}F</span></div>` : ''}`;
                
                stepsHtml = `<div class="flex items-center justify-center gap-3 sm:gap-5">
                       <div class="text-center min-w-[70px]">
                           <div class="impact-text text-2xl sm:text-4xl font-black text-white leading-none">${plan.killMove.name}</div>
                           <div class="text-[10px] text-zinc-500">-${plan.killTotal}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-xl sm:text-2xl">â†’</div>
                           <div class="text-[9px] text-yellow-500">${plan.remain}F</div>
                       </div>
                       <div class="text-center min-w-[70px]">
                           ${finalDisplay}
                       </div>
                   </div>`;
            }

            // æŠ•æŠ€æ˜¾ç¤º"æ”¾å€’"ï¼Œæ™®é€šæ‹›å¼æ˜¾ç¤º Hit/Block
            const hitColor = getFrameColorClass(plan.finalHit);
            const blockColor = getFrameColorClass(plan.finalBlock);
            const statsHtml = isThrow 
                ? `<span class="text-zinc-400 text-xs">æ”¾å€’</span>`
                : `<span class="text-sm text-zinc-500">H</span><span class="text-lg font-bold ${hitColor} ml-1">${plan.finalHit >= 0 ? '+' : ''}${plan.finalHit}</span>
                   <span class="text-sm text-zinc-500 ml-3">B</span><span class="text-lg font-bold ${blockColor} ml-1">${plan.finalBlock >= 0 ? '+' : ''}${plan.finalBlock}</span>`;

            // æ”¶è—æ˜Ÿå’Œæœ€å°åŒ–æŒ‰é’®
            const starIcon = isFavorite ? 'â˜…' : 'â˜†';
            const starClass = isFavorite ? 'text-yellow-400' : 'text-zinc-600 hover:text-yellow-400';
            
            // æ”¶è—å°ç« 
            const stampHtml = isFavorite ? '<div class="favorite-stamp">FAVE</div>' : '';
            
            // æ–¹æ¡ˆæ ‡ç­¾ï¼ˆå¦‚"æ‰“æŠ•æ‹©"ï¼‰
            const labelHtml = label ? `<div class="absolute top-1 left-1 sm:top-2 sm:left-2 text-[9px] font-bold px-1.5 py-0.5 bg-amber-600/80 text-white uppercase">${label}</div>` : '';

            return `
                <div class="mb-3 p-4 border ${borderColor} ${bgColor} relative group overflow-visible recommend-card">
                    ${stampHtml}
                    ${labelHtml}
                    ${tooltipHtml}
                    <div class="absolute top-1 right-1 sm:top-2 sm:right-2 flex gap-1 opacity-80 group-hover:opacity-100 transition-opacity">
                        <button onclick="toggleFavorite(${adv}, '${planKey}')" class="${starClass} text-xl sm:text-lg p-2 sm:p-1 transition-colors" title="æ”¶è—">${starIcon}</button>
                        <button onclick="minimizePlan(${adv}, '${planKey}')" class="text-zinc-600 hover:text-zinc-400 text-base sm:text-sm p-2 sm:p-1 transition-colors" title="æŠ˜å è‡³å¤‡é€‰">â–¼</button>
                    </div>
                    <div class="mb-2">
                        ${stepsHtml}
                    </div>
                    <div class="text-center border-t border-zinc-800/50 pt-2">
                        ${statsHtml}
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“å¤‡é€‰æ–¹æ¡ˆï¼ˆå¯å±•å¼€è¯¦æƒ…ï¼Œå¸¦æœ€å¤§åŒ–æŒ‰é’®ï¼‰
        function renderAltPlan(plan, adv) {
            if (!plan) return '';
            
            const planKey = getPlanKey(plan);
            const isFavorite = isPlanFavorite(adv, planKey);
            
            let desc;
            if (plan.isDirect) {
                desc = `ç›´æ¥ ${plan.meatyMove.name}`;
            } else if (plan.killMove2) {
                const separator = plan.isCommutative ? '+' : 'â†’';
                desc = `${plan.killMove.name} ${separator} ${plan.killMove2.name} â†’ ${plan.meatyMove.name}`;
            } else {
                desc = `${plan.killMove.name} â†’ ${plan.meatyMove.name}`;
            }
            
            // ç”Ÿæˆå±•å¼€åçš„è¯¦æƒ…
            let detailHtml = renderAltPlanDetail(plan, adv);
            
            // æ”¶è—æ˜Ÿæ ·å¼
            const starIcon = isFavorite ? 'â˜…' : 'â˜†';
            const starClass = isFavorite ? 'text-yellow-400' : 'text-zinc-600 hover:text-yellow-400';
            const rowBg = isFavorite ? 'bg-yellow-900/10' : '';

            const stolenColorAlt = getStolenColorClass(plan.stolen);
            
            return `
                <details class="border-b border-zinc-800/50 ${rowBg}">
                    <summary class="flex items-center justify-between py-2 cursor-pointer hover:bg-zinc-800/30 transition-colors group">
                        <span class="text-sm text-zinc-400">${desc}</span>
                        <div class="flex gap-1 sm:gap-2 text-sm font-bold items-center">
                            <span class="${stolenColorAlt} text-xs sm:text-sm">å·${plan.stolen}F</span>
                            <span class="${getFrameColorClass(plan.finalHit)} text-xs sm:text-sm">H${plan.finalHit >= 0 ? '+' : ''}${plan.finalHit}</span>
                            <span class="${getFrameColorClass(plan.finalBlock)} text-xs sm:text-sm">B${plan.finalBlock >= 0 ? '+' : ''}${plan.finalBlock}</span>
                            <button onclick="event.stopPropagation(); toggleFavorite(${adv}, '${planKey}')" class="${starClass} transition-colors p-1.5 sm:p-1 text-base sm:text-sm" title="æ”¶è—">${starIcon}</button>
                            <button onclick="event.stopPropagation(); maximizePlan(${adv}, '${planKey}')" class="text-zinc-600 hover:text-zinc-400 transition-colors p-1.5 sm:p-1 text-base sm:text-sm" title="ç½®é¡¶æ˜¾ç¤º">â–²</button>
                        </div>
                    </summary>
                    <div class="py-2 px-2 bg-zinc-800/20">
                        ${detailHtml}
                    </div>
                </details>
            `;
        }
        
        // æ¸²æŸ“å¤‡é€‰æ–¹æ¡ˆå±•å¼€è¯¦æƒ…
        function renderAltPlanDetail(plan, adv) {
            const isThrow = plan.isThrow;
            const stolenColorDetail = getStolenColorClass(plan.stolen);
            
            let stepsHtml;
            
            if (plan.isDirect) {
                stepsHtml = `<div class="text-center">
                       <div class="text-[10px] text-zinc-600 uppercase mb-2">ç›´æ¥${isThrow ? 'æŠ•' : 'å‹åˆ¶'} (å‰©ä½™ ${plan.remain}F)</div>
                       <div class="impact-text text-3xl sm:text-4xl font-black text-white leading-none">${plan.meatyMove.name}</div>
                       ${!isThrow ? `<div class="text-sm mt-2"><span class="text-zinc-500">å·</span><span class="${stolenColorDetail} font-bold">${plan.stolen}F</span></div>` : ''}
                   </div>`;
            } else if (plan.killMove2) {
                const remain1 = adv - plan.killTotal;
                const separator = plan.isCommutative ? '+' : 'â†’';
                
                stepsHtml = `<div class="flex items-center justify-center gap-2 sm:gap-3 flex-wrap">
                       <div class="text-center min-w-[60px]">
                           <div class="text-[9px] text-zinc-600 uppercase mb-1">å¡å¸§â‘ </div>
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.killMove.name}</div>
                           <div class="text-[10px] text-zinc-500 mt-1">-${plan.killTotal}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-lg">${separator}</div>
                           <div class="text-[9px] text-yellow-500">${remain1}F</div>
                       </div>
                       <div class="text-center min-w-[60px]">
                           <div class="text-[9px] text-zinc-600 uppercase mb-1">å¡å¸§â‘¡</div>
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.killMove2.name}</div>
                           <div class="text-[10px] text-zinc-500 mt-1">-${plan.killTotal2}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-lg">â†’</div>
                           <div class="text-[9px] text-yellow-500">${plan.remain}F</div>
                       </div>
                       <div class="text-center min-w-[60px]">
                           <div class="text-[9px] text-zinc-500 uppercase mb-1">${isThrow ? 'æŠ•' : 'å‹åˆ¶'}</div>
                           <div class="impact-text text-xl sm:text-2xl font-black text-white leading-none">${plan.meatyMove.name}</div>
                           ${!isThrow ? `<div class="text-[10px] mt-1"><span class="text-zinc-500">å·</span><span class="${stolenColorDetail} font-bold">${plan.stolen}F</span></div>` : ''}
                       </div>
                   </div>`;
            } else {
                stepsHtml = `<div class="flex items-center justify-center gap-3 sm:gap-5">
                       <div class="text-center min-w-[70px]">
                           <div class="text-[9px] text-zinc-600 uppercase mb-1">å¡å¸§</div>
                           <div class="impact-text text-2xl sm:text-3xl font-black text-white leading-none">${plan.killMove.name}</div>
                           <div class="text-xs text-zinc-500 mt-1">-${plan.killTotal}F</div>
                       </div>
                       <div class="text-center">
                           <div class="text-zinc-600 text-xl">â†’</div>
                           <div class="text-[10px] text-yellow-500">å‰©${plan.remain}F</div>
                       </div>
                       <div class="text-center min-w-[70px]">
                           <div class="text-[9px] text-zinc-500 uppercase mb-1">${isThrow ? 'æŠ•' : 'å‹åˆ¶'}</div>
                           <div class="impact-text text-2xl sm:text-3xl font-black text-white leading-none">${plan.meatyMove.name}</div>
                           ${!isThrow ? `<div class="text-xs mt-1"><span class="text-zinc-500">å·</span><span class="${stolenColorDetail} font-bold">${plan.stolen}F</span></div>` : ''}
                       </div>
                   </div>`;
            }

            const statsHtml = isThrow 
                ? `<div class="text-center text-zinc-400 text-xs font-bold mt-3">
                       æ”¾å€’
                   </div>`
                : `<div class="flex justify-center gap-6 mt-3">
                       <div class="text-center">
                           <span class="text-xs text-zinc-600 uppercase">Hit</span>
                           <span class="text-xl font-black ${getFrameColorClass(plan.finalHit)} ml-1">${plan.finalHit >= 0 ? '+' : ''}${plan.finalHit}</span>
                       </div>
                       <div class="text-center">
                           <span class="text-xs text-zinc-600 uppercase">Block</span>
                           <span class="text-xl font-black ${getFrameColorClass(plan.finalBlock)} ml-1">${plan.finalBlock >= 0 ? '+' : ''}${plan.finalBlock}</span>
                       </div>
                   </div>`;

            return `
                <div class="py-2">
                    ${stepsHtml}
                    ${statsHtml}
                </div>
            `;
        }
        
        // æ¸²æŸ“æŠ•æŠ€å¤‡é€‰æ–¹æ¡ˆï¼ˆå¯å±•å¼€è¯¦æƒ…ï¼‰
        function renderAltThrowPlan(plan, adv) {
            if (!plan) return '';
            
            const planKey = getPlanKey(plan);
            const isFavorite = isPlanFavorite(adv, planKey);
            
            let desc;
            if (plan.isDirect) {
                desc = `ç›´æ¥ ${plan.meatyMove.name}`;
            } else if (plan.killMove2) {
                const separator = plan.isCommutative ? '+' : 'â†’';
                desc = `${plan.killMove.name} ${separator} ${plan.killMove2.name} â†’ ${plan.meatyMove.name}`;
            } else {
                desc = `${plan.killMove.name} â†’ ${plan.meatyMove.name}`;
            }
            
            let detailHtml = renderAltPlanDetail(plan, adv);
            
            const starIcon = isFavorite ? 'â˜…' : 'â˜†';
            const starClass = isFavorite ? 'text-yellow-400' : 'text-zinc-600 hover:text-yellow-400';
            const rowBg = isFavorite ? 'bg-yellow-900/10' : '';

            return `
                <details class="border-b border-zinc-800/50 ${rowBg}">
                    <summary class="flex items-center justify-between py-2 cursor-pointer hover:bg-zinc-800/30 transition-colors">
                        <span class="text-sm text-zinc-400">${desc}</span>
                        <div class="flex gap-1 sm:gap-2 items-center">
                            <span class="text-[10px] sm:text-xs text-zinc-500">${plan.remain}F</span>
                            <button onclick="event.stopPropagation(); toggleFavorite(${adv}, '${planKey}')" class="${starClass} transition-colors p-1.5 sm:p-1 text-base sm:text-sm" title="æ”¶è—">${starIcon}</button>
                            <button onclick="event.stopPropagation(); maximizePlan(${adv}, '${planKey}')" class="text-zinc-600 hover:text-zinc-400 transition-colors p-1.5 sm:p-1 text-base sm:text-sm" title="ç½®é¡¶æ˜¾ç¤º">â–²</button>
                        </div>
                    </summary>
                    <div class="py-2 px-2 bg-zinc-800/20">
                        ${detailHtml}
                    </div>
                </details>
            `;
        }

        // æœç´¢è¿‡æ»¤å‡½æ•°
        function filterSolutions() {
            renderNotes();
        }
        
        // æ¸…é™¤æœç´¢
        function clearSearch() {
            const input = document.getElementById('solutionSearch');
            input.value = '';
            updateClearBtn();
            filterSolutions();
        }
        
        // æ›´æ–°æ¸…é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
        function updateClearBtn() {
            const input = document.getElementById('solutionSearch');
            const btn = document.getElementById('clearSearchBtn');
            if (input.value.trim()) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }
        
        // åˆ‡æ¢æ’åºæ–¹å‘
        function toggleSortOrder() {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
            updateSortOrderUI();
            renderNotes();
        }
        
        // æ›´æ–°æ’åºæŒ‰é’® UI
        function updateSortOrderUI() {
            const icon = document.getElementById('sortOrderIcon');
            const btn = document.getElementById('sortOrderBtn');
            if (state.sortOrder === 'asc') {
                icon.textContent = 'â†‘';
                btn.title = 'å½“å‰ï¼šä»å°åˆ°å¤§ï¼Œç‚¹å‡»åˆ‡æ¢';
            } else {
                icon.textContent = 'â†“';
                btn.title = 'å½“å‰ï¼šä»å¤§åˆ°å°ï¼Œç‚¹å‡»åˆ‡æ¢';
            }
        }
        
        // åˆ‡æ¢æ”¶è—çŠ¶æ€
        function toggleFavorite(adv, planKey) {
            const stateKey = `${state.currentCharacter}:${adv}:${planKey}`;
            state.favorites[stateKey] = !state.favorites[stateKey];
            if (!state.favorites[stateKey]) delete state.favorites[stateKey]; // æ¸…ç† false å€¼
            saveFavorites();
            renderNotes();
        }
        
        // æœ€å°åŒ–æ–¹æ¡ˆï¼ˆç§»åˆ°å¤‡é€‰åˆ—è¡¨ï¼‰
        function minimizePlan(adv, planKey) {
            const stateKey = `${state.currentCharacter}:${adv}:${planKey}`;
            state.minimized[stateKey] = true;
            saveMinimized();
            renderNotes();
        }
        
        // æœ€å¤§åŒ–æ–¹æ¡ˆï¼ˆä»å¤‡é€‰ç§»åˆ°ä¸»æ˜¾ç¤ºï¼‰
        function maximizePlan(adv, planKey) {
            const stateKey = `${state.currentCharacter}:${adv}:${planKey}`;
            delete state.minimized[stateKey];
            saveMinimized();
            renderNotes();
        }
        
        // æ£€æŸ¥æ–¹æ¡ˆæ˜¯å¦è¢«æœ€å°åŒ–
        function isPlanMinimized(adv, planKey) {
            return state.minimized[`${state.currentCharacter}:${adv}:${planKey}`] === true;
        }
        
        // æ£€æŸ¥æ–¹æ¡ˆæ˜¯å¦è¢«æ”¶è—
        function isPlanFavorite(adv, planKey) {
            return state.favorites[`${state.currentCharacter}:${adv}:${planKey}`] === true;
        }
        
        // åˆ‡æ¢æœ‰åˆ©å¸§å±•å¼€/æ”¶èµ·
        function toggleAdvExpand(adv) {
            if (state.expandedAdv === adv) {
                state.expandedAdv = null;  // æ”¶èµ·
            } else {
                state.expandedAdv = adv;   // å±•å¼€
            }
            renderNotes();
        }
        
        function renderNotes() {
            const container = document.getElementById('noteListContainer');
            const searchInput = document.getElementById('solutionSearch');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            if (state.moveLibrary.length === 0) {
                container.innerHTML = `
                    <div class="trend-card p-8 text-center">
                        <div class="text-zinc-600 text-lg mb-2">ğŸ“­ æš‚æ—  ${state.currentCharacter} çš„å¸§æ•°æ®</div>
                        <div class="text-zinc-700 text-sm">è¯·å‰å¾€ æ•°æ® é¡µç­¾å¯¼å…¥æ•°æ®</div>
                    </div>
                `;
                return;
            }

            // ========== æŒ‰ adv åˆ†ç»„ï¼Œåˆå¹¶ç›¸åŒå¸§æ•°çš„ context ==========
            const advGroups = {};
            state.notes.forEach((note, idx) => {
                if (!advGroups[note.adv]) {
                    advGroups[note.adv] = { adv: note.adv, contexts: [], indices: [] };
                }
                advGroups[note.adv].contexts.push(note.context);
                advGroups[note.adv].indices.push(idx);
            });
            
            // æŒ‰ adv æ’åºï¼ˆæ ¹æ®æ’åºæ–¹å‘ï¼‰
            let sortedGroups = Object.values(advGroups).sort((a, b) => {
                return state.sortOrder === 'asc' ? a.adv - b.adv : b.adv - a.adv;
            });
            
            // ========== æœç´¢è¿‡æ»¤ ==========
            if (searchTerm) {
                sortedGroups = sortedGroups.filter(group => {
                    // åŒ¹é…å¸§æ•°
                    if (String(group.adv).includes(searchTerm)) return true;
                    // åŒ¹é…ä»»æ„ context
                    if (group.contexts.some(ctx => ctx.toLowerCase().includes(searchTerm))) return true;
                    return false;
                });
            }
            
            // æ— åŒ¹é…ç»“æœ
            if (sortedGroups.length === 0) {
                // åŒºåˆ†æ— æ•°æ®å’Œæœç´¢æ— ç»“æœ
                const isEmptyNotes = state.notes.length === 0;
                container.innerHTML = isEmptyNotes ? `
                    <div class="trend-card p-8 text-center">
                        <div class="text-zinc-600 text-lg mb-2">ğŸ“‹ æš‚æ—  Scenario</div>
                        <div class="text-zinc-700 text-sm">ç‚¹å‡» + æ–°å¢åœºæ™¯ æ·»åŠ æœ‰åˆ©å¸§æƒ…å¢ƒ</div>
                    </div>
                ` : `
                    <div class="trend-card p-8 text-center">
                        <div class="text-zinc-600 text-lg mb-2">ğŸ” æœªæ‰¾åˆ°åŒ¹é…çš„ Scenario</div>
                        <div class="text-zinc-700 text-sm">å°è¯•å…¶ä»–æœç´¢è¯ï¼Œæˆ–æ¸…ç©ºæœç´¢æ¡†æŸ¥çœ‹å…¨éƒ¨</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = sortedGroups.map((group, cardIndex) => {
                const allPlans = calculateBestPlan(group.adv);
                
                // åˆ†ç¦»æŠ•æŠ€æ–¹æ¡ˆå’Œæ™®é€šæ–¹æ¡ˆ
                const throwPlans = allPlans.filter(p => p.isThrow && p.remain >= 4 && p.remain <= 5);
                const normalPlans = allPlans.filter(p => !p.isThrow && p.finalBlock > 0);
                
                // å®‰å…¨è·³åˆ¤æ–­
                const safeJumpFramesForPanel = getSafeJumpFrames(state.currentCharacter);
                let safeJumpBadgeHtml = '';
                let safeJumpCompactHtml = '';
                
                if (group.adv === safeJumpFramesForPanel) {
                    safeJumpBadgeHtml = `<div class="safe-jump-badge mt-2" title="å®‰å…¨è·³å‹åˆ¶ï¼Œé˜²5å¸§åŠä»¥ä¸Šå‡¹æ‹›">
                        <span class="safe-jump-badge-inner safe-jump-true">ğŸ¦˜ å®‰å…¨è·³</span>
                    </div>`;
                    safeJumpCompactHtml = `<span class="safe-jump-badge-inner safe-jump-true text-[10px] ml-2">ğŸ¦˜ å®‰å…¨è·³</span>`;
                } else if (group.adv === safeJumpFramesForPanel - 1) {
                    safeJumpBadgeHtml = `<div class="safe-jump-badge mt-2" title="ä¼ªå®‰å…¨è·³å‹åˆ¶ï¼Œé˜²6å¸§åŠä»¥ä¸Šå‡¹æ‹›">
                        <span class="safe-jump-badge-inner safe-jump-pseudo">ğŸ¦˜ ä¼ªå®‰å…¨è·³</span>
                    </div>`;
                    safeJumpCompactHtml = `<span class="safe-jump-badge-inner safe-jump-pseudo text-[10px] ml-2">ğŸ¦˜ ä¼ªå®‰å…¨è·³</span>`;
                }
                
                // åˆ¤æ–­æ˜¯å¦å±•å¼€
                const isExpanded = state.expandedAdv === group.adv;
                
                // ========== ç´§å‡‘åˆ—è¡¨è§†å›¾ ==========
                if (!isExpanded) {
                    // è·å–æœ€ä½³æ–¹æ¡ˆçš„ç®€è¦æè¿°
                    let bestPlanDesc = '';
                    if (normalPlans.length > 0) {
                        const best = normalPlans[0];
                        if (best.isDirect) {
                            bestPlanDesc = `ç›´æ¥ ${best.meatyMove.name}`;
                        } else if (best.killMove) {
                            bestPlanDesc = best.killMove2 
                                ? `${best.killMove.name} â†’ ${best.killMove2.name} â†’ ${best.meatyMove.name}`
                                : `${best.killMove.name} â†’ ${best.meatyMove.name}`;
                        }
                    } else if (throwPlans.length > 0) {
                        bestPlanDesc = 'æŠ•æŠ€æ–¹æ¡ˆ';
                    } else {
                        bestPlanDesc = 'æ— æœ‰åˆ©æ–¹æ¡ˆ';
                    }
                    
                    // ç´§å‡‘çš„ context æ˜¾ç¤º
                    const compactContexts = group.contexts.slice(0, 2).map(ctx => 
                        `<span class="text-xs px-2 py-0.5 bg-zinc-700/50 text-zinc-300">${escapeHtml(ctx)}</span>`
                    ).join('');
                    const moreContexts = group.contexts.length > 2 ? `<span class="text-xs text-zinc-500">+${group.contexts.length - 2}</span>` : '';
                    
                    return `
                        <div class="trend-card py-3 px-4 cursor-pointer hover:bg-opacity-80 transition-all" onclick="toggleAdvExpand(${group.adv})" style="animation-delay: ${cardIndex * 0.02}s">
                            <div class="flex items-center gap-4 flex-wrap">
                                <span class="impact-text text-2xl font-black min-w-[70px]" style="color: var(--theme-secondary);">+${group.adv}F</span>
                                ${safeJumpCompactHtml}
                                <span class="text-zinc-500">â†’</span>
                                <span class="text-white font-bold">${bestPlanDesc}</span>
                                <div class="flex gap-1 ml-auto items-center">
                                    ${compactContexts}
                                    ${moreContexts}
                                    <span class="text-zinc-600 text-xs ml-2">â–¼</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // ========== å±•å¼€çš„è¯¦ç»†è§†å›¾ ==========
                // æ¸²æŸ“å·¦ä¾§æœ‰åˆ©å¸§ä¿¡æ¯åŒº
                const contextsHtml = group.indices.map((idx, i) => {
                    const ctx = group.contexts[i];
                    const note = state.notes[idx];
                    const isPreset = !note.isUserAdded;
                    const deleteTitle = isPreset ? "æ­¤ä¸ºé¢„è®¾åœºæ™¯ï¼Œåˆ é™¤åå¯é€šè¿‡é‡ç½®æ¢å¤" : "åˆ é™¤æ­¤ç”¨æˆ·åœºæ™¯";
                    const contextClass = isPreset ? "context-tag-preset" : "context-tag";
                    return `<div class="flex items-center gap-2 group/ctx">
                        <div class="text-sm font-black uppercase tracking-wide px-2 py-1 border-l-2 flex-1 ${contextClass}">${escapeHtml(ctx)}</div>
                        <button onclick="event.stopPropagation(); removeNote(${idx})" class="text-zinc-600 hover:text-red-500 text-base sm:text-sm p-2 sm:p-1 sm:opacity-0 sm:group-hover/ctx:opacity-100 transition-all" title="${deleteTitle}">âœ•</button>
                    </div>`;
                }).join('');
                
                const leftPanel = `
                    <div class="flex flex-col min-w-[160px] items-start lg:border-r border-zinc-800 pr-6">
                        <div class="impact-text text-4xl sm:text-5xl leading-none frame-number" style="color: var(--theme-secondary);">+${group.adv}F</div>
                        ${safeJumpBadgeHtml}
                        <div class="flex flex-col gap-1 mt-3">
                            ${contextsHtml}
                        </div>
                    </div>
                `;
                
                // æ— ä»»ä½•å¯ç”¨æ–¹æ¡ˆ
                if (normalPlans.length === 0 && throwPlans.length === 0) {
                    return `
                        <div class="trend-card">
                            <div onclick="toggleAdvExpand(${group.adv})" class="px-5 py-3 cursor-pointer text-zinc-300 hover:text-white text-sm font-bold transition-colors select-none flex items-center gap-2 border-b" style="border-color: var(--theme-card-border);">
                                <span class="text-zinc-500 text-xs">â–¼</span>
                                æ”¶èµ· +${group.adv}F è¯¦ç»†æ–¹æ¡ˆ
                            </div>
                            <div class="p-6 flex flex-col lg:flex-row items-center gap-6">
                                ${leftPanel}
                                <div class="flex-1 text-zinc-600 font-bold italic">æœªæ‰¾åˆ°æœ‰åˆ©å‹åˆ¶æ–¹æ¡ˆ</div>
                            </div>
                        </div>
                    `;
                }

                const mainKeys = new Set();  // ä¸»æ˜¾ç¤ºåŒºçš„æ–¹æ¡ˆ
                const planReasons = new Map();  // è®°å½•æ¯ä¸ªæ–¹æ¡ˆçš„æ¨èç†ç”±
                let mainHtml = '';
                
                // æ£€æŸ¥æ–¹æ¡ˆæ˜¯å¦è¢«æœ€å°åŒ–
                const isMinimized = (plan) => isPlanMinimized(group.adv, getPlanKey(plan));
                
                // è¿‡æ»¤æ‰è¢«æœ€å°åŒ–çš„æ–¹æ¡ˆ
                const availableNormal = normalPlans.filter(p => !isMinimized(p));
                const availableThrow = throwPlans.filter(p => !isMinimized(p));
                
                // æ·»åŠ æ–¹æ¡ˆåˆ°ä¸»æ˜¾ç¤ºåŒºï¼ˆè‡ªåŠ¨å»é‡ï¼Œè®°å½•æ¨èç†ç”±ï¼‰
                const addMainPlan = (plan, label = '', reason = '') => {
                    if (!plan) return false;
                    const key = getPlanKey(plan);
                    
                    // å¦‚æœå·²å­˜åœ¨ï¼Œè¿½åŠ ç†ç”±
                    if (mainKeys.has(key)) {
                        if (reason && !planReasons.get(key).includes(reason)) {
                            planReasons.get(key).push(reason);
                        }
                        return false;
                    }
                    
                    mainKeys.add(key);
                    planReasons.set(key, reason ? [reason] : []);
                    return true;
                };

                // ========== 0. å¡å¸§è¾¾æˆå®‰å…¨è·³çš„æ–¹æ¡ˆ ==========
                // æ³¨æ„ï¼šåœºæ™¯çº§åˆ«çš„å®‰å…¨è·³åˆ¤æ–­å·²åœ¨ leftPanel å¤„ç†
                // è¿™é‡Œåªå¤„ç†é€šè¿‡å¡å¸§è¾¾åˆ°å®‰å…¨è·³å¸§æ•°çš„æ–¹æ¡ˆ
                const safeJumpFrames = getSafeJumpFrames(state.currentCharacter);
                
                // æ‰¾å¡å¸§åèƒ½è¾¾åˆ°å®‰å…¨è·³çš„æ–¹æ¡ˆï¼ˆæ’é™¤ç›´æ¥å‹åˆ¶ï¼Œå› ä¸ºé‚£æ˜¯åœºæ™¯çº§åˆ«çš„å®‰å…¨è·³ï¼‰
                const safeJumpPlans = availableNormal.filter(p => !p.isDirect && p.remain === safeJumpFrames);
                if (safeJumpPlans.length > 0) {
                    const bestSafeJump = [...safeJumpPlans].sort((a, b) => {
                        if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                        return b.finalHit - a.finalHit;
                    })[0];
                    addMainPlan(bestSafeJump, 'å®‰å…¨è·³', 'safe_jump');
                }
                
                // å¦‚æœæ²¡æœ‰å®‰å…¨è·³æ–¹æ¡ˆï¼Œæ‰¾ä¼ªå®‰å…¨è·³æ–¹æ¡ˆ
                if (safeJumpPlans.length === 0) {
                    const pseudoSafeJumpPlans = availableNormal.filter(p => !p.isDirect && p.remain === safeJumpFrames - 1);
                    if (pseudoSafeJumpPlans.length > 0) {
                        const bestPseudoSafeJump = [...pseudoSafeJumpPlans].sort((a, b) => {
                            if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                            return b.finalHit - a.finalHit;
                        })[0];
                        addMainPlan(bestPseudoSafeJump, 'ä¼ªå®‰å…¨è·³', 'pseudo_safe_jump');
                    }
                }

                // ========== 1. finalBlock æœ€é«˜çš„æ–¹æ¡ˆ ==========
                if (availableNormal.length > 0) {
                    const bestBlockPlan = [...availableNormal].sort((a, b) => {
                        const aFav = isPlanFavorite(group.adv, getPlanKey(a)) ? 1 : 0;
                        const bFav = isPlanFavorite(group.adv, getPlanKey(b)) ? 1 : 0;
                        if (bFav !== aFav) return bFav - aFav;
                        if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                        return b.finalHit - a.finalHit;
                    })[0];
                    addMainPlan(bestBlockPlan, '', 'best_block');
                }

                // ========== 2. finalHit æœ€é«˜çš„æ–¹æ¡ˆ ==========
                if (availableNormal.length > 0) {
                    const bestHitPlan = [...availableNormal].sort((a, b) => {
                        const aFav = isPlanFavorite(group.adv, getPlanKey(a)) ? 1 : 0;
                        const bFav = isPlanFavorite(group.adv, getPlanKey(b)) ? 1 : 0;
                        if (bFav !== aFav) return bFav - aFav;
                        if (b.finalHit !== a.finalHit) return b.finalHit - a.finalHit;
                        return b.finalBlock - a.finalBlock;
                    })[0];
                    addMainPlan(bestHitPlan, '', 'best_hit');
                }

                // ========== 3. ä¸­/å¼±æ”»å‡»ä¸­ finalBlock æœ€ä¼˜ ==========
                const nonHeavyPlans = availableNormal.filter(p => {
                    const strength = getPlanStrength(p);
                    return strength === 'medium' || strength === 'light' || strength === 'other';
                });
                if (nonHeavyPlans.length > 0) {
                    const bestNonHeavyBlock = [...nonHeavyPlans].sort((a, b) => {
                        const aFav = isPlanFavorite(group.adv, getPlanKey(a)) ? 1 : 0;
                        const bFav = isPlanFavorite(group.adv, getPlanKey(b)) ? 1 : 0;
                        if (bFav !== aFav) return bFav - aFav;
                        if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                        return b.finalHit - a.finalHit;
                    })[0];
                    addMainPlan(bestNonHeavyBlock, '', 'best_nonheavy_block');
                }

                // ========== 4. ä¸­/å¼±æ”»å‡»ä¸­ finalHit æœ€ä¼˜ ==========
                if (nonHeavyPlans.length > 0) {
                    const bestNonHeavyHit = [...nonHeavyPlans].sort((a, b) => {
                        const aFav = isPlanFavorite(group.adv, getPlanKey(a)) ? 1 : 0;
                        const bFav = isPlanFavorite(group.adv, getPlanKey(b)) ? 1 : 0;
                        if (bFav !== aFav) return bFav - aFav;
                        if (b.finalHit !== a.finalHit) return b.finalHit - a.finalHit;
                        return b.finalBlock - a.finalBlock;
                    })[0];
                    addMainPlan(bestNonHeavyHit, '', 'best_nonheavy_hit');
                }

                // ========== 5. å·å¸§æœ€å¤šçš„æ–¹æ¡ˆ ==========
                if (availableNormal.length > 0) {
                    const bestStolenPlan = [...availableNormal].sort((a, b) => {
                        const aFav = isPlanFavorite(group.adv, getPlanKey(a)) ? 1 : 0;
                        const bFav = isPlanFavorite(group.adv, getPlanKey(b)) ? 1 : 0;
                        if (bFav !== aFav) return bFav - aFav;
                        if (b.stolen !== a.stolen) return b.stolen - a.stolen;
                        if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                        return b.finalHit - a.finalHit;
                    })[0];
                    addMainPlan(bestStolenPlan, '', 'most_stolen');
                }

                // ========== 6. æŠ•æŠ€æ–¹æ¡ˆ ==========
                let hasShownThrow = false;
                if (availableThrow.length > 0) {
                    // æŠ•æŠ€æ–¹æ¡ˆæŒ‰æ”¶è—ä¼˜å…ˆï¼Œç›´æ¥ä¼˜å…ˆï¼Œç„¶åæŒ‰ remain è¶Šå°è¶Šä¼˜å…ˆ
                    const sortedThrow = [...availableThrow].sort((a, b) => {
                        const aFav = isPlanFavorite(group.adv, getPlanKey(a)) ? 1 : 0;
                        const bFav = isPlanFavorite(group.adv, getPlanKey(b)) ? 1 : 0;
                        if (bFav !== aFav) return bFav - aFav;
                        if (b.isDirect !== a.isDirect) return (b.isDirect ? 1 : 0) - (a.isDirect ? 1 : 0);
                        return a.remain - b.remain;
                    });
                    
                    const bestThrow = sortedThrow[0];
                    if (addMainPlan(bestThrow, '', 'throw')) {
                        hasShownThrow = true;
                    }
                }

                // ========== 6'. é›¶å¸§æ‰“æŠ•æ‹©æ–¹æ¡ˆï¼šå½“æ²¡æœ‰æ­£æ”¶ç›Šçš„æ™®é€šæ–¹æ¡ˆåœ¨ä¸»æ˜¾ç¤ºåŒºï¼Œä½†æœ‰æŠ•æŠ€æ—¶ï¼Œæ˜¾ç¤º Block=0 çš„æ–¹æ¡ˆå½¢æˆæ‰“æŠ•æ‹© ==========
                const hasNormalMainPlan = normalPlans.some(p => mainKeys.has(getPlanKey(p)));
                if (!hasNormalMainPlan && hasShownThrow) {
                    // ä» allPlans ä¸­æ‰¾å‡ºæ‰€æœ‰ finalBlock === 0 çš„éæŠ•æŠ€æ–¹æ¡ˆä¸”æœªè¢«æœ€å°åŒ–çš„
                    const zeroBlockPlans = allPlans.filter(p => !p.isThrow && p.finalBlock === 0 && !isMinimized(p));
                    if (zeroBlockPlans.length > 0) {
                        // æŒ‰æ”»å‡»ç­‰çº§æ’åºï¼šé‡ > ä¸­ > è½»
                        const strengthOrder = { heavy: 0, medium: 1, light: 2, other: 3 };
                        const sortedZeroPlans = [...zeroBlockPlans].sort((a, b) => {
                            const aStrength = strengthOrder[getPlanStrength(a)] ?? 3;
                            const bStrength = strengthOrder[getPlanStrength(b)] ?? 3;
                            if (aStrength !== bStrength) return aStrength - bStrength;
                            // åŒç­‰çº§æŒ‰ finalHit æ’åº
                            return b.finalHit - a.finalHit;
                        });
                        
                        // æ˜¾ç¤ºæ‰€æœ‰ 0 å¸§æ–¹æ¡ˆï¼ˆæ‰“æŠ•æ‹©é…åˆï¼‰
                        sortedZeroPlans.forEach(plan => {
                            addMainPlan(plan, 'æ‰“æŠ•æ‹©', 'mixup');
                        });
                    }
                }
                
                // è·å–å½“å‰è§’è‰²çš„æ‰€æœ‰è§„åˆ™
                const rules = getAllRulesForCharacter(state.currentCharacter);
                
                // ========== 7. ç”¨æˆ·å€¾å‘å‹åˆ¶è§„åˆ™ ==========
                // æŸ¥æ‰¾ä½¿ç”¨äº†å€¾å‘æ‹›å¼çš„æ–¹æ¡ˆï¼Œä»å¤‡é€‰æå‡åˆ°æ¨è
                const preferRules = rules.filter(r => r.type === 'prefer');
                preferRules.forEach(rule => {
                    const preferMoveName = rule.moveName.toUpperCase();
                    // åœ¨å¤‡é€‰ä¸­æŸ¥æ‰¾ä½¿ç”¨è¯¥æ‹›å¼ä½œä¸ºå‹åˆ¶çš„æ–¹æ¡ˆï¼ˆæ»¡è¶³å·å¸§â‰¥1ä¸”finalBlockâ‰¥1ï¼‰
                    const preferPlans = normalPlans.filter(p => 
                        !mainKeys.has(getPlanKey(p)) &&
                        !isMinimized(p) &&
                        p.meatyMove && 
                        p.meatyMove.name.toUpperCase() === preferMoveName &&
                        p.stolen >= 1 &&
                        p.finalBlock >= 1
                    );
                    
                    // å¦‚æœæ‰¾åˆ°ï¼Œæ·»åŠ æœ€ä¼˜çš„å‡ ä¸ª
                    if (preferPlans.length > 0) {
                        const sorted = [...preferPlans].sort((a, b) => {
                            if (b.finalBlock !== a.finalBlock) return b.finalBlock - a.finalBlock;
                            return b.finalHit - a.finalHit;
                        });
                        // æœ€å¤šæ·»åŠ å‰2ä¸ªæœ€ä¼˜æ–¹æ¡ˆ
                        sorted.slice(0, 2).forEach(plan => {
                            addMainPlan(plan, '', `prefer:${rule.moveName}`);
                        });
                    }
                });
                
                // ========== 8. ç”¨æˆ·æ”¶è—æ–¹æ¡ˆ ==========
                // æŸ¥æ‰¾è¢«æ”¶è—ä½†è¿˜æ²¡åœ¨æ¨èåŒºçš„æ–¹æ¡ˆ
                allPlans.forEach(plan => {
                    if (!mainKeys.has(getPlanKey(plan)) && 
                        !isMinimized(plan) && 
                        isPlanFavorite(group.adv, getPlanKey(plan))) {
                        // éæŠ•æŠ€æ–¹æ¡ˆéœ€è¦æ»¡è¶³å·å¸§â‰¥1ä¸”finalBlockâ‰¥1
                        if (plan.isThrow || (plan.stolen >= 1 && plan.finalBlock >= 1)) {
                            addMainPlan(plan, '', 'favorite');
                        }
                    }
                });
                
                // ========== æœ€ç»ˆæ¸²æŸ“ï¼šæŒ‰è®°å½•çš„ç†ç”±æ¸²æŸ“æ‰€æœ‰æ–¹æ¡ˆ ==========
                mainHtml = '';
                mainKeys.forEach(key => {
                    // ä» allPlans ä¸­æ‰¾å›æ–¹æ¡ˆå¯¹è±¡
                    const plan = allPlans.find(p => getPlanKey(p) === key);
                    if (plan) {
                        const reasons = planReasons.get(key) || [];
                        // ç¡®å®šæ ‡ç­¾ä¼˜å…ˆçº§ï¼šå®‰å…¨è·³ > ä¼ªå®‰å…¨è·³ > æ‰“æŠ•æ‹©
                        let label = '';
                        if (reasons.includes('safe_jump')) {
                            label = 'å®‰å…¨è·³';
                        } else if (reasons.includes('pseudo_safe_jump')) {
                            label = 'ä¼ªå®‰å…¨è·³';
                        } else if (reasons.includes('mixup')) {
                            label = 'æ‰“æŠ•æ‹©';
                        }
                        mainHtml += renderMainPlan(plan, label, group.adv, reasons);
                    }
                });

                // ========== 4. å¤‡é€‰æ–¹æ¡ˆæŠ˜å åŒº ==========
                // å¤‡é€‰æ–¹æ¡ˆ = ä¸åœ¨ä¸»æ˜¾ç¤ºåŒºçš„æ‰€æœ‰æ–¹æ¡ˆï¼ˆåŒ…æ‹¬è¢«æœ€å°åŒ–çš„ï¼‰
                // ç­›é€‰æ¡ä»¶ï¼šå·å¸§â‰¥1 ä¸” finalBlockâ‰¥1
                const altNormalPlans = normalPlans.filter(p => 
                    !mainKeys.has(getPlanKey(p)) && 
                    p.stolen >= 1 && 
                    p.finalBlock >= 1
                );
                const altThrowPlans = throwPlans.filter(p => !mainKeys.has(getPlanKey(p)));
                
                let altHtml = '';
                
                // æ™®é€šå¤‡é€‰æ–¹æ¡ˆ
                if (altNormalPlans.length > 0) {
                    const altContent = altNormalPlans.map(plan => renderAltPlan(plan, group.adv)).join('');
                    altHtml += `
                        <details class="mt-2">
                            <summary class="text-[11px] text-zinc-600 cursor-pointer hover:text-zinc-400 transition-colors py-2">
                                â–¶ ${altNormalPlans.length} ä¸ªå¤‡é€‰æ‰“å‡»æ–¹æ¡ˆ (Block > 0)
                            </summary>
                            <div class="mt-2 bg-zinc-900/50 p-3 border border-zinc-800">
                                ${altContent}
                            </div>
                        </details>
                    `;
                }
                
                // æŠ•æŠ€å¤‡é€‰æ–¹æ¡ˆ
                if (altThrowPlans.length > 0) {
                    const altThrowContent = altThrowPlans.map(plan => renderAltThrowPlan(plan, group.adv)).join('');
                    
                    altHtml += `
                        <details class="mt-2">
                            <summary class="text-[11px] text-zinc-600 cursor-pointer hover:text-zinc-400 transition-colors py-2">
                                â–¶ ${altThrowPlans.length} ä¸ªå…¶ä»–æŠ•æŠ€è·¯çº¿
                            </summary>
                            <div class="mt-2 bg-zinc-900/50 p-3 border border-zinc-800">
                                ${altThrowContent}
                            </div>
                        </details>
                    `;
                }

                return `
                    <div class="trend-card">
                        <div onclick="toggleAdvExpand(${group.adv})" class="px-5 py-3 cursor-pointer text-zinc-300 hover:text-white text-sm font-bold transition-colors select-none flex items-center gap-2 border-b" style="border-color: var(--theme-card-border);">
                            <span class="text-zinc-500 text-xs">â–¼</span>
                            æ”¶èµ· +${group.adv}F è¯¦ç»†æ–¹æ¡ˆ
                        </div>
                        <div class="p-6">
                            <div class="flex flex-col lg:flex-row gap-6">
                                ${leftPanel}
                                <div class="flex-1">
                                    ${mainHtml}
                                    ${altHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderLibrary() {
            const body = document.getElementById('moveTableBody');
            
            if (state.moveLibrary.length === 0) {
                body.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-8 text-center text-zinc-600">
                            æš‚æ— æ•°æ®ï¼Œè¯·ç²˜è´´ JSON å¯¼å…¥ ${state.currentCharacter} çš„å¸§æ•°æ®
                        </td>
                    </tr>
                `;
                return;
            }
            
            // è·å–åŸå§‹é¢„è®¾æ•°æ®çš„æ‹›å¼åç§°åˆ—è¡¨ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å¯åˆ é™¤
            const defaultMoves = getDefaultMoves(state.currentCharacter);
            const defaultMoveNames = new Set(defaultMoves.map(m => m.name.toUpperCase()));

            body.innerHTML = state.moveLibrary.map((m, idx) => {
                // åˆ¤æ–­æ˜¯å¦ä¸ºç”¨æˆ·æ·»åŠ çš„æ‹›å¼ï¼ˆå¯åˆ é™¤ï¼‰
                const isUserAdded = m.isUserAdded || !defaultMoveNames.has(m.name.toUpperCase());
                const deleteBtn = isUserAdded 
                    ? `<button onclick="removeMove(${idx})" class="text-zinc-700 hover:text-red-500 transition-colors p-2 -m-1 text-base" title="åˆ é™¤">âœ•</button>`
                    : '';
                const userBadge = isUserAdded 
                    ? '<span class="ml-1 text-[9px] px-1 py-0.5 bg-emerald-900/50 text-emerald-400 rounded">NEW</span>' 
                    : '';
                
                // ç‰¹æ®Šå¤„ç† Dash æ‹›å¼
                if (m.isDash) {
                    return `
                        <tr class="border-b border-zinc-900 hover:bg-zinc-800/20">
                            <td class="p-4 text-zinc-300">${m.name}${userBadge} <span class="text-[10px] text-zinc-500">DASH</span></td>
                            <td class="p-4 text-center font-mono text-zinc-500" colspan="3">${m.dashFrames || 19}F æ€»å¸§æ•° (ä»…å¡å¸§ç”¨)</td>
                            <td class="p-4 text-center font-mono text-zinc-600">-</td>
                            <td class="p-4 text-center font-mono text-zinc-600">-</td>
                            <td class="p-4 text-right">${deleteBtn}</td>
                        </tr>
                    `;
                }
                
                // ç‰¹æ®Šå¤„ç†æŠ•æŠ€
                if (m.isThrow) {
                    return `
                        <tr class="border-b border-zinc-900 hover:bg-zinc-800/20">
                            <td class="p-4 text-zinc-300">${m.name}${userBadge} <span class="text-[10px] text-zinc-500">THROW</span></td>
                            <td class="p-4 text-center font-mono text-zinc-500">${m.startup}</td>
                            <td class="p-4 text-center font-mono text-zinc-500">${m.active}</td>
                            <td class="p-4 text-center font-mono text-zinc-500">${m.recovery}</td>
                            <td class="p-4 text-center font-mono text-zinc-600">-</td>
                            <td class="p-4 text-center font-mono text-zinc-600">-</td>
                            <td class="p-4 text-right">${deleteBtn}</td>
                        </tr>
                    `;
                }
                
                // æ™®é€šæ‹›å¼
                const knockdownBadge = m.isKnockdown 
                    ? '<span class="ml-1 text-[9px] px-1 py-0.5 bg-red-900/50 text-red-400 rounded">KD</span>' 
                    : '';
                    
                return `
                    <tr class="border-b border-zinc-900 hover:bg-zinc-800/20">
                        <td class="p-4 text-zinc-300">${m.name}${userBadge}${knockdownBadge}</td>
                        <td class="p-4 text-center font-mono text-zinc-500">${m.startup}</td>
                        <td class="p-4 text-center font-mono text-zinc-500">${m.active}</td>
                        <td class="p-4 text-center font-mono text-zinc-500">${m.recovery}</td>
                        <td class="p-4 text-center font-mono ${getFrameColorClass(m.hit)}">${m.hit >= 0 ? '+' : ''}${m.hit}</td>
                        <td class="p-4 text-center font-mono ${getFrameColorClass(m.block)}">${m.block >= 0 ? '+' : ''}${m.block}</td>
                        <td class="p-4 text-right">${deleteBtn}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderAll() {
            renderThrowMixups();
            renderNotes();
            renderLibrary();
            renderRules();
        }
        
        // ==================== æ‰“æŠ•æ‹©æ–¹æ¡ˆè®¡ç®— ====================
        // å½“å‰é€‰ä¸­çš„æ‰“æŠ•æ‹©Tab
        let currentMixupTab = 5;
        
        // è·å–åœºæ™¯çš„ contextï¼ˆç”¨æˆ·è‡ªå®šä¹‰æˆ–é¢„è®¾ï¼‰
        function getContextForAdv(adv) {
            const contexts = [];
            state.notes.forEach(note => {
                if (note.adv === adv && note.context) {
                    contexts.push(note.context);
                }
            });
            return contexts;
        }
        
        // è®¡ç®—æ‰€æœ‰èƒ½å¡å‡ºç‰¹å®šå‰©ä½™å¸§çš„åœºæ™¯
        function calculateThrowMixups() {
            const results = {
                2: [], 3: [], 4: [], 5: []
            };
            
            if (state.moveLibrary.length === 0) return results;
            
            // éå† 6-50 å¸§
            for (let adv = 6; adv <= 50; adv++) {
                const plans = calculateBestPlan(adv);
                
                // æ”¶é›†æ¯ä¸ªå‰©ä½™å¸§æ•°çš„æ‰€æœ‰å¡å¸§æ–¹å¼
                const remainPlans = { 2: [], 3: [], 4: [], 5: [] };
                
                for (const plan of plans) {
                    // è·³è¿‡æŠ•æŠ€æ–¹æ¡ˆï¼ˆæŠ•æŠ€ä¸é€‚åˆæ‰“æŠ•æ‹©ï¼‰
                    if (plan.isThrow) continue;
                    // è·³è¿‡ç›´æ¥å‹åˆ¶ï¼ˆä¸éœ€è¦å¡å¸§ï¼‰
                    if (plan.isDirect) continue;
                    
                    const remain = plan.remain;
                    
                    // åªå…³æ³¨ 2-5 å¸§çš„å‰©ä½™
                    if (remain < 2 || remain > 5) continue;
                    
                    // ç”Ÿæˆå¡å¸§æè¿°
                    let killDesc;
                    if (plan.killMove2) {
                        // å¦‚æœå¯äº¤æ¢ï¼Œæ’åºåç”¨ "+" è¿æ¥ï¼ˆé¿å…é‡å¤ï¼‰
                        if (plan.isCommutative) {
                            const names = [plan.killMove.name, plan.killMove2.name].sort();
                            killDesc = names.join(' + ');
                        } else {
                            // ä¸å¯äº¤æ¢ï¼Œä¿ç•™é¡ºåºç”¨ "â†’"
                            killDesc = `${plan.killMove.name} â†’ ${plan.killMove2.name}`;
                        }
                    } else {
                        killDesc = plan.killMove.name;
                    }
                    
                    // é¿å…åŒä¸€å¸§æ•°çš„é‡å¤å¡å¸§æ–¹å¼
                    if (!remainPlans[remain].includes(killDesc)) {
                        remainPlans[remain].push(killDesc);
                    }
                }
                
                // ä¸ºæ¯ä¸ªæœ‰æœ‰æ•ˆæ–¹æ¡ˆçš„å‰©ä½™å¸§åˆ›å»ºæ¡ç›®
                for (let r = 2; r <= 5; r++) {
                    if (remainPlans[r].length > 0) {
                        const contexts = getContextForAdv(adv);
                        results[r].push({
                            adv,
                            remain: r,
                            killDescs: remainPlans[r],  // æ”¹ä¸ºæ•°ç»„ï¼ŒåŒ…å«æ‰€æœ‰å¡å¸§æ–¹å¼
                            contexts
                        });
                    }
                }
            }
            
            // æŒ‰æœ‰åˆ©å¸§æ’åº
            for (let i = 2; i <= 5; i++) {
                results[i].sort((a, b) => a.adv - b.adv);
            }
            
            return results;
        }
        
        // åˆ‡æ¢æ‰“æŠ•æ‹©Tab
        function switchMixupTab(frame) {
            currentMixupTab = frame;
            
            // æ›´æ–° tab æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.mixup-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`mixupTab${frame}`).classList.add('active');
            
            // é‡æ–°æ¸²æŸ“å†…å®¹
            renderThrowMixupContent();
        }
        
        // æ¸²æŸ“æ‰“æŠ•æ‹©æ–¹æ¡ˆ
        function renderThrowMixups() {
            renderThrowMixupContent();
        }
        
        // æ¸²æŸ“æ‰“æŠ•æ‹©å†…å®¹
        function renderThrowMixupContent() {
            const container = document.getElementById('throwMixupContent');
            
            if (state.moveLibrary.length === 0) {
                container.innerHTML = '<p class="text-zinc-600 text-sm">ğŸ“­ æš‚æ— è§’è‰²æ•°æ®</p>';
                return;
            }
            
            const mixups = calculateThrowMixups();
            const items = mixups[currentMixupTab];
            
            // åˆ†ç¦»æœ‰åœºæ™¯å’Œæ— åœºæ™¯çš„æ–¹æ¡ˆ
            const withContext = items.filter(item => item.contexts.length > 0);
            const withoutContext = items.filter(item => item.contexts.length === 0);
            
            let mainHtml = '';
            
            if (withContext.length > 0) {
                mainHtml = withContext.map(item => {
                    const contextHtml = `<div class="mt-2 flex flex-wrap gap-1.5">
                        ${item.contexts.map(ctx => `<span class="text-xs px-2.5 py-1 bg-zinc-700/80 text-zinc-200 font-bold">${escapeHtml(ctx)}</span>`).join('')}
                    </div>`;
                    
                    // å¤šç§å¡å¸§æ–¹å¼ç”¨"æˆ–"è¿æ¥ï¼Œä¸¤æ­¥å¡å¸§æ ¹æ®ç¬¦å·åˆ¤æ–­
                    const killDescsHtml = item.killDescs.map(desc => {
                        if (desc.includes(' + ')) {
                            // å¯äº¤æ¢çš„ä¸¤æ­¥å¡å¸§ç”¨ "+" è¿æ¥
                            const parts = desc.split(' + ');
                            return parts.map(p => `<span class="text-white font-black text-lg">${p}</span>`).join('<span class="text-yellow-500 mx-1 font-bold">+</span>');
                        } else if (desc.includes(' â†’ ')) {
                            // æœ‰é¡ºåºé™åˆ¶çš„ä¸¤æ­¥å¡å¸§ç”¨ "â†’" è¿æ¥
                            const parts = desc.split(' â†’ ');
                            return parts.map(p => `<span class="text-white font-black text-lg">${p}</span>`).join('<span class="text-zinc-600 mx-1 font-bold">â†’</span>');
                        }
                        return `<span class="text-white font-black text-lg">${desc}</span>`;
                    }).join('<span class="text-zinc-500 mx-2">æˆ–</span>');
                    
                    return `
                        <div class="py-3 px-4 bg-zinc-900/50 border-l-4 mb-3" style="border-left-color: var(--theme-primary);">
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="impact-text text-2xl font-black" style="color: var(--theme-secondary);">+${item.adv}F</span>
                                ${killDescsHtml}
                            </div>
                            ${contextHtml}
                        </div>
                    `;
                }).join('');
            }
            
            // æ— åœºæ™¯æ–¹æ¡ˆçš„æŠ˜å åŒºåŸŸ
            let noContextHtml = '';
            if (withoutContext.length > 0) {
                const noContextItems = withoutContext.map(item => {
                    const killDescsHtml = item.killDescs.map(desc => {
                        if (desc.includes(' + ')) {
                            // å¯äº¤æ¢çš„ä¸¤æ­¥å¡å¸§ç”¨ "+"
                            const parts = desc.split(' + ');
                            return parts.map(p => `<span class="text-zinc-300 font-bold">${p}</span>`).join('<span class="text-yellow-600 mx-1 font-bold">+</span>');
                        } else if (desc.includes(' â†’ ')) {
                            // æœ‰é¡ºåºé™åˆ¶çš„ä¸¤æ­¥å¡å¸§ç”¨ "â†’"
                            const parts = desc.split(' â†’ ');
                            return parts.map(p => `<span class="text-zinc-300 font-bold">${p}</span>`).join('<span class="text-zinc-600 mx-1 font-bold">â†’</span>');
                        }
                        return `<span class="text-zinc-300 font-bold">${desc}</span>`;
                    }).join('<span class="text-zinc-500 mx-1">æˆ–</span>');
                    
                    return `
                        <div class="py-1.5 px-3 bg-black/20 border-l-2 mb-1" style="border-left-color: var(--theme-card-border);">
                            <div class="flex items-center gap-2 flex-wrap text-sm">
                                <span class="font-bold" style="color: var(--theme-secondary);">+${item.adv}F</span>
                                ${killDescsHtml}
                            </div>
                        </div>
                    `;
                }).join('');
                
                noContextHtml = `
                    <details class="mt-4">
                        <summary class="cursor-pointer text-zinc-500 hover:text-zinc-300 text-xs font-bold transition-colors select-none py-2">
                            â–¶ æ— å¯¹åº”åœºæ™¯çš„æ‰“æŠ•æ‹©å¡å¸§æ–¹æ¡ˆ (${withoutContext.length})
                        </summary>
                        <div class="pt-2">
                            ${noContextItems}
                        </div>
                    </details>
                `;
            }
            
            // é¡¶éƒ¨æç¤º
            const countText = withContext.length > 0 
                ? `âœ“ æ‰¾åˆ° ${withContext.length} ä¸ªæ–¹æ¡ˆå¯å¡å‡º ${currentMixupTab}F`
                : `æš‚æ— å¯¹åº”åœºæ™¯çš„ ${currentMixupTab}F æ‰“æŠ•æ‹©å¡å¸§æ–¹æ¡ˆ`;
            
            container.innerHTML = `
                <div class="text-sm mb-4" style="color: var(--theme-primary);">${countText}</div>
                ${mainHtml}
                ${noContextHtml}
            `;
        }

        // ==================== äº‹ä»¶å¤„ç† ====================
        function openCharacterModal() { 
            initCharacterGrid();
            document.getElementById('charModal').classList.remove('hidden'); 
        }
        
        function closeCharModal() { 
            document.getElementById('charModal').classList.add('hidden'); 
        }
        
        function openHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
        }
        
        function closeHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
        }
        
        function openRuleModal() {
            // å¡«å……æ‹›å¼ä¸‹æ‹‰åˆ—è¡¨
            populateMoveSelects();
            // é»˜è®¤æ˜¾ç¤ºç¦ç”¨å‹åˆ¶tab
            switchRuleTab('disable');
            document.getElementById('ruleModal').classList.remove('hidden');
        }
        
        function closeRuleModal() {
            document.getElementById('ruleModal').classList.add('hidden');
            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥
            document.getElementById('inputDisableMove').value = '';
            document.getElementById('inputDisableUsage').value = 'kill';
            document.getElementById('inputDisableDesc').value = '';
            document.getElementById('inputComboMove1').value = '';
            document.getElementById('inputComboMove2').value = '';
            document.getElementById('inputComboDesc').value = '';
            document.getElementById('inputPreferMove').value = '';
            document.getElementById('inputPreferDesc').value = '';
        }
        
        // åˆ‡æ¢è§„åˆ™ç±»å‹ tab
        function switchRuleTab(type) {
            // æ›´æ–° tab æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.rule-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`ruleTab-${type}`).classList.add('active');
            
            // æ˜¾ç¤º/éšè—è¡¨å•
            document.getElementById('ruleForm-disable').classList.toggle('hidden', type !== 'disable');
            document.getElementById('ruleForm-combo').classList.toggle('hidden', type !== 'combo');
            document.getElementById('ruleForm-prefer').classList.toggle('hidden', type !== 'prefer');
        }
        
        // å¡«å……æ‹›å¼ä¸‹æ‹‰åˆ—è¡¨
        function populateMoveSelects() {
            const moves = state.moveLibrary.map(m => m.name).sort();
            
            // ç¦ç”¨å‹åˆ¶è§„åˆ™çš„ä¸‹æ‹‰
            const disableSelect = document.getElementById('inputDisableMove');
            disableSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ‹›å¼ --</option>' +
                moves.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // ç¦ç”¨ç»„åˆè§„åˆ™çš„ä¸¤ä¸ªä¸‹æ‹‰
            const comboSelect1 = document.getElementById('inputComboMove1');
            const comboSelect2 = document.getElementById('inputComboMove2');
            const optionsHtml = '<option value="">-- è¯·é€‰æ‹©æ‹›å¼ --</option>' +
                moves.map(m => `<option value="${m}">${m}</option>`).join('');
            comboSelect1.innerHTML = optionsHtml;
            comboSelect2.innerHTML = optionsHtml;
            
            // å€¾å‘å‹åˆ¶è§„åˆ™çš„ä¸‹æ‹‰
            const preferSelect = document.getElementById('inputPreferMove');
            preferSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ‹›å¼ --</option>' +
                moves.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        
        // ä¿å­˜ç¦ç”¨å‹åˆ¶è§„åˆ™
        function saveDisableRule() {
            const moveName = document.getElementById('inputDisableMove').value.trim();
            const usage = document.getElementById('inputDisableUsage').value;
            const description = document.getElementById('inputDisableDesc').value.trim();
            
            if (!moveName) {
                showToast('è¯·é€‰æ‹©æ‹›å¼', 'error');
                return;
            }
            
            const usageLabels = {
                'kill': 'ç”¨äºå¡å¸§',
                'meaty_after_kill': 'ç”¨äºå¡å¸§åå‹åˆ¶',
                'meaty_direct': 'ç”¨äºç›´æ¥å‹åˆ¶'
            };
            
            const newRule = {
                id: `rule_${Date.now()}`,
                type: 'disable',
                moveName,
                usage,
                description: description || `ç¦æ­¢ ${moveName} ${usageLabels[usage]}`
            };
            
            // æ·»åŠ åˆ°è§’è‰²ä¸“å±è§„åˆ™
            if (!state.characterRules[state.currentCharacter]) {
                state.characterRules[state.currentCharacter] = [];
            }
            state.characterRules[state.currentCharacter].push(newRule);
            
            // ä¿å­˜åˆ° localStorage
            saveCharacterRules(state.currentCharacter, state.characterRules[state.currentCharacter]);
            
            closeRuleModal();
            renderRules();
            renderNotes(); // é‡æ–°è®¡ç®—æ–¹æ¡ˆ
            showToast('è§„åˆ™å·²æ·»åŠ ');
        }
        
        // ä¿å­˜ç¦ç”¨ç»„åˆè§„åˆ™
        function saveComboRule() {
            const move1 = document.getElementById('inputComboMove1').value.trim();
            const move2 = document.getElementById('inputComboMove2').value.trim();
            const description = document.getElementById('inputComboDesc').value.trim();
            
            if (!move1 || !move2) {
                showToast('è¯·é€‰æ‹©ä¸¤ä¸ªæ‹›å¼', 'error');
                return;
            }
            
            if (move1 === move2) {
                showToast('è¯·é€‰æ‹©ä¸åŒçš„æ‹›å¼', 'error');
                return;
            }
            
            const newRule = {
                id: `rule_${Date.now()}`,
                type: 'combo',
                move1,
                move2,
                description: description || `${move1} Ã— ${move2} ç¦æ­¢è¿ç»­ä½¿ç”¨`
            };
            
            // æ·»åŠ åˆ°è§’è‰²ä¸“å±è§„åˆ™
            if (!state.characterRules[state.currentCharacter]) {
                state.characterRules[state.currentCharacter] = [];
            }
            state.characterRules[state.currentCharacter].push(newRule);
            
            // ä¿å­˜åˆ° localStorage
            saveCharacterRules(state.currentCharacter, state.characterRules[state.currentCharacter]);
            
            closeRuleModal();
            renderRules();
            renderNotes(); // é‡æ–°è®¡ç®—æ–¹æ¡ˆ
            showToast('è§„åˆ™å·²æ·»åŠ ');
        }
        
        // ä¿å­˜å€¾å‘å‹åˆ¶è§„åˆ™
        function savePreferRule() {
            const moveName = document.getElementById('inputPreferMove').value.trim();
            const description = document.getElementById('inputPreferDesc').value.trim();
            
            if (!moveName) {
                showToast('è¯·é€‰æ‹©æ‹›å¼', 'error');
                return;
            }
            
            const newRule = {
                id: `rule_${Date.now()}`,
                type: 'prefer',
                moveName,
                description: description || `å€¾å‘ä½¿ç”¨ ${moveName} è¿›è¡Œå‹åˆ¶`
            };
            
            // æ·»åŠ åˆ°è§’è‰²ä¸“å±è§„åˆ™
            if (!state.characterRules[state.currentCharacter]) {
                state.characterRules[state.currentCharacter] = [];
            }
            state.characterRules[state.currentCharacter].push(newRule);
            
            // ä¿å­˜åˆ° localStorage
            saveCharacterRules(state.currentCharacter, state.characterRules[state.currentCharacter]);
            
            closeRuleModal();
            renderRules();
            renderNotes(); // é‡æ–°è®¡ç®—æ–¹æ¡ˆ
            showToast('è§„åˆ™å·²æ·»åŠ ');
        }
        
        function saveRule() {
            const pattern1 = document.getElementById('inputPattern1').value.trim().toUpperCase();
            const pattern2 = document.getElementById('inputPattern2').value.trim().toUpperCase();
            const description = document.getElementById('inputRuleDesc').value.trim();
            
            if (!pattern1 || !pattern2) {
                alert('è¯·å¡«å†™ä¸¤ä¸ªæ‹›å¼å…³é”®è¯');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰è§„åˆ™é‡å¤ï¼ˆåŒ…æ‹¬å…¨å±€è§„åˆ™ï¼‰
            const allRules = getAllRulesForCharacter(state.currentCharacter);
            const isDuplicate = allRules.some(r => {
                const p1 = r.pattern1.toUpperCase();
                const p2 = r.pattern2.toUpperCase();
                // åŒå‘åŒ¹é…æ£€æŸ¥
                return (p1 === pattern1 && p2 === pattern2) || (p1 === pattern2 && p2 === pattern1);
            });
            
            if (isDuplicate) {
                alert('è¯¥è§„åˆ™å·²å­˜åœ¨');
                return;
            }
            
            const newRule = {
                id: `rule_${Date.now()}`,
                pattern1,
                pattern2,
                description: description || `${pattern1} Ã— ${pattern2} ç¦æ­¢ç»„åˆ`
            };
            
            // æ·»åŠ åˆ°è§’è‰²ä¸“å±è§„åˆ™
            if (!state.characterRules[state.currentCharacter]) {
                state.characterRules[state.currentCharacter] = [];
            }
            state.characterRules[state.currentCharacter].push(newRule);
            
            // ä¿å­˜åˆ° localStorage
            saveCharacterRules(state.currentCharacter, state.characterRules[state.currentCharacter]);
            
            closeRuleModal();
            renderRules();
            renderNotes(); // é‡æ–°è®¡ç®—æ–¹æ¡ˆ
            showToast('è§„åˆ™å·²æ·»åŠ ');
        }
        
        function removeRule(ruleId) {
            const rules = state.characterRules[state.currentCharacter] || [];
            const idx = rules.findIndex(r => r.id === ruleId);
            if (idx !== -1) {
                rules.splice(idx, 1);
                saveCharacterRules(state.currentCharacter, rules);
                renderRules();
                renderNotes();
            }
        }
        
        // ==================== æ–°å¢æ‹›å¼å¼¹çª— ====================
        let currentMoveType = 'normal';  // normal, throw, dash
        
        function openAddMoveModal() {
            currentMoveType = 'normal';
            updateMoveTypeUI();
            document.getElementById('addMoveModal').classList.remove('hidden');
            document.getElementById('inputMoveName').focus();
        }
        
        function closeAddMoveModal() {
            document.getElementById('addMoveModal').classList.add('hidden');
            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥
            document.getElementById('inputMoveName').value = '';
            document.getElementById('inputMoveStartup').value = '';
            document.getElementById('inputMoveActive').value = '';
            document.getElementById('inputMoveRecovery').value = '';
            document.getElementById('inputMoveHit').value = '';
            document.getElementById('inputMoveBlock').value = '';
            document.getElementById('inputMoveKnockdown').checked = false;
            document.getElementById('inputMoveDashFrames').value = '';
        }
        
        function setMoveType(type) {
            currentMoveType = type;
            updateMoveTypeUI();
        }
        
        function updateMoveTypeUI() {
            const normalBtn = document.getElementById('moveTypeNormal');
            const throwBtn = document.getElementById('moveTypeThrow');
            const dashBtn = document.getElementById('moveTypeDash');
            const frameFields = document.getElementById('moveFrameFields');
            const dashFields = document.getElementById('moveDashFields');
            const hitBlockFields = document.getElementById('moveHitBlockFields');
            const knockdownField = document.getElementById('moveKnockdownField');
            
            // é‡ç½®æŒ‰é’®æ ·å¼
            [normalBtn, throwBtn, dashBtn].forEach(btn => {
                btn.style.backgroundColor = '';
                btn.className = 'flex-1 py-2 text-xs font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white';
            });
            
            // è®¾ç½®é€‰ä¸­æŒ‰é’®æ ·å¼
            const selectedBtn = currentMoveType === 'normal' ? normalBtn : 
                               currentMoveType === 'throw' ? throwBtn : dashBtn;
            selectedBtn.style.backgroundColor = 'var(--theme-btn-primary)';
            selectedBtn.className = 'flex-1 py-2 text-xs font-bold transition-all text-white';
            
            // æ˜¾ç¤º/éšè—å­—æ®µ
            if (currentMoveType === 'dash') {
                frameFields.classList.add('hidden');
                dashFields.classList.remove('hidden');
            } else {
                frameFields.classList.remove('hidden');
                dashFields.classList.add('hidden');
                
                // æŠ•æŠ€éšè— Hit/Block å’Œ Knockdown é€‰é¡¹
                if (currentMoveType === 'throw') {
                    hitBlockFields.classList.add('hidden');
                    knockdownField.classList.add('hidden');
                } else {
                    hitBlockFields.classList.remove('hidden');
                    knockdownField.classList.remove('hidden');
                }
            }
        }
        
        function saveNewMove() {
            const name = document.getElementById('inputMoveName').value.trim().toUpperCase();
            
            if (!name) {
                alert('è¯·è¾“å…¥æ‹›å¼åç§°');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é‡å¤
            const exists = state.moveLibrary.some(m => m.name.toUpperCase() === name);
            if (exists) {
                alert('è¯¥æ‹›å¼å·²å­˜åœ¨');
                return;
            }
            
            let newMove;
            
            if (currentMoveType === 'dash') {
                const dashFrames = parseInt(document.getElementById('inputMoveDashFrames').value);
                if (!dashFrames || dashFrames <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ Dash å¸§æ•°');
                    return;
                }
                newMove = {
                    name,
                    isDash: true,
                    dashFrames,
                    isUserAdded: true  // æ ‡è®°ä¸ºç”¨æˆ·æ·»åŠ 
                };
            } else {
                const startup = parseInt(document.getElementById('inputMoveStartup').value);
                const active = document.getElementById('inputMoveActive').value.trim();
                const recovery = parseInt(document.getElementById('inputMoveRecovery').value);
                
                if (!startup || startup <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ Startup');
                    return;
                }
                if (!active) {
                    alert('è¯·è¾“å…¥ Active å¸§ï¼ˆå¦‚: 7-9 æˆ– 5-7,12-14ï¼‰');
                    return;
                }
                if (!recovery || recovery < 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ Recovery');
                    return;
                }
                
                // éªŒè¯ active æ ¼å¼
                const activeRegex = /^\d+(-\d+)?(,\d+(-\d+)?)*$/;
                if (!activeRegex.test(active)) {
                    alert('Active æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨å¦‚ 7-9 æˆ– 5-7,12-14 çš„æ ¼å¼');
                    return;
                }
                
                if (currentMoveType === 'throw') {
                    newMove = {
                        name,
                        startup,
                        active,
                        recovery,
                        isThrow: true,
                        isKnockdown: true,
                        isUserAdded: true
                    };
                } else {
                    const hit = parseInt(document.getElementById('inputMoveHit').value) || 0;
                    const block = parseInt(document.getElementById('inputMoveBlock').value) || 0;
                    const isKnockdown = document.getElementById('inputMoveKnockdown').checked;
                    
                    newMove = {
                        name,
                        startup,
                        active,
                        recovery,
                        hit,
                        block,
                        isKnockdown,
                        isUserAdded: true
                    };
                }
            }
            
            // æ·»åŠ åˆ°æ‹›å¼åº“
            state.moveLibrary.push(newMove);
            
            // æ›´æ–°ç¼“å­˜
            if (state.characterCache[state.currentCharacter]) {
                state.characterCache[state.currentCharacter].moves = [...state.moveLibrary];
            }
            
            // ä¿å­˜åˆ° localStorage
            saveMoves(state.currentCharacter, state.moveLibrary);
            
            closeAddMoveModal();
            renderAll();
            showToast(`å·²æ·»åŠ  ${name}`);
        }
        
        function renderRules() {
            const container = document.getElementById('rulesContainer');
            if (!container) return;
            
            const allRules = getAllRulesForCharacter(state.currentCharacter);
            
            if (allRules.length === 0) {
                container.innerHTML = '<div class="text-zinc-600 italic">æš‚æ— è§„åˆ™</div>';
                return;
            }
            
            container.innerHTML = allRules.map(rule => {
                const isGlobal = rule.isGlobal;
                const tagClass = isGlobal ? 'bg-zinc-700 text-zinc-400' : 'bg-cyan-900/50 text-cyan-400';
                const tagText = isGlobal ? 'å…¨å±€' : state.currentCharacter;
                const deleteBtn = isGlobal ? '' : `<button onclick="removeRule('${rule.id}')" class="text-zinc-600 hover:text-red-500 transition-colors p-2 -m-1 text-base" title="åˆ é™¤è§„åˆ™">âœ•</button>`;
                
                // æ ¹æ®è§„åˆ™ç±»å‹æ¸²æŸ“ä¸åŒçš„å†…å®¹
                let content = '';
                let typeLabel = '';
                let typeColor = '';
                
                if (rule.type === 'disable') {
                    // ç¦ç”¨å‹åˆ¶è§„åˆ™
                    const usageLabels = {
                        'kill': 'å¡å¸§',
                        'meaty_after_kill': 'å¡å¸§åå‹åˆ¶',
                        'meaty_direct': 'ç›´æ¥å‹åˆ¶'
                    };
                    typeLabel = 'ç¦ç”¨';
                    typeColor = 'text-red-400';
                    content = `
                        <span class="${typeColor} font-bold">${escapeHtml(rule.moveName)}</span>
                        <span class="text-zinc-600 mx-1">â†’</span>
                        <span class="text-zinc-400">ç¦æ­¢${usageLabels[rule.usage] || rule.usage}</span>
                    `;
                } else if (rule.type === 'combo') {
                    // ç¦ç”¨ç»„åˆè§„åˆ™
                    typeLabel = 'ç¦ç”¨';
                    typeColor = 'text-red-400';
                    content = `
                        <span class="${typeColor} font-mono">${escapeHtml(rule.move1)}</span>
                        <span class="text-zinc-600 mx-1">Ã—</span>
                        <span class="${typeColor} font-mono">${escapeHtml(rule.move2)}</span>
                    `;
                } else if (rule.type === 'prefer') {
                    // å€¾å‘å‹åˆ¶è§„åˆ™
                    typeLabel = 'å€¾å‘';
                    typeColor = 'text-green-400';
                    content = `
                        <span class="${typeColor} font-bold">${escapeHtml(rule.moveName)}</span>
                        <span class="text-zinc-400 ml-2">ä¼˜å…ˆæ¨èä¸ºå‹åˆ¶æ‹›å¼</span>
                    `;
                } else {
                    // æ—§çš„ pattern è§„åˆ™ï¼ˆå…¼å®¹ï¼‰
                    typeLabel = 'ç¦ç”¨';
                    typeColor = 'text-red-400';
                    content = `
                        <span class="text-zinc-300 font-mono">${escapeHtml(rule.pattern1)}</span>
                        <span class="text-zinc-600 mx-1">Ã—</span>
                        <span class="text-zinc-300 font-mono">${escapeHtml(rule.pattern2)}</span>
                    `;
                }
                
                return `
                    <div class="flex items-center justify-between py-1.5 px-2 bg-zinc-800/30 border-l-2 ${isGlobal ? 'border-zinc-600' : 'border-cyan-600'}">
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-[9px] px-1.5 py-0.5 ${tagClass} uppercase tracking-wide">${tagText}</span>
                            <span class="text-[9px] px-1.5 py-0.5 bg-zinc-700/50 ${typeColor} uppercase">${typeLabel}</span>
                            ${content}
                            ${rule.description ? `<span class="text-zinc-500 text-xs ml-2">â€” ${escapeHtml(rule.description)}</span>` : ''}
                        </div>
                        ${deleteBtn}
                    </div>
                `;
            }).join('');
        }
        
        // ==================== æœŸæœ›åç»­åŠŸèƒ½ ====================
        // å½“å‰æœŸæœ›æ¨¡å¼ï¼š'remain' æˆ– 'move'
        let expectMode = 'remain';
        // å½“å‰è®¡ç®—å‡ºçš„æœŸæœ›æ–¹æ¡ˆ
        let currentExpectPlan = null;
        
        function setExpectMode(mode) {
            expectMode = mode;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const remainBtn = document.getElementById('expectModeRemain');
            const moveBtn = document.getElementById('expectModeMove');
            const remainPanel = document.getElementById('expectRemainPanel');
            const movePanel = document.getElementById('expectMovePanel');
            
            if (mode === 'remain') {
                remainBtn.className = 'flex-1 py-3 text-sm font-bold transition-all modal-btn-active text-white';
                moveBtn.className = 'flex-1 py-3 text-sm font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white';
                remainPanel.classList.remove('hidden');
                movePanel.classList.add('hidden');
            } else {
                remainBtn.className = 'flex-1 py-3 text-sm font-bold transition-all bg-zinc-800 text-zinc-400 hover:text-white';
                moveBtn.className = 'flex-1 py-3 text-sm font-bold transition-all modal-btn-active text-white';
                remainPanel.classList.add('hidden');
                movePanel.classList.remove('hidden');
            }
            
            // æ¸…é™¤ä¹‹å‰çš„ç»“æœ
            currentExpectPlan = null;
            document.getElementById('expectResult').classList.add('hidden');
            
            // é‡æ–°è®¡ç®—
            calculateExpectPlan();
        }
        
        // è°ƒæ•´æœ‰åˆ©å¸§æ•°å€¼ï¼ˆ+/- æŒ‰é’®ï¼‰
        function adjustAdv(delta) {
            const input = document.getElementById('inputAdv');
            let currentVal = parseInt(input.value);
            
            // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œä» placeholder å€¼å¼€å§‹
            if (isNaN(currentVal) || input.value === '') {
                currentVal = 40; // placeholder é»˜è®¤å€¼
            }
            
            const newVal = currentVal + delta;
            
            // èŒƒå›´é™åˆ¶ï¼š1~99
            if (newVal < 1 || newVal > 99) {
                return; // è¶…å‡ºèŒƒå›´ï¼Œä¸æ‰§è¡Œ
            }
            
            input.value = newVal;
            updateExpectOptions();
        }
        
        // æ¸…ç†è¾“å…¥ï¼Œåªå…è®¸æ•°å­—ä¸”èŒƒå›´ 1~99
        function sanitizeAdvInput() {
            const input = document.getElementById('inputAdv');
            // ç§»é™¤éæ•°å­—å­—ç¬¦
            let val = input.value.replace(/[^0-9]/g, '');
            
            // é™åˆ¶æœ€å¤§ä¸¤ä½æ•°
            if (val.length > 2) {
                val = val.slice(0, 2);
            }
            
            // å¦‚æœè¾“å…¥çš„æ•°å­—è¶…è¿‡99ï¼Œæˆªæ–­ä¸º99
            if (parseInt(val) > 99) {
                val = '99';
            }
            
            // ç§»é™¤å‰å¯¼é›¶ï¼ˆä½†ä¿ç•™å•ç‹¬çš„ 0 ä»¥ä¾¿ç»§ç»­è¾“å…¥ï¼‰
            if (val.length > 1 && val.startsWith('0')) {
                val = val.replace(/^0+/, '');
            }
            
            input.value = val;
        }
        
        // æ›´æ–°æœŸæœ›é€‰é¡¹ï¼ˆå½“æœ‰åˆ©å¸§å˜åŒ–æ—¶ï¼‰
        function updateExpectOptions() {
            // æ›´æ–°æ‹›å¼ä¸‹æ‹‰æ¡†é€‰é¡¹
            const select = document.getElementById('inputExpectMove');
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const previousValue = select.value;
            
            select.innerHTML = '<option value="">-- é€‰æ‹©æ‹›å¼ --</option>';
            
            // åªæ˜¾ç¤ºæœ‰ active ä¸”ä¸æ˜¯ dash/throw çš„æ‹›å¼
            const availableMoves = state.moveLibrary.filter(m => m.active && !m.isDash && !m.isThrow);
            availableMoves.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.name;
                opt.textContent = `${m.name} (å‘ç”Ÿ ${m.startup}F, æŒç»­ ${m.active}F)`;
                select.appendChild(opt);
            });
            
            // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼ï¼ˆå¦‚æœè¯¥é€‰é¡¹ä»ç„¶å­˜åœ¨ï¼‰
            if (previousValue && availableMoves.some(m => m.name === previousValue)) {
                select.value = previousValue;
            }
            
            // é‡æ–°è®¡ç®—æœŸæœ›æ–¹æ¡ˆ
            calculateExpectPlan();
        }
        
        // è®¡ç®—æœŸæœ›æ–¹æ¡ˆ
        function calculateExpectPlan() {
            const adv = parseInt(document.getElementById('inputAdv').value);
            const resultDiv = document.getElementById('expectResult');
            const resultContent = document.getElementById('expectResultContent');
            
            if (!adv || adv <= 0) {
                resultDiv.classList.add('hidden');
                currentExpectPlan = null;
                return;
            }
            
            let plan = null;
            
            if (expectMode === 'remain') {
                const targetRemain = parseInt(document.getElementById('inputExpectRemain').value);
                if (!targetRemain || targetRemain <= 0 || targetRemain >= adv) {
                    resultDiv.classList.add('hidden');
                    currentExpectPlan = null;
                    return;
                }
                plan = findFrameKillPlan(adv, targetRemain);
            } else {
                const moveName = document.getElementById('inputExpectMove').value;
                if (!moveName) {
                    resultDiv.classList.add('hidden');
                    currentExpectPlan = null;
                    return;
                }
                const move = state.moveLibrary.find(m => m.name === moveName);
                if (!move) {
                    resultDiv.classList.add('hidden');
                    currentExpectPlan = null;
                    return;
                }
                plan = findMoveKillPlan(adv, move);
            }
            
            currentExpectPlan = plan;
            resultDiv.classList.remove('hidden');
            
            if (plan) {
                resultContent.innerHTML = renderExpectPlanPreview(plan);
            } else {
                resultContent.innerHTML = `<div class="text-red-400 font-bold">âŒ æ²¡æœ‰å¯¹åº”å¡å¸§è§£å†³æ–¹æ¡ˆ</div>
                    <div class="text-zinc-500 text-xs mt-1">æ— è®ºä¸€æ­¥è¿˜æ˜¯ä¸¤æ­¥å¡å¸§éƒ½æ— æ³•è¾¾æˆæ­¤ç›®æ ‡</div>`;
            }
        }
        
        // æŸ¥æ‰¾èƒ½å¡å¸§åˆ°æŒ‡å®šå‰©ä½™å¸§æ•°çš„æ–¹æ¡ˆ
        function findFrameKillPlan(adv, targetRemain) {
            const neededKill = adv - targetRemain;
            if (neededKill <= 0) return null;
            
            const rules = getAllRulesForCharacter(state.currentCharacter);
            
            // æ–¹æ¡ˆAï¼šä¸€æ­¥å¡å¸§
            for (const killMove of state.moveLibrary) {
                // æ£€æŸ¥æ˜¯å¦è¢«ç¦ç”¨ç”¨äºå¡å¸§
                if (isMoveDisabled(killMove, 'kill', rules)) continue;
                
                let killTotal;
                if (killMove.isDash) {
                    killTotal = killMove.dashFrames || 19;
                } else if (killMove.active) {
                    const lastActive = getLastActiveFrame(killMove.active);
                    killTotal = lastActive + killMove.recovery;
                } else {
                    continue;
                }
                
                if (killTotal === neededKill) {
                    return {
                        type: 'single',
                        killMove,
                        killTotal,
                        remain: targetRemain,
                        displayMeaty: `+${targetRemain}F`
                    };
                }
            }
            
            // æ–¹æ¡ˆCï¼šä¸¤æ­¥å¡å¸§
            for (const killMove1 of state.moveLibrary) {
                // æ£€æŸ¥ç¬¬ä¸€æ­¥æ˜¯å¦è¢«ç¦ç”¨ç”¨äºå¡å¸§
                if (isMoveDisabled(killMove1, 'kill', rules)) continue;
                
                let killTotal1;
                if (killMove1.isDash) {
                    killTotal1 = killMove1.dashFrames || 19;
                } else if (killMove1.active) {
                    const lastActive1 = getLastActiveFrame(killMove1.active);
                    killTotal1 = lastActive1 + killMove1.recovery;
                } else {
                    continue;
                }
                
                if (killTotal1 >= neededKill) continue;
                
                for (const killMove2 of state.moveLibrary) {
                    // æ£€æŸ¥ç¬¬äºŒæ­¥æ˜¯å¦è¢«ç¦ç”¨ç”¨äºå¡å¸§
                    if (isMoveDisabled(killMove2, 'kill', rules)) continue;
                    
                    // æ£€æŸ¥è§„åˆ™ç¦æ­¢ç»„åˆ
                    if (isComboForbidden(killMove1, killMove2, rules)) continue;
                    
                    let killTotal2;
                    if (killMove2.isDash) {
                        killTotal2 = killMove2.dashFrames || 19;
                    } else if (killMove2.active) {
                        const lastActive2 = getLastActiveFrame(killMove2.active);
                        killTotal2 = lastActive2 + killMove2.recovery;
                    } else {
                        continue;
                    }
                    
                    if (killTotal1 + killTotal2 === neededKill) {
                        return {
                            type: 'double',
                            killMove: killMove1,
                            killMove2,
                            killTotal: killTotal1,
                            killTotal2,
                            remain: targetRemain,
                            displayMeaty: `+${targetRemain}F`
                        };
                    }
                }
            }
            
            return null;
        }
        
        // æŸ¥æ‰¾èƒ½ç”¨æŒ‡å®šæ‹›å¼å‹åˆ¶ï¼ˆå·è‡³å°‘1å¸§ï¼‰çš„å¡å¸§æ–¹æ¡ˆ
        function findMoveKillPlan(adv, targetMove) {
            const rules = getAllRulesForCharacter(state.currentCharacter);
            const bestPlans = [];
            
            // æ£€æŸ¥å„ç§å¯èƒ½çš„å‰©ä½™å¸§æ•°ï¼Œä»å¤§åˆ°å°ï¼ˆå·å¸§è¶Šå¤šè¶Šå¥½ï¼‰
            const ranges = parseActiveRanges(targetMove.active);
            const firstActiveStart = ranges[0].start;
            const lastActiveEnd = ranges[ranges.length - 1].end;
            
            // è®¡ç®—å¯èƒ½çš„å‰©ä½™å¸§èŒƒå›´ï¼šè®© remain+1 è½åœ¨ active èŒƒå›´å†…
            // remain+1 >= firstActiveStart ä¸” remain+1 <= lastActiveEnd
            // å³ remain >= firstActiveStart - 1 ä¸” remain <= lastActiveEnd - 1
            // ä½†æˆ‘ä»¬è¦å·è‡³å°‘1å¸§ï¼Œå³ remain+1 > firstActiveStartï¼Œå³ remain >= firstActiveStart
            for (let remain = firstActiveStart; remain <= lastActiveEnd - 1; remain++) {
                const targetFrame = remain + 1;
                const hitInfo = checkActiveHit(targetMove.active, targetFrame);
                
                if (hitInfo && hitInfo.stolen >= 1) {
                    const neededKill = adv - remain;
                    
                    // ç‰¹æ®Šæƒ…å†µï¼šä¸éœ€è¦å¡å¸§ï¼Œç›´æ¥å‹åˆ¶
                    if (neededKill === 0) {
                        // æ£€æŸ¥æ˜¯å¦è¢«ç¦ç”¨äºç›´æ¥å‹åˆ¶
                        if (!isMoveDisabled(targetMove, 'meaty_direct', rules)) {
                            bestPlans.push({
                                type: 'direct',
                                remain: remain,
                                meatyMove: targetMove,
                                stolen: hitInfo.stolen,
                                finalHit: (targetMove.hit || 0) + hitInfo.stolen,
                                finalBlock: (targetMove.block || 0) + hitInfo.stolen,
                                displayMeaty: targetMove.name
                            });
                        }
                        continue;
                    }
                    
                    // å°è¯•æ‰¾åˆ°å¡å¸§æ–¹æ¡ˆ
                    const plan = findFrameKillPlan(adv, remain);
                    if (plan) {
                        // æ£€æŸ¥targetMoveæ˜¯å¦è¢«ç¦ç”¨äºå¡å¸§åå‹åˆ¶
                        if (!isMoveDisabled(targetMove, 'meaty_after_kill', rules)) {
                            bestPlans.push({
                                ...plan,
                                meatyMove: targetMove,
                                stolen: hitInfo.stolen,
                                finalHit: (targetMove.hit || 0) + hitInfo.stolen,
                                finalBlock: (targetMove.block || 0) + hitInfo.stolen,
                                displayMeaty: targetMove.name
                            });
                        }
                    }
                }
            }
            
            // æŒ‰å·å¸§æ•°é™åºæ’åºï¼Œè¿”å›æœ€ä¼˜æ–¹æ¡ˆ
            if (bestPlans.length === 0) return null;
            bestPlans.sort((a, b) => b.stolen - a.stolen);
            return bestPlans[0];
        }
        
        // æ¸²æŸ“æœŸæœ›æ–¹æ¡ˆé¢„è§ˆ
        function renderExpectPlanPreview(plan) {
            let stepsHtml = '';
            
            if (plan.type === 'direct') {
                stepsHtml = `<div class="text-center">
                    <span class="text-zinc-500">ç›´æ¥</span>
                    <span class="text-cyan-400 font-black text-xl ml-2">${plan.displayMeaty}</span>
                </div>`;
            } else if (plan.type === 'single') {
                stepsHtml = `<div class="flex items-center justify-center gap-2">
                    <span class="text-white font-bold">${plan.killMove.name}</span>
                    <span class="text-zinc-600">(-${plan.killTotal}F)</span>
                    <span class="text-zinc-500">â†’</span>
                    <span class="text-cyan-400 font-black text-xl">${plan.displayMeaty}</span>
                </div>`;
            } else if (plan.type === 'double') {
                const remain1 = plan.killTotal;  // ç¬¬ä¸€æ­¥åçš„å‰©ä½™
                stepsHtml = `<div class="flex items-center justify-center gap-2 flex-wrap">
                    <span class="text-white font-bold">${plan.killMove.name}</span>
                    <span class="text-zinc-600">(-${plan.killTotal}F)</span>
                    <span class="text-zinc-500">â†’</span>
                    <span class="text-white font-bold">${plan.killMove2.name}</span>
                    <span class="text-zinc-600">(-${plan.killTotal2}F)</span>
                    <span class="text-zinc-500">â†’</span>
                    <span class="text-cyan-400 font-black text-xl">${plan.displayMeaty}</span>
                </div>`;
            }
            
            // å¦‚æœæœ‰æ‹›å¼ä¿¡æ¯ï¼Œæ˜¾ç¤ºå¸§æ•°ä¼˜åŠ¿
            let statsHtml = '';
            if (plan.meatyMove) {
                const stolenColorPreview = getStolenColorClass(plan.stolen);
                const hitColorPreview = getFrameColorClass(plan.finalHit);
                const blockColorPreview = getFrameColorClass(plan.finalBlock);
                statsHtml = `<div class="mt-2 pt-2 border-t border-zinc-700 text-center text-xs">
                    <span class="text-zinc-500">å·</span><span class="${stolenColorPreview} font-bold ml-1">${plan.stolen}F</span>
                    <span class="text-zinc-500 ml-3">H</span><span class="${hitColorPreview} font-bold ml-1">${plan.finalHit >= 0 ? '+' : ''}${plan.finalHit}</span>
                    <span class="text-zinc-500 ml-3">B</span><span class="${blockColorPreview} font-bold ml-1">${plan.finalBlock >= 0 ? '+' : ''}${plan.finalBlock}</span>
                </div>`;
            }
            
            return `<div class="text-green-400 font-bold mb-2">âœ“ æ‰¾åˆ°å¯è¡Œæ–¹æ¡ˆ</div>${stepsHtml}${statsHtml}`;
        }
        
        function openNoteModal() { 
            // é‡ç½®æœŸæœ›åç»­çŠ¶æ€
            expectMode = 'remain';
            currentExpectPlan = null;
            document.getElementById('expectDetails').removeAttribute('open');
            document.getElementById('inputExpectRemain').value = '5';
            document.getElementById('inputExpectMove').value = '';
            document.getElementById('expectResult').classList.add('hidden');
            setExpectMode('remain');
            
            // æ›´æ–°æ‹›å¼ä¸‹æ‹‰æ¡†
            updateExpectOptions();
            
            document.getElementById('noteModal').classList.remove('hidden'); 
            document.getElementById('inputAdv').focus();
        }
        
        function closeModal() { 
            document.getElementById('noteModal').classList.add('hidden');
            // æ¸…ç†çŠ¶æ€
            currentExpectPlan = null;
        }

        function switchTab(tab) {
            const viewNotes = document.getElementById('view-notes');
            const viewLibrary = document.getElementById('view-library');
            
            // ç§»é™¤ä¹‹å‰çš„åŠ¨ç”»ç±»
            viewNotes.classList.remove('view-transition');
            viewLibrary.classList.remove('view-transition');
            
            viewNotes.classList.toggle('hidden', tab !== 'notes');
            viewLibrary.classList.toggle('hidden', tab !== 'library');
            document.getElementById('tab-notes').classList.toggle('active', tab === 'notes');
            document.getElementById('tab-library').classList.toggle('active', tab === 'library');
            
            // æ·»åŠ å…¥åœºåŠ¨ç”»
            requestAnimationFrame(() => {
                if (tab === 'notes') viewNotes.classList.add('view-transition');
                else viewLibrary.classList.add('view-transition');
            });
            
            // æ›´æ–°æ»‘åŠ¨æŒ‡ç¤ºå™¨ä½ç½®
            updateTabIndicator(tab);
        }
        
        function updateTabIndicator(tab) {
            const indicator = document.getElementById('tabIndicator');
            const activeTab = document.getElementById(`tab-${tab}`);
            if (indicator && activeTab) {
                indicator.style.left = activeTab.offsetLeft + 'px';
                indicator.style.width = activeTab.offsetWidth + 'px';
            }
        }

        function saveNote() {
            const adv = parseInt(document.getElementById('inputAdv').value);
            const ctx = document.getElementById('inputContext').value.trim();
            
            if (!adv || adv < 1 || adv > 99) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æœ‰åˆ©å¸§æ•° (1~99)');
                return;
            }
            
            // åˆç†èŒƒå›´æ£€æŸ¥ï¼ˆè¶…è¿‡70å¸§çš„æœ‰åˆ©å¾ˆå°‘è§ï¼‰
            if (adv > 70) {
                if (!confirm(`+${adv}F æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æœ‰åˆ©å¸§æ•°ï¼Œç¡®å®šè¦æ·»åŠ å—ï¼Ÿ`)) {
                    return;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†æœŸæœ›åç»­åŠŸèƒ½
            const expectDetailsOpen = document.getElementById('expectDetails').hasAttribute('open');
            if (expectDetailsOpen) {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¾“å…¥äº†æœŸæœ›
                let hasExpectInput = false;
                if (expectMode === 'remain') {
                    hasExpectInput = !!document.getElementById('inputExpectRemain').value;
                } else {
                    hasExpectInput = !!document.getElementById('inputExpectMove').value;
                }
                
                // å¦‚æœç”¨æˆ·è¾“å…¥äº†æœŸæœ›ä½†æ²¡æœ‰å¯è¡Œæ–¹æ¡ˆï¼Œé˜»æ­¢æ·»åŠ 
                if (hasExpectInput && !currentExpectPlan) {
                    alert('æœŸæœ›åç»­æ²¡æœ‰å¯è¡Œçš„å¡å¸§æ–¹æ¡ˆï¼Œè¯·ä¿®æ”¹æœŸæœ›æˆ–æŠ˜å æœŸæœ›åç»­é€‰é¡¹åå†æ·»åŠ ');
                    return;
                }
            }
            
            state.notes.push({ adv, context: ctx || "è‡ªå®šä¹‰åœºæ™¯", isUserAdded: true });
            saveScenarios(state.currentCharacter, state.notes); // åªä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰çš„éƒ¨åˆ†
            document.getElementById('inputAdv').value = '';
            document.getElementById('inputContext').value = '';
            closeModal();
            renderNotes();
            showToast(`å·²æ·»åŠ  +${adv}F åœºæ™¯`);
        }

        function removeNote(idx) {
            const note = state.notes[idx];
            const isPreset = !note.isUserAdded;
            
            // å¦‚æœæ˜¯é¢„è®¾åœºæ™¯ï¼Œç»™å‡ºæç¤º
            if (isPreset) {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾åœºæ™¯ "${note.context}" å—ï¼Ÿ\n\næ­¤åœºæ™¯å¯é€šè¿‡"é‡ç½®"æŒ‰é’®æ¢å¤ã€‚`)) {
                    return;
                }
            }
            
            state.notes.splice(idx, 1);
            saveScenarios(state.currentCharacter, state.notes); // åªä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰çš„éƒ¨åˆ†
            renderNotes();
            
            const tipMsg = isPreset ? 'å·²éšè—é¢„è®¾åœºæ™¯ï¼ˆå¯é€šè¿‡é‡ç½®æ¢å¤ï¼‰' : 'å·²åˆ é™¤åœºæ™¯';
            showToast(tipMsg);
        }

        function resetToDefault() {
            const userCount = state.notes.filter(n => n.isUserAdded).length;
            const confirmMsg = userCount > 0 
                ? `é‡ç½® ${state.currentCharacter} çš„ Scenarios ä¸ºé¢„è®¾å€¼ï¼Ÿ\nï¼ˆå°†æ¸…é™¤ ${userCount} ä¸ªç”¨æˆ·è‡ªå®šä¹‰åœºæ™¯ï¼Œä¿ç•™æ‰€æœ‰é¢„è®¾åœºæ™¯ï¼‰`
                : `é‡ç½® ${state.currentCharacter} çš„ Scenarios ä¸ºé¢„è®¾å€¼ï¼Ÿ`;
            
            if (confirm(confirmMsg)) {
                state.notes = resetScenarios(state.currentCharacter);
                renderNotes();
                showToast('å·²é‡ç½®ä¸ºé¢„è®¾åœºæ™¯');
            }
        }
        
        function removeMove(idx) { 
            state.moveLibrary.splice(idx, 1);
            // åŒæ­¥æ›´æ–°ç¼“å­˜
            if (state.characterCache[state.currentCharacter]) {
                state.characterCache[state.currentCharacter].moves = [...state.moveLibrary];
            }
            // ä¿å­˜åˆ° localStorage
            saveMoves(state.currentCharacter, state.moveLibrary);
            renderAll(); 
        }

        function clearLibrary() {
            if (confirm(`ç¡®å®šæ¸…ç©º ${state.currentCharacter} çš„æ‰€æœ‰å¸§æ•°æ®ï¼Ÿ`)) {
                state.moveLibrary = [];
                if (state.characterCache[state.currentCharacter]) {
                    state.characterCache[state.currentCharacter].moves = [];
                }
                // æ¸…é™¤ localStorage ä¸­çš„ä¿å­˜
                clearSavedMoves(state.currentCharacter);
                renderAll();
            }
        }
        
        function resetMovesToDefault() {
            if (confirm(`é‡ç½® ${state.currentCharacter} çš„æ‹›å¼æ•°æ®ä¸ºé¢„è®¾å€¼ï¼Ÿ`)) {
                state.moveLibrary = resetMoves(state.currentCharacter);
                if (state.characterCache[state.currentCharacter]) {
                    state.characterCache[state.currentCharacter].moves = [...state.moveLibrary];
                }
                renderAll();
            }
        }

        function loadTemplate() {
            const template = `[
  {"name": "5MP", "startup": 6, "active": "6-9", "recovery": 15, "hit": 5, "block": 0},
  {"name": "5LP", "startup": 4, "active": "4-6", "recovery": 7, "hit": 4, "block": -1}
]`;
            document.getElementById('rawPaste').value = template;
            document.getElementById('rawPaste').focus();
        }

        function importJson() {
            const input = document.getElementById('rawPaste').value.trim();
            if (!input) {
                alert('è¯·å…ˆç²˜è´´ JSON æ•°æ®');
                return;
            }
            
            try {
                const data = JSON.parse(input);
                const newMoves = Array.isArray(data) ? data : [data];
                
                // éªŒè¯æ•°æ®æ ¼å¼
                for (const move of newMoves) {
                    if (!move.name || move.startup === undefined) {
                        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘ name æˆ– startup å­—æ®µ');
                    }
                }
                
                state.moveLibrary = [...state.moveLibrary, ...newMoves];
                
                // å»é‡ (åŸºäº name)
                const seen = new Set();
                state.moveLibrary = state.moveLibrary.filter(m => {
                    if (seen.has(m.name)) return false;
                    seen.add(m.name);
                    return true;
                });
                
                // æ›´æ–°ç¼“å­˜
                if (state.characterCache[state.currentCharacter]) {
                    state.characterCache[state.currentCharacter].moves = [...state.moveLibrary];
                }
                
                // ä¿å­˜åˆ° localStorage
                saveMoves(state.currentCharacter, state.moveLibrary);
                
                document.getElementById('rawPaste').value = '';
                renderAll();
                showToast(`å·²å¯¼å…¥ ${newMoves.length} ä¸ªæ‹›å¼`);
            } catch (e) {
                showToast('JSON æ ¼å¼é”™è¯¯', 'error');
                console.error('JSON è§£æé”™è¯¯:', e);
            }
        }

        // ==================== é”®ç›˜äº‹ä»¶ ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeCharModal();
                closeHelpModal();
                closeRuleModal();
                closeAddMoveModal();
            }
            // Enter é”®ä¿å­˜
            if (e.key === 'Enter') {
                if (!document.getElementById('noteModal').classList.contains('hidden')) {
                    saveNote();
                } else if (!document.getElementById('ruleModal').classList.contains('hidden')) {
                    saveRule();
                } else if (!document.getElementById('addMoveModal').classList.contains('hidden')) {
                    saveNewMove();
                }
            }
        });

        // ==================== åˆå§‹åŒ– ====================
        window.onload = function() {
            console.log('=== SF6 FRAME LAB åˆå§‹åŒ– ===');
            
            // è®¾ç½®ç¦ç”¨åœºæ™¯è¯´æ˜ç›‘å¬å™¨
            const usageSelect = document.getElementById('inputDisableUsage');
            const hintDiv = document.getElementById('disableUsageHint');
            
            if (usageSelect && hintDiv) {
                usageSelect.addEventListener('change', () => {
                    const hints = {
                        'kill': 'ç¦æ­¢æ­¤æ‹›å¼ç”¨äºæ¶ˆè€—æœ‰åˆ©å¸§',
                        'meaty_after_kill': 'ç¦æ­¢æ­¤æ‹›å¼åœ¨å¡å¸§åä½œä¸ºå‹åˆ¶æ‹›å¼',
                        'meaty_direct': 'ç¦æ­¢æ­¤æ‹›å¼ç›´æ¥å‹åˆ¶ï¼ˆä¸å¡å¸§ï¼‰'
                    };
                    hintDiv.textContent = hints[usageSelect.value] || '';
                });
            }
            
            // 0. ä» localStorage æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„è§’è‰²
            let savedCharacter = loadCurrentCharacter();
            // ç¡®ä¿ä¿å­˜çš„è§’è‰²æœ‰æ•°æ®ï¼Œå¦åˆ™å›é€€åˆ°RYU
            if (!CONFIG.CHARACTERS_WITH_DATA.includes(savedCharacter)) {
                savedCharacter = 'RYU';
            }
            state.currentCharacter = savedCharacter;
            document.getElementById('currentCharIcon').textContent = getCharIcon(savedCharacter);
            
            // åº”ç”¨è§’è‰²ä¸»é¢˜
            applyTheme(savedCharacter);
            console.log(`[è§’è‰²] æ¢å¤ä¸Šæ¬¡é€‰æ‹©: ${savedCharacter}`);
            
            console.log(`CHARACTER_DATA å·²åŠ è½½è§’è‰²:`, Object.keys(CHARACTER_DATA));
            
            // 1. åŠ è½½è§’è‰²æ•°æ® (ä¼˜å…ˆ localStorageï¼Œå…¶æ¬¡å…¨å±€å˜é‡ CHARACTER_DATA)
            const loadSuccess = loadCharacterData(state.currentCharacter);
            console.log(`æ•°æ®åŠ è½½${loadSuccess ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
            
            // 2. åŠ è½½scenarios: é¢„è®¾ + ç”¨æˆ·è‡ªå®šä¹‰
            state.notes = loadAllScenarios(state.currentCharacter);
            console.log(`[Scenarios] åŠ è½½å®Œæˆ: é¢„è®¾ ${getDefaultScenarios(state.currentCharacter).length} ä¸ª + ç”¨æˆ·è‡ªå®šä¹‰ ${loadScenariosFromStorage(state.currentCharacter).length} ä¸ª`);
            
            // 3. åŠ è½½è§’è‰²ä¸“å±è§„åˆ™
            state.characterRules[state.currentCharacter] = loadCharacterRules(state.currentCharacter);
            console.log(`[Rules] åŠ è½½ ${state.characterRules[state.currentCharacter].length} ä¸ªè§’è‰²è§„åˆ™`);
            
            // 4. åŠ è½½æ”¶è—å’Œæœ€å°åŒ–çŠ¶æ€
            state.favorites = loadFavorites();
            state.minimized = loadMinimized();
            console.log(`[UI] åŠ è½½ ${Object.keys(state.favorites).length} ä¸ªæ”¶è—, ${Object.keys(state.minimized).length} ä¸ªæœ€å°åŒ–`);
            
            console.log(`æœ€ç»ˆçŠ¶æ€: ${state.moveLibrary.length} æ‹›å¼, ${state.notes.length} åœºæ™¯`);
            console.log('=== åˆå§‹åŒ–å®Œæˆ ===');
            
            updateSortOrderUI();
            renderAll();
            
            // åˆå§‹åŒ– Tab æŒ‡ç¤ºå™¨ä½ç½®
            setTimeout(() => updateTabIndicator('notes'), 100);
            
            // åˆå§‹åŒ–å°æ¡æ»šåŠ¨å†…å®¹
            updateMarqueeTape();
            
            // æ ‡è®°åŠ è½½å®Œæˆï¼Œå¯ç”¨é¡µé¢è¿‡æ¸¡
            requestAnimationFrame(() => {
                document.documentElement.classList.add('loaded');
            });
            
            // åˆå§‹åŒ– Lucide å›¾æ ‡
            lucide.createIcons();
        };
        
        // åˆå§‹åŒ–/æ›´æ–°å°æ¡æ»šåŠ¨æ•ˆæœ
        function updateMarqueeTape() {
            const charName = state.currentCharacter;
            const charIcon = getCharIcon(charName);
            
            // å°æ¡å†…å®¹ï¼šemoji + è§’è‰²åï¼Œäº¤æ›¿æ˜¾ç¤º
            // å¢åŠ é‡å¤æ¬¡æ•°ç¡®ä¿å†…å®¹è¶³å¤Ÿé•¿ï¼Œé¿å…æ»šåŠ¨æ—¶å‡ºç°ç©ºç™½
            const repeatCount = 20;
            const content = Array(repeatCount).fill(`<span>${charIcon} ${charName}</span>`).join('');
            
            document.getElementById('marqueeContent1').innerHTML = content;
            document.getElementById('marqueeContent1Clone').innerHTML = content;
            document.getElementById('marqueeContent2').innerHTML = content;
            document.getElementById('marqueeContent2Clone').innerHTML = content;
        }
        
        // ==================== SF6 å¯¼èˆªèœå•æ§åˆ¶ ====================
        const sf6MenuBtn = document.getElementById('sf6MenuBtn');
        const sf6CloseMenu = document.getElementById('sf6CloseMenu');
        const sf6FullscreenMenu = document.getElementById('sf6FullscreenMenu');
        
        sf6MenuBtn.addEventListener('click', () => {
            sf6FullscreenMenu.classList.add('active');
        });
        
        sf6CloseMenu.addEventListener('click', closeSf6Menu);
        
        function closeSf6Menu() {
            sf6FullscreenMenu.classList.remove('active');
        }
        
        // ESC é”®å…³é—­èœå•
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && sf6FullscreenMenu.classList.contains('active')) {
                closeSf6Menu();
            }
        });
    </script>
</body>
</html>
